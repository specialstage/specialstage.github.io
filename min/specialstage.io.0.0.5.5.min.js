function Control(){var a=this;this.BINDINGS=this.GAMEPAD=this.TRACK=this.BACK=this.HIDE=this.ESC=this.CTRL=this.SHIFT=this.SPACE=this.ENTER=this.RIGHT=this.LEFT=this.FORWARD=this.BACK=this.DOWN=this.UP=this.MOBILE=!1;this.touches=[];var f="";this.connect=function(){this.MOBILE?(window.addEventListener("touchstart",a.touch,!1),window.addEventListener("touchmove",a.touch,!1),window.addEventListener("touchend",a.touch,!1)):(window.addEventListener("keydown",a.key,!1),window.addEventListener("keyup",
a.key,!1),window.addEventListener("mousedown",a.mousedown),window.addEventListener("mouseup",a.mouseup,!1),window.addEventListener("touchstart",a.touchSetup,!1))};this.disconnect=function(){window.removeEventListener("keydown",a.key,!1);window.removeEventListener("keyup",a.key,!1);window.removeEventListener("mousedown",a.mousedown,!1);window.removeEventListener("mouseup",a.mouseup,!1);window.removeEventListener("touchstart",a.touchSetup,!1);window.removeEventListener("touchstart",a.touch,!1);window.removeE;
ventListener("touchmove",a.touch,!1);window.removeEventListener("touchend",a.touch,!1)};this.key=function(g){var d="keydown"==g.type;switch(d||(f+=g.key),3<f.length&&(f=f.slice(1,4)),g.key){case "ArrowUp":a.UP=d;break;case "ArrowDown":a.DOWN=d;break;case "ArrowLeft":a.LEFT=d;break;case "ArrowRight":a.RIGHT=d;break;case "w":a.UP=d;break;case "s":a.DOWN=d;break;case "a":a.LEFT=d;break;case "d":a.RIGHT=d;break;case "r":a.RESET=d;break;case " ":a.SPACE=d;break;case "Shift":a.SHIFT=d;break;case "Enter":a.ENTER=
d;break;case "Control":a.CTRL=d;break;case "Escape":case "Backspace":a.ESC=d;break;case "=":a.ZOOM_IN=d;break;case "-":a.ZOOM_OUT=d;break;case "t":a.TARGET=d;break;case "h":a.HIDE=d;break;case ">":!d&&2>PIXEL_SCALE&&(PIXEL_SCALE+=.5);resize();break;case "<":!d&&.5<PIXEL_SCALE&&(PIXEL_SCALE-=.5),resize()}UAS_ENABLED?!vhs.PLAY||MENU||UAS_IS_ACTIVE||"vhs"===f&&(ui.print("code detected: ghost data overwrite","2","2"),window.setTimeout(vhs["export"],1E3,state.results,!1),f=""):"uas"===f&&(UAS_ENABLED=
!0,MENU=!0,state.settings(state.STATE),ui.print("code detected: uas enabled","2","2"),f="")};this.mousedown=function(g){g.preventDefault();a.touches[0]={x:g.clientX,y:g.clientY,start:!0}};this.mouseup=function(g){g.preventDefault();a.touches[0]={x:g.clientX,y:g.clientY,start:!1}};this.touchSetup=function(g){window.removeEventListener("keydown",a.key,!1);window.removeEventListener("keyup",a.key,!1);window.removeEventListener("keyup",a.key,!1);window.removeEventListener("mousedown",a.mousedown,!1);
window.removeEventListener("mouseup",a.mouseup,!1);window.removeEventListener("touchstart",a.touchSetup,!1);window.addEventListener("touchstart",a.touchstart,!1);window.addEventListener("touchmove",a.touchmove,!1);window.addEventListener("touchend",a.touchend,!1);a.touchstart(g)};this.clear=function(){a.touches=[];this.ENTER=this.RIGHT=this.LEFT=this.DOWN=this.UP=!1};this.touchstart=function(g){g=g.touches;a.touches=[];for(var d=0;d<g.length;d++)a.touches[d]={x:g[d].clientX,y:g[d].clientY,start:!0}};
this.touchmove=function(g){a.touches=[];g=g.touches;for(var d=0;d<g.length;d++)a.touches[d]={x:g[d].clientX,y:g[d].clientY,start:!1}};this.touchend=function(g){a.touches=[];g=g.touches;for(var d=0;d<g.length;d++)a.touches[d]={x:g[d].clientX,y:g[d].clientY,start:!1}}}
function Generate(){var a=(scope=this).SEED=0;this.length=480;var f=[],g=0;f[0]={name:"forest",palette:palette[9],tree:function(n,l){return scope.pine()},limit:Math.floor(scope.length/2),range:5,map:[],flags:[]};f[0].map[0]=function(n,l){var p=palette[10],D=!1;return.92<Math.abs(n)&&(p=.92<Math.abs(n)?palette[9]:palette[2],D=!0),f[0].flags[l]=D,p};f[1]={name:"sakura",palette:palette[12],tree:function(){return scope.sakura()},limit:Math.floor(1/6*scope.length),range:10,map:[],flags:[]};f[1].map[0]=
function(n,l){var p=palette[1],D=!1;return.95<Math.abs(n)&&(p=.92<Math.abs(n)?palette[12]:palette[1],D=!0),f[1].flags[l]=D,p};f[2]={name:"summit",palette:palette[1],tree:function(){return new THREE.Geometry},limit:0,range:10,map:[],flags:[]};f[2].map[0]=function(n,l){var p=palette[7],D=!1;return.95<Math.abs(n)&&(p=.92<Math.abs(n)?palette[2]:palette[7],D=!0),f[2].flags[l]=D,p};var d=new THREE.Points(new THREE.Geometry);d.name="Generative Extruder";d.visible=!1;var h=new THREE.Line(new THREE.Geometry);
h.name="Generative Nodes";h.visible=!1;h.material.color=palette[6];h.material.name="Node Material";h.position.z+=2;var z=new THREE.LineSegments(new THREE.Geometry);z.name="Generative Segments";z.visible=!0;z.material.color=palette[3];z.material.name="Segments Material";var t=new THREE.Mesh(new THREE.Geometry);t.name="Generative Surface";t.visible=!1;t.material.color=palette[0];t.material.name="Surface Material";var x=new THREE.LineSegments(new THREE.Geometry);x.name="Generative Perimeter";x.material.color=
palette[1];x.material.name="Perimeter Material";var w=new THREE.Mesh(new THREE.Geometry,new THREE.MeshBasicMaterial({vertexColors:THREE.VertexColors}));w.name="Terrain";w.material.name="Terrain Material";w.material.wireframe=!0;w.material.side=THREE.DoubleSide;w.visible=!0;wireframe=new THREE.Mesh(new THREE.Geometry,new THREE.MeshBasicMaterial({vertexColors:THREE.VertexColors}));wireframe.name="Wireframe";wireframe.material.name="Wireframe Material";wireframe.material.wireframe=!0;wireframe.material.side=
THREE.FrontSide;wireframe.visible=!0;var b=new THREE.LineSegments(new THREE.Geometry,new THREE.LineBasicMaterial({vertexColors:THREE.VertexColors}));b.name="Trees";var k=new THREE.Mesh(new THREE.Geometry,new THREE.MeshBasicMaterial);k.name="Background";k.material.color=palette[0];k.material.name="Background Material";k.material.wireframe=!1;k.material.side=THREE.FrontSide;k.material.opacity=.75;k.material.blendMode=THREE.MultiplyBlending;k.material.transparent=!0;var q=new THREE.Points(new THREE.Geometry);
q.material.color=palette[1];q.material.sizeAttenuation=!1;q.material.size=1.5;q.material.fog=!1;scope.stars=q;var m=new THREE.Mesh(new THREE.Geometry,new THREE.MeshBasicMaterial);m.name="Collision Mesh";m.visible=!0;m.material.name="Collision Material";m.material.side=THREE.BackSide;this.checkpoints=[];var B=new THREE.Vector3(0,0,1),G=new THREE.Vector3(1,0,0);new THREE.Vector3(0,1,0);new THREE.Vector3(0,0,1);var J=new THREE.Vector3(0,3,0),U=new THREE.Vector3(0,0,1),T=h.geometry.clone(),r=t.geometry.clone(),
C=z.geometry.clone(),A=x.geometry.clone(),E=[],M=[],Y=new THREE.Vector3;E[0]=new THREE.Vector3(5,3,0);E[1]=new THREE.Vector3(-5,3,0);M[0]=E[0].clone();M.z+=1;M[1]=E[1].clone();M.z+=1;var Q=Math.PI/64,N=Math.PI/32,S=[],X=0,aa=new THREE.Vector3;this.start=new THREE.Vector3;var ca=!1,da=!1,Z=!1;this.IMPORT=this.END=!1;this.DISTANCE=0;var ra=18,sa=new THREE.Raycaster;sa.far=800;d.geometry.vertices[0]=J.clone();d.geometry.vertices[1]=B.clone().add(J);d.geometry.vertices[2]=E[0].clone();d.geometry.vertices[3]=
E[1].clone();d.geometry.vertices[4]=M[0].clone();d.geometry.vertices[5]=M[1].clone();this.connect=function(){scope.SEED=SEED;g=scope.randomInt(0,3);stage.SNOW=2===g;stage.SNOW&&stage.snow.init();scene.add(d);scene.add(h);scene.add(z);scene.add(x);scene.add(t);scene.add(wireframe);scene.add(k);X=window.performance.now();window.setTimeout(scope.generate,0)};this.disconnect=function(){for(var n in S=[],scene.remove(d),scene.remove(h),scene.remove(z),scene.remove(x),scene.remove(t),scene.remove(wireframe),
scene.remove(k),scene.remove(b),f)f[n].flag=[];for(var l in scope.checkpoints)scene.remove(scope.checkpoints[l].display),scope.checkpoints[l].display.geometry.dispose(),scope.checkpoints[l].collision.geometry.dispose()};this.complete=function(){m.geometry.mergeVertices();m.geometry.verticesNeedUpdate=!0;m.geometry.elementsNeedUpdate=!0;m.geometry.computeFaceNormals();m.geometry.computeVertexNormals();m.geometry.computeBoundingSphere();k.geometry.copy(m.geometry);--k.position.z;for(var n=[],l=0;l<
m.geometry.faces.length;l++)n[m.geometry.faces[l].a]=m.geometry.faces[l].vertexNormals[0].clone(),n[m.geometry.faces[l].b]=m.geometry.faces[l].vertexNormals[1].clone(),n[m.geometry.faces[l].c]=m.geometry.faces[l].vertexNormals[2].clone();for(l=0;l<m.geometry.vertices.length;l++)m.geometry.vertices[l].add(n[l].multiplyScalar(2));m.geometry.verticesNeedUpdate=!0;wireframe.geometry.mergeVertices();wireframe.geometry.verticesNeedUpdate=!0;wireframe.geometry.elementsNeedUpdate=!0;wireframe.geometry.computeFaceNormals();
wireframe.geometry.computeBoundingSphere();n=new THREE.IcosahedronGeometry(1200,10);for(var p in n.vertices).3>scope.random()&&-400<n.vertices[p].z&&q.geometry.vertices.push(n.vertices[p].clone());n.dispose();q.geometry.computeBoundingSphere();stage.surface=m.clone();stage.start=scope.start.clone();X=window.performance.now()-X;ca=!0;scope.END=!0;FIREBASE&&firebase.analytics().logEvent("stage_generation_complete",{time:Math.round(X/1E3)});BATTLE?(ui.clear(),vehicle.connect(stage.start,stage.surface),
vehicle.PLAY=!1,vhs.PLAY=!0):state.ready()};this.reset=function(){ra=(36+scope.random()-.5)/2;a=0;h.geometry.dispose();z.geometry.dispose();t.geometry.dispose();d.geometry.dispose();x.geometry.dispose();w.geometry.dispose();wireframe.geometry.dispose();m.geometry.dispose();b.geometry.dispose();q.geometry.dispose();C.dispose();A.dispose();T.dispose();r.dispose();C.copy(new THREE.Geometry);A.copy(new THREE.Geometry);T.copy(new THREE.Geometry);r.copy(new THREE.Geometry);h.geometry.copy(new THREE.Geometry);
d.geometry.copy(new THREE.Geometry);z.geometry.copy(new THREE.Geometry);x.geometry.copy(new THREE.Geometry);t.geometry.copy(new THREE.Geometry);w.geometry.copy(new THREE.Geometry);m.geometry.copy(new THREE.Geometry);J.set(0,3,0);U.set(0,0,1);E[0]=new THREE.Vector3(4,3,0);E[1]=new THREE.Vector3(-4,3,0);ca&&(ca=!1,da=!1,Z=!1);this.END=!1;d.position.set(0,0,0);d.geometry.vertices[0]=J.clone();d.geometry.vertices[1]=B.clone().add(J);d.geometry.vertices[2]=E[0].clone();d.geometry.vertices[3]=E[1].clone();
d.geometry.vertices[4]=M[0].clone();d.geometry.vertices[5]=M[1].clone();d.geometry.verticesNeedUpdate=!0};this.generate=function(){scope.path()};this.path=function(n,l,p,D,y,u,O,F,I,H){n=void 0===n?0:n;l=void 0===l?0:l;p=void 0===p?0:p;D=void 0===D?0:D;y=void 0===y?0:y;u=void 0===u?{start:0,end:30,angle:0,slope:0}:u;O=void 0===O?[]:O;F=void 0===F?[]:F;I=void 0===I?!1:I;H=void 0===H?999:H;var P=window.performance.now(),W=0;for(0===D&&(D=.5<scope.random()?1:-1);32>W&&!da;){if(n===u.end+1){F=[];for(p=
0;1>p;p++)if(n>=scope.length)F.push({angle:0,slope:0,end:30}),H=n+30;else if(0===l){var V=scope.randomInt(2,4)*D;W=Math.floor(Math.abs(36/V));D=.01>scope.random()?+D:-1*D;W=scope.randomInt(1,W);F.push({angle:V,slope:0,end:W})}else V=scope.randomInt(-5,-1),W=scope.random(),V=2!==g&&.05>W?V*=-1:V,W=scope.randomInt(2,20),F.push({angle:0,slope:V,end:W});W=scope.randomInt(0,F.length);l=F[W].angle;p=F[W].slope;u.start=n;u.end=n+F[W].end;F=F.slice(W,1)}if(I||(scope.extrude(l,p),S.push({angle:l,slope:p}),
T.verticesNeedUpdate=!0,n++),10<=n&&!I){W=new THREE.Vector2(T.vertices[n-1].x,T.vertices[n-1].y);for(V=0;V<T.vertices.length-1-10;V++)if(18>(new THREE.Vector2(T.vertices[V].x,T.vertices[V].y)).distanceTo(W)){I=!0;break}I&&window.setTimeout(stage.reset(!0),0)}0;n===H&&(da=!0,h.geometry.dispose(),h.geometry=T.clone(),h.geometry.computeBoundingSphere(),h.geometry.center(),h.updateMatrixWorld(),0<h.geometry.vertices.length&&(aa.copy(h.geometry.vertices[0]),aa.sub(T.vertices[0])),window.setTimeout(function(){state.PATH=
!0;state.STATE();scope["import"]()},0));W=window.performance.now()-P}da||I||window.setTimeout(scope.path,0,n,l,p,D,y,u,O,F,I,H)};this.skijump=function(n,l,p,D,y,u,O,F,I,H,P){n=void 0===n?0:n;l=void 0===l?0:l;p=void 0===p?0:p;D=void 0===D?0:D;y=void 0===y?0:y;u=void 0===u?{start:0,end:20,angle:0,slope:0}:u;O=void 0===O?[]:O;F=void 0===F?[]:F;I=void 0===I?!1:I;H=void 0===H?300:H;P=void 0===P?0:P;var W=window.performance.now(),V=0;for(0===D&&(D=.5<scope.random()?1:-1);32>V&&!da;){if(n===u.end+1){F=[];
for(l=0;1>l;l++)0===p&&20===u.end?(P=-1,F.push({angle:0,slope:-4,end:30})):3===p?F.push({angle:0,slope:4,end:3}):4===p?F.push({angle:0,slope:-32,end:10}):-4===p?(P=1,F.push({angle:0,slope:p+1,end:1})):-32===p?F.push({angle:0,slope:-4,end:40}):1==P?F.push({angle:0,slope:p+1,end:1}):-1==P&&F.push({angle:0,slope:p-1,end:1});V=scope.randomInt(0,F.length);l=F[V].angle;p=F[V].slope;u.start=n;u.end=n+F[V].end;F=F.slice(V,1)}if(I||(scope.extrude(l,p),S.push({angle:l,slope:p}),T.verticesNeedUpdate=!0,n++),
10<=n&&!I){V=new THREE.Vector2(T.vertices[n-1].x,T.vertices[n-1].y);for(var ka=0;ka<T.vertices.length-1-10;ka++)if(0>(new THREE.Vector2(T.vertices[ka].x,T.vertices[ka].y)).distanceTo(V)){I=!0;break}I&&window.setTimeout(stage.reset(!0),0)}0;H<=n&&(da=!0,h.geometry.dispose(),h.geometry=T.clone(),h.geometry.computeBoundingSphere(),h.geometry.center(),h.updateMatrixWorld(),0<h.geometry.vertices.length&&(aa.copy(h.geometry.vertices[0]),aa.sub(T.vertices[0])),window.setTimeout(function(){scope["import"]()},
0));V=window.performance.now()-W}da||I||window.setTimeout(scope.skijump,0,n,l,p,D,y,u,O,F,I,H)};this["import"]=function(n){n=void 0===n?0:n;for(var l=window.performance.now(),p=0;!Z&&32>p;){if(0===n&&(d.position.set(0,0,0),d.rotation.z=0,J.set(0,3,0),d.geometry.vertices[0]=J.clone(),d.geometry.vertices[1]=B.clone().add(J),d.geometry.vertices[2]=E[0].clone(),d.geometry.vertices[3]=E[1].clone(),d.geometry.vertices[4]=M[0].clone(),d.geometry.vertices[5]=M[1].clone(),d.geometry.verticesNeedUpdate=!0,
d.updateMatrixWorld()),n<S.length)a=n,angle=S[n].angle,slope=S[n].slope,scope.extrude(angle,slope),z.geometry.dispose(),z.geometry=C.clone(),z.geometry.computeBoundingSphere(),x.geometry.dispose(),x.geometry=A.clone(),x.geometry.computeBoundingSphere(),t.geometry.dispose(),t.geometry=r.clone(),t.geometry.computeBoundingSphere(),n++;else if(!Z&&n===S.length){for(var D in scope.checkpoints=scope.checkpoint(),scope.checkpoints)scene.add(scope.checkpoints[D].display);Z=!0;window.setTimeout(function(){scope.terrain(!0)},
0)}p=window.performance.now()-l}Z||window.setTimeout(scope["import"],0,n,angle,slope)};this.extrude=function(n,l){n=void 0===n?0:n;l=void 0===l?0:l;for(var p in d.updateMatrixWorld(),d.rotateZ(n*N),d.geometry.vertices)d.geometry.vertices[p].applyAxisAngle(G,l*Q);d.geometry.verticesNeedUpdate=!0;p=d.geometry.vertices[0].clone();var D=d.geometry.vertices[2].clone(),y=d.geometry.vertices[3].clone(),u=d.geometry.vertices[1].clone();if(p.applyMatrix4(d.matrix),D.applyMatrix4(d.matrix),y.applyMatrix4(d.matrix),
u.applyMatrix4(d.matrix),u.sub(p),da){if(D.add(aa),y.add(aa),0<C.vertices.length){var O=C.vertices[C.vertices.length-1].clone().sub(Y),F=C.vertices[C.vertices.length-2].clone().sub(Y);r.vertices.push(D.clone().sub(u));r.vertices.push(y.clone().sub(u));r.vertices.push(F);r.vertices.push(y.clone().sub(u));r.vertices.push(O);r.vertices.push(F);var I=D.clone();n=y.clone();O=C.vertices[C.vertices.length-1].clone();F=C.vertices[C.vertices.length-2].clone();m.geometry.vertices.push(I);m.geometry.vertices.push(n);
m.geometry.vertices.push(F);m.geometry.vertices.push(n);m.geometry.vertices.push(O);m.geometry.vertices.push(F);O=r.vertices.length;var H=new THREE.Face3(O-3,O-2,O-1);I=new THREE.Face3(O-5,O-4,O-6);r.faces.push(H);r.faces.push(I);H=H.clone();I=I.clone();H.color=new THREE.Color(16777215);I.color=new THREE.Color(16777215);m.geometry.faces.push(H);m.geometry.faces.push(I)}0<A.vertices.length?(H=2,I=1,4<A.vertices.length&&(H=4,I=2),H=A.vertices[A.vertices.length-H].clone(),I=A.vertices[A.vertices.length-
I].clone(),A.vertices.push(D.clone().add(u)),A.vertices.push(H.clone()),A.vertices.push(y.clone().add(u)),A.vertices.push(I.clone()),a==S.length-1&&(F=D.clone().add(u),O=y.clone().add(u),A.vertices.push(F),A.vertices.push(O))):(A.vertices.push(D.clone().add(u)),A.vertices.push(y.clone().add(u)));C.vertices.push(D.clone());C.vertices.push(y.clone());Y.copy(u)}else T.vertices.push(p.clone());for(var P in J.copy(p).sub(d.position),d.position.add(J),d.geometry.vertices)d.geometry.vertices[P].applyAxisAngle(G,
-1*l*Q)};this.terrain=function(n,l,p,D,y,u,O){l=void 0===l?[]:l;p=void 0===p?[]:p;D=void 0===D?[]:D;y=void 0===y?0:y;u=void 0===u?0:u;O=void 0===O?0:O;if(void 0===n||n){z.updateMatrixWorld();w.geometry.dispose();w.geometry.copy(new THREE.Geometry);l=[];p=[];D=[];for(n=0;2>n;n++)D[n]=[],l[n]=[],p[n]=[];for(n=0;n<z.geometry.vertices.length;n++)p[n%2].push(z.geometry.vertices[n]);for(n=0;2>n;n++)for(var F=0;F<p[n].length;F++){var I=0===n?1:-1,H=p[n][F].clone();H.sub(p[n+I][F]);H.normalize().multiplyScalar(3);
D[n][F]=H.clone()}}F=0;var P;n=window.performance.now();if(4>y){if(w.geometry.verticesNeedUpdate=!0,w.geometry.elementsNeedUpdate=!0,w.geometry.computeBoundingSphere(),w.geometry.computeFaceNormals(),w.geometry.computeVertexNormals(),w.updateMatrixWorld(),0<y&&0===O)for(p[u]=[],I=0;I<l[u].length;I++)p[u][I]=w.geometry.vertices[l[u][I]];0===O&&(l[u]=[]);for(v=O;v<p[u].length&&32>F;){F=!1;if(void 0!==p[u][v]&&void 0!==p[u][v-1]){if(void 0===D[u][v])D[u][v]=D[s][v-1].clone();else if(w.geometry.computeBoundingSphere(),
I=p[u][v].clone().add(D[u][v]),I.z-=100,sa.set(I,B),I.z+=100,H=sa.intersectObjects([w],!0),0<H.length)for(var W in H).01<H[W].point.distanceTo(I)&&(l[u][v]=void 0,F=!0);F||(w.geometry.vertices.push(p[u][v].clone()),w.geometry.vertices.push(p[u][v].clone().add(D[u][v])),l[u][v]=w.geometry.vertices.length-1,0<v&&(w.geometry.vertices.push(p[u][v-1].clone()),P=w.geometry.vertices.length,0===u?w.geometry.faces.push(new THREE.Face3(P-2,P-1,P-3)):1===u&&w.geometry.faces.push(new THREE.Face3(P-1,P-2,P-3))))}F=
window.performance.now()-n;v++;O=v}if(O===p[u].length){O=0;for(P=1;P<l[u].length;P++)if(void 0!==l[u][P]&&void 0!==l[u][P-1]){W=w.geometry.vertices[l[u][P]];var V;n=w.geometry.vertices[l[u][P-1]];2.8>W.distanceTo(n)?(W.copy(n),l[u][P]=l[u][P-1],D[u][P].copy(D[u][P-1])):1<P&&(w.geometry.vertices.push(p[u][P-1]),V=0===u?l[u][P]:l[u][P-1],n=0===u?l[u][P-1]:l[u][P],w.geometry.faces.push(new THREE.Face3(V,n,w.geometry.vertices.length-1)))}u++}1<u&&(u=0,y++)}if(4===y){w.geometry.verticesNeedUpdate=!0;w.geometry.elementsNeedUpdate=
!0;w.geometry.colorsNeedUpdate=!0;w.geometry.computeFaceNormals();w.geometry.computeVertexNormals();w.geometry.mergeVertices();w.geometry.computeBoundingSphere();scope.noise(w.geometry);for(V=0;V<w.geometry.faces.length;V++)W=w.geometry.vertices[w.geometry.faces[V].a].clone(),n=w.geometry.vertices[w.geometry.faces[V].b].clone(),P=w.geometry.vertices[w.geometry.faces[V].c].clone(),w.geometry.colors[w.geometry.faces[V].a],w.geometry.colors[w.geometry.faces[V].b],w.geometry.colors[w.geometry.faces[V].c],
m.geometry.vertices.push(W),m.geometry.vertices.push(n),m.geometry.vertices.push(P),wireframe.geometry.vertices.push(W),wireframe.geometry.vertices.push(n),wireframe.geometry.vertices.push(P),P=m.geometry.vertices.length,W=new THREE.Face3(P-1,P-2,P-3),W.color=new THREE.Color(0),m.geometry.faces.push(W),wireframe.geometry.faces.push(new THREE.Face3(P-1,P-2,P-3));wireframe.geometry.copy(w.geometry);wireframe.geometry.computeVertexNormals();scope.biome();window.setTimeout(scope.complete,0)}else window.setTimeout(function(){scope.terrain(!1,
l.slice(),p.slice(),D.slice(),y,u,O)},0)};this.biome=function(){for(var n=g,l=wireframe.geometry.faces,p=[],D=[],y=0;y<l.length;y++)for(var u=0;u<f[g].map.length;u++)l[y].vertexColors[0]=f[g].map[u](l[y].vertexNormals[0].z,l[y].a),l[y].vertexColors[1]=f[g].map[u](l[y].vertexNormals[1].z,l[y].b),l[y].vertexColors[2]=f[g].map[u](l[y].vertexNormals[2].z,l[y].c);for(l=0;l<f[g].flags.length;l++)for(y=0;y<z.geometry.vertices.length;y++).1>wireframe.geometry.vertices[l].distanceTo(z.geometry.vertices[y])&&
(f[g].flags[l]=!1);for(l=0;l<f[g].flags.length;l++)f[g].flags[l]&&p.push(l);for(l=0;l<f[g].limit&&l<p.length;){y=scope.randomInt(0,p.length);u=!0;if(0<D.length&&0<p.length)for(;u;){for(var O in D){if(wireframe.geometry.vertices[p[y]].distanceTo(wireframe.geometry.vertices[D[O]])<f[g].range){u=!0;p.slice(y,1);y=scope.randomInt(0,p.length);break}u=!1}0>=p.length&&(u=!1)}if(0<p.length){u=f[n].tree();for(var F in u.vertices)b.geometry.vertices.push(u.vertices[F].clone().add(wireframe.geometry.vertices[p[y]])),
b.geometry.colors[b.geometry.vertices.length-1]=u.colors[F];D.push(p[y]);p.slice(y,1)}l++}b.verticesNeedUpdate=!0;b.elementsNeedUpdate=!0;scene.add(b)};this.sakura=function(){var n=new THREE.Geometry,l=[],p=[],D=1,y,u=new THREE.Vector3(0,0,0),O=new THREE.Vector3(0,0,3),F=12,I=0,H=new THREE.Vector3(1,0,0),P=new THREE.Vector3(0,0,1);n.vertices.push(u);n.vertices.push(O);n.colors.push(palette[2]);n.colors.push(palette[2]);p.push({v:O.clone(),n:O.clone(),pitch:H.clone(),roll:P.clone()});for(u=[];4>I;){O=
[];for(H=0;H<p.length;H++)for(var W=P=0;3>W;W++){var V=0===I&&2===W&&1>P?1:scope.random();if(.2<V){V=scope.randomInt(-2,2);var ka=p[H].n.clone(),ea=palette[2];ka.applyAxisAngle(p[H].pitch,2*Math.PI/(F+V));ka.applyAxisAngle(p[H].roll,2*Math.PI/3*W);ka.multiplyScalar(D);V=ka.clone().add(p[H].v);n.vertices.push(p[H].v.clone());n.vertices.push(V);n.colors.push(ea);n.colors.push(ea);ea=p[H].pitch.clone();ea.applyAxisAngle(p[H].roll,2*Math.PI/3*W);ea.applyAxisAngle(p[H].pitch,2*Math.PI/F);var oa=p[H].roll.clone();
oa.applyAxisAngle(p[H].pitch,2*Math.PI/F);oa.applyAxisAngle(p[H].roll,2*Math.PI/3*W);0<W&&l.push({a:V.clone(),b:p[H].v.clone(),pitch:ea,roll:oa});O.push({v:V.clone(),n:ka.clone(),pitch:ea,roll:oa});P++}else 0===P&&2===W&&u.push({v:p[H].v.clone(),n:p[H].n.clone(),pitch:p[H].pitch.clone(),roll:p[H].roll.clone()})}p=O.slice();D*=.9;I++}for(y in F=6,l)D=l[y].a.clone(),O=l[y].b.clone(),D=D.clone().sub(O),H=D.clone().multiplyScalar(.5).add(O),I=scope.randomInt(0,3)-1,D.applyAxisAngle(l[y].pitch,2*Math.PI/
F),D.applyAxisAngle(l[y].roll,2*Math.PI/I),D.multiplyScalar(.5),O=H,H=D.clone().add(H),n.vertices.push(O),n.vertices.push(H),n.colors.push(palette[2]),n.colors.push(palette[2]),O=l[y].pitch.clone(),O.applyAxisAngle(l[y].roll,2*Math.PI/I),O.applyAxisAngle(l[y].pitch,2*Math.PI/F),P=l[y].roll.clone(),P.applyAxisAngle(l[y].pitch,2*Math.PI/F),P.applyAxisAngle(l[y].roll,2*Math.PI/I),p.push({v:H.clone(),n:D.clone(),pitch:O,roll:P});p=p.concat(u);for(l=0;l<p.length;l++)for(y=0;5>y;y++)F=p[l].n.clone(),F.normalize(),
F.applyAxisAngle(p[l].pitch,2*Math.PI/6),F.applyAxisAngle(p[l].roll,2*Math.PI/5*y),F.multiplyScalar(.5),F=F.add(p[l].v),u=p[l].v.clone(),n.vertices.push(F),n.vertices.push(u),n.colors.push(palette[12]),n.colors.push(palette[12]);return n.colorsNeedUpdate=!0,n};this.pine=function(){var n=Math.floor(8*scope.random())+6,l=2*Math.PI/6,p=new THREE.Geometry;p.vertices.push(new THREE.Vector3(0,0,0));p.vertices.push(new THREE.Vector3(0,0,+n-.5+1));p.colors.push(palette[9]);p.colors.push(palette[9]);p.colors.push(palette[9]);
for(var D=1;D<n;D++)for(var y=0;6>y;y++)off=D%2*l*.5,p.vertices.push(new THREE.Vector3(0,0,+D+1)),p.vertices.push(new THREE.Vector3(.3*(n-D),0,+D-.3+1)),p.vertices[p.vertices.length-1].applyAxisAngle(B,l*y+off),p.colors.push(palette[9]),p.colors.push(palette[9]);return p};this.checkpoint=function(){function n(y,u,O){var F=new THREE.Geometry,I=(new THREE.Vector3).copy(y).sub(u),H=(new THREE.Vector3).copy(y).add(I.clone().multiplyScalar(1.5));I=(new THREE.Vector3).copy(u).sub(I.clone().multiplyScalar(1.5));
F.vertices.push(new THREE.Vector3(H.x,H.y,H.z-12));F.vertices.push(new THREE.Vector3(H.x,H.y,H.z+12));F.vertices.push(new THREE.Vector3(I.x,I.y,I.z+12));F.vertices.push(new THREE.Vector3(I.x,I.y,I.z+12));F.vertices.push(new THREE.Vector3(I.x,I.y,I.z-12));F.vertices.push(new THREE.Vector3(H.x,H.y,H.z-12));F.faces.push(new THREE.Face3(0,1,2));F.faces.push(new THREE.Face3(3,4,5));H=new THREE.Geometry;H.vertices.push(new THREE.Vector3(y.x,y.y,y.z+6));H.vertices.push(new THREE.Vector3(y.x,y.y,y.z+8));
H.vertices.push(new THREE.Vector3(u.x,u.y,u.z+6));H.vertices.push(new THREE.Vector3(u.x,u.y,u.z+8));H.vertices.push(new THREE.Vector3(y.x,y.y,y.z+6));H.vertices.push(new THREE.Vector3(u.x,u.y,u.z+6));H.vertices.push(new THREE.Vector3(y.x,y.y,y.z+8));H.vertices.push(new THREE.Vector3(u.x,u.y,u.z+8));H.vertices.push(new THREE.Vector3(y.x,y.y,y.z+1));H.vertices.push(new THREE.Vector3(u.x,u.y,u.z+1));y=new THREE.MeshBasicMaterial({side:THREE.DoubleSide,wireframe:!1,fog:!0});y.color=palette[5];F=new THREE.Mesh(F,
y);F.visible=!0;y=new THREE.LineSegments(H,y);return F.name="Objective "+O,y.name="Checkpoint"+O,{display:y,collision:F}}var l=z.geometry,p=l.vertices.length-80;p=Math.floor(p/4)-Math.floor(p/4)%2;var D=[];D[0]=n(l.vertices[40],l.vertices[41],0);D[1]=n(l.vertices[40+p],l.vertices[1+p+40],1);D[2]=n(l.vertices[2*p+40],l.vertices[2*p+41],2);D[3]=n(l.vertices[3*p+40],l.vertices[3*p+41],3);D[4]=n(l.vertices[4*p+40],l.vertices[4*p+41],4);this.DISTANCE=4*p/2*3;scope.start.copy(l.vertices[36]);scope.start.sub(l.vertices[37]);
scope.start.multiplyScalar(-.75);scope.start.add(l.vertices[36]);for(l=0;5>l;l++)null==stage.best&&(stage.best[l]=4>l?p*(l+1)/ra:stage.best[l]=stage.best[l-1]);return state.STATE(),D};this.resetCheckpoints=function(){for(var n in scope.checkpoints)scope.checkpoints[n].display.material.color=palette[5]};this.random=function(){SEED=(SEED+1)%2147483647;var n=1E4*Math.sin(SEED);return n-Math.floor(n)};this.randomInt=function(n,l){return Math.floor(scope.random()*(l-n))+n};this.noise=function(n){var l=
new ImprovedNoise,p=[],D=8,y=0,u=0,O=1E3*scope.random();g;for(var F=0;F<n.vertices.length;F++)p[F]=0;for(F=0;2>F;F++){for(var I=0;I<n.vertices.length;I++)p[I]+=Math.floor(l.noise(n.vertices[I].x/D,n.vertices[I].y/D,O)*D),p[I]>y&&(y=p[I]),p[I]<u&&(u=p[I]);D*=3}for(l=0;l<p.length;l++){D=2===g?2:.5;for(y=0;y<z.geometry.vertices.length;y++)u=n.vertices[l].distanceTo(z.geometry.vertices[y]),u=u*u/100,u<D&&(D=u);n.vertices[l].z+=p[l]*D}};this.name=function(){var n="";if(CUSTOM_SEED)n=state.custom_seed;
else if(CHALLENGE||BATTLE)n=state.CHALLENGES.seed;else{var l=[" forest"," pass"," mountain"],p="wa tsu mi n wa ra ya ma ha na ta ka a wi ri mi hi ni chi shi ki i ru yu mu fu nu tsu su ku u we re me he ne te se ke e wo ro yo mo no to so ko o".split(" ");TOGGLE=!1;for(var D=Math.ceil(3*Math.random())+1,y=0;y<D;)n+=p[Math.floor(Math.random()*p.length)],y++;p=2===g?1:0;p=l[Math.floor(p+Math.random()*(l.length-p))];if(n+=p,.01<Math.random())for(p=Math.floor(Math.random()*seeds.length),n=seeds[p];n==LAST_SEED;)n=
seeds[Math.floor(Math.random()*seeds.length)]}return LAST_SEED=n,n}}
var Ghost=function(a,f,g,d){g=void 0===g?0:g;d=void 0===d?[]:d;var h=this,z=void 0===f?0:f;f=g;var t=a.slice();this.tape=t;var x=this.frame=0,w=new THREE.Vector3(0,0,1),b=new THREE.Vector3,k=new THREE.Vector3,q=new THREE.Vector3(0,0,1),m=new THREE.Vector3,B=new THREE.Vector3(0,5,0);this.position=new THREE.Vector3;this.direction=new THREE.Vector3;var G;this.velocity=new THREE.Vector3;new THREE.Vector3;new THREE.Vector3;var J=new THREE.Vector3,U=[{name:"logistics crate",geometry:function(){return MODEL.logistics_crate()}},
{name:"ag-86",geometry:function(){return MODEL.ag_86()}}][z].geometry(),T=new THREE.MeshBasicMaterial({color:PAINT[f]}),r=new THREE.LineSegments(U,T);r.name="ghost_"+ghost.length;r.position.copy(t[0].position);scene.add(r);var C=new MODEL.emitter;C.connect(PAINT[g]);x=0;cp=d.slice();(cp[4]<stage.best[4]||null==stage.best[4])&&(stage.best=cp.slice());this.reset=function(){TIME.reset();C.reset();x=0;h.update()};this.update=function(A){A={TS:TIME.time};x=vhs.convert(t,A,x);b.copy(A.position);q.copy(A.lookTarget);
G=A.rotation;m.copy(q);m.add(b);r.position.copy(b);r.lookAt(m);r.rotateOnAxis(w,G);k.copy(r.localToWorld(B.clone()));k.sub(b);k.normalize();h.position.copy(b);h.direction.copy(k);this.velocity.copy(b);this.velocity.sub(J);J.copy(b);h.frame=x;GHOST_EMITTER&&C.update(!0,h.position,h.direction,h.velocity.length())};this.toggleEmitter=function(A){void 0===A||A?C.connect():C.disconnect()};this.disconnect=function(){scene.remove(r);U.dispose();T.dispose();C.disconnect()};this.debug=function(){console.log(t)}},
BUILD="0.0.5.5",DB_BUILD="005";window.onload=init;window.onresize=resize;window.fullscreenchange=resize;window.focus=resize;
var seeds="prey first pass;ego mountain;aretete pass;ato mountain;chimi forest;chiwi pass;eha pass;eva tribute;funano mountain;fuwinmi forest;ghxst forest;ghxst run;ginko mountain;haro forest;hefuhi mountain;hema forest;heronefu forest;hewae forest;hollow touge;iitsuwo forest;ikufu pass;ima pass;inutsuwa pass;irohazaka;kami mountain;kamomi pass;karanu mountain;ken pass;kikeori mountain;kitsumomi pass;kodama forest;koehako mountain;kokiri forest;kotewa forest;kouyo pass;kukaru forest;kusune mountain;kuu forest;machi pass;machiuso mountain;mamushi mountain;matoreko mountain;mawa mountain;mea pass;meihi pass;meikiru mountain;meina pass;meriko pass;mewi pass;miki pass;mikuma forest;mimu forest;minaaru pass;mise pass;misuriwe forest;miuchin pass;miyoheri pass;moko mountain;momayawa forest;momo mountain;morioto pass;morua pass;mowakaya mountain;muhinawa forest;mumetsu pass;muwo pass;nake forest;nani mountain;natewa mountain;nawowako mountain;nechika forest;neiwika mountain;nekona forest;neni pass;nenuro pass;nere mountain;netata pass;niawi pass;niemeri pass;nisu forest;nkake pass;nme forest;nosuyowo forest;nowitsuyo pass;noyahesu pass;nrofuha forest;ntsuna forest;nuke mountain;nuku mountain;numo pass;nune pass;osuchi forest;oyuni pass;pine forest;procedural;raa pass;rafu forest;ran forest;raranike mountain;rarimi pass;rawatsuku mountain;reoyana pass;rerike mountain;riara pass;rihama pass;rihayoya pass;rikemoo pass;roka mountain;rononi mountain;ruchitesu pass;rutsuyo pass;ryuk mountain;senitake forest;senuteme pass;sesh mountain;shiko mountain;shinpuru mountain;shiomawa pass;shiraseto pass;shisene forest;shiwa forest;shiwoya mountain;somamishi mountain;sowe forest;tamuro mountain;taruwoo mountain;tase mountain;tefuroha mountain;tena forest;teyawochi mountain;the lotus order;titan forest;tokoheru forest;towihe mountain;towiwo mountain;tsukeoshi mountain;tsukon forest;tsuraku mountain;tsuruchihi mountain;tsurutsu pass;tsuwimasu mountain;ui pass;umawaro forest;umoai mountain;unari mountain;ureso forest;wahiheya pass;wakaru pass;wamichi forest;wanano forest;wareto mountain;wariroru pass;wawako pass;wesotewe mountain;wifuwaku forest;woihime pass;woka mountain;womaso forest;worenaku mountain;worunera forest;yaa pass;yakayu pass;yasoha mountain;yawishise pass;yokakeo pass;yona mountain;yonewi pass;yori mountain;yorihaka mountain;yosurora mountain;yowo pass;yoyatsushi pass;yume pass;yunuwime pass;yure mountain;yuuneme pass;yuyuke pass".split(";"),palette=
[1052688,16777215,12698049,2894892,5308334,16740978,2393855,2201343,3424820,2201152,7168071,10066329,16756970],e;for(e in palette){var c$65=new THREE.Color(palette[e]);palette[e]=c$65}
var PAINT=[16777215,16760825,12910564,16758197,16383882,14267903,7727359],PAINT_NAME="snow sakura melon peach bumblebee lavender ice".split(" "),LOADSTATUS=0,PERSONAL_BEST=!1,SEED_NAME="",CUSTOM_SEED="",SEED=Math.floor(2147483647*Math.random()),LAST_SEED="",scene,camera,renderer,stage,vehicle,control,ui,vhs,state,ghost=[],SCORE_LIMIT=99,GHOST_LIMIT=12,GHOST_SOFT_LIMIT=9,RAID_LIMIT=20,GHOST_PRIORITY=0,GHOST_EMITTER=!0,UAS_IS_ACTIVE,UAS_ENABLED=!1,UAS_IS_TRACKING=!1,UAS_IS_FOLLOWING=!1,REGISTER=!1,
UID=null,NAME="",UP,PLAY=!1,IMPORT=!1,BG=palette[0],FRAME=0,CURSOR=!1,FPS=0,COUNTER=0,TIMEOUT=0,DNF=!1,REASON="out of bounds",FULLSCREEN=!1,MODE=0,LOAD=0,LOADING=!1,MENU=!1,MOBILE=!1,CHALLENGE=!1,OBJECTIVES=[],UPDATES=[],HITBOX=!0,FIREBASE=!0,SCALE=1,RESIZE_SCALE=1,SNOW=!1,RAFID=0,GLOBAL_TS,GLOBAL_DT,GLOBAL_TS_START,GLOBAL_LAST_TS,MUSIC=!1,MUSIC_PAUSE=!1,sound,CHALLENGES=[],BATTLE=!1,PIXEL_SCALE=1,firebaseConfig={apiKey:"AIzaSyB8RCC02kiLKX3Vm5bUCKDdYgKKVyMRh_0",authDomain:"ssio-live.firebaseapp.com",
databaseURL:"https://ssio-live-default-rtdb.firebaseio.com",projectId:"ssio-live",storageBucket:"ssio-live.appspot.com",messagingSenderId:"205970490845",appId:"1:205970490845:web:fa37aac1e169e6feade234",measurementId:"G-54D3B95XY3"};
function init(){window.addEventListener("touchstart",activateTouch);window.addEventListener("contextmenu",function(){event.preventDefault()});scene=new THREE.Scene;scene.background=BG;UP=new THREE.Vector3(0,0,1);camera=new THREE.PerspectiveCamera;camera.up=UP;camera.position.z=2E3;camera.lookAt(0,0,0);camera.fov=70;camera.near=1E-4;camera.far=3E3;camera.name="Camera";scene.add(camera);renderer=new THREE.WebGLRenderer({logarithmicDepthBuffer:!0,antialias:!1,precision:"highp"});renderer.setClearColor(BG);
renderer.domElement.id="renderer";renderer.setSize(document.innerWidth,document.innerHeight);document.body.appendChild(renderer.domElement);control=new Control;control.connect();ui=new UI;stage=new Stage;vehicle=new Vehicle;vhs=new VHS;state=new State;state.login();state.checksave();state.decodeURL();uas=new UAS;vehicle.init();ui.onload=function(){ui.format(1,"#50ffae");ui.format(2,"#999999");ui.format(3,"#75e8ff");ui.format(4,"#ff7272");ui.format(5,"#eeeeee");camera.position.set(0,25,10);camera.lookAt(0,
0,0);resize();main();state.intro()}}function activateTouch(){MOBILE=!0;window.removeEventListener("touchstart",activateTouch)}function resize(){var a=1===window.devicePixelRatio&&600<=window.innerWidth&&600<=window.innerHeight?2:1,f=window.innerWidth,g=window.innerHeight;camera.aspect=f/g;camera.updateProjectionMatrix();ui.resize(f,g,a,PIXEL_SCALE);state.resize(f,g,a)}
function main(){if(window.requestAnimationFrame(main),RAFID=window.performance.now(),PLAY){vehicle.update();for(var a=0;a<ghost.length;a++)vehicle.START&&(DT(),ghost[a].update());MENU||REGISTER||state.update();!MOBILE||MENU||DNF||ui.dpad();control.RESET&&!MENU&&(state.reset(),control.RESET=!1);stage.update()}else if(vhs.PLAY){DT();stage.update();for(a=0;a<ghost.length;a++)ghost[a].update();if(0<ghost.length&&UAS_IS_ACTIVE&&TIME.time>ghost[0].tape[ghost[0].tape.length-1].TS+3E3)for(TIME.reset(),a=
0;a<ghost.length;a++)ghost[a].reset();UAS_IS_ACTIVE&&vehicle.START?(uas.update(),vhs.play(vehicle)):UAS_IS_ACTIVE?uas.update():vhs.play(vehicle)}else LOADING?(camera.position.applyAxisAngle(camera.up,.01),camera.lookAt(new THREE.Vector3,0,0,0),state.loading()):(camera.position.applyAxisAngle(camera.up,.01),camera.lookAt(new THREE.Vector3,0,0,0));renderer.render(scene,camera);ui.update(control.touches)}firebase.initializeApp(firebaseConfig);firebase.analytics();
var MODEL={ag_86:function(){geometry=new THREE.Geometry;return geometry.vertices.push(new THREE.Vector3(.45,-.75,1)),geometry.vertices.push(new THREE.Vector3(.3,1.2,1)),geometry.vertices.push(new THREE.Vector3(-.45,-.75,1)),geometry.vertices.push(new THREE.Vector3(-.3,1.2,1)),geometry.vertices.push(new THREE.Vector3(.3,1.2,1)),geometry.vertices.push(new THREE.Vector3(-.3,1.2,1)),geometry.vertices.push(new THREE.Vector3(.45,-.75,1)),geometry.vertices.push(new THREE.Vector3(-.45,-.75,1)),geometry.vertices.push(new THREE.Vector3(-.3,
1.2,1)),geometry.vertices.push(new THREE.Vector3(-1,-.75,-.1)),geometry.vertices.push(new THREE.Vector3(-.45,-.75,1)),geometry.vertices.push(new THREE.Vector3(-1,-.75,-.1)),geometry.vertices.push(new THREE.Vector3(.3,1.2,1)),geometry.vertices.push(new THREE.Vector3(1,-.75,-.1)),geometry.vertices.push(new THREE.Vector3(.45,-.75,1)),geometry.vertices.push(new THREE.Vector3(1,-.75,-.1)),geometry.vertices.push(new THREE.Vector3(.45,-.75,1)),geometry.vertices.push(new THREE.Vector3(.45,-1.4,.4)),geometry.vertices.push(new THREE.Vector3(-.45,
-.75,1)),geometry.vertices.push(new THREE.Vector3(-.45,-1.4,.4)),geometry.vertices.push(new THREE.Vector3(.45,-1.4,.4)),geometry.vertices.push(new THREE.Vector3(-.45,-1.4,.4)),geometry.vertices.push(new THREE.Vector3(.45,-1.4,.4)),geometry.vertices.push(new THREE.Vector3(1,-.75,-.1)),geometry.vertices.push(new THREE.Vector3(-.45,-1.4,.4)),geometry.vertices.push(new THREE.Vector3(-1,-.75,-.1)),geometry.center(),geometry.name="AG-86",geometry},logistics_crate:function(){var a=(new THREE.Geometry).fromBufferGeometry(new THREE.EdgesGeometry(new THREE.BoxGeometry(1,
2,1)));return a.name="Logistics Crate",a},emitter:function(){var a=this;this.maxLife=100;for(var f=0,g=new THREE.Geometry;g.vertices.length<a.maxLife;){var d=new THREE.Vector3(0,0,0);d.life=0;d.maxLife=a.maxLife;d.acc=new THREE.Vector3(0,0,0);g.vertices.push(d);d=new THREE.Color(4294967040);g.colors.push(d)}g.verticesNeedUpdate=!0;var h=new THREE.Points(g,new THREE.PointsMaterial({size:.2,vertexColors:THREE.VertexColors,blending:THREE.AdditiveBlending,transparent:!0}));h.name="Emitter";var z=new THREE.Color;
a.connect=function(t){t=void 0===t?16777215:t;scene.add(h);a.paint(t)};a.paint=function(t){t=new THREE.Color(void 0===t?16777215:t);z=new THREE.Color;t.getHSL(z);for(t=0;t<h.geometry.vertices.length;t++)h.geometry.colors[t].setHSL(z.h,z.s,0),h.geometry.vertices[t].life=0};a.reset=function(){for(var t=0;t<h.geometry.colors.length;t++)h.geometry.colors[t].setHSL(z.h,z.s,0),h.geometry.vertices[t].life=0};a.disconnect=function(){scene.remove(h);h.geometry.dispose();h.material.dispose()};a.update=function(t,
x,w,b){if(t)for(t=0;1>t;){h.geometry.vertices[f].copy(w);h.geometry.vertices[f].multiplyScalar(-1-Math.random()*b);h.geometry.vertices[f].add(x);h.geometry.vertices[f].life=h.geometry.vertices[f].maxLife;Math.random();Math.random();Math.random();var k=.1*-Math.random();h.geometry.vertices[f].acc.copy(w);h.geometry.vertices[f].acc.multiplyScalar(k);f++;f%=h.geometry.vertices.length;t++}for(var q in h.geometry.vertices){var m;0<h.geometry.vertices[q].life&&(h.geometry.vertices[q].add(h.geometry.vertices[q].acc),
--h.geometry.vertices[q].life,m=h.geometry.vertices[q].life/100,h.geometry.colors[q].setHSL(z.h,z.s,z.l*m));0>=h.geometry.vertices[q].life&&(h.geometry.vertices[q].set(0,0,0),h.geometry.vertices[f].acc.x=0,h.geometry.vertices[f].acc.y=0,h.geometry.vertices[f].acc.z=0)}h.geometry.verticesNeedUpdate=!0;h.geometry.colorsNeedUpdate=!0;h.geometry.computeBoundingSphere()}}},ImprovedNoise=function(){function a(z){return z*z*z*(z*(6*z-15)+10)}function f(z,t,x){return t+z*(x-t)}function g(z,t,x,w){var b=15&
z;z=8>b?t:x;w=4>b?x:12==b||14==b?t:w;return(0==(1&b)?z:-z)+(0==(2&b)?w:-w)}for(var d=[151,160,137,91,90,15,131,13,201,95,96,53,194,233,7,225,140,36,103,30,69,142,8,99,37,240,21,10,23,190,6,148,247,120,234,75,0,26,197,62,94,252,219,203,117,35,11,32,57,177,33,88,237,149,56,87,174,20,125,136,171,168,68,175,74,165,71,134,139,48,27,166,77,146,158,231,83,111,229,122,60,211,133,230,220,105,92,41,55,46,245,40,244,102,143,54,65,25,63,161,1,216,80,73,209,76,132,187,208,89,18,169,200,196,135,130,116,188,159,
86,164,100,109,198,173,186,3,64,52,217,226,250,124,123,5,202,38,147,118,126,255,82,85,212,207,206,59,227,47,16,58,17,182,189,28,42,223,183,170,213,119,248,152,2,44,154,163,70,221,153,101,155,167,43,172,9,129,22,39,253,19,98,108,110,79,113,224,232,178,185,112,104,218,246,97,228,251,34,242,193,238,210,144,12,191,179,162,241,81,51,145,235,249,14,239,107,49,192,214,31,181,199,106,157,184,84,204,176,115,121,50,45,127,4,150,254,138,236,205,93,222,114,67,29,24,72,243,141,128,195,78,66,215,61,156,180],h=
0;256>h;h++)d[256+h]=d[h];return{noise:function(z,t,x){var w=Math.floor(z),b=Math.floor(t),k=Math.floor(x),q=255&w,m=255&b,B=255&k,G=(z-=w)-1,J=(t-=b)-1,U=(x-=k)-1,T=a(z),r=a(t);w=a(x);b=d[q]+m;k=d[b]+B;b=d[b+1]+B;q=d[1+q]+m;m=d[q]+B;B=d[q+1]+B;return f(w,f(r,f(T,g(d[k],z,t,x),g(d[m],G,t,x)),f(T,g(d[b],z,J,x),g(d[B],G,J,x))),f(r,f(T,g(d[k+1],z,t,U),g(d[m+1],G,t,x-1)),f(T,g(d[b+1],z,J,U),g(d[B+1],G,J,U))))}}},profanity=function(a,f){for(var g="616e616c 617373 6175746973 62616c73 62616c7a 626c77 626c6f776a6f62 626f6e6572 6269746368 746974 627574 6368696e616d656e 6368696e616d616e 6368696e6b 636f636b 63756d 63756e74 64696b 6469636b 64796b65 656a6163756c6174 6572656374696f6e 666167 666774 66676574 666774 66676f74 66617274 66656c6174696f 666f7265736b696e 666f72736b696e 34736b696e 666f7265736b6e 666f72736b6e 34736b6e 666b 66756b 667563 66636b 6675646765706163 66756765706163 667567706163 667564676570636b 66646770636b 676179 6761796c6f72 6761796c72 67796c7264 676f6f6b 68616e646a6f62 686562 6869746c6572 68746c72 6869746c72 68746c6572 6a696761 6a69676761 6a676761 6a676162 6a697a 6b696b65 6d617374657262617465 6d617374757262617465 6d6173747262617465 6d61737475726238 6d61737465726238 6d617374726238 6d6964676574 6a65726b6f66 6a61636b6f66 6a61636b6d656f66 626561746d656174 6265746d6574 6d6574626574 6d65617462656174 6d6f6c657374 6e617a69 6e7a69 6e6772 6e676572 6e6761 6e656772 6e6967 6e6767 6e7574 70616b69 70656e6973 70657276 7068756b 70687563 706863 70696d70 70697373 706f7263686d6f6e6b6579 707263686d6e6b79 706f7263686d6e6b79 707263686d6f6e6b6579 706f7263686d6e6b6579 707263686d6f6e6b6579 706f726e 70726963 707269636b 70726f737469 70757379 7075736965 7065646f 70646f 72617065 7261706973 726170696e 72656374756d 74617264 72696d696e67 72696d6a6f62 736578 7365636b73 7363726f74756d 736b616e6b 736c617665 736c7574 736f646f6d 73706963 73686974 736874 7375636b 737578 73756b73 7370756e6b 73706f6765 7377617374696b61 73797068 746573746963 74657374696b 77616e6b 77686f7265 7768747077 776869746570726964 77686974707264 7768697465706f77 77686974657077 77707777 79656c6f776d616e 7a696761626f 7a6970657268656164 6a65737573 6a77 6a6577 61726162 6d75736c696d 636872697374 736174616e 676f64 6c6f7264 616c6168 62756468 6269626c65 71756172616e".split(" "),
d="a4 g6 g9 s5 i1 l1 b8 t7 b6 s$ y$ g& a& b& i! i/ i\\ i? g8 b8 s6 o0 e3".split(" "),h=a.toLowerCase(),z=0;z<h.length;z++){var t=h.charCodeAt(z);if(122<t||57<t&&61>t||33>t||40==t||41==t)return"";t="";for(var x=z;x<h.length;x++){h.charAt(x);var w=h.charCodeAt(x);(48<=w&&57>=w||97<=w&&122>=w)&&(t+=w.toString(16));for(w=0;w<g.length;w++){for(var b="",k="",q=[],m=0,B=0,G=0;G<g[w].length;G+=2){var J=t.charAt(G+m)+t.charAt(G+1+m),U=g[w].charAt(G)+g[w].charAt(G+1);if((J===b||J===k)&&0!==J.length&&(B++,0<
B))for(;J===b||J===k;)m+=2,J=t.charAt(G+m)+t.charAt(G+1+m);if(J===U)q[G/2]=!0,b=J,k=U;else{q[G/2]=!1;for(var T=0;T<d.length;T++){var r=d[T].charCodeAt(1).toString(16),C=d[T].charCodeAt(0).toString(16);J===r&&(C===U?(q[G/2]=!0,b=r,k=U):C!==b&&C!==k||(B++,0<B&&(m+=2,G-=2)))}!1===q[G/2]&&(G=g[w].length)}}for(k=b=0;k<q.length;k++)if(!0===q[k]&&b++,b===q.length)return""}}}return a};
function Sound(){var a;window.addEventListener("click",function(){a=new (window.AudioContext||window.webkitAudioContext)});(function(){for(var f=[],g=0;9>g;g++)f[g]=[];f[0].A=27.5;f[0]["A#"]=29.13523509488062;f[0].B=30.867706328507754;f[1].C=32.70319566257483;f[1]["C#"]=34.64782887210901;f[1].D=36.70809598967595;f[1]["D#"]=38.890872965260115;f[1].E=41.20344461410874;f[1].F=43.653528929125486;f[1]["F#"]=46.2493028389543;f[1].G=48.99942949771866;f[1]["G#"]=51.91308719749314;f[1].A=55;f[1]["A#"]=58.27047018976124;
f[1].B=61.735412657015516})();this.trigger=function(){var f=a.createOscillator();f.connect(null);var g=wavePicker.options[wavePicker.selectedIndex].value;return"custom"==g?f.setPeriodicWave(null):f.type=g,f.frequency.value=freq,f.start(),f}}
function Stage(){var a=this;this.SNOW=this.COMPLETE=!1;this.start=new THREE.Vector3;this.generate=new Generate;this.checkpoint=[];this.objectives=[];this.best=[];this.grid=[];this.dimension=2400;this.partitionDimension=16;this.partionDivision=this.dimension/this.partitionDimension;this.seed;this.snow={distance:200,height:100,limit:200,mesh:new THREE.Points(new THREE.Geometry,new THREE.PointsMaterial),init:function(){for(;a.snow.mesh.geometry.vertices.length<a.snow.limit;){var g=new THREE.Vector3;
g.copy(camera.position);g.x+=Math.random()*a.snow.distance-a.snow.distance/2;g.y+=Math.random()*a.snow.distance-a.snow.distance/2;g.z+=Math.random()*a.snow.height-a.snow.height/2;a.snow.mesh.geometry.vertices.push(g)}a.snow.mesh.geometry.verticesNeedUpdate=!0;a.snow.mesh.geometry.computeBoundingSphere()},update:function(){for(var g=0;g<a.snow.mesh.geometry.vertices.length;g++){var d=a.snow.mesh.geometry.vertices[g];d.z-=.5*vehicle.DT();(Math.abs(d.z-camera.position.z)>a.snow.height/2||Math.abs(d.x-
camera.position.x)>a.snow.distance/2||Math.abs(d.y-camera.position.y)>a.snow.distance/2)&&(d.copy(camera.position),d.x+=Math.random()*a.snow.distance-a.snow.distance/2,d.y+=Math.random()*a.snow.distance-a.snow.distance/2,d.z+=Math.random()*a.snow.height-a.snow.height/2)}a.snow.mesh.geometry.verticesNeedUpdate=!0;a.snow.mesh.geometry.computeBoundingSphere()}};for(var f=0;4>f;f++)this.checkpoint[this.checkpoint.length]=new THREE.Mesh(new THREE.Geometry);this.connect=function(g){g=void 0===g?!1:g;if(camera.position.set(0,
400,200),camera.far=2E3,camera.updateProjectionMatrix(),camera.lookAt(new THREE.Vector3),renderer.render(scene,camera),!g){this.name=this.generate.name();g="";for(var d in this.name)g+=this.name.charCodeAt(d).toString();SEED=g}a.generate.connect();COUNTER++};this.disconnect=function(){SNOW&&(scene.remove(a.snow.mesh),a.SNOW=!1);this.generate.disconnect();this.generate.reset()};this.reset=function(g){g=void 0===g?!1:g;SEED++;a.best=[];a.COMPLETE=!1;a.disconnect();a.generate=new Generate;a.connect(g)};
this.preview=function(){window.setTimeout(0,0)};this.update=function(){this.SNOW&&this.snow.update()}}
function State(){var a=this,f,g,d="",h=0,z=0;this.custom_seed="";var t="#1#ffffff#334#",x=GHOST_LIMIT+"#1#",w=!0;this.SETTINGS=!1;this.STATE=function(){a.intro()};this.CHALLENGES={};this.CHALLENGER="";this.TIMELIST=[];this.BATTLE=[];this.PATH=!1;this.login=function(){firebase.auth().onAuthStateChanged(function(b){return b?(UID=b.uid,a.STATE(),vhs.requestName(UID,function(k){NAME=k;a.STATE()})):(UID=!1,a.STATE()),null})};this.register=function(b){ui.clear();a.STATE=function(){a.register(b)};REGISTER=
!0;a.inputName(function(){REGISTER=!1;vhs["export"]()},!0,"input name to save data")};this.resize=function(b,k){f=ui.width;g=ui.height;GHOST_SOFT_LIMIT=Math.floor((window.innerHeight/ui.scale/ui.row-34)/2)};this.wallet=function(){var b=vehicle.yen();ui.print("$ "+b.toString(),"2","1.0-4")};this.nav=function(b){b=void 0===b?function(){ui.clear()}:b;UAS_IS_ACTIVE?(ui.sprite(24,64,8,8,"1.0-3","2",8,8),ui.button("","0.5","0.5","1.0","1.0",function(){a.menu(b)},!1)):(ui.sprite(8,64,8,8,"1.0-4+2p","2",
8,8),ui.button("","2","2+4p","1.0-4","8",function(){a.menu(b)},!1))};this.title=function(b,k){a.breadcrumb(b,k);ui.sprite(16,64,8,8,"1.0-4+2p","2",8,8);ui.button("","1.0-7","2+4p","7","5",function(){w||ui.backdrop(!1);b();MENU=!1;a.SETTINGS=!1},!1);a.wallet()};this.breadcrumb=function(b,k){k=void 0===k?function(){w||ui.backdrop(!1);b();MENU=!1;a.SETTINGS=!1}:function(){a.menu(b);MENU=!0};ui.print("< menu","2","2");ui.button("","2","2+4p","7","8",k,!1)};this.menu=function(b){MENU=!0;ui.style=0;a.STATE=
function(){a.menu(b)};w||ui.backdrop();ui.clear();a.title(b);ui.sprite(0,0,1,1,"2","6","1.0-4",1);UAS_IS_ACTIVE?(ui.print(" > view spectator controls","2","8"),ui.button("","2","8+4p","1.0-4","5",function(){a.uas(!0)},!1)):(ui.print(" > modify vehicle","2","8"),ui.button("","2","8+4p","1.0-4","5",function(){a.vehicle(b)},!1));ui.sprite(0,0,1,1,"2","11","1.0-4",1);ui.print(" > settings","2","13");ui.button("","2","13+4p","1.0-4","5",function(){a.settings(b)},!1);ui.sprite(0,0,1,1,"2","16","1.0-4",
1);var k=8;UAS_IS_ACTIVE?(ui.button("reset uas","2","1.0-2-"+k,"1.0-4","6",function(){ui.backdrop(!1);uas.reset();a.uas()},!0),k+=8,ui.button("deploy vehicle","2","1.0-2-"+k,"1.0-4","6",function(){ui.backdrop(!1);a.STATE=function(){};vehicle.connect(stage.start,stage.generate.surface);uas.disconnect();a.reset()},!0)):(PLAY||vhs.PLAY)&&(ui.button("restart stage","2","1.0-2-"+k,"1.0-4","6",function(){ui.backdrop(!1);a.reset()},!0),k+=8);stage.COMPLETE&&(PLAY||vhs.PLAY)&&ui.button("next stage","2","1.0-2-"+
k,"1.0-4","6",function(){ui.backdrop(!1);a.next()},!0);a.discord()};this.intro=function(){var b;a.STATE=function(){a.intro()};w=!0;ui.clear();ui.print("specialstage.io","2","2");ui.print("-","2","4");ui.link("","0","1.0-24","26","6","https://ginko.ltd");ui.print("new physical items","2","1.0-23");ui.print("available at","2","1.0-21");ui.style=1;ui.print("ginko.ltd","2+13","1.0-21");ui.style=0;CHALLENGE?(ui.style=4,ui.print("challenge detected!","2","12"),ui.style=0,b=null!==a.CHALLENGER&&0<a.CHALLENGER.length?
a.CHALLENGER:"...",ui.style=2,ui.print("rival:","2","15"),ui.style=0,ui.print(b,"9","15"),vhs.requestName(a.CHALLENGES.uid,function(k){a.CHALLENGER=k;a.STATE()}),ui.style=2,ui.print("seed:","2","17"),ui.style=0,ui.print(a.CHALLENGES.seed,"9","17")):CUSTOM_SEED&&(ui.style=3,ui.print("seed detected","2","13",1),ui.style=0,ui.print("> "+a.custom_seed,"2","16",1));null!==UID&&!1===UID||""!==NAME?null!==NAME&&""!==NAME?(ui.style=5,ui.print("welcome back!","2","6"),ui.style=0,ui.print("> "+NAME,"2","9"),
ui.style=2,ui.print("[edit]",NAME.length+"+5","9"),ui.style=0,ui.button("","2","9+4p",NAME.length+"+9","4",function(){a.inputName(a.intro)},!1)):!1!==UID||""!==NAME&&null!==NAME||(ui.style=2,ui.print("user data not detected","2","6"),ui.style=0,ui.print("> [register/sign in]","2","9"),ui.button("","2","9+4p","1.0-4","4",function(){a.inputName(a.intro)},!1)):(ui.style=2,ui.print("> loading user data...","2","6"),ui.style=0);ui.style=2;ui.print(BUILD,"2","1.0-4");ui.style=0;a.nav(function(){a.intro()});
ui.print("menu","1.0-9","2");ui.button("","1.0-9","2+4p","4","5",function(){a.menu(a.intro)},!1);a.discord();a.startButton()};this.startButton=function(){ui.button("start","2","1.0-12+"+(2*(RESIZE_SCALE-1)).toString(),"1.0-4","8",function(){ui.clear();w=!1;ui.renderer.style.background="transparent";ui.renderer.style.animation="none";STATE=function(){};START=!0;FIREBASE&&firebase.analytics().logEvent("game_start");stage.connect();a.load()})};this.discord=function(){ui.style=3;ui.sprite(0,72,16,16,
"1.0-12","1.0-5+4p",16,16);ui.print("discord","1.0-9","1.0-4");ui.link("","1.0-13","1.0-5","12","4","https://discord.gg/ACewNWH");ui.style=0};this.load=function(){a.STATE=function(){a.target()};a.TIMELIST=[];vhs.scan(stage.name,function(b){for(var k={$jscomp$loop$prop$t$90$158:0};k.$jscomp$loop$prop$t$90$158<b.length;k={$jscomp$loop$prop$t$90$158:k.$jscomp$loop$prop$t$90$158},k.$jscomp$loop$prop$t$90$158++)a.TIMELIST[k.$jscomp$loop$prop$t$90$158]={uid:b[k.$jscomp$loop$prop$t$90$158].uid,time:b[k.$jscomp$loop$prop$t$90$158].time,
name:"..."},vhs.requestName(b[k.$jscomp$loop$prop$t$90$158].uid,function(B){return function(G){a.TIMELIST[B.$jscomp$loop$prop$t$90$158].name=G;a.STATE()}}(k)),vhs.checkTime(UID,b[k.$jscomp$loop$prop$t$90$158].uid,b[k.$jscomp$loop$prop$t$90$158].time);var q=a.TIMELIST.length<GHOST_LIMIT?a.TIMELIST.length:GHOST_LIMIT;k=[];switch(GHOST_PRIORITY){case 0:k=b.slice(0,q);break;case 1:for(b=b.slice();k.length<q;){var m=Math.floor(Math.random()*b.length);k.push(Object.assign({},b[m]));b.splice(m,1)}}if(a.BATTLE=
k.slice(),PLAY)for(q=0;q<k.length;q++)vhs["import"](stage.name+"/"+k[q].uid,function(B){ghost.push(new Ghost(B.tape,B.model,B.paint,B.cp))});a.STATE()});LOADING=!0;a.target();h=0};this.ready=function(){LOADING=!1;a.STATE()};this.play=function(){ui.clear();a.nav(a.play);MENU=!1;ui.style=0};this.complete=function(){MENU=!0;ui.clear();a.nav(a.complete);var b="stage complete!";ui.style=0;ui.print(b,"0.5-"+2*Math.round(b.length/2),"0.3-1",2);ui.style=0;stage.COMPLETE=!0;window.setTimeout(function(){!1===
UID||null===UID?(a.register(),a.STATE=function(){a.results()}):(a.STATE=function(){a.results()},vhs["export"](a.results))},2E3);FIREBASE&&(b=vehicle.param().model+" ("+(vehicle.param().power+1)+"/"+(vehicle.param().drag+1)+"/"+(vehicle.param().sensitivity+1)+"/"+(vehicle.param().ease+1)+")",firebase.analytics().logEvent("stage_complete",{operator_id:NAME,time:vehicle.AT(),penalty:vehicle.PENALTY(),score:vehicle.AT()+vehicle.PENALTY(),seed:stage.name,rating:Math.round(stage.generate.DISTANCE/(vehicle.AT()+
vehicle.PENALTY())),distance:stage.generate.DISTANCE,vehicle:b}))};this.results=function(){a.STATE=function(){a.results()};ui.style=0;MENU=!0;ui.clear();NAME;vhs.tape.slice();MENU=!0;var b,k=ui["float"](vehicle.AT()+vehicle.PENALTY()),q=0;if(0<a.TIMELIST.length){for(var m=Math.floor(100*(vehicle.AT()+vehicle.PENALTY()))/100,B=0;B<a.TIMELIST.length;B++)if(m<a.TIMELIST[B].time){q=B+1;break}0==q&&(q=a.TIMELIST.length+1)}a.nav(a.results);ui.style=5;ui.print("stage complete! "+stage.name,"2","2");ui.style=
0;ui.print(k,"2","5",2);0!=q?ui.print("rank "+q,2*k.length+"+3".toString(),"5+4p"):vehicle.AT()+vehicle.PENALTY()<stage.best[4]?(b=CHALLENGE?"challenge victory!":"new record!",ui.style=4,ui.print(b,2*k.length+"+3".toString(),"5+4p"),ui.style=0):CHALLENGE&&ui.print("challenge failed",2*k.length+"+3".toString(),"5+4p");b=9;k=vehicle.CP();if(320<g){for(m=0;m<k.length-1;m++){ui.style=5;ui.print("cp "+(m+1).toString(),"2",b+"+"+m.toString());m;var G=void 0;B=void 0;B="number"==typeof k[m]?(G=ui["float"](k[m]),
Number.isNaN(stage.best[m])?"+1 cp":k[m]-stage.best[m]):(G="penalty",ui.style=4,"");ui.print(G.toString(),"0.5 -1-"+G.length.toString(),b+"+"+m.toString());ui.style=0;G="penalty"===G?"25 sec":"+1 cp"==B?"+1 cp":0<B?"( - "+ui["float"](B)+" )":"( + "+ui["float"](Math.abs(B))+" )";ui.style=0<B?4:0>B?1:0===B?2:4;ui.print(G,"0.5+1",b+"+"+m.toString());ui.style=0;b+=1}b+=5}1===q&&(ui.style=1,ui.print("new record!","2",b.toString(),2),ui.style=0);ui.button("issue challenge","0.5+1","1.0-20","0.5-3","4",
a.challenge);ui.button("modify vehicle","2","1.0-20","0.5-3","4",function(){ui.backdrop();a.vehicle(a.results)});ui.button("next stage","2","1.0-12","1.0-4","8",function(){a.next()});ui.button("restart stage","2","1.0-4","0.5-3","4",function(){a.reset("complete")});ui.button("view replay","0.5+1","1.0-4","0.5-3","4",function(){MENU=!1;a.replay()});window.setTimeout(function(){PLAY=!1;vhs.PLAY=!0},0)};this.battle=function(){var b=new Ghost(vhs.save(vhs.tape),vehicle.MODEL,vehicle.PAINT);ghost.push(b);
a.reset()};this.replay=function(){a.STATE=function(){a.results()};ui.clear();a.nav(a.results);for(var b={$jscomp$loop$prop$e$97$160:0};4>b.$jscomp$loop$prop$e$97$160;b={$jscomp$loop$prop$e$97$160:b.$jscomp$loop$prop$e$97$160},b.$jscomp$loop$prop$e$97$160++){var k="4+"+(4*b.$jscomp$loop$prop$e$97$160).toString(),q=b.$jscomp$loop$prop$e$97$160===vehicle.CAMERA-1?48:40;ui.button("",k+"-10p","1.0-4+4p","3","4",function(m){return function(){vehicle.CAMERA=m.$jscomp$loop$prop$e$97$160+1;a.replay()}}(b),
!1);ui.sprite(q,64,8,8,k,"1.0-4",8,8)}ui.print("<","2","2");ui.button("","2","2+4p","7","8",function(){a.results(a.replay)},!1)};this.next=function(){ui.clear();LOADING=!0;CUSTOM_SEED=BATTLE=CHALLENGE=!1;a.PATH=!1;custom_seed="";stage.name="";a.BATTLE=[];PERSONAL_BEST=!1;window.history.pushState("","","/");renderer.clear();vehicle.reset();vehicle.disconnect();for(var b=0;b<ghost.length;b++)ghost[b].disconnect();ghost=[];stage.SNOW&&scene.remove(stage.snow.mesh);stage.reset();PLAY=MENU=!1;vhs.PLAY=
!1;a.load();FIREBASE&&firebase.analytics().logEvent("next_stage")};this.dnf=function(){a.STATE=function(){a.dnf()};ui.backdrop(!1);ui.clear();a.nav(a.dnf);FIREBASE&&firebase.analytics().logEvent("dnf");ui.print("dnf","0.5-3+3p","0.5-8",2);ui.button("restart stage?","2","0.5+8","1.0-4","1.0-4",function(){a.reset("dnf")},!1)};this.reset=function(b){b=void 0===b?"reset":b;ghost.index=0;ui.clear();a.nav(a.play);PLAY=!0;MENU=!1;vehicle.reset();for(var k=0;k<ghost.length;k++)ghost[k].reset();FIREBASE&&
firebase.analytics().logEvent("stage_restart",{status:b})};this.hide=function(b){};this.update=function(){MENU||!PLAY||DNF||(ui["delete"](16,16,f-64,16),ui["delete"](16,g-32,64,16),ui.text(ui["float"](vehicle.AT()),16,16),ui.text(vehicle.SPEED.toString(),16,g-32))};this.loading=function(){d=0!=h%16?d:3<=d.length?"":d+".";MENU||(ui["delete"](16,16,160,8),ui.style=2,ui.text("stage generating"+d,16,16),ui.style=0);h++};this.target=function(){ui.clear();a.STATE=function(){a.target()};a.nav(a.target);
var b=stage.name;if(LOADING||(ui.style=2,ui.print("stage generated.","2","2"),ui.style=0,ui.button("ready","2","1.0-10","1.0-4","8",function(){stage.SNOW&&scene.add(stage.snow.mesh);for(var m=0;m<a.BATTLE.length;m++)vhs["import"](stage.name+"/"+a.BATTLE[m].uid,function(B){ghost.push(new Ghost(B.tape,B.model,B.paint,B.cp))});a.STATE=function(){};stage.generate.END=!1;ui.clear();a.play();PLAY=!0;vehicle.connect(stage.start,stage.surface,!1);FIREBASE&&firebase.analytics().logEvent("stage_start")}),ui.style=
4,MOBILE||!UAS_ENABLED||vhs.SCAN||(ui.style=1,ui.button("spectate!","1.0-14","1.0-18","12","3",function(){UAS_IS_TRACKING=!0;stage.SNOW&&scene.add(stage.snow.mesh);for(var m=ui.style=0;m<a.BATTLE.length;m++)vhs["import"](stage.name+"/"+a.BATTLE[m].uid,function(B){ghost.push(new Ghost(B.tape,B.model,B.paint,B.cp));uas.AUTOPILOT=!0;a.uas()});stage.generate.END=!1;ui.clear();PLAY=!1;vhs.PLAY=!0;uas.connect();a.uas();scene.add(stage.generate.stars);FIREBASE&&firebase.analytics().logEvent("uas_start")},
!1))),ui.style=5,ui.print(b,"2","5-1p",2),(ui.style=0)===a.TIMELIST.length&&vhs.SCAN)ui.style=5,ui.print("scanning...","2","9");else if(0!==a.TIMELIST.length){ui.style=2;ui.print("best time:","2","9");ui.style=0;ui.print(ui["float"](a.TIMELIST[0].time),"2","12",2);ui.style=5;var k=(b=a.TIMELIST.length<GHOST_SOFT_LIMIT)?a.TIMELIST.length:GHOST_SOFT_LIMIT;b=b?0:a.TIMELIST.length-GHOST_SOFT_LIMIT;for(var q=0;q<k;q++)ui.print(q+1+". "+a.TIMELIST[q].name,"2","16+"+2*q),ui.print(ui["float"](a.TIMELIST[q].time),
"18","16+"+2*q);0<b&&ui.print("+ "+b+" more entries","2",2*k+"+17")}else ui.style=2,ui.print("no entries found.","2","9"),ui.style=0};this.uasComputer=function(){ui.clear();ui.style=0;var b;ui.print("autopilot "+(uas.AUTOPILOT?"enabled":"disabled"),"2","2");uas.AUTOPILOT?(b=state.TIMELIST[uas.data().target].name,ui.print("targeting: "+b,"2","4")):(b=0<ghost.length?state.TIMELIST[uas.data().target].name:"disabled",ui.print("targeting: "+b,"2","4"),ui.style=2,b=uas.CTRL||control.SHIFT?"roll":"yaw",
ui.print("ctrl: "+b,"2","1.0-4"),ui.button("","0","1.0-4+4p","14","4",function(){a.uas(!0);uas.tutorial=!0},!1),ui.style=0)};this.uas=function(b){var k=this;b=void 0===b?!1:b;if(ui.clear(),ui.style=0,a.STATE=function(){a.uas()},a.nav(function(){k.uas()}),b)ui.backdrop(),ui.sprite(16,64,8,8,"1.0-4+2p","2",8,8),ui.button("","2","2","1.0","4",function(){ui.backdrop(!1);a.uas(!1);uas.tutorial=!1},!1),ui.style=0,ui.print("spectator controls","2","2"),ui.style=2,ui.print("esc              autopilot toggle",
"2","6"),ui.style=0,ui.print("autopilot controls","2","10"),ui.style=2,ui.print("arrow            pitch/yaw","2","14"),ui.print("shift + arrow    change target","2","16"),ui.print("+ -              adjust distance","2","18"),ui.style=0,ui.print("manual controls","2","22"),ui.style=2,ui.print("arrow            pitch/yaw/roll","2","26"),ui.print("shift + arrow    roll/yaw modifier","2","28"),ui.print("space            power +","2","30"),ui.print("shift + space    power -","2","32"),ui.print("ctrl:            roll/yaw toggle",
"2","34"),ui.print("r                reset","2","36"),ui.print("t                targeting mode toggle","2","38"),ui.print("shift + arrow    change target (targeting mode)","2","40"),ui.style=0;else if(UAS_IS_TRACKING){b="";for(var q=0;q<stage.name.length;q++)c=" "===stage.name.charAt(q)?"-":stage.name.charAt(q),b+=c;ui.style=0;ui.print("specialstage.io/#/"+b,"2","2");ui.style=2;b=new window.Date;ui.print(b.getDate().toString()+" "+(b.getMonth()+1).toString()+" "+b.getFullYear().toString(),"1.0-10",
"1.0-4");(ui.style=0)<ghost.length?(ui.print(a.TIMELIST[uas.data().target].name,"2","1.0-6"),ui.style=2,ui.print("stage rank "+(uas.data().target+1).toString(),"2","1.0-4"),ui.style=0):(uas.TARGET,ui.style=2,ui.print("no data".toString(),"2","1.0-4"))}else ui.style=2,b=uas.CTRL||control.SHIFT?"roll":"yaw",ui.print("ctrl: "+b,"2","1.0-4"),ui.button("","0","1.0-4+4p","14","4",function(){a.uas(!0);uas.tutorial=!0},!1),ui.style=0};this.timelist=function(){ui.style=0};this.save=function(){var b=NAME+"#"+
vehicle.MODEL+"#"+vehicle.PAINT+"#"+vehicle.param().power+vehicle.param().drag+ +vehicle.param().sensitivity+"#"+Date.now();b!==t&&(t=b,a.cSave("SAVE",t))};this.vehicle=function(b){a.STATE=function(){a.vehicle(b)};MENU=!0;ui.clear();a.title(function(){b();a.save()},function(){a.menu();sv()});var k=[],q=vehicle.param();k.push({id:"power",value:q.power,funct:function(U){vehicle.tune.power(U)}});k.push({id:"drag",value:q.drag,funct:function(U){vehicle.tune.drag(U)}});k.push({id:"sensitivity",value:q.sensitivity,
funct:function(U){vehicle.tune.sensitivity(U)}});ui.sprite(0,0,1,1,"2","8+-5+3","1.0-2-2",1);ui.print("model","2","8+");ui.print(vehicle.models()[vehicle.MODEL].name,"2+8","8+");ui.sprite(0,0,1,1,"2","8++3","1.0-2-2",1);ui.button(">","1.0-6","8++4p","4","4",function(){vehicle.MODEL+=1;1<vehicle.MODEL&&(vehicle.MODEL=0);vehicle.body();a.vehicle(b)},!1);ui.button("<","1.0-12","8++4p","4","4",function(){--vehicle.MODEL;0>vehicle.MODEL&&(vehicle.MODEL=1);vehicle.body();a.vehicle(b)},!1);ui.sprite(0,0,
1,1,"2","8+5+-5+3","1.0-2-2",1);ui.print("paint","2","8+5+");ui.print(PAINT_NAME[vehicle.PAINT],"10","8+5+");ui.sprite(0,0,1,1,"2","8+5++3","1.0-2-2",1);ui.button(">","1.0-6","8+5++4p","4","4",function(){vehicle.PAINT+=1;vehicle.PAINT>PAINT.length-1&&(vehicle.PAINT=0);vehicle.paint();a.vehicle(b)},!1);ui.button("<","1.0-12","8+5++4p","4","4",function(){--vehicle.PAINT;0>vehicle.PAINT&&(vehicle.PAINT=PAINT.length-1);vehicle.paint();a.vehicle(b)},!1);for(q={$jscomp$loop$prop$t$106$162:0};q.$jscomp$loop$prop$t$106$162<
k.length;q={$jscomp$loop$prop$t$106$162:q.$jscomp$loop$prop$t$106$162},q.$jscomp$loop$prop$t$106$162++){var m="8+5+5+"+(5*q.$jscomp$loop$prop$t$106$162).toString();ui.print(k[q.$jscomp$loop$prop$t$106$162].id,"2",m);ui.sprite(0,0,1,1,"2",m+"+3","1.0-2-2",1);for(var B={$jscomp$loop$prop$e$107$164:0};6>B.$jscomp$loop$prop$e$107$164;B={$jscomp$loop$prop$e$107$164:B.$jscomp$loop$prop$e$107$164},B.$jscomp$loop$prop$e$107$164++){var G="1.0-18+"+(3*B.$jscomp$loop$prop$e$107$164).toString(),J=B.$jscomp$loop$prop$e$107$164<=
k[q.$jscomp$loop$prop$t$106$162].value?48:40;ui.button("",G+"-10p",m+"+4p","3","4",function(U,T){return function(){k[U.$jscomp$loop$prop$t$106$162].funct(T.$jscomp$loop$prop$e$107$164);a.vehicle(b)}}(q,B),!1);ui.sprite(J,64,8,8,G,m,8,8)}}};this.settings=function(b){a.STATE=function(){a.settings(b)};a.SETTINGS=!0;x=GHOST_LIMIT+"#"+GHOST_PRIORITY+"#"+(HITBOX?1:0)+"#"+(UAS_ENABLED?1:0)+"#";a.cSave("SETTINGS",x);ui.clear();w||ui.backdrop();a.title(b,a.menu);ui.sprite(0,0,1,1,"2","6","1.0-4",1);ui.print("ghost config",
"2","8");ui.print("[edit]","1.0-2-6","8");ui.button("","2","8+4p","1.0-4","5",function(){a.ghostConfig(b)},!1);ui.sprite(0,0,1,1,"2","11","1.0-4",1);MOBILE?(k=HITBOX?"enabled":"disabled",ui.print("display touch hitboxes","2","13"),ui.print(k,"1.0-2-"+k.length,"13"),ui.sprite(0,0,1,1,"2","21","1.0-4",1),ui.button("","2","13+4p","1.0-4","5",function(){HITBOX=!HITBOX;a.settings(b)},!1)):(ui.print("keybindings","2","13"),ui.print("arrow / wasdr","1.0-15","13"),ui.sprite(0,0,1,1,"2","21","1.0-4",1));ui.sprite(0,
0,1,1,"2","16","1.0-4",1);ui.print("pixel scale","2","18");ui.print(""+PIXEL_SCALE,"1.0-18","18");ui.button("+","1.0-6","18+4p","4","4",function(){2>PIXEL_SCALE&&(PIXEL_SCALE+=.5);ui.style=0;a.settings(b);resize()},!1);ui.button("-","1.0-12","18+4p","4","4",function(){1<PIXEL_SCALE&&(PIXEL_SCALE-=.5);ui.style=0;a.settings(b);resize()},!1);ui.sprite(0,0,1,1,"2","26","1.0-4",1);ui.print("camera mode","2","23");var k=vehicle.FPV?"fpv":"tpv";ui.print(k,"1.0-6","23");ui.button("","2","23+4p","1.0-4","5",
function(){vehicle.FPV=!vehicle.FPV;a.settings(b)},!1);ui.print("www.procedural.ca","2","1.0-10");ui.print("www.ginko.ltd","2","1.0-8");a.discord();ui.style=0};this.ghostConfig=function(b,k){a.STATE=function(){a.ghostConfig(b)};var q=UAS_ENABLED?1:0;x=GHOST_LIMIT+"#"+GHOST_PRIORITY+"#"+(HITBOX?1:0)+"#"+q;a.cSave("SETTINGS",x);ui.clear();w||ui.backdrop();a.title(b,function(){a.settings(b)});ui.sprite(0,0,1,1,"2","6","1.0-4",1);ui.print("ghost name","2","8");ui.print(NAME,"1.0-13-"+NAME.length,"8");
ui.print("[edit]","1.0-8","8");ui.button("","2","9+4p","1.0-4","4",function(){a.inputName(function(){a.ghostConfig(b)},!1)},!1);ui.sprite(0,0,1,1,"2","11","1.0-4",1);ui.print("ghost limit","2","13");q=GHOST_LIMIT.toString();ui.print(q,"1.0-13-"+q.length,"13");ui.button(">","1.0-6","13+4p","4","4",function(){20>GHOST_LIMIT&&(GHOST_LIMIT+=1);a.ghostConfig(b)},!1);ui.button("<","1.0-12","13+4p","4","4",function(){0<GHOST_LIMIT&&--GHOST_LIMIT;a.ghostConfig(b)},!1);ui.sprite(0,0,1,1,"2","16","1.0-4",1);
ui.print("ghost priority","2","18");q=0===GHOST_PRIORITY?"best":"random";ui.print(q,"1.0-13-"+q.length,"18");ui.button(">","1.0-6","18+4p","4","4",function(){GHOST_PRIORITY+=1;1<GHOST_PRIORITY&&(GHOST_PRIORITY=0);a.STATE()},!1);ui.button("<","1.0-12","18+4p","4","4",function(){--GHOST_PRIORITY;0>GHOST_PRIORITY&&(GHOST_PRIORITY=1);a.STATE()},!1);ui.sprite(0,0,1,1,"2","21","1.0-4",1);ui.print("ghost particles","2","23");q=GHOST_EMITTER?"enabled":"disabled";ui.print(q,"1.0-2-"+q.length,"23");ui.button("",
"2","23+4p","1.0-4","4",function(){GHOST_EMITTER=!GHOST_EMITTER;for(var m=0;m<ghost.length;m++)ghost[m].toggleEmitter(GHOST_EMITTER);a.ghostConfig(b)},!1);ui.sprite(0,0,1,1,"2","26","1.0-4",1)};this.controls=function(b){ui.clear();a.title(b,a.menu)};this.fullscreen=function(){document.fullscreenElement?document.exitFullscreen&&document.exitFullscreen():document.documentElement.requestFullscreen()};this.prompt=function(){ui.clear();ui.print("specialstage.io","4","4",2);ui.print("-","4","8",2)};this.challenge=
function(b){ui.clear();a.nav(function(){a.challenge()},a.menu);ui.print("issue challenge url","2","2");ui.print("-","2","4");ui.style=2;ui.print("issued by","2","6");ui.style=0;ui.print("> "+NAME,"2","9");ui.style=2;ui.print("[edit]",NAME.length+"+9","9");ui.button("","2","9+4p",NAME.length+"+5","4",function(){a.inputName(a.challenge,!1)},!1);ui.style=2;ui.print("seed","2","13");ui.style=5;ui.print(stage.name,"2","15");ui.style=2;ui.print("time","2","19");b=ui["float"](vehicle.CP()[3]+vehicle.PENALTY());
ui.style=5;ui.print(b,"2","21");ui.style=0;ui.button("copy challenge url","1","1.0-8","1.0-2","8",function(){ui.clear();a.encodeURL();window.setTimeout(a.results,2E3)})};this.appearance=function(){ui.clear();a.breadcrumb(this.vehicle,this.state);a.nav(function(){a.appearance()},a.menu)};this.inputName=function(b,k,q){k=void 0===k?!1:k;q=void 0===q?"enter display name:":q;a.STATE=function(){a.inputName(b,k,q)};ui.clear();MENU=!0;k?a.nav(function(){b()},a.menu):a.title(b);ui.print(q,"2","2");ui.textinput(NAME,
"2","4","1.0-2","6","operator_id");var m=document.getElementById("operator_id");ui.button("accept","2","14","1.0-4","6",function(){ui.clear();ui.print("submitting name to db","2","2");NAME=profanity(m.value.toLowerCase());!1===UID&&1<NAME.length&&null!==NAME?firebase.auth().signInAnonymously().then(function(){UID=firebase.auth().currentUser.uid;a.submitName(UID,b,k);a.STATE=function(){}})["catch"](function(B){B.code;B.message}):!1!==UID&&1<NAME.length&&null!==NAME?a.submitName(UID,b,k):(ui.clear(),
ui.print("invalid name","2","2"),window.setTimeout(a.STATE,1E3))},!0)};this.submitName=function(b,k,q){q=void 0===q?!1:q;1<NAME.length&&10>NAME.length?firebase.database().ref("uid/"+b).set({name:NAME},function(m){m?(ui.clear(),m="PERMISSION_DENIED"===m.code?"invalid name":"network error",ui.print(m,"2","2"),window.setTimeout(function(){a.inputName(k,q)},1E3)):(ui.clear(),ui.print("name change successful","2","2"),window.setTimeout(k,1E3))}):(ui.clear(),ui.print("invalid name","2","2"),window.setTimeout(function(){a.inputName(k,
q)},1E3))};this.encodeURL=function(){for(var b="",k=stage.name,q=0;q<k.length;q++){var m=k.charAt(q);m=" "===m?"-":m;b+=m}b=b+"/"+UID;window.history.pushState("","","/");k=window.location.href;var B="./#/"+b;navigator.clipboard.writeText("https://specialstage.io/#/"+b).then(function(){ui.print("url copied to clipboard","2","2");window.history.pushState("","",B)},function(){window.history.pushState("","",B);ui.print("url copied to address bar","2","2")});FIREBASE&&firebase.analytics().logEvent("challenge_issued",
{url:k+"#/"+b})};this.decodeURL=function(){for(var b=window.location.href,k="",q=[],m=!1,B=0,G=0;G<b.length;G++){var J=b.charAt(G);m?"/"===J?(CHALLENGE=!0,B++):(1===B&&(J="-"===J?" ":J,k+=J),1<B&&(q+=J)):"#"===J&&(m=!0,CUSTOM_SEED=!0,B=0)}CHALLENGE&&0<q.length?(a.custom_seed=k,stage.name=k,a.CHALLENGES={seed:k,uid:q}):CUSTOM_SEED&&(a.custom_seed=k,stage.name=k,CHALLENGE=!1);FIREBASE&&CHALLENGE&&firebase.analytics().logEvent("challenge_accepted",{url:b})};this.cSave=function(b,k){var q=new Date;q.setTime(q.getTime()+
2808E7);q="expires="+q.toUTCString();document.cookie=b+"="+k+";"+q+";path=/"};this.cLoad=function(b){b+="=";for(var k=document.cookie.split(";"),q=0;q<k.length;q++){for(var m=k[q];" "==m.charAt(0);)m=m.substring(1);if(0==m.indexOf(b))return m.substring(b.length,m.length)}return""};this.checksave=function(){var b=a.cLoad("SAVE");if(0!==b.length&&null!=b){for(var k=0,q="",m="",B="",G="",J=0,U=0;U<b.length;U++){var T=b.charAt(U);if("#"!==T)switch(J){case 1:k=parseInt(T);break;case 2:q+=T;break;case 3:m+=
b.charAt(U),B+=b.charAt(U+1),G+=b.charAt(U+2),U+=2}else J++}vehicle.MODEL=parseInt(k);vehicle.PAINT=parseInt(q);vehicle.paint();vehicle.tune.power(parseInt(m));vehicle.tune.drag(parseInt(B));vehicle.tune.sensitivity(parseInt(G))}else vehicle.PAINT=0,vehicle.paint();if(b=a.cLoad("SETTINGS"),0!==b.length&&null!=b){k=0;B=m=q="";for(G=0;G<b.length;G++)if(J=b.charAt(G),"#"!==J)switch(k){case 0:q+=J;break;case 1:GHOST_PRIORITY=parseInt(J);break;case 2:m=parseInt(J);break;case 3:B=parseInt(J)}else k++;GHOST_LIMIT=
parseInt(q);HITBOX=0!==m;1===B&&(UAS_ENABLED=!0)}};this.credit=function(){ui.clear();ui.print("procedural.ca","2","1.0-6");ui.print("ginko.ltd","2","1.0-4")};this.promo=function(){ui.clear();ui.print("0.0.5.3","2","2");ui.sprite(0,88,47,8,"2","6-4p",188,32,4);ui.sprite(49,88,40,8,"2","12-4p",160,32,4);ui.sprite(1,0,255,16,"2","1.0-6",255,16);ui.print("www.specialstage.io  ","2","1.0-8")};this.fpv=function(){ui.clear();ui.print("https://specialstage.io - 0.0.4","2","2");ui.print("new feature","4",
"0.5");ui.print("first person view (fpv)","4","0.5 + 4",2);window.setTimeout(function(){ui.clear();ui.print("https://specialstage.io - 0.0.4","2","2")},4E3)};this.biome=function(){ui.clear();ui.print("https://specialstage.io - 0.0.4","2","2");ui.print("new feature","4","0.5");ui.print("ice biome","4","0.5 + 4",2);window.setTimeout(function(){ui.clear();ui.print("https://specialstage.io - 0.0.4","2","2")},4E3)};this.physics=function(){ui.clear();ui.print("https://specialstage.io - 0.0.4","2","2");
ui.print("update","4","0.5");ui.print("improved vehicle physics","4","0.5 + 4",2);window.setTimeout(function(){ui.clear();ui.print("https://specialstage.io - 0.0.4","2","2")},4E3)};this.endtag=function(){ui.clear();ui.print("play at","2","0.25-4");ui.print("https://specialstage.io","2","0.25",1);ui.print("challenges posted on discord","4","0.25+ 6");ui.print("> discord.ginko.ltd","4","0.25 + 10");ui.print("> discord.specialstage.io","4","0.25 + 12");window.setTimeout(a.music,2E3)};this.music=function(b){window.setTimeout(function(){ui.print("procedural.ca",
"2","1.0-12")},500);window.setTimeout(function(){ui.print("ginko.ltd","2","1.0-10")},1E3);window.setTimeout(function(){},3E3)};this.updates=function(){ui.clear();ui.print("https://specialstage.io - 0.0.4","2","2");ui.print("updates","2","6");ui.print("> added ice biome","2","10");ui.print("> added fpv camera","2","12");ui.print("> added snow particle effects","2","14");ui.print("> added terrain drag penalty","2","16");ui.print("> improved vehicle physics","2","18");ui.print("> increased gravity",
"2","20");ui.print("> decreased air resistance","2","22");ui.print("> disabled DNF timeout during button input for big jumps","2","24");ui.print("> removed framerate dependecies","2","26");ui.print("> reworked ui pixel scaling","2","28");window.setTimeout(function(){ui.clear()},1E4)};this.plug=function(b){if("n"===b.key)switch(z){case 0:ui.clear();window.setTimeout(a.promo,1E3);z++;break;case 1:window.setTimeout(a.biome,1E3);z++;vehicle.CAMERA=4;break;case 2:window.setTimeout(a.physics,1E3);z++;vehicle.CAMERA=
2;break;case 3:window.setTimeout(a.fpv,1E3);z++;vehicle.CAMERA=3;break;case 4:window.setTimeout(a.endtag,1E3);z++;vehicle.CAMERA=1;break;case 5:ui.clear(),z=0}}}
var TIME={dt:1,start:window.performance.now(),time:0,last:0,timestep:0,reset:function(){TIME.start=window.performance.now();TIME.time=0;TIME.last=0;TIME.timestep=16.6667;TIME.dt=1}},DT=function(){return TIME.time=window.performance.now()-TIME.start,TIME.timestep=TIME.time-TIME.last,TIME.dt=TIME.timestep/(1E3/60),2<TIME.dt&&(TIME.dt=2),TIME.last=TIME.time,TIME.dt};
function UAS(){var a=this;this.tutorial=!0;this.CTRL=!1;this.AUTOPILOT=this.IS_FOLLOWING=this.IS_TRACKING=!0;this.RANDOMIZE=this.TARGET=this.TRACK=!1;this.RANDOM_TIMER=0;var f=function(){},g=!1,d=new THREE.Vector3,h=0,z=new THREE.Vector3(0,0,1);this.cameras=[];this.cameras[0]={distance:40,yaw:1.8,pitch:.698,position:new THREE.Vector3(0,1,0),lerp:.1,lookAt:new THREE.Vector3};this.cameras[1]={distance:1,yaw:0,pitch:Math.PI/5,position:new THREE.Vector3(20,1,20),lerp:.1,lookAt:new THREE.Vector3};this.cameras[2]=
{distance:1,yaw:0,pitch:Math.PI/5,position:new THREE.Vector3(0,-20,10),lerp:.1,lookAt:new THREE.Vector3};this.cameras[4]={distance:1,yaw:0,pitch:Math.PI/5,position:new THREE.Vector3(0,-20,10),lerp:.1,lookAt:new THREE.Vector3};this.lookAt=new THREE.Vector3(0,0,0);this.altitude=this.rotation=0;this.start=new THREE.Vector3;this.loc=new THREE.Vector3(0,0,0);this.vel=new THREE.Vector3(0,0,0);this.acc=new THREE.Vector3(0,0,0);this.last=new THREE.Vector3(this.loc.x,this.loc.y,this.loc.z);this.lift=0;this.power=
.003;this.force=.02;this.vel_grip=.9;this.ang_grip=.96;this.yaw_vel=this.roll_vel=this.pitch_vel=0;this.pitch_grip=.95;this.roll_grip=.96;this.yaw_grip=.98;this.pitch=new THREE.Vector3(1,0,0);this.roll=new THREE.Vector3(0,1,0);this.yaw=new THREE.Vector3(0,0,1);this.pitch_acc=9E-4;this.roll_acc=.0015;this.yaw_acc=9E-4;this.raycaster=new THREE.Raycaster;var t=new THREE.Vector3;this.reset=function(){this.AUTOPILOT||(this.lookAt.set(0,0,0),this.loc.copy(a.start),this.vel.set(0,0,0),this.acc.set(0,0,0),
this.last.set(this.loc.x,this.loc.y,this.loc.z),this.pitch=new THREE.Vector3(1,0,0),this.roll=new THREE.Vector3(0,1,0),this.yaw=new THREE.Vector3(0,0,1),this.pitch_vel=0,this.roll_vel=0,this.yaw_vel=0,this.force=.02,camera.up.set(this.yaw))};this.connect=function(){h=0;a.start.copy(stage.start);a.start.z+=10;a.start.y-=20;a.loc.copy(a.start);UAS_IS_ACTIVE=!0;camera.up.set(0,0,1);PLAY=!1;vhs.PLAY=!0;TIME.reset()};this.randomize=function(x){x=void 0===x?[]:x;h=Math.floor(Math.random()*x.length);state.uas()};
this.disconnect=function(){a.reset();h=0;UAS_IS_ACTIVE=!1};this.update=function(){0===ghost.length&&(a.AUTOPILOT=!1);control.ESC&&(a.AUTOPILOT=!a.AUTOPILOT,a.AUTOPILOT?(this.setOrbitPosition(ghost,!0),t.copy(camera.up),camera.up.set(0,0,1)):camera.up.copy(t),control.ESC=!1);this.AUTOPILOT?(this.track(ghost),this.target(ghost)):this.flight(ghost);control.HIDE&&(g=!g,g?(f=function(){state.STATE()},state.hide(state.STATE)):f())};this.passenger=function(x){x=void 0===x?[]:x;camera.lookAt[0];camera.position.lerp(x[0].position);
camera.position.add(a.cameras[c].position)};this.target=function(x){x=void 0===x?[]:x;0<x.length&&camera.lookAt(x[h].position)};this.track=function(x){x=void 0===x?[]:x;0<x.length&&(control.LEFT&&control.SHIFT&&(h=0<h?h-1:x.length-1,state.uas(),control.LEFT=!1),control.RIGHT&&control.SHIFT&&(h=h<x.length-1?h+1:0,state.uas(),control.RIGHT=!1),a.setOrbitPosition(x,!1))};this.setOrbitPosition=function(x,w){w=void 0===w?!1:w;var b=control.UP?.1:control.DOWN?-.1:0,k=control.ZOOM_IN?-1:control.ZOOM_OUT?
1:0;a.cameras[0].yaw+=control.RIGHT?.1:control.LEFT?-.1:0;a.cameras[0].pitch+=b;a.cameras[0].distance+=k;b=a.cameras[0].position.clone();b.multiplyScalar(a.cameras[0].distance);b.multiplyScalar(1/PIXEL_SCALE);b.applyAxisAngle(camera.up,a.cameras[0].yaw);k=new THREE.Vector3(1,0,0);k.applyAxisAngle(camera.up,a.cameras[0].yaw);b.applyAxisAngle(k,a.cameras[0].pitch);d.copy(b);d.add(x[h].position);w?camera.position.copy(d):camera.position.lerp(d,.1);camera.position.add(x[h].velocity)};this.flight=function(x){x=
void 0===x?[]:x;control.RESET&&a.reset();control.CTRL&&!this.TARGET&&(a.CTRL=!a.CTRL,control.CTRL=!1,state.uas(!1));control.SPACE&&state.uas(!1);var w=control.UP,b=control.DOWN,k=control.LEFT,q=control.RIGHT,m=control.SPACE,B=!a.TARGET&&control.SHIFT;this.last.set(this.loc.x,this.loc.y,this.loc.z);var G=a.CTRL?a.roll_vel:a.yaw_vel,J=a.CTRL?a.yaw_vel:a.roll_vel,U=a.CTRL?-a.roll_acc:a.yaw_acc,T=a.CTRL?-a.yaw_acc:a.roll_acc;w&&!B?this.pitch_vel-=this.pitch_acc:w&&(this.pitch_vel-=1.5*this.pitch_acc);
b&&!B?this.pitch_vel+=this.pitch_acc:b&&(this.pitch_vel+=1.5*this.pitch_acc);k&&!B?G+=U:k&&(J-=T);q&&!B?G-=U:q&&(J+=T);m&&!control.SHIFT?this.force+=.005:m&&control.SHIFT&&(this.force-=.005,0>this.force&&(this.force=0));a.yaw_vel=a.CTRL?J:G;a.roll_vel=a.CTRL?G:J;this.pitch_vel*=this.pitch_grip;this.roll_vel*=this.roll_grip;this.yaw_vel*=this.yaw_grip;this.pitch.applyAxisAngle(this.roll,this.roll_vel);this.pitch.applyAxisAngle(this.yaw,this.yaw_vel);this.roll.applyAxisAngle(this.pitch,this.pitch_vel);
this.roll.applyAxisAngle(this.yaw,this.yaw_vel);this.yaw.applyAxisAngle(this.pitch,this.pitch_vel);this.yaw.applyAxisAngle(this.roll,this.roll_vel);this.vel.set(this.roll.x*this.force,this.roll.y*this.force,this.roll.z*this.force);this.vel.z+=this.lift;.001>Math.abs(this.lift.z)&&(this.lift.z=0);this.loc.add(this.vel);camera.position.set(this.loc.x,this.loc.y,this.loc.z);camera.up.set(this.yaw.x,this.yaw.y,this.yaw.z);control.TARGET&&0<x.length&&(this.TARGET=!this.TARGET,control.TARGET=!1,this.TARGET?
(t.copy(camera.up),camera.up.set(0,0,1)):camera.up.copy(t));this.TARGET?(this.lookAt.lerp(x[h].position,.1),camera.up.set(0,0,1),control.SHIFT&&this.TARGET&&(0!=(m=control.LEFT?-1:control.RIGHT?1:0)&&(control.LEFT=!1,control.RIGHT=!1),h+=m,h=h>x.length-1?0:0>h?x.length-1:h,state.uas())):(x=this.roll.clone(),z.lerp(x,.1),this.lookAt.copy(x),this.lookAt.add(this.loc));camera.lookAt(this.lookAt);1200<camera.position.clone().length()&&(a.reset(),state.next())};this.data=function(){return{target:h}}}
function UI(){var a=this;this.renderer=document.createElement("canvas");this.renderer.id="ui";document.body.appendChild(this.renderer);var f=this.renderer.getContext("2d");this.context=f;var g=document.createElement("img");g.src="./img/stage.font.0.0.5.png";g.onload=function(){a.connect();a.onload()};document.createElement("canvas");this.onload=function(){};var d=document.createElement("canvas"),h=d.getContext("2d");this.scale=1;this.row=this.col=8;this.width;this.height;this.style=0;var z=128,t=
180,x=128,w=80,b;var k=128;var q=t;var m=128;var B=80;var G=!(b={x:128,y:t+60,w:128,h:40}),J=[],U=[],T=[];this.connect=function(){f.imageSmoothingEnabled=!1;a.format(0,"#ffffff")};this.format=function(r,C){r=void 0===r?0:r;C=void 0===C?"#ffffff":C;void 0===d[r]&&(d[r]=document.createElement("canvas"),h[r]=d[r].getContext("2d"));h[r].drawImage(g,0,0,128,128,0,0,128,128);h[r].globalCompositeOperation="source-atop";h[r].fillStyle=C;h[r].fillRect(0,0,128,128);h[r].globalCompositeOperation="source-out"};
this.resize=function(r,C,A,E){E=void 0===E?1:E;a.scale=A*E;var M=window.devicePixelRatio,Y=300>Math.ceil(M)/M*r?Math.floor(M):Math.ceil(M);0!=Y-M&&(A=Y/M*E);1>=M&&1<a.scale&&(A=a.scale);this.width=r/A;this.height=C/A;this.renderer.width=this.width;this.renderer.height=this.height;renderer.setSize(this.width,this.height);a.scale=A;this.renderer.style.transform="scale("+A+","+A+")";renderer.domElement.style.transform="scale("+A+","+A+")";this.renderer.style.transformOrigin="top left";renderer.domElement.style.transformOrigin=
"top left";f.imageSmoothingEnabled=!1;this.redraw();z=128;t=180;x=128;w=80;k=128;q=t;m=128;B=80;b={x:128,y:t+60,w:128,h:40};this.automate(this.width,this.height)};this.update=function(r){var C=0,A;for(A in r)for(var E in T)if(r[A].x>T[E].x*a.scale&&r[A].y>T[E].y*a.scale&&r[A].x<T[E].w*a.scale&&r[A].y<T[E].h*a.scale&&(C++,1==r[A].start)){T[E].funct();r[A].start=!1;break}};this.print=function(r,C,A,E){E=void 0===E?1:E;for(var M=0,Y=a.compile(C,a.width,a.col),Q=a.compile(A,a.height,a.row),N=a.style;M<
r.length;)a.encode(r.charAt(M),Y+M*a.col*E,Q,E),M++;G||J.push(function(){a.style=N;a.print(r,C,A,E)})};this.text=function(r,C,A,E,M){E=void 0===E?1:E;for(M=0;M<r.length;)a.encode(r.charAt(M),C+M*a.col*E,A,E),M++};this.button=function(r,C,A,E,M,Y,Q,N){Q=void 0===Q?!0:Q;N=void 0===N?1:N;var S=a.compile(C,a.width,a.col),X=a.compile(A,a.height,a.row),aa=a.compile(E,a.width,a.col),ca=a.compile(M,a.height,a.row),da=a.style;Q&&(f.drawImage(d[a.style],0,0,1,1,S,X+ca/2,aa+1,1),f.drawImage(d[a.style],0,0,1,
1,S,X-ca/2,aa+1,1),f.drawImage(d[a.style],0,0,1,1,S,X-ca/2,1,ca),f.drawImage(d[a.style],0,0,1,1,S+aa-1,X-ca/2,1,ca+1));for(var Z=0;Z<r.length;)a.encode(r.charAt(Z),S+Z*a.col+aa/2-Math.round(r.length*a.col)/2+2,X-a.row/2,N),Z++;T.push({x:S,y:X-ca/2,w:S+aa,h:X+ca/2,funct:function(){Y()}});G||J.push(function(){a.style=da;a.button(r,C,A,E,M,Y,Q,N)})};this.line=function(r,C,A,E){a.sprite(0,0,1,1,r,C,A,E)};this.sprite=function(r,C,A,E,M,Y,Q,N){var S=a.compile(M,a.width,a.col),X=a.compile(Y,a.height,a.row),
aa=a.compile(Q,a.width,a.col),ca=a.compile(N,a.height,a.row),da=a.style;f.drawImage(d[a.style],r,C,A,E,S,X,aa,ca);G||J.push(function(){a.style=da;a.sprite(r,C,A,E,M,Y,Q,N)})};this.backdrop=function(r,C,A,E,M){r=void 0===r?"#10101099":r;!1===r?(a.clear(),a.renderer.style.background="transparent"):(a.clear(),a.renderer.style.background=r)};this.getDrawList=function(){return J};this.redraw=function(){G=!0;a.clear();for(var r=0;r<J.length;r++)J[r]();r=document.body.getElementsByTagName("input");for(var C=
0;C<r.length;C++)a.text(r[C].value,r[C].style.top,r[C].style.left);G=!1};this.automate=function(r,C){r=Math.floor(r/3)-2;C=Math.floor(C/4);x>r&&(x=r,z=r,m=r,k=r,b.w=r,b.x=r);t>C&&(t=C+40,q=t,b.y=t+60)};this.pad=function(r,C,A,E,M,Y,Q){var N=0;for(Q();N<control.touches.length;)control.touches[N].x>C*a.scale&&control.touches[N].y>A*a.scale&&control.touches[N].x<(C+E)*a.scale&&control.touches[N].y<(A+M)*a.scale&&Y(),N++;HITBOX&&(f.drawImage(d[a.style],0,0,1,1,C+1,A,E-1,1),f.drawImage(d[a.style],0,0,
1,1,C+1,A+M,E-1,1),f.drawImage(d[a.style],0,0,1,1,C+1,A,1,M),f.drawImage(d[a.style],0,0,1,1,C+E-1,A,1,M));a.encode(r,C+E/2-a.col/2,A+M/2-a.row/2)};this.dpad=function(){f.drawImage(d[a.style],88,88,40,40,a.width-k+m/2-20,a.height-q+B/2-20,40,40);a.pad("<",z-x-1,a.height-t,x,w,function(){control.LEFT=!0},function(){control.LEFT=!1});a.pad(">",z+1,a.height-t,x,w,function(){control.RIGHT=!0},function(){control.RIGHT=!1});a.pad("^",a.width-k,a.height-q,m,B,function(){control.UP=!0},function(){control.UP=
!1});a.pad("b",a.width-b.x,a.height-b.y+b.h/2,b.w,b.h,function(){control.DOWN=!0},function(){control.DOWN=!1})};this.clear=function(){if(!G){for(var r=document.body.getElementsByTagName("input"),C=0;C<r.length;C++)document.body.removeChild(r[C]);if(!a.REDRAW){J=[];for(r=0;r<U.length;r++)document.body.removeChild(U[r]);U=[]}J=[]}T=[];f.clearRect(0,0,a.width,a.height)};this["delete"]=function(r,C,A,E){C=void 0===C?0:C;A=void 0===A?renderer.width:A;E=void 0===E?renderer.height:E;r=a.compile(void 0===
r?0:r,a.width,a.col);C=a.compile(C,a.height,a.row);A=a.compile(A,a.width,a.col);E=a.compile(E,a.height,a.row);f.clearRect(r,C,A,E)};this.encode=function(r,C,A,E){E=void 0===E?1:E;var M=r.charCodeAt(0);r=8*M%128;M=8*Math.floor(M/16);f.clearRect(C,A,8,8);f.drawImage(d[a.style],r,M,8,8,C,A,8*E,8*E)};this["float"]=function(r,C){var A=Math.floor(Math.abs(100*r));A=A.toString();var E=A.slice(0,A.length-2),M=A.slice(A.length-2,A.length);return 0==r?"0.00":(0==E.length&&(E="0"),2>M.length&&(M+="0"),C&&0<
r?E="+"+E:0>r&&(E="-"+E),A=E+"."+M,A)};this.compile=function(r,C,A){var E=0;switch(C=Math.floor(C),typeof r){case "number":E=r;break;case "function":E=r();break;case "string":for(var M=!1,Y=1,Q=0,N="";Q<r.length;){var S=r.charAt(Q);"."===S?(N+=S,M=!0):"+"===S?(N=M?Number(N)*C:Number(N)*A,N*=Y,Y=1,E+=N,M=!1,N=""):"-"===S?(N=M?Number(N)*C:Number(N)*A,N*=Y,Y=-1,E+=N,M=!1,N=""):"p"===S?(N=Number(N),N*=Y,E+=N,N=""):Q===r.length-1?(N+=S,N=M?Number(N)*C:Number(N)*A,N*=Y,E+=N,N=""):N+=S;Q++}}return E};this.textinput=
function(r,C,A,E,M,Y,Q){var N=a.compile(C,a.width,a.col),S=a.compile(A,a.height,a.row),X=a.compile(E,a.width,a.col),aa=a.compile(M,a.height,a.row),ca=a.style;if(G)a.text("> "+Q.value,N,S+aa/2);else{(Q=document.createElement("input")).type="text";Q.id=Y;Q.name=Y;Q.value=r;Q.style.position="fixed";Q.style.top=S+"px";Q.style.left=N+"px";Q.style.width=X+"px";Q.style.height=aa+"px";Q.style.paddingLeft="12px";Q.style.fontSize="14px";Q.style.zIndex=9999;Q.style.opacity=0;Q.maxlength=10;a.text("> "+Q.value,
N,S+aa/2);document.body.appendChild(Q);window.setTimeout(function(){Q.focus();Q.select()},200);Q.oninput=function(){da()};Q.onfocusout=function(){da()};Q.onfocusin=function(){da()};Q.onclick=function(){da()};var da=function(Z){a["delete"](N,S,X,aa);a.text("> "+Q.value,N,S+aa/2);a.text("_",Q.selectionStart*a.col+2*a.col+N,S+aa/2)};J.push(function(){a.style=ca;a.textinput(Q.value,C,A,E,M,Y,Q)})}};this.link=function(r,C,A,E,M,Y,Q,N){var S=a.compile(C,a.width,a.col)*a.scale,X=a.compile(A,a.height,a.row)*
a.scale,aa=a.compile(E,a.width,a.col)*a.scale,ca=a.compile(M,a.height,a.row)*a.scale,da=a.style;G||J.push(function(){return new function(){a.style=da;Z.style.left=S+"px";Z.style.top=X+"px";Z.style.width=aa+"px";Z.style.height=ca+"px";a.print(r,S,X)}});var Z=document.createElement("a");Z.href=Y;Z.style.left=S+"px";Z.style.top=X+"px";Z.style.width=aa+"px";Z.style.height=ca+"px";Z.style.display="block";Z.style.zIndex=400;Z.style.position="fixed";Z.target="_blank";Z.id=Y;document.body.appendChild(Z);
U.push(Z);G=!0;a.print(r,S,X);G=!1}}
function Vehicle(){var a=this;this.TEXTTIME=this.SPEED="";this.END=this.START=!1;this.OBJECTIVE=0;this.POSITION;this.MODEL=1;this.ANALOG=!1;this.PENALTY=function(){return r};this.CAMERA=1;this.FPV=!1;var f=[],g=0,d=1/60*1E3,h=1,z=new THREE.Mesh(new THREE.IcosahedronGeometry(4,0),new THREE.MeshBasicMaterial({wireframe:!0})),t=new THREE.Vector3,x=new THREE.Vector3,w=new THREE.Vector3,b=0,k=!1,q=!1,m=!0,B=!1,G=1,J=0,U=[],T=0,r=0,C=0,A=0,E=!1,M=!1,Y=!1,Q=0,N=0,S=0;this.DT=function(){return 1};var X={power:3,
drag:1,mass:1,brake:3,sensitivity:2,ease:0},aa=0,ca=0,da=0;aa=.004;ca=.985-.98;da=.015;var Z,ra,sa,n=6,l,p=0,D=0,y=0,u=new THREE.Vector3(0,1,0),O=new THREE.Vector3(0,0,0),F=new THREE.Vector3,I=new THREE.Vector3(0,5,0);new THREE.Vector3(1,0,0);var H=new THREE.Vector3(0,0,1),P=new THREE.Vector3(0,0,1),W=new THREE.Vector3(0,0,1),V=new THREE.Vector3(0,0,1),ka=new THREE.Vector3(0,0,-.008),ea=new THREE.Vector3,oa=new THREE.Vector3,xa=new THREE.Vector3,na=new THREE.Vector3,la=[],pa=new THREE.Vector3(0,0,
1),ta=new THREE.Raycaster(na,pa,0,2);this.cameras=[];this.cameras[0]={distance:22,x:0,y:0,z:9,lerp:.1,lookAt:new THREE.Vector3};this.cameras[1]={distance:0,x:20,y:20,z:10,lerp:.05,lookAt:new THREE.Vector3};this.cameras[2]={distance:0,x:-20,y:-20,z:20,lerp:.05,lookAt:new THREE.Vector3};this.cameras[3]={distance:0,x:-40,y:40,z:30,lerp:.075,lookAt:new THREE.Vector3};this.cameras[4]={distance:0,x:0,y:-20,z:60,lerp:.0075,lookAt:new THREE.Vector3};var ua=[{name:"logistics crate",geometry:function(){return MODEL.logistics_crate()}},
{name:"ag-86",geometry:function(){return MODEL.ag_86()}}];this.models=function(){return ua};this.PAINT=0;var wa=new THREE.MeshBasicMaterial({color:PAINT[a.PAINT]}),ba=(new THREE.LineSegments(ua[a.MODEL].geometry(),wa)).clone();ba.name="Vehicle";var va=new MODEL.emitter;this.init=function(){};this.connect=function(K,ia){ba.copy(new THREE.LineSegments(ua[a.MODEL].geometry(),wa));ba.name="Vehicle";ba.geometry.computeBoundingSphere();xa.copy(K);ea.copy(xa);ba.position.copy(xa);oa.copy(ea);scene.add(ba);
va.connect(PAINT[a.PAINT]);a.tune.power();a.tune.drag();a.tune.sensitivity();a.tune.ease();scene.fog=new THREE.FogExp2(palette[0],.005);camera.fov=90;camera.updateProjectionMatrix();scene.add(stage.generate.stars);B=!1;window.setTimeout(function(){B=!0},1E3);f=[];g=0;A=RAFID;f[0]={position:ea.clone(),normal:new THREE.Vector3(0,0,1),direction:new THREE.Vector3(0,1,0),camera:new THREE.Vector3,rotation:0,velocity:new THREE.Vector3,time:RAFID};TIME.reset()};this.disconnect=function(){a.reset();scene.remove(ba);
va.disconnect();scene.fog=new THREE.FogExp2(palette[0],0);scene.remove(stage.generate.stars)};this.ready=function(){k&&(TIME.reset(),A=window.performance.now(),J=0,a.START=!0)};this.reset=function(){if(a.END&&U[3]+r<stage.best[3])for(var K in stage.best)stage.best[K]=3===K?J+r:U[K];B=DNF=this.END=this.START=!1;control.UP=!1;control.DOWN=!1;control.LEFT=!1;R=L=q=k=control.RIGHT=!1;J=0;U=[];S=C=r=Q=0;ea.copy(xa);oa.copy(ea);u.set(0,1,0);F.set(0,0,0);V.set(0,0,1);ba.copy(new THREE.LineSegments(ua[a.MODEL].geometry(),
wa));ba.lookAt(V);p=D=0;camera.position.copy(ea);camera.position.add(u.clone().multiplyScalar(-60));camera.position.z+=40;camera.up.set(0,0,1);camera.lookAt(ba.position);camera.updateProjectionMatrix();renderer.render(scene,camera);vhs.reset();window.setTimeout(function(){B=!0},1E3);for(K=0;K<ghost.length;K++)ghost[K].reset();va.reset();TIME.reset();f=[];g=0;A=RAFID;f[0]={time:RAFID,position:ea.clone(),normal:V.clone(),direction:new THREE.Vector3(0,1,0),camera:camera.position.clone(),velocity:new THREE.Vector3,
rotation:0}};this.update=function(){R=DNF||a.END||!B?(k=!1,q=!1,L=!1):(k=control.UP,q=control.DOWN,L=control.LEFT,control.RIGHT);var K=0;if(RAFID>f[g].time){var ia={};Object.assign(ia,f[g]);var qa=ia.time;f=[];g=0;f.push({time:qa,position:ia.position.clone(),normal:ia.normal.clone(),direction:ia.direction.clone(),velocity:ia.velocity.clone(),rotation:ia.rotation,camera:ia.camera.clone()});for(var ma=window.performance.now();qa<ma;){qa+=d;f.push({time:qa,position:f[g].position.clone(),normal:f[g].normal.clone(),
direction:f[g].direction.clone(),velocity:f[g].velocity.clone(),camera:ia.camera.clone(),rotation:f[g].rotation});g=f.length-1;var za=ma=void 0;0!=(za=L&&R?0:L?1:R?-1:0)&&Math.abs(y)<n?y+=za:Math.abs(y)>n?(ma=y/Math.abs(y),y=n*ma):0<Math.abs(y)&&(ma=y/Math.abs(y),y-=y/Math.abs(y),y/Math.abs(y)!=ma&&(y=0));p=y/n*sa;f[g].rotation+=p;l=f[g].velocity.length();ma=void 0;k&&m&&(O.copy(f[g].direction),O.multiplyScalar(Z),f[g].velocity.add(O));q&&m&&f[g].velocity.multiplyScalar(.95);m?(Y=!1,ma=M?ra-.01:ra,
f[g].velocity.multiplyScalar(ma)):m||(Y?f[g].velocity.add(ka):Y=!0,f[g].velocity.multiplyScalar(.998));f[g].position.add(f[g].velocity);z.position.copy(f[g].position);na.copy(f[g].position);na.z-=50;la=[];pa.set(0,0,1);ta.far=100;ta.set(na,pa);stage.surface.raycast(ta,la);0<la.length?(na.copy(la[0].point),M=f[g].position.z<na.z&&5>Math.abs(f[g].position.z-na.z)?(T=0,m=!0,P.copy(la[0].face.normal),f[g].position.copy(na),1!==la[0].face.color.r):m=!1):0===la.length&&(m=!1,M=!1,k||q||L||R||(T+=d),1E3<
T&&!a.END&&!DNF&&(DNF=!0,state.dnf()));P.clone().multiplyScalar(1);W.lerp(P,Y?.001:.25);V.copy(W);V.add(f[g].position);f[g].normal=W.clone();z.lookAt(V);z.rotateOnAxis(H,f[g].rotation);u.copy(z.localToWorld(I.clone()));u.sub(f[g].position);u.normalize();f[g].direction.copy(u);(function(){la=[];pa.copy(f[g].position);pa.sub(f[g-1].position);pa.normalize();ta.far=pa.length();ta.set(f[g].position,pa);for(var ja=0,fa=!1,ya=S;5>ya;ya++)if(stage.generate.checkpoints[ya].collision.raycast(ta,la),0<la.length){ja=
ya;fa=!0;break}if(E=!1,fa){var ha;fa=Math.floor(100*J)/100;if(ja===S)stage.generate.checkpoints[S].display.material.color=palette[4],0<S&&(U[S-1]=fa,ui["delete"](16,32,ui.width-16,16),ha=Number.isNaN(stage.best[S-1])?"+1 cp":fa-stage.best[S-1],ui.style=0<ha?4:0>ha?1:2,ha=0<ha?"(-"+ui["float"](ha)+")":"+1 cp"===ha?"+1 cp":"(+"+ui["float"](Math.abs(ha))+")",ui.text(ha,16,32),ui.style=0),4===S&&(E=!0,U[ja-1]=fa,U[ja]=fa+r,Q=J+r<stage.best[3]?100-r+Math.floor(10*(stage.best[3]-(fa+r))):100-r,N+=Q,a.END=
!0,control.RESET=!1,state.complete()),E=!0,S++;else{E=!0;for(ha=S-1;ha<ja-1;ha++)0<=ha&&(U[ha]="-",C++);r=25*C;4===ja?(U[ja-1]=fa,U[ja]=fa+r,Q=J+r<stage.best[3]?100-r+Math.floor(10*(stage.best[3]-(J+r))):100-r,N+=Q,S=0,a.END=!0,control.RESET=!1,state.complete()):(U[ja-1]=fa,S=ja+1,ui["delete"]("2","4","30","1"),ui.style=2,ui.text("missed checkpoint x "+C.toString()+" ( -"+r.toString()+".00 )",16,32),ui.style=0);E=!0;stage.generate.checkpoints[ja].display.material.color=palette[4]}}a.SPEED=Math.round(60*
l/1E3*3600);a.START&&!a.END&&(J=(RAFID-A)/1E3);a.OBJECTIVE=S;oa.copy(ea)})();K++;a.START&&vhs.record(a);z.updateMatrix();ma=window.performance.now()}}if(h=(d-(f[g].time-RAFID))/d,1<h&&(h=1),1<f.length)t.copy(f[g-1].position),t.lerp(f[g].position,h),x.copy(f[g-1].normal),x.lerp(f[g].normal,h),x.multiplyScalar(5),K=x.clone(),K.add(t),b=f[g].rotation,b-=f[g-1].rotation,b=f[g-1].rotation+b*h,w.copy(f[g-1].direction),w.lerp(f[g].direction,h),w.multiplyScalar(5),w.normalize(),ba.position.copy(t),ba.lookAt(K),
ba.rotateOnAxis(H,b),function(){if(a.FPV)a.fpv();else{var ja=DNF||a.END?1E-5:.1,fa=w.clone();fa.multiplyScalar(-a.cameras[0].distance+4*(ui.scale-1));fa.add(t);fa.z+=a.cameras[0].z;camera.position.lerp(fa,ja);camera.lookAt(ba.position)}}(),va.update(k,t,w,l);this.START||this.ready()};this.results=function(){return{reward:Q,yen:N}};this.AT=function(){return J};this.CP=function(){return U.slice()};this.replay=function(K){DT();K={TS:TIME.time};vhs.frame=vhs.convert(vhs.tape,K,vhs.frame);t.copy(K.position);
W.copy(K.lookTarget);b=K.rotation;x.copy(W);x.add(t);ba.position.copy(t);ba.lookAt(x);ba.rotateOnAxis(H,b);w.copy(ba.localToWorld(I.clone()));w.sub(t);w.normalize();k=K.UP;E=K.CHECK;b=K.rotation;S=K.objective;K=t.clone();if(E&&(stage.generate.checkpoints[S].display.material.color=palette[4]),!UAS_IS_ACTIVE)if(3===a.CAMERA)a.fpv();else{var ia=1,qa=1;a.CAMERA===G&&(ia=a.cameras[1].lerp,qa=1);G=a.CAMERA;K.x+=a.cameras[a.CAMERA].x;K.y+=a.cameras[a.CAMERA].y;K.z+=a.cameras[a.CAMERA].z;camera.up.set(0,
0,1);camera.position.lerp(K,ia);a.cameras[G].lookAt.lerp(t,qa);camera.lookAt(a.cameras[G].lookAt)}va.update(k,t,w,l)};this.record=function(){return{position:f[g].position.clone(),lookTarget:f[g].normal.clone(),UP:k,AT:J,TS:vhs.tape.length*d,rotation:f[g].rotation,objective:S,check:E}};this.fpv=function(){camera.position.copy(t);var K=ba.localToWorld(new THREE.Vector3(0,0,5));K.sub(t);K.normalize();camera.up.copy(K);K=w.clone();K.add(t);camera.lookAt(K)};this.tune={power:function(K){K=void 0===K?X.power:
K;X.power=0>K?0:5<K?5:K;Z=.016+X.power/5*aa},drag:function(K){K=void 0===K?X.drag:K;X.drag=0>K?0:5<K?5:K;ra=.985-X.drag/5*ca},sensitivity:function(K){K=void 0===K?X.sensitivity:K;X.sensitivity=0>K?0:5<K?5:K;sa=.06+X.sensitivity/5*da},ease:function(K){K=void 0===K?X.ease:K;X.ease=0>K?0:5<K?5:K;n=6+X.ease}};this.param=function(){return array=Object.assign(X,[]),array.model=ua[a.MODEL].name,array};this.paint=function(K){K=void 0===K?a.PAINT:K;a.PAINT=K;va.paint(PAINT[K]);wa.color.set(PAINT[K]);wa.needsUpdate=
!0};this.body=function(){ba.geometry.dispose();ba.geometry=ua[a.MODEL].geometry().clone();ba.geometry.verticesNeedUpdate=!0};this.yen=function(){return state.cSave("YEN",N),N};this.debug=function(){console.log("position:",ba.position,ea);console.log("direction:",u);console.log("rotation:",D);console.log("dt:",1);console.log("TIME:",RAFID);console.log("TAPES:",Math.ceil(RAFID-A)/d);console.log("INTERPOLATION:",h);console.log("PHYSICS MESH:",z.rotation);console.log("TAPE VELOCITY",f[g].velocity);console.log(f);
console.log(T)}}
function VHS(a){var f=this;this.PLAY=!1;this.RECORD=!0;this.tape=[];this.timer=this.frame=0;this.AT=function(){return f.tape[g].timer};this.DT=DT();var g=0;this.keybuffer=[[],[]];this.SCAN=!1;this.capture=function(d){return{position:(new THREE.Vector3).copy(d.position),normal:(new THREE.Vector3).copy(d.normal),lookTarget:d.lookTarget.clone(),rotation:d.rotation,timer:d.getTime(),objective:d.getObjective(),check:d.check,UP:d.UP}};this.record=function(d){f.tape[g]=d.record();g=24E4<f.tape[g].TS?0:g+
1};this.play=function(d){if(this.RECORD){this.RECORD=!1;for(var h=f.frame=0;h<ghost.length;h++)ghost[h].reset();TIME.reset();TIMEOUT=0}if(f.frame>f.tape.length-10){f.frame=0;TIME.reset();for(h=0;h<ghost.length;h++)ghost[h].reset();stage.generate.resetCheckpoints()}if(d.replay(),this.tape[f.frame].check)stage.generate.checkpoints[0===this.tape[f.frame].objective?4:this.tape[f.frame].objective-1].display.material.color=palette[4]};this.reset=function(){stage.generate.resetCheckpoints();g=0;f.frame=
0;TIME.reset();f.PLAY=!1;f.RECORD=!0;f.tape=[]};this["export"]=function(d,h){d=void 0===d?function(){state.results()}:d;h=void 0===h?PERSONAL_BEST:h;if((!1===h||vehicle.CP()[4]<PERSONAL_BEST)&&""!==NAME&&null!==NAME&&!1!==UID&&void 0!==UID&&!f.SCAN){ui.clear();ui.print("uploading vhs to db","2","2");PERSONAL_BEST=vehicle.CP()[4];UID;var z=stage.name,t=vehicle.CP()[4],x=vehicle.CP().slice(),w=vehicle.MODEL;h=vehicle.PAINT;for(var b=f.save(f.tape),k=[],q=0;q<b.length;q++){var m="";m+=f.burn(b[q].TS);
m+="#";m+=f.burn(Math.round(100*b[q].AT)/100);m+="#";m+=f.burn(b[q].position.x);m+="#";m+=f.burn(b[q].position.y);m+="#";m+=f.burn(b[q].position.z);m+="#";m+=f.burn(b[q].lookTarget.x);m+="#";m+=f.burn(b[q].lookTarget.y);m+="#";m+=f.burn(b[q].lookTarget.z);m+="#";m+=f.burn(b[q].rotation);k.push(m)}h={version:DB_BUILD,id:UID,seed:z,time:Math.round(100*t)/100,cp:x,data:k,model:w,paint:h};firebase.database().ref("vhs/"+DB_BUILD+"/"+h.seed+"/"+UID).set(h,function(B){B?(ui.clear(),ui.print("network error",
"2","2")):(ui.clear(),ui.print("vhs succesfully submitted","2","2"));window.setTimeout(d,1E3)})}else void 0===UID||!1===UID||null===NAME||""===NAME||void 0===NAME?state.register():state.results()};this.burn=function(d){return Math.round(1E9*d).toString(16)};this.read=function(d){return parseInt(d,16)/1E9};this.scan=function(d,h){f.SCAN=!0;var z=[];firebase.database().ref("vhs/"+DB_BUILD+"/"+d).orderByChild("time").limitToFirst(SCORE_LIMIT).once("value").then(function(t){t.forEach(function(x){var w=
x.child("id").val();x=x.child("time").val();z.push({uid:w,time:x})});f.SCAN=!1;h(z)})};this.checkTime=function(d,h,z){d===h&&(PERSONAL_BEST=z)};this.requestName=function(d,h){firebase.database().ref("uid/"+d).once("value").then(function(z){z=z.child("name").val();return h(z),z})};this["import"]=function(d,h){h=void 0===h?function(){}:h;firebase.database().ref("vhs/"+DB_BUILD+"/"+d).once("value").then(function(z){var t=z.val(),x=t.id,w=t.seed,b=t.cp.slice(),k=[],q=t.model;z=t.paint;for(var m=0;m<t.data.length;m++){for(var B=
0,G=[""],J=0;J<t.data[m].length;J++)"#"===t.data[m].charAt(J)?(G[B]=f.read(G[B]),B++,G[B]=""):G[B]+=t.data[m].charAt(J);G[8]=f.read(G[8]);k[m]={TS:G[0],AT:G[1],position:new THREE.Vector3(G[2],G[3],G[4]),lookTarget:new THREE.Vector3(G[5],G[6],G[7]),rotation:G[8]}}f.save(k,1E3/60);h({uid:x,seed:w,cp:b,model:q,paint:z,tape:k.slice()})})};this.save=function(d,h){h=void 0===h?1E3/30:h;for(var z=0,t=[],x=d[d.length-1].TS,w=0;w<x;)w+=h,w<x&&t.push({TS:w});for(x=0;x<t.length;x++)z=f.convert(d,t[x],z);return t};
this.convert=function(d,h,z){for(var t=d[z].TS,x=d[z+1].TS,w=x-t;h.TS>x&&z<d.length-2;)t=d[++z].TS,x=d[z+1].TS,w=x-t;t=z;var b=z+1;x=(w-(x-h.TS))/w;return h.position=new THREE.Vector3,h.position.copy(d[t].position),h.position.lerp(d[b].position,x),h.lookTarget=new THREE.Vector3,h.lookTarget.copy(d[t].lookTarget),h.lookTarget.lerp(d[b].lookTarget,x),h.rotation=(d[b].rotation-d[t].rotation)*x,h.rotation+=d[t].rotation,h.rotation=(d[b].rotation-d[t].rotation)*x,h.rotation+=d[t].rotation,h.AT=(d[b].AT-
d[t].AT)*x,h.AT+=d[t].AT,h.UP=d[t].UP,h.check=d[t].check,h.objective=d[t].objective,z}}TIME.convert=function(a){a=void 0===a?[]:a;for(var f="[\n",g=0;g<a.length;g++){f+="'";for(var d=0;d<a[g].length;d++)f+=a[g].charCodeAt(d).toString(16);f+="',\n"}return f+="]",console.log(f),f};