var BUILD="0.0.2 _ DEV 7";window.onload=init;window.onresize=resize;window.fullscreenchange=resize;window.focus=resize;var palette=[1052688,16777215,12698049,2894892,5308334,16740978,2393855,16722266,3424820,2201152,7168071,10066329,16756970],i;for(i in palette){var c=new THREE.Color(palette[i]);palette[i]=c}
var LOADSTATUS=0,SEED_NAME="",SEED=Math.floor(2147483647*Math.random()),scene,camera,renderer,stage,vehicle,control,ui,vhs,state,UP,PLAY=!1,IMPORT=!1,BG=palette[0],FRAME=0,TIME=0,TIMER=0,DT=0,FPS=0,COUNTER=0,TIMEOUT=0,DNF=!1,REASON="out of bounds",FULLSCREEN=!1,MODE=0,LOAD=0,LOADING=!1,MENU=!1,MOBILE=!1,CHALLENGE=!1,OBJECTIVES=[],UPDATES=[],HITBOX=!0,FIREBASE=!0,SCALE=0,RESIZE_SCALE=1,RAFID=0,demo;
function init(){decodeURL();window.addEventListener("touchstart",activateTouch);window.addEventListener("contextmenu",function(){event.preventDefault()});scene=new THREE.Scene;scene.background=BG;UP=new THREE.Vector3(0,0,1);camera=new THREE.PerspectiveCamera;camera.up=UP;camera.position.z=2E3;camera.lookAt(0,0,0);camera.fov=70;camera.near=1E-4;camera.far=3E3;camera.name="Camera";scene.add(camera);renderer=new THREE.WebGLRenderer({logarithmicDepthBuffer:!0,antialias:!1});renderer.setClearColor(BG);
renderer.domElement.id="renderer";document.body.appendChild(renderer.domElement);control=new Control;control.connect();ui=new UI;stage=new Stage;vehicle=new Vehicle;vhs=new VHS;state=new State;resize();ui.onload=function(){demo=new THREE.LineSegments(stage.generate.sakura(),new THREE.LineBasicMaterial({vertexColors:!0}));demo.geometry.colorsNeedUpdate=!0;demo.position.z-=5;scene.add(demo);camera.position.set(0,25,10);camera.lookAt(0,0,0);main();state.intro()}}
function activateTouch(){MOBILE=!0;window.removeEventListener("touchstart",activateTouch)}function resize(a){state.SETTINGS&&state.settings(state.STATE);RESIZE_SCALE=a=640<window.innerWidth&&640<window.innerHeight&&0===SCALE?2:0===SCALE?1:SCALE;var b=window.innerWidth/a,m=window.innerHeight/a;renderer.clear();renderer.setSize(b,m);renderer.domElement.style.zoom=a;camera.aspect=b/m;camera.updateProjectionMatrix();ui.resize(b,m,a);state.resize(b,m,a)}
function main(){RAFID=window.requestAnimationFrame(main);var a=window.performance.now();FPS=a-TIME;TIME=a;FPS=10*Math.round(100/FPS);PLAY?(vehicle.update(),vhs.record(vehicle),MENU||state.update(),!MOBILE||MENU||DNF||ui.dpad()):vhs.PLAY?vhs.play(vehicle):LOADING?(camera.position.applyAxisAngle(camera.up,.01),camera.lookAt(new THREE.Vector3,0,0,0),state.loading()):(camera.position.applyAxisAngle(camera.up,.01),camera.lookAt(new THREE.Vector3,0,0,0));renderer.render(scene,camera);ui.update(control.touches)}
function encodeURL(){for(var a="#",b=window.location.href,m="",h=0;h<b.length;h++)if("#"===b.charAt(h)){b=m;break}else m+=b.charAt(h);m=vehicle.getCT();h=stage.generate.SEED.toString();h+="#";for(var G in m){var k=ui.getTextFloat(m[G]);h=h.concat(k);h+=","}h=btoa(h);a=a.concat(h);a=b.concat(a);b=document.createElement("textarea");b.value=a;b.setAttribute("readonly","");b.style={position:"absolute",left:"-9999px"};document.body.appendChild(b);b.select();document.execCommand("copy");document.body.removeChild(b)}
function decodeURL(){for(var a=window.location.href,b="",m=SEED,h=0,G="",k=!1,B=0;B<a.length;B++){var C=a.charAt(B);k&&(b+=a.charAt(B));"#"===C&&(k=!0)}if(k)for(b=atob(b),m="",a=0;a<b.length;a++)k=b.charAt(a),"#"===k?CHALLENGE=!0:CHALLENGE?","===k?(OBJECTIVES[h]=G,G="",h++):void 0!=k&&(G+=k):CHALLENGE||(m+=k.toString());CHALLENGE&&(SEED=parseInt(m))};function UI(){var a=this;this.renderer=document.createElement("canvas");this.renderer.id="ui";document.body.appendChild(this.renderer);var b=this.renderer.getContext("2d");this.context=b;var m=document.createElement("img");m.src="./img/STAGE_8PX.png";m.onload=function(){a.connect();a.onload()};document.createElement("canvas");this.onload=function(){};var h=document.createElement("canvas"),G=h.getContext("2d");this.scale=1;this.row=this.col=8;this.width;this.height;var k=128;var B=180;var C=128;var t=
80;var H=128;var M=B;var Z=128;var I=80;var P=128;var ea=B+60;var ba=128;var W=40;var K=!1,X=[],U=[];this.connect=function(){b.imageSmoothingEnabled=!1;h.width=m.width;h.height=m.height;G.drawImage(m,0,0,h.width,h.height,0,0,h.width,h.height)};this.resize=function(r,z,u){var y=document.querySelector("meta[name=viewport]"),F=1/window.devicePixelRatio*Math.round(window.devicePixelRatio);y.setAttribute("content","width="+Math.floor(window.innerWidth*F)+", initial-scale="+F+",maximum-scale=4.0, user-scalable=0");
a.scale=u;this.width=r;this.height=z;this.renderer.width=r;this.renderer.height=z;this.renderer.style.zoom=u;b.imageSmoothingEnabled=!1;this.redraw();k=128;B=180;C=128;t=80;H=128;M=B;Z=128;I=80;P=128;ea=B+60;ba=128;W=40;this.automate(r,z)};this.update=function(r){for(var z in r)for(var u in U)if(r[z].x>U[u].x*a.scale&&r[z].y>U[u].y*a.scale&&r[z].x<U[u].w*a.scale&&r[z].y<U[u].h*a.scale&&1==r[z].start){U[u].funct();r[z].start=!1;break}};this.print=function(r,z,u,y){y=void 0===y?1:y;for(var F=0,Y=a.compile(z,
a.width,a.col),N=a.compile(u,a.height,a.row);F<r.length;)a.encode(r.charAt(F),Y+F*a.col*y,N,y),F++;K||X.push(function(){a.print(r,z,u,y)})};this.text=function(r,z,u,y,F){y=void 0===y?1:y;for(F=0;F<r.length;)a.encode(r.charAt(F),z+F*a.col*y,u,y),F++};this.button=function(r,z,u,y,F,Y,N,D){N=void 0===N?!0:N;D=void 0===D?1:D;var O=a.compile(z,a.width,a.col),S=a.compile(u,a.height,a.row),da=a.compile(y,a.width,a.col),T=a.compile(F,a.height,a.row);N&&(b.drawImage(h,0,0,1,1,O,S+T/2,da+1,1),b.drawImage(h,
0,0,1,1,O,S-T/2,da+1,1),b.drawImage(h,0,0,1,1,O,S-T/2,1,T),b.drawImage(h,0,0,1,1,O+da,S-T/2,1,T));for(var ha=0;ha<r.length;)a.encode(r.charAt(ha),O+ha*a.col+da/2-Math.round(r.length*a.col)/2+2,S-a.row/2,D),ha++;U.push({x:O,y:S-T/2,w:O+da,h:S+T/2,funct:function(){Y()}});K||X.push(function(){a.button(r,z,u,y,F,Y,N,D)})};this.line=function(r,z,u,y){a.sprite(0,0,1,1,r,z,u,y)};this.sprite=function(r,z,u,y,F,Y,N,D){var O=a.compile(F,a.width,a.col),S=a.compile(Y,a.height,a.row),da=a.compile(N,a.width,a.col),
T=a.compile(D,a.height,a.row);b.drawImage(h,r,z,u,y,O,S,da,T);K||X.push(function(){a.sprite(r,z,u,y,F,Y,N,D)})};this.backdrop=function(r,z,u,y,F){r=void 0===r?"#10101099":r;!1===r?(ui.clear(),a.renderer.style.background="transparent"):(ui.clear(),a.renderer.style.background=r)};this.getDrawList=function(){return X};this.redraw=function(){K=!0;a.clear();for(var r=0;r<X.length;r++)X[r]();K=!1};this.automate=function(r,z){var u=Math.floor(r/3)-2,y=Math.floor(z/4);C>u&&(P=ba=H=Z=k=C=u);B>y&&(M=B=y+40,
ea=B+60)};this.pad=function(r,z,u,y,F,Y,N){var D=0;for(N();D<control.touches.length;)control.touches[D].x>z*a.scale&&control.touches[D].y>u*a.scale&&control.touches[D].x<(z+y)*a.scale&&control.touches[D].y<(u+F)*a.scale&&Y(),D++;HITBOX&&(b.drawImage(h,0,0,1,1,z+1,u,y-1,1),b.drawImage(h,0,0,1,1,z+1,u+F,y-1,1),b.drawImage(h,0,0,1,1,z+1,u,1,F),b.drawImage(h,0,0,1,1,z+y-1,u,1,F));a.encode(r,z+y/2-a.col/2,u+F/2-a.row/2)};this.dpad=function(){b.drawImage(h,88,88,40,40,a.width-H+Z/2-20,a.height-M+I/2-20,
40,40);b.drawImage(h,88,70,40,17,a.width-P+Z/2-20,a.height-ea+W-8,40,17);a.pad("<",k-C-1,a.height-B,C,t,function(){control.LEFT=!0},function(){control.LEFT=!1});a.pad(">",k+1,a.height-B,C,t,function(){control.RIGHT=!0},function(){control.RIGHT=!1});a.pad("^",a.width-H,a.height-M,Z,I,function(){control.UP=!0},function(){control.UP=!1});a.pad("b",a.width-P,a.height-ea+W/2,ba,W,function(){control.DOWN=!0},function(){control.DOWN=!1})};this.clear=function(){K||(X=[]);U=[];b.clearRect(0,0,a.width,a.height);
b.beginPath()};this["delete"]=function(r,z,u,y){z=void 0===z?0:z;u=void 0===u?renderer.width:u;y=void 0===y?renderer.height:y;r=a.compile(void 0===r?0:r,a.width,a.col);z=a.compile(z,a.height,a.row);u=a.compile(u,a.width,a.col);y=a.compile(y,a.height,a.row);b.clearRect(r,z,u,y)};this.encode=function(r,z,u,y){y=void 0===y?1:y;var F=r.charCodeAt(0);r=8*F%128;F=8*Math.floor(F/16);b.clearRect(z,u,8,8);b.drawImage(h,r,F,8,8,z,u,8*y,8*y)};this["float"]=function(r,z){var u=Math.floor(Math.abs(100*r));u=u.toString();
var y=u.slice(0,u.length-2);u=u.slice(u.length-2,u.length);if(0==r)return"0.00";0==y.length&&(y="0");2>u.length&&(u+="0");z&&0<r?y="+"+y:0>r&&(y="-"+y);return y+"."+u};this.compile=function(r,z,u){var y=0;switch(typeof r){case "number":y=r;break;case "function":y=r();break;case "string":for(var F=!1,Y=1,N=0,D="";N<r.length;){var O=r.charAt(N);"."===O?(D+=O,F=!0):"+"===O?(D=F?Number(D)*z:Number(D)*u,D*=Y,Y=1,y+=D,F=!1,D=""):"-"===O?(D=F?Number(D)*z:Number(D)*u,D*=Y,Y=-1,y+=D,F=!1,D=""):"p"===O?(D=
Number(D),D*=Y,y+=D,D=""):N===r.length-1?(D+=O,D=F?Number(D)*z:Number(D)*u,D*=Y,y+=D,D=""):D+=O;N++}}return y}};function State(){var a=this,b,m,h="",G=0;this.SETTINGS=!1;this.STATE=function(){};this.resize=function(k,B){b=k;m=B};this.wallet=function(){var k=vehicle.yen();ui.print("$ "+k.toString(),"2","1.0-4")};this.nav=function(k){k=void 0===k?function(){ui.clear()}:k;ui.sprite(8,64,8,8,"1.0-4+2p","2",8,8);ui.button("","1.0-8","2+4p","8","8",function(){a.menu(k)},!1)};this.title=function(k,B){a.breadcrumb(k,B);ui.sprite(16,64,8,8,"1.0-4+2p","2",8,8);ui.button("","1.0-7","2+4p","7","5",function(){ui.backdrop(!1);
k();MENU=!1;a.SETTINGS=!1},!1);a.wallet()};this.breadcrumb=function(k,B){var C=void 0===B?function(){ui.backdrop(!1);k();MENU=!1;a.SETTINGS=!1}:function(){a.menu(k);MENU=!0};ui.print("< menu","2","2");ui.button("","2","2+4p","7","8",C,!1)};this.menu=function(k){MENU=!0;ui.backdrop();ui.clear();a.title(k);ui.sprite(0,0,1,1,"2","6","1.0-4",1);ui.print(" > modify vehicle","2","8");ui.button("","2","8+4p","1.0-4","5",function(){a.vehicle(k)},!1);ui.sprite(0,0,1,1,"2","11","1.0-4",1);ui.print(" > settings ( dev )",
"2","13");ui.button("","2","13+4p","1.0-4","5",function(){a.settings(k)},!1);ui.sprite(0,0,1,1,"2","16","1.0-4",1);var B=8;if(PLAY||vhs.PLAY)ui.button("restart stage","2","1.0-2-"+B,"1.0-4","6",function(){ui.backdrop(!1);a.reset()},!0),B+=8;stage.COMPLETE&&(PLAY||vhs.PLAY)&&ui.button("next stage","2","1.0-2-"+B,"1.0-4","6",function(){ui.backdrop(!1);a.next()},!0);a.discord()};this.intro=function(){ui.clear();ui.print("specialstage.io","2","2");ui.print("-","2","4");ui.print("A _ "+BUILD,"2","1.0-4");
ui.button("","2","0.5-5","1.0-4","1.0-20",function(){scene.remove(demo);demo.geometry.dispose();demo.geometry=stage.generate.sakura();scene.add(demo)},!1);a.nav(function(){a.intro()});ui.print("menu","1.0-9","2");ui.button("","1.0-9","2+4p","4","5",function(){a.menu(a.intro)},!1);a.discord();ui.button("start","2","1.0-12+"+(2*(RESIZE_SCALE-1)).toString(),"1.0-4","8",function(){scene.remove(demo);ui.clear();START=!0;FIREBASE&&firebase.analytics().logEvent("game_start");stage.connect();a.load()})};
this.discord=function(){ui.sprite(2,83,16,12,"1.0-12","1.0-5+8p",16,12);ui.button("discord","1.0-11","1.0-4+4p","10","4",function(){window.open("https://discord.gg/ACewNWH")},!1)};this.load=function(){ui.clear();LOADING=!0;a.nav(a.load);ui.print("seed : ","2","2");ui.print(stage.name,"2","5-1p",2);G=0};this.ready=function(){ui.clear();LOADING=!1;a.nav(a.ready);ui.print("stage generated.","2","2");ui.print(stage.name,"2","5-1p",2);a.target();ui.button("ready","2","1.0-10","1.0-4","8",function(){stage.generate.END=
!1;ui.clear();a.play();PLAY=!0;vehicle.connect(stage.start,stage.surface);FIREBASE&&firebase.analytics().logEvent("stage_start")});a.wallet()};this.play=function(){ui.clear();a.nav(a.play);MENU=!1};this.complete=function(){MENU=!0;ui.clear();a.nav(a.complete);ui.print("stage complete!","0.5-15","0.3-1",2);stage.COMPLETE=!0;window.setTimeout(a.results,2E3);if(FIREBASE){var k=vehicle.param().model+" ("+(vehicle.param().power+1)+"/"+(vehicle.param().drag+1)+"/"+(vehicle.param().sensitivity+1)+")";console.log(k);
firebase.analytics().logEvent("stage_complete",{time:vehicle.AT(),penalty:vehicle.PENALTY(),score:vehicle.AT()+vehicle.PENALTY(),seed:stage.name,rating:Math.round(stage.generate.DISTANCE/(vehicle.AT()+vehicle.PENALTY())),distance:stage.generate.DISTANCE,vehicle:k})}};this.results=function(){ui.clear();MENU=!0;var k=ui["float"](vehicle.AT()+vehicle.PENALTY());a.nav(a.results);ui.print("stage complete : "+stage.name,"2","2");ui.print(k,"2","5",2);vehicle.AT()+vehicle.PENALTY()<stage.best[3]&&ui.print("new record!",
2*k.length+"+3".toString(),"5+4p");k=9;var B=vehicle.CP();if(340<m){for(var C=0;C<B.length;C++){ui.print("cp "+(C+1).toString(),"2",k+"+"+C.toString());var t=void 0,H=void 0;"number"===typeof B[C]?(t=ui["float"](B[C]),H=B[C]-stage.best[C]):(t="penalty",H="");ui.print(t.toString(),"0.5 -1-"+t.length.toString(),k+"+"+C.toString());t="penalty"===t?"25 sec":0<H?"( - "+ui["float"](H)+" )":"( + "+ui["float"](Math.abs(H))+" )";ui.print(t,"0.5+1",k+"+"+C.toString());k+=1}k+=5}ui.print("reward","2",k.toString());
k+=3;ui.print("$"+vehicle.results().reward,"2",k.toString(),2);ui.button("next stage","2","1.0-12","1.0-4","8",function(){a.next()});ui.button("restart stage","2","1.0-4","0.5-3","4",function(){a.reset("complete")});ui.button("view replay","0.5+1","1.0-4","0.5-3","4",function(){a.replay()});window.setTimeout(function(){PLAY=!1;vhs.PLAY=!0},0)};this.replay=function(){ui.clear();a.nav(a.results);for(var k={$jscomp$loop$prop$i$13$85:0};4>k.$jscomp$loop$prop$i$13$85;k={$jscomp$loop$prop$i$13$85:k.$jscomp$loop$prop$i$13$85},
k.$jscomp$loop$prop$i$13$85++)ui.button("[ "+(k.$jscomp$loop$prop$i$13$85+1).toString()+" ]",(7*k.$jscomp$loop$prop$i$13$85).toString(),"1.0-3","7","5",function(B){return function(){vehicle.CAMERA=B.$jscomp$loop$prop$i$13$85+1}}(k),!1);ui.print("<","2","2");ui.button("","2","2+4p","7","8",function(){a.results(a.replay)},!1)};this.next=function(){ui.clear();renderer.clear();vehicle.reset();vehicle.disconnect();stage.reset();PLAY=MENU=!1;vhs.PLAY=!1;a.load();FIREBASE&&firebase.analytics().logEvent("next_stage")};
this.dnf=function(){ui.clear();a.nav(a.dnf);FIREBASE&&firebase.analytics().logEvent("dnf");ui.print("dnf","0.5-3+3p","0.5-8",2);ui.button("restart stage?","2","0.5+8","1.0-4","1.0-4",function(){a.reset("dnf")},!1)};this.reset=function(k){k=void 0===k?"reset":k;ui.clear();a.nav(a.play);PLAY=!0;MENU=!1;vehicle.reset();FIREBASE&&firebase.analytics().logEvent("stage_restart",{status:k})};this.update=function(){MENU||!PLAY||DNF||ui.text(ui["float"](vehicle.AT()),16,16)};this.loading=function(){h=0!==G%
16?h:3<=h.length?"":h+".";MENU||(ui["delete"](16,16,160,8),ui.text("stage generating"+h,16,16));G++};this.target=function(){ui.print(stage.name,"2","5-1p",2);ui.print("target:","2","9");ui.print(ui["float"](stage.best[3]),"2","12-1p",2);if(340<m)for(var k=0;k<stage.best.length;k++){var B=ui["float"](stage.best[k]);ui.print("cp "+(k+1).toString(),"2","16+"+(2*k).toString());ui.print(B,"1.0-2-"+B.length.toString(),"16+"+(2*k).toString())}};this.vehicle=function(k){MENU=!0;ui.clear();a.title(k,a.menu);
var B=[],C=vehicle.param();B.push({id:"power",value:C.power,funct:function(P){vehicle.tune.power(P)}});B.push({id:"drag",value:C.drag,funct:function(P){vehicle.tune.drag(P)}});B.push({id:"sensitivity",value:C.sensitivity,funct:function(P){vehicle.tune.sensitivity(P)}});B.push({id:"easing",value:C.ease,funct:function(P){vehicle.tune.ease(P)}});C="8+";ui.sprite(0,0,1,1,"2",C+"-5+3","1.0-2-2",1);ui.print("model","2",C);ui.print(vehicle.models()[vehicle.MODEL].name,"2+8",C);ui.sprite(0,0,1,1,"2",C+"+3",
"1.0-2-2",1);ui.button(">","1.0-6",C+"+4p","4","4",function(){vehicle.MODEL+=1;1<vehicle.MODEL&&(vehicle.MODEL=0);a.vehicle(k)},!1);ui.button("<","1.0-12",C+"+4p","4","4",function(){--vehicle.MODEL;0>vehicle.MODEL&&(vehicle.MODEL=1);a.vehicle(k)},!1);C+="5+";for(var t={$jscomp$loop$prop$i$15$87:0};t.$jscomp$loop$prop$i$15$87<B.length;t={$jscomp$loop$prop$i$15$87:t.$jscomp$loop$prop$i$15$87},t.$jscomp$loop$prop$i$15$87++){var H=C+(5*t.$jscomp$loop$prop$i$15$87).toString();ui.print(B[t.$jscomp$loop$prop$i$15$87].id,
"2",H);ui.sprite(0,0,1,1,"2",H+"+3","1.0-2-2",1);for(var M={$jscomp$loop$prop$n$89:0};6>M.$jscomp$loop$prop$n$89;M={$jscomp$loop$prop$n$89:M.$jscomp$loop$prop$n$89},M.$jscomp$loop$prop$n$89++){var Z="1.0-18+"+(3*M.$jscomp$loop$prop$n$89).toString(),I=M.$jscomp$loop$prop$n$89<=B[t.$jscomp$loop$prop$i$15$87].value?48:40;ui.button("",Z+"-10p",H+"+4p","3","4",function(P,ea){return function(){B[P.$jscomp$loop$prop$i$15$87].funct(ea.$jscomp$loop$prop$n$89);a.vehicle(k)}}(t,M),!1);ui.sprite(I,64,8,8,Z,H,
8,8)}}};this.settings=function(k){a.SETTINGS=!0;a.STATE=function(){k()};ui.clear();a.title(k,a.menu);ui.sprite(0,0,1,1,"2","6","1.0-4",1);ui.print("pixel scaling","2","8");(620>b||620>m)&&1===RESIZE_SCALE?ui.print("1 (locked)","1.0-2-10","8"):(ui.print(RESIZE_SCALE.toString()+" [change]","1.0-4-8","8"),ui.button("","2","8+4p","1.0-4","5",function(){return new function(){if(620<b&&620<m||1!=RESIZE_SCALE)SCALE=1<RESIZE_SCALE?1:2,resize(),a.settings(k)}},!1));ui.sprite(0,0,1,1,"2","11","1.0-4",1);ui.print("control input",
"2","13");MOBILE?ui.print("touch (detected)","1.0-7-10","13"):ui.print("keyboard (detected)","1.0-11-10","13");ui.sprite(0,0,1,1,"2","16","1.0-4",1);if(MOBILE){var B=HITBOX?"enabled":"disabled";ui.print("display touch hitboxes","2","18");ui.print(B,"1.0-2-"+B.length,"18");ui.sprite(0,0,1,1,"2","21","1.0-4",1);ui.button("","2","18+4p","1.0-4","5",function(){HITBOX=!HITBOX;a.settings(k)},!1)}else ui.print("keybindings","2","18"),ui.print("arrow / wasd","1.0-14","18"),ui.sprite(0,0,1,1,"2","21","1.0-4",
1);ui.print("developed by","2","1.0-14");ui.print("www.procedural.ca","2","1.0-10");ui.print("www.ginko.ltd","2","1.0-8");a.discord()};this.controls=function(k){ui.clear();a.title(k,a.menu)};this.fullscreen=function(){document.fullscreenElement?document.exitFullscreen&&document.exitFullscreen():document.documentElement.requestFullscreen()};this.prompt=function(){ui.clear();ui.print("specialstage.io","4","4",2);ui.print("-","4","8",2)};this.credits=function(){}};function Control(){var a=this;this.ENTER=this.RIGHT=this.LEFT=this.DOWN=this.UP=this.MOBILE=!1;this.touches=[];this.connect=function(){this.MOBILE?(window.addEventListener("touchstart",a.touch,!1),window.addEventListener("touchmove",a.touch,!1),window.addEventListener("touchend",a.touch,!1)):(window.addEventListener("keydown",a.key,!1),window.addEventListener("keyup",a.key,!1),window.addEventListener("mousedown",a.mousedown),window.addEventListener("mouseup",a.mouseup,!1),window.addEventListener("touchstart",
a.touchSetup,!1))};this.disconnect=function(){window.removeEventListener("keydown",a.key,!1);window.removeEventListener("keyup",a.key,!1);window.removeEventListener("mousedown",a.mousedown,!1);window.removeEventListener("mouseup",a.mouseup,!1);window.removeEventListener("touchstart",a.touchSetup,!1);window.removeEventListener("touchstart",a.touch,!1);window.removeEventListener("touchmove",a.touch,!1);window.removeEventListener("touchend",a.touch,!1)};this.key=function(b){var m="keydown"==b.type;switch(b.key){case "ArrowUp":a.UP=
m;break;case "ArrowDown":a.DOWN=m;break;case "ArrowLeft":a.LEFT=m;break;case "ArrowRight":a.RIGHT=m;break;case "w":a.UP=m;break;case "s":a.DOWN=m;break;case "a":a.LEFT=m;break;case "d":a.RIGHT=m;break;case "r":a.RESET=m;break;case " ":a.SPACE=m;break;case "Enter":a.ENTER=m}};this.mousedown=function(b){b.preventDefault();a.touches[0]={x:b.clientX,y:b.clientY,start:!0}};this.mouseup=function(b){b.preventDefault();a.touches[0]={x:b.clientX,y:b.clientY,start:!1}};this.touchSetup=function(b){window.removeEventListener("keydown",
a.key,!1);window.removeEventListener("keyup",a.key,!1);window.removeEventListener("keyup",a.key,!1);window.removeEventListener("mousedown",a.mousedown,!1);window.removeEventListener("mouseup",a.mouseup,!1);window.removeEventListener("touchstart",a.touchSetup,!1);window.addEventListener("touchstart",a.touchstart,!1);window.addEventListener("touchmove",a.touchmove,!1);window.addEventListener("touchend",a.touchend,!1);a.touchstart(b)};this.clear=function(){a.touches=[];this.ENTER=this.RIGHT=this.LEFT=
this.DOWN=this.UP=!1};this.touchstart=function(b){b=b.touches;a.touches=[];for(var m=0;m<b.length;m++)a.touches[m]={x:b[m].clientX,y:b[m].clientY,start:!0}};this.touchmove=function(b){a.touches=[];b=b.touches;for(var m=0;m<b.length;m++)a.touches[m]={x:b[m].clientX,y:b[m].clientY,start:!1}};this.touchend=function(b){a.touches=[];b=b.touches;for(var m=0;m<b.length;m++)a.touches[m]={x:b[m].clientX,y:b[m].clientY,start:!1}}};function Vehicle(){function a(){if(m)for(var x=0;1>x;){emitter.geometry.vertices[aa].copy(S);emitter.geometry.vertices[aa].multiplyScalar(-1-Math.random()*Y);emitter.geometry.vertices[aa].add(l);emitter.geometry.vertices[aa].life=emitter.geometry.vertices[aa].maxLife;var ca=.1*-Math.random();emitter.geometry.vertices[aa].acc.copy(S);emitter.geometry.vertices[aa].acc.multiplyScalar(ca);aa++;aa%=emitter.geometry.vertices.length;x++}for(var fa in emitter.geometry.vertices)0<emitter.geometry.vertices[fa].life&&
(emitter.geometry.vertices[fa].add(emitter.geometry.vertices[fa].acc),--emitter.geometry.vertices[fa].life,emitter.geometry.colors[fa].setHSL(0,0,emitter.geometry.vertices[fa].life/100)),0===emitter.geometry.vertices[fa].life&&(emitter.geometry.vertices[fa].set(0,0,0),emitter.geometry.vertices[aa].acc.x=0,emitter.geometry.vertices[aa].acc.y=0,emitter.geometry.vertices[aa].acc.z=0);emitter.geometry.verticesNeedUpdate=!0;emitter.geometry.colorsNeedUpdate=!0;emitter.geometry.computeBoundingSphere()}
var b=this;this.TEXTTIME=this.SPEED="";this.END=this.START=!1;this.OBJECTIVE=0;this.POSITION;this.MODEL=1;this.ANALOG=!1;this.PENALTY=function(){return H};this.CAMERA=1;var m=!1,h=!1,G=!0,k=!1,B=1,C=0,t=[],H=0,M=0,Z=0,I=0,P=!1,ea=0,ba=0,W=0,K={power:2,drag:2,mass:1,brake:3,sensitivity:2,ease:0},X=0,U=0,r=0;X=.02-.015;U=.985-.98;r=.075-.055;var z,u,y,F=6,Y,N=0,D=0,O=0,S=new THREE.Vector3(0,1,0),da=new THREE.Vector3(0,0,0),T=new THREE.Vector3,ha=new THREE.Vector3(0,0,1),ja=new THREE.Vector3(0,0,1),
e=new THREE.Vector3(0,0,1),d=new THREE.Vector3(0,0,1),f=new THREE.Vector3(0,0,-.0065),l=new THREE.Vector3,n=new THREE.Vector3,g=new THREE.Vector3,A=new THREE.Vector3,p=[],q=new THREE.Vector3(0,0,1),E=new THREE.Raycaster(A,q,0,2);this.cameras=[];this.cameras[0]={distance:20,x:0,y:0,z:7,lerp:.1,lookAt:new THREE.Vector3};this.cameras[1]={distance:0,x:20,y:20,z:10,lerp:.05,lookAt:new THREE.Vector3};this.cameras[2]={distance:0,x:-30,y:-30,z:20,lerp:.05,lookAt:new THREE.Vector3};this.cameras[3]={distance:0,
x:-40,y:40,z:30,lerp:.075,lookAt:new THREE.Vector3};this.cameras[4]={distance:0,x:0,y:-20,z:60,lerp:.0075,lookAt:new THREE.Vector3};var w=[];this.models=function(){return w};w[0]=(new THREE.Geometry).fromBufferGeometry(new THREE.EdgesGeometry(new THREE.BoxGeometry(1,2,1)));w[0].name="logistics crate";var Q=new THREE.MeshBasicMaterial;w[1]=new THREE.Geometry;w[1].vertices.push(new THREE.Vector3(.45,-.75,1));w[1].vertices.push(new THREE.Vector3(.3,1.2,1));w[1].vertices.push(new THREE.Vector3(-.45,-.75,
1));w[1].vertices.push(new THREE.Vector3(-.3,1.2,1));w[1].vertices.push(new THREE.Vector3(.3,1.2,1));w[1].vertices.push(new THREE.Vector3(-.3,1.2,1));w[1].vertices.push(new THREE.Vector3(.45,-.75,1));w[1].vertices.push(new THREE.Vector3(-.45,-.75,1));w[1].vertices.push(new THREE.Vector3(-.3,1.2,1));w[1].vertices.push(new THREE.Vector3(-1,-.75,-.1));w[1].vertices.push(new THREE.Vector3(-.45,-.75,1));w[1].vertices.push(new THREE.Vector3(-1,-.75,-.1));w[1].vertices.push(new THREE.Vector3(.3,1.2,1));
w[1].vertices.push(new THREE.Vector3(1,-.75,-.1));w[1].vertices.push(new THREE.Vector3(.45,-.75,1));w[1].vertices.push(new THREE.Vector3(1,-.75,-.1));w[1].vertices.push(new THREE.Vector3(.45,-.75,1));w[1].vertices.push(new THREE.Vector3(.45,-1.4,.4));w[1].vertices.push(new THREE.Vector3(-.45,-.75,1));w[1].vertices.push(new THREE.Vector3(-.45,-1.4,.4));w[1].vertices.push(new THREE.Vector3(.45,-1.4,.4));w[1].vertices.push(new THREE.Vector3(-.45,-1.4,.4));w[1].vertices.push(new THREE.Vector3(.45,-1.4,
.4));w[1].vertices.push(new THREE.Vector3(1,-.75,-.1));w[1].vertices.push(new THREE.Vector3(-.45,-1.4,.4));w[1].vertices.push(new THREE.Vector3(-1,-.75,-.1));w[1].center();w[1].name="ag-86";for(var J=(new THREE.LineSegments(w[b.MODEL].clone(),Q)).clone(),aa=0,ia=new THREE.Geometry;100>ia.vertices.length;){var V=new THREE.Vector3(0,0,0);V.life=0;V.maxLife=100;V.acc=new THREE.Vector3(0,0,0);ia.vertices.push(V);V=new THREE.Color(4294967040);ia.colors.push(V)}ia.verticesNeedUpdate=!0;emitter=new THREE.Points(ia,
new THREE.PointsMaterial({size:.1,vertexColors:THREE.VertexColors,blending:THREE.AdditiveBlending,transparent:!0}));emitter.name="Emitter";this.connect=function(x,ca){J.copy(new THREE.LineSegments(w[b.MODEL].clone(),Q));g.copy(x);l.copy(g);n.copy(l);scene.add(J);scene.add(emitter);b.tune.power();b.tune.drag();b.tune.sensitivity();b.tune.ease();scene.fog=new THREE.FogExp2(palette[0],.01);camera.fov=90;camera.updateProjectionMatrix();scene.add(stage.generate.stars);k=!1;window.setTimeout(function(){k=
!0},1E3)};this.disconnect=function(){b.reset();scene.remove(J);scene.remove(emitter);scene.fog=new THREE.FogExp2(palette[0],0);scene.remove(stage.generate.stars)};this.ready=function(){m&&(I=performance.now(),C=0,b.START=!0)};this.reset=function(){if(b.END&&t[3]+H<stage.best[3])for(var x in stage.best)stage.best[x]=3===x?C+H:t[x];k=DNF=this.END=this.START=!1;control.UP=!1;control.DOWN=!1;control.LEFT=!1;R=L=h=m=control.RIGHT=!1;C=0;t=[];W=M=H=ea=0;l.copy(g);n.copy(l);S.set(0,1,0);T.set(0,0,0);d.set(0,
0,1);J.copy(new THREE.LineSegments(w[b.MODEL].clone(),Q));J.lookAt(d);N=D=0;camera.position.copy(l);camera.position.add(S.clone().multiplyScalar(-60));camera.position.z+=40;camera.lookAt(J.position);camera.updateProjectionMatrix();renderer.render(scene,camera);vhs.reset();window.setTimeout(function(){k=!0},1E3)};this.update=function(){this.START||this.ready();DNF||b.END||!k?R=L=h=m=!1:(m=control.UP,h=control.DOWN,L=control.LEFT,R=control.RIGHT);a();var x=L&&R?0:L?1:R?-1:0;0!=x&&Math.abs(O)<F?O+=x:
0<Math.abs(O)&&(O-=O/Math.abs(O));N=O/F;N*=y;D+=N;D%=2*Math.PI;S.copy(J.up);S.applyMatrix4(J.matrixWorld);S.sub(l);S.normalize();da.copy(S);Y=T.length();m&&G&&(da.copy(S).multiplyScalar(z),T.add(da));h&&G&&T.multiplyScalar(.95);G?T.multiplyScalar(u):T.multiplyScalar(.99);l.add(T);J.position.copy(l);A.copy(l);A.z-=50;p=[];q.set(0,0,1);E.far=100;E.set(A,q);stage.surface.raycast(E,p);0<p.length?(A.copy(p[0].point),l.z<A.z&&5>Math.abs(l.z-A.z)?(Z=0,G=!0,ja.copy(p[0].face.normal),l.copy(A)):G?(G=!1,T.sub(f)):
T.add(f)):0===p.length&&(G=!1,Z++,T.add(f),60<Z&&!b.END&&!DNF&&(DNF=!0,state.dnf()));e.lerp(ja,.2);d.copy(e);d.add(l);J.lookAt(d);J.rotateOnAxis(ha,D);p=[];q.copy(l);q.sub(n);E.far=q.length();q.normalize();E.set(l,q);x=0;for(var ca=!1,fa=W;5>fa;fa++)if(stage.generate.checkpoints[fa].collision.raycast(E,p),0<p.length){x=fa;ca=!0;break}P=!1;if(ca)if(x===W)stage.generate.checkpoints[W].display.material.color=palette[4],0<W&&(t[W-1]=C,ui["delete"]("2","4","30","1"),x=C-stage.best[W-1],x=0<x?"(-"+ui["float"](x)+
")":"(+"+ui["float"](Math.abs(x))+")",ui.text(x,16,32)),4===W&&(P=!0,ea=C+H<stage.best[3]?100-H+Math.floor(10*(stage.best[3]-(C+H))):100-H,ba+=ea,b.END=!0,state.complete()),P=!0,W++;else{P=!0;for(ca=W-1;ca<x-1;ca++)0<=ca&&(t[ca]="-",M++);H=25*M;4===x?(t[x-1]=C,ea=C+H<stage.best[3]?100-H+Math.floor(10*(stage.best[3]-(C+H))):100-H,ba+=ea,W=0,b.END=!0,state.complete()):(t[x-1]=C,W=x+1,ui["delete"]("2","4","30","1"),ui.text("missed checkpoint x "+M.toString()+" ( -"+H.toString()+".00 )",16,32));P=!0;
stage.generate.checkpoints[x].display.material.color=palette[4]}b.SPEED=Math.round(60*Y/1E3*3600);b.START&&!b.END&&(C=Math.floor((window.performance.now()-I)/10)/100);b.OBJECTIVE=W;n.copy(l);x=DNF||b.END?1E-5:.1;ca=S.clone();ca.multiplyScalar(-b.cameras[0].distance);ca.add(J.position);ca.z+=b.cameras[0].z;camera.position.lerp(ca,x);camera.lookAt(J.position)};this.results=function(){return{reward:ea,yen:ba}};this.AT=function(){return C};this.CP=function(){return t.slice()};this.replay=function(x){l.copy(x.position);
J.position.copy(l);S.copy(x.direction);ja.copy(x.normal);d.copy(x.lookAt);m=x.UP;P=x.CHECK;D=x.rotation;W=x.objective;J.lookAt(d);J.rotateOnAxis(ha,D);x=l.clone();var ca=1,fa=1;b.CAMERA===B&&(ca=b.cameras[1].lerp,fa=1);B=b.CAMERA;x.x+=b.cameras[b.CAMERA].x;x.y+=b.cameras[b.CAMERA].y;x.z+=b.cameras[b.CAMERA].z;camera.position.lerp(x,ca);b.cameras[B].lookAt.lerp(l,fa);camera.lookAt(b.cameras[B].lookAt);P&&(stage.generate.checkpoints[W].display.material.color=palette[4]);a()};this.record=function(){return{position:l.clone(),
direction:S.clone(),normal:ja.clone(),lookAt:d.clone(),UP:m,rotation:D,objective:W,check:P}};this.tune={power:function(x){x=void 0===x?K.power:x;K.power=0>x?0:5<x?5:x;z=.015+K.power/5*X},drag:function(x){x=void 0===x?K.drag:x;K.drag=0>x?0:5<x?5:x;u=.985-K.drag/5*U},sensitivity:function(x){x=void 0===x?K.sensitivity:x;K.sensitivity=0>x?0:5<x?5:x;y=.055+K.sensitivity/5*r},ease:function(x){x=void 0===x?K.ease:x;K.ease=0>x?0:5<x?5:x;F=6+K.ease}};this.param=function(){array=Object.assign(K,[]);array.model=
w[b.MODEL].name;return array};this.yen=function(){return ba};this.debug=function(){console.log("ROTATION:",D)}};function Stage(){this.COMPLETE=!1;this.start=new THREE.Vector3;this.generate=new Generate;this.checkpoint=[];this.objectives=[];this.best=[];this.grid=[];this.dimension=2400;this.partitionDimension=16;this.partionDivision=this.dimension/this.partitionDimension;for(var a=0;4>a;a++)this.checkpoint[this.checkpoint.length]=new THREE.Mesh(new THREE.Geometry);this.connect=function(b){b=void 0===b?!1:b;camera.position.set(0,400,200);camera.far=2E3;camera.updateProjectionMatrix();camera.lookAt(new THREE.Vector3);
renderer.render(scene,camera);if(!b){this.name=this.generate.name();b="";for(var m in this.name)b+=this.name.charCodeAt(m).toString();SEED=b}this.generate.connect();COUNTER++};this.disconnect=function(){this.generate.disconnect();this.generate.reset()};this.reset=function(b){b=void 0===b?!1:b;SEED++;this.COMPLETE=!1;this.disconnect();this.generate=new Generate;this.connect(b)};this.preview=function(){window.setTimeout(0,0)}};function Generate(){scope=this;var a=this.SEED=0;this.length=480;var b=[],m=0;b[0]={name:"forest",palette:palette[9],tree:function(e,d){return scope.pine()},limit:Math.floor(scope.length/2),range:5,map:[],flags:[]};b[0].map[0]=function(e,d){var f=palette[10],l=!1;.92<Math.abs(e)&&(f=.92<Math.abs(e)?palette[9]:palette[2],l=!0);b[0].flags[d]=l;return f};b[1]={name:"sakura",palette:palette[12],tree:function(){return scope.sakura()},limit:Math.floor(1/6*scope.length),range:10,map:[],flags:[]};b[1].map[0]=
function(e,d){var f=palette[1],l=!1;.95<Math.abs(e)&&(f=.92<Math.abs(e)?palette[12]:palette[1],l=!0);b[1].flags[d]=l;return f};var h=new THREE.Points(new THREE.Geometry);h.name="Generative Extruder";h.visible=!1;var G=new THREE.Line(new THREE.Geometry);G.name="Generative Nodes";G.visible=!1;G.material.color=palette[6];G.material.name="Node Material";G.position.z+=2;var k=new THREE.LineSegments(new THREE.Geometry);k.name="Generative Segments";k.visible=!0;k.material.color=palette[3];k.material.name=
"Segments Material";var B=new THREE.Mesh(new THREE.Geometry);B.name="Generative Surface";B.visible=!1;B.material.color=palette[0];B.material.name="Surface Material";var C=new THREE.LineSegments(new THREE.Geometry);C.name="Generative Perimeter";C.material.color=palette[1];C.material.name="Perimeter Material";var t=new THREE.Mesh(new THREE.Geometry,new THREE.MeshBasicMaterial({vertexColors:THREE.VertexColors}));t.name="Terrain";t.material.name="Terrain Material";t.material.wireframe=!0;t.material.side=
THREE.DoubleSide;t.visible=!0;wireframe=new THREE.Mesh(new THREE.Geometry,new THREE.MeshBasicMaterial({vertexColors:THREE.VertexColors}));wireframe.name="Wireframe";wireframe.material.name="Wireframe Material";wireframe.material.wireframe=!0;wireframe.material.side=THREE.FrontSide;wireframe.visible=!0;var H=new THREE.LineSegments(new THREE.Geometry,new THREE.LineBasicMaterial({vertexColors:THREE.VertexColors}));H.name="Trees";var M=new THREE.Mesh(new THREE.Geometry,new THREE.MeshBasicMaterial);M.name=
"Background";M.material.color=palette[0];M.material.name="Background Material";M.material.wireframe=!1;M.material.side=THREE.FrontSide;M.material.opacity=.75;M.material.blendMode=THREE.MultiplyBlending;M.material.transparent=!0;var Z=new THREE.Points(new THREE.Geometry);Z.material.color=palette[1];Z.material.sizeAttenuation=!1;Z.material.size=1.5;Z.material.fog=!1;scope.stars=Z;var I=new THREE.Mesh(new THREE.Geometry);I.name="Collision Mesh";I.visible=!0;I.material.color=palette[3];I.material.name=
"Collision Material";I.material.side=THREE.BackSide;this.checkpoints=[];var P=new THREE.Vector3(0,0,1),ea=new THREE.Vector3(1,0,0);new THREE.Vector3(0,1,0);new THREE.Vector3(0,0,1);var ba=new THREE.Vector3(0,3,0),W=new THREE.Vector3(0,0,1),K=G.geometry.clone(),X=B.geometry.clone(),U=k.geometry.clone(),r=C.geometry.clone(),z=[],u=[],y=new THREE.Vector3;z[0]=new THREE.Vector3(4,3,0);z[1]=new THREE.Vector3(-4,3,0);u[0]=z[0].clone();u.z+=1;u[1]=z[1].clone();u.z+=1;var F=Math.PI/64,Y=Math.PI/32,N=[],D=
0,O=new THREE.Vector3;this.start=new THREE.Vector3;var S=!1,da=!1,T=!1;this.IMPORT=this.END=!1;this.DISTANCE=0;var ha=18,ja=new THREE.Raycaster;ja.far=800;h.geometry.vertices[0]=ba.clone();h.geometry.vertices[1]=P.clone().add(ba);h.geometry.vertices[2]=z[0].clone();h.geometry.vertices[3]=z[1].clone();h.geometry.vertices[4]=u[0].clone();h.geometry.vertices[5]=u[1].clone();this.connect=function(){scope.SEED=SEED;m=scope.randomInt(0,2);scene.add(h);scene.add(G);scene.add(k);scene.add(C);scene.add(B);
scene.add(wireframe);scene.add(M);D=window.performance.now();window.setTimeout(scope.generate,0)};this.disconnect=function(){N=[];scene.remove(h);scene.remove(G);scene.remove(k);scene.remove(C);scene.remove(B);scene.remove(wireframe);scene.remove(M);scene.remove(H);for(var e in b)b[e].flag=[];for(var d in scope.checkpoints)scene.remove(scope.checkpoints[d].display),scope.checkpoints[d].display.geometry.dispose(),scope.checkpoints[d].collision.geometry.dispose()};this.complete=function(){I.geometry.mergeVertices();
I.geometry.verticesNeedUpdate=!0;I.geometry.elementsNeedUpdate=!0;I.geometry.computeFaceNormals();I.geometry.computeBoundingSphere();wireframe.geometry.mergeVertices();wireframe.geometry.verticesNeedUpdate=!0;wireframe.geometry.elementsNeedUpdate=!0;wireframe.geometry.computeFaceNormals();wireframe.geometry.computeBoundingSphere();M.geometry.copy(I.geometry);--M.position.z;var e=new THREE.IcosahedronGeometry(1200,4),d;for(d in e.vertices).3>scope.random()&&-400<e.vertices[d].z&&Z.geometry.vertices.push(e.vertices[d].clone());
e.dispose();Z.geometry.computeBoundingSphere();stage.surface=I.clone();stage.start=scope.start.clone();D=window.performance.now()-D;console.log("Generation Time:",ui["float"](D/1E3));S=!0;scope.END=!0;FIREBASE&&firebase.analytics().logEvent("stage_generation_complete",{time:Math.round(D/1E3)});state.ready()};this.reset=function(){ha=(36+scope.random()-.5)/2;a=0;G.geometry.dispose();k.geometry.dispose();B.geometry.dispose();h.geometry.dispose();C.geometry.dispose();t.geometry.dispose();wireframe.geometry.dispose();
I.geometry.dispose();H.geometry.dispose();Z.geometry.dispose();U.dispose();r.dispose();K.dispose();X.dispose();U.copy(new THREE.Geometry);r.copy(new THREE.Geometry);K.copy(new THREE.Geometry);X.copy(new THREE.Geometry);G.geometry.copy(new THREE.Geometry);h.geometry.copy(new THREE.Geometry);k.geometry.copy(new THREE.Geometry);C.geometry.copy(new THREE.Geometry);B.geometry.copy(new THREE.Geometry);t.geometry.copy(new THREE.Geometry);I.geometry.copy(new THREE.Geometry);ba.set(0,3,0);W.set(0,0,1);z[0]=
new THREE.Vector3(4,3,0);z[1]=new THREE.Vector3(-4,3,0);S&&(T=da=S=!1);this.END=!1;h.position.set(0,0,0);h.geometry.vertices[0]=ba.clone();h.geometry.vertices[1]=P.clone().add(ba);h.geometry.vertices[2]=z[0].clone();h.geometry.vertices[3]=z[1].clone();h.geometry.vertices[4]=u[0].clone();h.geometry.vertices[5]=u[1].clone();h.geometry.verticesNeedUpdate=!0};this.generate=function(){scope.path()};this.path=function(e,d,f,l,n,g,A,p,q,E){e=void 0===e?0:e;d=void 0===d?0:d;f=void 0===f?0:f;l=void 0===l?
0:l;n=void 0===n?0:n;g=void 0===g?{start:0,end:30,angle:0,slope:0}:g;A=void 0===A?[]:A;p=void 0===p?[]:p;q=void 0===q?!1:q;E=void 0===E?999:E;var w=window.performance.now(),Q=0;for(0===l&&(l=.5<scope.random()?1:-1);32>Q&&!da;){if(e===g.end+1){p=[];for(f=0;1>f;f++)if(e>=scope.length)p.push({angle:0,slope:0,end:30}),E=e+30;else if(0===d){Q=scope.randomInt(2,4)*l;var J=Math.floor(Math.abs(36/Q));l=.01>scope.random()?1*l:-1*l;J=scope.randomInt(1,J);p.push({angle:Q,slope:0,end:J})}else Q=scope.randomInt(-5,
-1),Q=.2>scope.random()?Q*=-1:Q,J=scope.randomInt(2,20),p.push({angle:0,slope:Q,end:J});Q=scope.randomInt(0,p.length);d=p[Q].angle;f=p[Q].slope;g.start=e;g.end=e+p[Q].end;p=p.slice(Q,1)}q||(scope.extrude(d,f),N.push({angle:d,slope:f}),K.verticesNeedUpdate=!0,e++);if(10<=e&&!q){Q=new THREE.Vector2(K.vertices[e-1].x,K.vertices[e-1].y);for(J=0;J<K.vertices.length-1-10;J++)if(18>(new THREE.Vector2(K.vertices[J].x,K.vertices[J].y)).distanceTo(Q)){q=!0;break}q&&window.setTimeout(stage.reset(!0),0)}e===
E&&(da=!0,G.geometry.dispose(),G.geometry=K.clone(),G.geometry.computeBoundingSphere(),G.geometry.center(),G.updateMatrixWorld(),0<G.geometry.vertices.length&&(O.copy(G.geometry.vertices[0]),O.sub(K.vertices[0])),window.setTimeout(function(){scope["import"]()},0));Q=window.performance.now()-w}da||q||window.setTimeout(scope.path,0,e,d,f,l,n,g,A,p,q,E)};this["import"]=function(e){e=void 0===e?0:e;for(var d=window.performance.now(),f=0;!T&&32>f;){0===e&&(h.position.set(0,0,0),h.rotation.z=0,ba.set(0,
3,0),h.geometry.vertices[0]=ba.clone(),h.geometry.vertices[1]=P.clone().add(ba),h.geometry.vertices[2]=z[0].clone(),h.geometry.vertices[3]=z[1].clone(),h.geometry.vertices[4]=u[0].clone(),h.geometry.vertices[5]=u[1].clone(),h.geometry.verticesNeedUpdate=!0,h.updateMatrixWorld());if(e<N.length)angle=N[e].angle,slope=N[e].slope,scope.extrude(angle,slope),k.geometry.dispose(),k.geometry=U.clone(),k.geometry.computeBoundingSphere(),C.geometry.dispose(),C.geometry=r.clone(),C.geometry.computeBoundingSphere(),
B.geometry.dispose(),B.geometry=X.clone(),B.geometry.computeBoundingSphere(),e++;else if(!T&&e===N.length){scope.checkpoints=scope.checkpoint();for(var l in scope.checkpoints)scene.add(scope.checkpoints[l].display);T=!0;window.setTimeout(function(){scope.terrain(!0)},0)}f=window.performance.now()-d}T||window.setTimeout(scope["import"],0,e,angle,slope)};this.extrude=function(e,d){e=void 0===e?0:e;d=void 0===d?0:d;h.updateMatrixWorld();h.rotateZ(e*Y);for(var f in h.geometry.vertices)h.geometry.vertices[f].applyAxisAngle(ea,
d*F);h.geometry.verticesNeedUpdate=!0;f=h.geometry.vertices[0].clone();var l=h.geometry.vertices[2].clone(),n=h.geometry.vertices[3].clone(),g=h.geometry.vertices[1].clone();f.applyMatrix4(h.matrix);l.applyMatrix4(h.matrix);n.applyMatrix4(h.matrix);g.applyMatrix4(h.matrix);g.sub(f);if(da){l.add(O);n.add(O);if(0<U.vertices.length){var A=U.vertices[U.vertices.length-1].clone().sub(y),p=U.vertices[U.vertices.length-2].clone().sub(y);X.vertices.push(l.clone().sub(g));X.vertices.push(n.clone().sub(g));
X.vertices.push(p);X.vertices.push(n.clone().sub(g));X.vertices.push(A);X.vertices.push(p);A=l.clone();p=n.clone();var q=U.vertices[U.vertices.length-1].clone(),E=U.vertices[U.vertices.length-2].clone();I.geometry.vertices.push(A);I.geometry.vertices.push(p);I.geometry.vertices.push(E);I.geometry.vertices.push(p);I.geometry.vertices.push(q);I.geometry.vertices.push(E);A=X.vertices.length;X.faces.push(new THREE.Face3(A-3,A-2,A-1));X.faces.push(new THREE.Face3(A-5,A-4,A-6));I.geometry.faces.push(new THREE.Face3(A-
3,A-2,A-1));I.geometry.faces.push(new THREE.Face3(A-5,A-4,A-6))}0<r.vertices.length?(p=2,A=1,4<r.vertices.length&&(p=4,A=2),p=r.vertices[r.vertices.length-p].clone(),A=r.vertices[r.vertices.length-A].clone(),r.vertices.push(l.clone().add(g.clone())),r.vertices.push(p.clone()),r.vertices.push(n.clone().add(g.clone())),r.vertices.push(A.clone()),a==N.length-1&&(r.vertices.push(l.clone().add(g.clone())),r.vertices.push(n.clone().add(g.clone())))):(r.vertices.push(l.clone().add(g.clone())),r.vertices.push(n.clone().add(g.clone())));
U.vertices.push(l.clone());U.vertices.push(n.clone());y.copy(g)}else K.vertices.push(f.clone());ba.copy(f).sub(h.position);h.position.add(ba);for(var w in h.geometry.vertices)h.geometry.vertices[w].applyAxisAngle(ea,-1*d*F)};this.terrain=function(e,d,f,l,n,g,A){d=void 0===d?[]:d;f=void 0===f?[]:f;l=void 0===l?[]:l;n=void 0===n?0:n;g=void 0===g?0:g;A=void 0===A?0:A;if(void 0===e||e){k.updateMatrixWorld();t.geometry.dispose();t.geometry.copy(new THREE.Geometry);d=[];f=[];l=[];for(e=0;2>e;e++)l[e]=[],
d[e]=[],f[e]=[];for(e=0;e<k.geometry.vertices.length;e++)f[e%2].push(k.geometry.vertices[e]);for(e=0;2>e;e++)for(var p=0;p<f[e].length;p++){var q=0===e?1:-1,E=f[e][p].clone();E.sub(f[e+q][p]);E.normalize().multiplyScalar(3);l[e][p]=E.clone()}}p=0;e=window.performance.now();if(4>n){t.geometry.verticesNeedUpdate=!0;t.geometry.elementsNeedUpdate=!0;t.geometry.computeBoundingSphere();t.geometry.computeFaceNormals();t.geometry.computeVertexNormals();t.updateMatrixWorld();if(0<n&&0===A)for(f[g]=[],q=0;q<
d[g].length;q++)f[g][q]=t.geometry.vertices[d[g][q]];0===A&&(d[g]=[]);for(v=A;v<f[g].length&&32>p;){p=!1;if(void 0!==f[g][v]&&void 0!==f[g][v-1]){if(void 0===l[g][v])l[g][v]=l[s][v-1].clone();else if(t.geometry.computeBoundingSphere(),q=f[g][v].clone().add(l[g][v]),q.z-=100,ja.set(q,P),q.z+=100,E=ja.intersectObjects([t],!0),0<E.length)for(var w in E).01<E[w].point.distanceTo(q)&&(d[g][v]=void 0,p=!0);p||(t.geometry.vertices.push(f[g][v].clone()),t.geometry.vertices.push(f[g][v].clone().add(l[g][v])),
d[g][v]=t.geometry.vertices.length-1,0<v&&(t.geometry.vertices.push(f[g][v-1].clone()),p=t.geometry.vertices.length,0===g?t.geometry.faces.push(new THREE.Face3(p-2,p-1,p-3)):1===g&&t.geometry.faces.push(new THREE.Face3(p-1,p-2,p-3))))}p=window.performance.now()-e;v++;A=v}if(A===f[g].length){A=0;for(w=1;w<d[g].length;w++)void 0!==d[g][w]&&void 0!==d[g][w-1]&&(e=t.geometry.vertices[d[g][w]],p=t.geometry.vertices[d[g][w-1]],2.8>e.distanceTo(p)?(e.copy(p),d[g][w]=d[g][w-1],l[g][w].copy(l[g][w-1])):1<
w&&(t.geometry.vertices.push(f[g][w-1]),t.geometry.faces.push(new THREE.Face3(0===g?d[g][w]:d[g][w-1],0===g?d[g][w-1]:d[g][w],t.geometry.vertices.length-1))));g++}1<g&&(g=0,n++)}if(4===n){t.geometry.verticesNeedUpdate=!0;t.geometry.elementsNeedUpdate=!0;t.geometry.colorsNeedUpdate=!0;t.geometry.computeFaceNormals();t.geometry.computeVertexNormals();t.geometry.mergeVertices();t.geometry.computeBoundingSphere();scope.noise(t.geometry);for(w=0;w<t.geometry.faces.length;w++)e=t.geometry.vertices[t.geometry.faces[w].a].clone(),
p=t.geometry.vertices[t.geometry.faces[w].b].clone(),q=t.geometry.vertices[t.geometry.faces[w].c].clone(),I.geometry.vertices.push(e),I.geometry.vertices.push(p),I.geometry.vertices.push(q),wireframe.geometry.vertices.push(e),wireframe.geometry.vertices.push(p),wireframe.geometry.vertices.push(q),e=I.geometry.vertices.length,I.geometry.faces.push(new THREE.Face3(e-1,e-2,e-3)),wireframe.geometry.faces.push(new THREE.Face3(e-1,e-2,e-3));wireframe.geometry.copy(t.geometry);wireframe.geometry.computeVertexNormals();
scope.biome();window.setTimeout(scope.complete,0)}else window.setTimeout(function(){scope.terrain(!1,d.slice(),f.slice(),l.slice(),n,g,A)},0)};this.biome=function(){for(var e=m,d=wireframe.geometry.faces,f=[],l=[],n=0;n<d.length;n++)for(var g=0;g<b[m].map.length;g++)d[n].vertexColors[0]=b[m].map[g](d[n].vertexNormals[0].z,d[n].a),d[n].vertexColors[1]=b[m].map[g](d[n].vertexNormals[1].z,d[n].b),d[n].vertexColors[2]=b[m].map[g](d[n].vertexNormals[2].z,d[n].c);for(d=0;d<b[m].flags.length;d++)for(n=0;n<
k.geometry.vertices.length;n++).1>wireframe.geometry.vertices[d].distanceTo(k.geometry.vertices[n])&&(b[m].flags[d]=!1);for(d=0;d<b[m].flags.length;d++)b[m].flags[d]&&f.push(d);for(d=0;d<b[m].limit&&d<f.length;){n=scope.randomInt(0,f.length);g=!0;if(0<l.length&&0<f.length)for(;g;){for(var A in l)if(wireframe.geometry.vertices[f[n]].distanceTo(wireframe.geometry.vertices[l[A]])<b[m].range){g=!0;f.slice(n,1);n=scope.randomInt(0,f.length);break}else g=!1;0>=f.length&&(g=!1)}if(0<f.length){g=b[e].tree();
for(var p in g.vertices)H.geometry.vertices.push(g.vertices[p].clone().add(wireframe.geometry.vertices[f[n]])),H.geometry.colors[H.geometry.vertices.length-1]=g.colors[p];l.push(f[n]);f.slice(n,1)}d++}H.verticesNeedUpdate=!0;H.elementsNeedUpdate=!0;scene.add(H)};this.sakura=function(){var e=new THREE.Geometry,d=[],f=[],l=1,n=new THREE.Vector3(0,0,0),g=new THREE.Vector3(0,0,3),A=12,p=0,q=new THREE.Vector3(1,0,0),E=new THREE.Vector3(0,0,1);e.vertices.push(n);e.vertices.push(g);e.colors.push(palette[2]);
e.colors.push(palette[2]);f.push({v:g.clone(),n:g.clone(),pitch:q.clone(),roll:E.clone()});for(n=[];4>p;){g=[];for(q=0;q<f.length;q++)for(var w=E=0;3>w;w++){var Q=0===p&&2===w&&1>E?1:scope.random();if(.2<Q){Q=scope.randomInt(-2,2);var J=f[q].n.clone(),aa=palette[2];J.applyAxisAngle(f[q].pitch,2*Math.PI/(A+Q));J.applyAxisAngle(f[q].roll,2*Math.PI/3*w);J.multiplyScalar(l);Q=J.clone().add(f[q].v);e.vertices.push(f[q].v.clone());e.vertices.push(Q);e.colors.push(aa);e.colors.push(aa);aa=f[q].pitch.clone();
aa.applyAxisAngle(f[q].roll,2*Math.PI/3*w);aa.applyAxisAngle(f[q].pitch,2*Math.PI/A);var ia=f[q].roll.clone();ia.applyAxisAngle(f[q].pitch,2*Math.PI/A);ia.applyAxisAngle(f[q].roll,2*Math.PI/3*w);0<w&&d.push({a:Q.clone(),b:f[q].v.clone(),pitch:aa,roll:ia});g.push({v:Q.clone(),n:J.clone(),pitch:aa,roll:ia});E++}else 0===E&&2===w&&n.push({v:f[q].v.clone(),n:f[q].n.clone(),pitch:f[q].pitch.clone(),roll:f[q].roll.clone()})}f=g.slice();l*=.9;p++}A=6;for(var V in d)l=d[V].a.clone(),p=d[V].b.clone(),l=l.clone().sub(p),
g=l.clone().multiplyScalar(.5).add(p),p=scope.randomInt(0,3)-1,l.applyAxisAngle(d[V].pitch,2*Math.PI/A),l.applyAxisAngle(d[V].roll,2*Math.PI/p),l.multiplyScalar(.5),q=g,g=l.clone().add(g),e.vertices.push(q),e.vertices.push(g),e.colors.push(palette[2]),e.colors.push(palette[2]),q=d[V].pitch.clone(),q.applyAxisAngle(d[V].roll,2*Math.PI/p),q.applyAxisAngle(d[V].pitch,2*Math.PI/A),E=d[V].roll.clone(),E.applyAxisAngle(d[V].pitch,2*Math.PI/A),E.applyAxisAngle(d[V].roll,2*Math.PI/p),f.push({v:g.clone(),
n:l.clone(),pitch:q,roll:E});f=f.concat(n);for(d=0;d<f.length;d++)for(A=0;5>A;A++)V=f[d].n.clone(),V.normalize(),V.applyAxisAngle(f[d].pitch,2*Math.PI/6),V.applyAxisAngle(f[d].roll,2*Math.PI/5*A),V.multiplyScalar(.5),V=V.add(f[d].v),n=f[d].v.clone(),e.vertices.push(V),e.vertices.push(n),e.colors.push(palette[12]),e.colors.push(palette[12]);e.colorsNeedUpdate=!0;return e};this.pine=function(){var e=Math.floor(8*scope.random())+6,d=2*Math.PI/6,f=new THREE.Geometry;f.vertices.push(new THREE.Vector3(0,
0,0));f.vertices.push(new THREE.Vector3(0,0,1*e-.5+1));f.colors.push(palette[9]);f.colors.push(palette[9]);f.colors.push(palette[9]);for(var l=1;l<e;l++)for(var n=0;6>n;n++)off=l%2*d*.5,f.vertices.push(new THREE.Vector3(0,0,1*l+1)),f.vertices.push(new THREE.Vector3(.3*(e-l),0,1*l-.3+1)),f.vertices[f.vertices.length-1].applyAxisAngle(P,d*n+off),f.colors.push(palette[9]),f.colors.push(palette[9]);return f};this.checkpoint=function(){function e(n,g,A){var p=new THREE.Geometry,q=(new THREE.Vector3).copy(n).sub(g),
E=(new THREE.Vector3).copy(n).add(q.clone().multiplyScalar(1.5));q=(new THREE.Vector3).copy(g).sub(q.clone().multiplyScalar(1.5));p.vertices.push(new THREE.Vector3(E.x,E.y,E.z-12));p.vertices.push(new THREE.Vector3(E.x,E.y,E.z+12));p.vertices.push(new THREE.Vector3(q.x,q.y,q.z+12));p.vertices.push(new THREE.Vector3(q.x,q.y,q.z+12));p.vertices.push(new THREE.Vector3(q.x,q.y,q.z-12));p.vertices.push(new THREE.Vector3(E.x,E.y,E.z-12));p.faces.push(new THREE.Face3(0,1,2));p.faces.push(new THREE.Face3(3,
4,5));E=new THREE.Geometry;E.vertices.push(new THREE.Vector3(n.x,n.y,n.z+6));E.vertices.push(new THREE.Vector3(n.x,n.y,n.z+8));E.vertices.push(new THREE.Vector3(g.x,g.y,g.z+6));E.vertices.push(new THREE.Vector3(g.x,g.y,g.z+8));E.vertices.push(new THREE.Vector3(n.x,n.y,n.z+6));E.vertices.push(new THREE.Vector3(g.x,g.y,g.z+6));E.vertices.push(new THREE.Vector3(n.x,n.y,n.z+8));E.vertices.push(new THREE.Vector3(g.x,g.y,g.z+8));E.vertices.push(new THREE.Vector3(n.x,n.y,n.z+1));E.vertices.push(new THREE.Vector3(g.x,
g.y,g.z+1));n=new THREE.MeshBasicMaterial({side:THREE.DoubleSide,wireframe:!1,fog:!0});n.color=palette[5];p=new THREE.Mesh(p,n);p.visible=!0;n=new THREE.LineSegments(E,n);p.name="Objective "+A;n.name="Checkpoint"+A;return{display:n,collision:p}}var d=k.geometry,f=d.vertices.length-80;f=Math.floor(f/4)-Math.floor(f/4)%2;var l=[];l[0]=e(d.vertices[40],d.vertices[41],0);l[1]=e(d.vertices[f+40],d.vertices[f+1+40],1);l[2]=e(d.vertices[2*f+40],d.vertices[2*f+41],2);l[3]=e(d.vertices[3*f+40],d.vertices[3*
f+41],3);l[4]=e(d.vertices[4*f+40],d.vertices[4*f+41],4);this.DISTANCE=4*f/2*3;scope.start.copy(d.vertices[36]);scope.start.sub(d.vertices[37]);scope.start.multiplyScalar(-.75);scope.start.add(d.vertices[36]);for(d=0;4>d;d++)stage.best[d]=CHALLENGE?OBJECTIVES[d]:f*(d+1)/ha;state.target();return l};this.resetCheckpoints=function(){for(var e in scope.checkpoints)scope.checkpoints[e].display.material.color=palette[5]};this.random=function(){SEED=(SEED+1)%2147483647;var e=1E4*Math.sin(SEED);return e-=
Math.floor(e)};this.randomInt=function(e,d){return Math.floor(scope.random()*(d-e))+e};this.noise=function(e){for(var d=new ImprovedNoise,f=[],l=8,n=0,g=0,A=1E3*scope.random(),p=0;p<e.vertices.length;p++)f[p]=0;for(p=0;2>p;p++){for(var q=0;q<e.vertices.length;q++)f[q]+=Math.floor(d.noise(e.vertices[q].x/l,e.vertices[q].y/l,A)*l),f[q]>n&&(n=f[q]),f[q]<g&&(g=f[q]);l*=3}for(d=0;d<f.length;d++){l=.5;for(n=0;n<k.geometry.vertices.length;n++)g=e.vertices[d].distanceTo(k.geometry.vertices[n]),g=g*g/100,
g<l&&(l=g);e.vertices[d].z+=f[d]*l}};this.name=function(){var e=" pass; line; forest; summit; route; path; mountain; park".split(";"),d="n wa ra ya ma ha na ta ka a wi ri mi hi ni chi shi ki i ru yu mu fu nu tsu su ku u we re me he ne te se ke e wo ro yo mo no to so ko o".split(" ");TOGGLE=!1;for(var f=Math.ceil(3*Math.random())+1,l="",n=0;n<f;)l+=d[Math.floor(Math.random()*d.length)],n++;return l+=e[Math.floor(Math.random()*e.length)]}};function VHS(a){var b=this;this.PLAY=!1;this.RECORD=!0;this.tape=[];this.timer=0;this.AT=function(){return b.tape[m].timer};var m=0;this.capture=function(h){return{position:(new THREE.Vector3).copy(h.position),normal:(new THREE.Vector3).copy(h.normal),direction:(new THREE.Vector3).copy(h.dir),lookAt:h.lookAt.clone(),rotation:h.rotation,timer:h.getTime(),objective:h.getObjective(),check:h.check,UP:h.UP}};this.record=function(h){this.tape[m]=h.record();m++;m%=18E3;17999==m&&console.log("VHS OVERWRITE")};
this.play=function(h){this.RECORD&&(this.RECORD=!1,TIMEOUT=m=0);0===m&&stage.generate.resetCheckpoints();h.replay(this.tape[m]);this.tape[m].check&&(stage.generate.checkpoints[0===this.tape[m].objective?4:this.tape[m].objective-1].display.material.color=palette[4]);this.timer=this.tape[m].timer;m++;m%=this.tape.length;0===m&&stage.generate.resetCheckpoints()};this.reset=function(){m=0;stage.generate.resetCheckpoints();b.PLAY=!1;b.RECORD=!0;b.tape=[]};this["export"]=function(){for(var h="",G=0;G<b.tape.length;G++)h+=
b.tape[G].position.x+" "+b.tape[G].position.y+" "+b.tape[G].position.z,h+="/n";return h}};