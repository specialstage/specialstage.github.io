(()=>{function Control(){var o=this;this.MOBILE=!1,this.UP=!1,this.DOWN=!1,this.BACK=!1,this.FORWARD=!1,this.LEFT=!1,this.RIGHT=!1,this.ENTER=!1,this.GAMEPAD=!1,this.BINDINGS=!1,this.touches=[],this.connect=function(){this.MOBILE?(window.addEventListener("touchstart",o.touch,!1),window.addEventListener("touchmove",o.touch,!1),window.addEventListener("touchend",o.touch,!1)):(window.addEventListener("keydown",o.key,!1),window.addEventListener("keyup",o.key,!1),window.addEventListener("mousedown",o.mousedown),window.addEventListener("mouseup",o.mouseup,!1),window.addEventListener("touchstart",o.touchSetup,!1))},this.disconnect=function(){window.removeEventListener("keydown",o.key,!1),window.removeEventListener("keyup",o.key,!1),window.removeEventListener("mousedown",o.mousedown,!1),window.removeEventListener("mouseup",o.mouseup,!1),window.removeEventListener("touchstart",o.touchSetup,!1),window.removeEventListener("touchstart",o.touch,!1),window.removeE,ventListener("touchmove",o.touch,!1),window.removeEventListener("touchend",o.touch,!1)},this.key=function(e){var t="keydown"==e.type;switch(e.key){case"ArrowUp":o.UP=t;break;case"ArrowDown":o.DOWN=t;break;case"ArrowLeft":o.LEFT=t;break;case"ArrowRight":o.RIGHT=t;break;case"w":o.UP=t;break;case"s":o.DOWN=t;break;case"a":o.LEFT=t;break;case"d":o.RIGHT=t;break;case"r":o.RESET=t;break;case" ":o.SPACE=t;break;case"Enter":o.ENTER=t}},this.mousedown=function(e){e.preventDefault(),o.touches[0]={x:e.clientX,y:e.clientY,start:!0}},this.mouseup=function(e){e.preventDefault(),o.touches[0]={x:e.clientX,y:e.clientY,start:!1}},this.touchSetup=function(e){window.removeEventListener("keydown",o.key,!1),window.removeEventListener("keyup",o.key,!1),window.removeEventListener("keyup",o.key,!1),window.removeEventListener("mousedown",o.mousedown,!1),window.removeEventListener("mouseup",o.mouseup,!1),window.removeEventListener("touchstart",o.touchSetup,!1),window.addEventListener("touchstart",o.touchstart,!1),window.addEventListener("touchmove",o.touchmove,!1),window.addEventListener("touchend",o.touchend,!1),o.touchstart(e)},this.clear=function(){o.touches=[],this.UP=!1,this.DOWN=!1,this.LEFT=!1,this.RIGHT=!1,this.ENTER=!1},this.touchstart=function(e){var t=e.touches;o.touches=[];for(let e=0;e<t.length;e++)o.touches[e]={x:t[e].clientX,y:t[e].clientY,start:!0}},this.touchmove=function(e){o.touches=[];var t=e.touches;for(let e=0;e<t.length;e++)o.touches[e]={x:t[e].clientX,y:t[e].clientY,start:!1}},this.touchend=function(e){o.touches=[];var t=e.touches;for(let e=0;e<t.length;e++)o.touches[e]={x:t[e].clientX,y:t[e].clientY,start:!1}}}function Generate(){(scope=this).SEED=0;let g=0;this.length=480;const l=[];let E=0;l[0]={name:"forest",palette:palette[9],tree:function(e,t){return scope.pine()},limit:Math.floor(scope.length/2),range:5,map:[],flags:[]},l[0].map[0]=function(e,t){let o=palette[10],i=!1;return.92<Math.abs(e)&&(o=.92<Math.abs(e)?palette[9]:palette[2],i=!0),l[0].flags[t]=i,o},l[1]={name:"sakura",palette:palette[12],tree:function(){return scope.sakura()},limit:Math.floor(scope.length*(1/6)),range:10,map:[],flags:[]},l[1].map[0]=function(e,t){let o=palette[1],i=!1;return.95<Math.abs(e)&&(o=.92<Math.abs(e)?palette[12]:palette[1],i=!0),l[1].flags[t]=i,o},l[2]={name:"summit",palette:palette[1],tree:function(){return new THREE.Geometry},limit:0,range:10,map:[],flags:[]},l[2].map[0]=function(e,t){let o=palette[7],i=!1;return.95<Math.abs(e)&&(o=.92<Math.abs(e)?palette[2]:palette[7],i=!0),l[2].flags[t]=i,o};const f=new THREE.Points(new THREE.Geometry);f.name="Generative Extruder",f.visible=!1;const T=new THREE.Line(new THREE.Geometry);T.name="Generative Nodes",T.visible=!1,T.material.color=palette[6],T.material.name="Node Material",T.position.z+=2;const w=new THREE.LineSegments(new THREE.Geometry);w.name="Generative Segments",w.visible=!0,w.material.color=palette[3],w.material.name="Segments Material";const n=new THREE.Mesh(new THREE.Geometry);n.name="Generative Surface",n.visible=!1,n.material.color=palette[0],n.material.name="Surface Material";const r=new THREE.LineSegments(new THREE.Geometry);r.name="Generative Perimeter",r.material.color=palette[1],r.material.name="Perimeter Material";const y=new THREE.Mesh(new THREE.Geometry,new THREE.MeshBasicMaterial({vertexColors:THREE.VertexColors}));y.name="Terrain",y.material.name="Terrain Material",y.material.wireframe=!0,y.material.side=THREE.DoubleSide,y.visible=!0,wireframe=new THREE.Mesh(new THREE.Geometry,new THREE.MeshBasicMaterial({vertexColors:THREE.VertexColors})),wireframe.name="Wireframe",wireframe.material.name="Wireframe Material",wireframe.material.wireframe=!0,wireframe.material.side=THREE.FrontSide,wireframe.visible=!0;const u=new THREE.LineSegments(new THREE.Geometry,new THREE.LineBasicMaterial({vertexColors:THREE.VertexColors}));u.name="Trees";const i=new THREE.Mesh(new THREE.Geometry,new THREE.MeshBasicMaterial);i.name="Background",i.material.color=palette[0],i.material.name="Background Material",i.material.wireframe=!1,i.material.side=THREE.FrontSide,i.material.opacity=.75,i.material.blendMode=THREE.MultiplyBlending,i.material.transparent=!0;const a=new THREE.Points(new THREE.Geometry);a.material.color=palette[1],a.material.sizeAttenuation=!1,a.material.size=1.5,a.material.fog=!1,scope.stars=a;const A=new THREE.Mesh(new THREE.Geometry,new THREE.MeshBasicMaterial);A.name="Collision Mesh",A.visible=!0,A.material.name="Collision Material",A.material.side=THREE.BackSide,this.checkpoints=[];const R=new THREE.Vector3(0,0,1);var I=new THREE.Vector3(1,0,0);new THREE.Vector3(0,1,0),new THREE.Vector3(0,0,1);const S=new THREE.Vector3(0,3,0),e=new THREE.Vector3(0,0,1),b=T.geometry.clone(),M=n.geometry.clone(),H=w.geometry.clone(),N=r.geometry.clone(),c=[],h=[],L=new THREE.Vector3;c[0]=new THREE.Vector3(5,3,0),c[1]=new THREE.Vector3(-5,3,0),h[0]=c[0].clone(),h.z+=1,h[1]=c[1].clone(),h.z+=1;var O=Math.PI/64,D=Math.PI/32;let x=[];let p=0,k=new THREE.Vector3;this.start=new THREE.Vector3;let m=!1,C=!1;let d=!1;this.END=!1,this.IMPORT=!1,this.DISTANCE=0;let B=18;const P=new THREE.Raycaster;P.far=800,f.geometry.vertices[0]=S.clone(),f.geometry.vertices[1]=R.clone().add(S),f.geometry.vertices[2]=c[0].clone(),f.geometry.vertices[3]=c[1].clone(),f.geometry.vertices[4]=h[0].clone(),f.geometry.vertices[5]=h[1].clone(),this.connect=function(){scope.SEED=SEED,E=scope.randomInt(0,3),stage.SNOW=2===E,stage.SNOW&&stage.snow.init(),scene.add(f),scene.add(T),scene.add(w),scene.add(r),scene.add(n),scene.add(wireframe),scene.add(i),p=window.performance.now(),window.setTimeout(scope.generate,0)},this.disconnect=function(){for(var e in x=[],scene.remove(f),scene.remove(T),scene.remove(w),scene.remove(r),scene.remove(n),scene.remove(wireframe),scene.remove(i),scene.remove(u),l)l[e].flag=[];for(var t in scope.checkpoints)scene.remove(scope.checkpoints[t].display),scope.checkpoints[t].display.geometry.dispose(),scope.checkpoints[t].collision.geometry.dispose()},this.complete=function(){A.geometry.mergeVertices(),A.geometry.verticesNeedUpdate=!0,A.geometry.elementsNeedUpdate=!0,A.geometry.computeFaceNormals(),A.geometry.computeVertexNormals(),A.geometry.computeBoundingSphere(),i.geometry.copy(A.geometry),--i.position.z;let t=[];for(let e=0;e<A.geometry.faces.length;e++)t[A.geometry.faces[e].a]=A.geometry.faces[e].vertexNormals[0].clone(),t[A.geometry.faces[e].b]=A.geometry.faces[e].vertexNormals[1].clone(),t[A.geometry.faces[e].c]=A.geometry.faces[e].vertexNormals[2].clone();for(let e=0;e<A.geometry.vertices.length;e++)A.geometry.vertices[e].add(t[e].multiplyScalar(2));A.geometry.verticesNeedUpdate=!0,wireframe.geometry.mergeVertices(),wireframe.geometry.verticesNeedUpdate=!0,wireframe.geometry.elementsNeedUpdate=!0,wireframe.geometry.computeFaceNormals(),wireframe.geometry.computeBoundingSphere();const e=new THREE.IcosahedronGeometry(1200,4);for(var o in e.vertices)scope.random()<.4&&-400<e.vertices[o].z&&a.geometry.vertices.push(e.vertices[o].clone());e.dispose(),a.geometry.computeBoundingSphere(),stage.surface=A.clone(),stage.start=scope.start.clone(),p=window.performance.now()-p,m=!0,scope.END=!0,FIREBASE&&firebase.analytics().logEvent("stage_generation_complete",{time:Math.round(p/1e3)}),BATTLE?(ui.clear(),vehicle.connect(stage.start,stage.surface),vehicle.PLAY=!1,vhs.PLAY=!0):state.ready()},this.reset=function(){B=(36+scope.random()-.5)/2,g=0,T.geometry.dispose(),w.geometry.dispose(),n.geometry.dispose(),f.geometry.dispose(),r.geometry.dispose(),y.geometry.dispose(),wireframe.geometry.dispose(),A.geometry.dispose(),u.geometry.dispose(),a.geometry.dispose(),H.dispose(),N.dispose(),b.dispose(),M.dispose(),H.copy(new THREE.Geometry),N.copy(new THREE.Geometry),b.copy(new THREE.Geometry),M.copy(new THREE.Geometry),T.geometry.copy(new THREE.Geometry),f.geometry.copy(new THREE.Geometry),w.geometry.copy(new THREE.Geometry),r.geometry.copy(new THREE.Geometry),n.geometry.copy(new THREE.Geometry),y.geometry.copy(new THREE.Geometry),A.geometry.copy(new THREE.Geometry),S.set(0,3,0),e.set(0,0,1),c[0]=new THREE.Vector3(4,3,0),c[1]=new THREE.Vector3(-4,3,0),m&&(m=!1,C=!1,d=!1),this.END=!1,f.position.set(0,0,0),f.geometry.vertices[0]=S.clone(),f.geometry.vertices[1]=R.clone().add(S),f.geometry.vertices[2]=c[0].clone(),f.geometry.vertices[3]=c[1].clone(),f.geometry.vertices[4]=h[0].clone(),f.geometry.vertices[5]=h[1].clone(),f.geometry.verticesNeedUpdate=!0},this.generate=function(){scope.path()},this.path=function(t=0,o=0,e=0,i=0,n=0,r={start:0,end:30,angle:0,slope:0},s=[],a=[],c=!1,l=999){var u=window.performance.now();let h=0;for(0===i&&(i=.5<scope.random()?1:-1);h<32&&!C;){if(t===r.end+1){a=[];for(let e=0;e<1;e++)if(t>=scope.length)a.push({angle:0,slope:0,end:30}),l=t+30;else if(0===o){var p=scope.randomInt(2,4)*i,m=Math.floor(Math.abs(36/p));i=scope.random()<.01?+i:-1*i;m=scope.randomInt(1,m);a.push({angle:p,slope:0,end:m})}else{let e=scope.randomInt(-5,-1);m=scope.random();e=2!==E&&m<.05?e*=-1:e;m=scope.randomInt(2,20);a.push({angle:0,slope:e,end:m})}var d=scope.randomInt(0,a.length);o=a[d].angle,e=a[d].slope,r.start=t,r.end=t+a[d].end,a=a.slice(d,1)}if(c||(scope.extrude(o,e),x.push({angle:o,slope:e}),b.verticesNeedUpdate=!0,t++),10<=t&&!c){var g=new THREE.Vector2(b.vertices[t-1].x,b.vertices[t-1].y);for(let t=0;t<b.vertices.length-1-10;t++){let e=new THREE.Vector2(b.vertices[t].x,b.vertices[t].y);if(e.distanceTo(g)<18){c=!0;break}}c&&window.setTimeout(stage.reset(!0),0)}0,t===l&&(C=!0,T.geometry.dispose(),T.geometry=b.clone(),T.geometry.computeBoundingSphere(),T.geometry.center(),T.updateMatrixWorld(),0<T.geometry.vertices.length&&(k.copy(T.geometry.vertices[0]),k.sub(b.vertices[0])),window.setTimeout(function(){scope.import()},0)),h=window.performance.now()-u}C||c||window.setTimeout(scope.path,0,t,o,e,i,n,r,s,a,c,l)},this.skijump=function(e=0,t=0,o=0,i=0,n=0,r={start:0,end:20,angle:0,slope:0},s=[],a=[],c=!1,l=300,u=0){var h=window.performance.now();let p=0;for(0===i&&(i=.5<scope.random()?1:-1);p<32&&!C;){if(e===r.end+1){a=[];for(let e=0;e<1;e++)0===o&&20===r.end?(u=-1,a.push({angle:0,slope:-4,end:30})):3===o?a.push({angle:0,slope:4,end:3}):4===o?a.push({angle:0,slope:-32,end:10}):-4===o?(u=1,a.push({angle:0,slope:o+1,end:1})):-32===o?a.push({angle:0,slope:-4,end:40}):1==u?a.push({angle:0,slope:o+1,end:1}):-1==u&&a.push({angle:0,slope:o-1,end:1});var m=scope.randomInt(0,a.length);t=a[m].angle,o=a[m].slope,r.start=e,r.end=e+a[m].end,a=a.slice(m,1)}if(c||(scope.extrude(t,o),x.push({angle:t,slope:o}),b.verticesNeedUpdate=!0,e++),10<=e&&!c){var d=new THREE.Vector2(b.vertices[e-1].x,b.vertices[e-1].y);for(let t=0;t<b.vertices.length-1-10;t++){let e=new THREE.Vector2(b.vertices[t].x,b.vertices[t].y);if(e.distanceTo(d)<0){c=!0;break}}c&&window.setTimeout(stage.reset(!0),0)}0,l<=e&&(C=!0,T.geometry.dispose(),T.geometry=b.clone(),T.geometry.computeBoundingSphere(),T.geometry.center(),T.updateMatrixWorld(),0<T.geometry.vertices.length&&(k.copy(T.geometry.vertices[0]),k.sub(b.vertices[0])),window.setTimeout(function(){scope.import()},0)),p=window.performance.now()-h}C||c||window.setTimeout(scope.skijump,0,e,t,o,i,n,r,s,a,c,l)},this.import=function(e=0){var t=window.performance.now();let o=0;for(;!d&&o<32;){if(0===e&&(f.position.set(0,0,0),f.rotation.z=0,S.set(0,3,0),f.geometry.vertices[0]=S.clone(),f.geometry.vertices[1]=R.clone().add(S),f.geometry.vertices[2]=c[0].clone(),f.geometry.vertices[3]=c[1].clone(),f.geometry.vertices[4]=h[0].clone(),f.geometry.vertices[5]=h[1].clone(),f.geometry.verticesNeedUpdate=!0,f.updateMatrixWorld()),e<x.length)g=e,angle=x[e].angle,slope=x[e].slope,scope.extrude(angle,slope),w.geometry.dispose(),w.geometry=H.clone(),w.geometry.computeBoundingSphere(),r.geometry.dispose(),r.geometry=N.clone(),r.geometry.computeBoundingSphere(),n.geometry.dispose(),n.geometry=M.clone(),n.geometry.computeBoundingSphere(),e++;else if(!d&&e===x.length){for(var i in scope.checkpoints=scope.checkpoint(),scope.checkpoints)scene.add(scope.checkpoints[i].display);d=!0,window.setTimeout(function(){scope.terrain(!0)},0)}o=window.performance.now()-t}d||window.setTimeout(scope.import,0,e,angle,slope)},this.extrude=function(e=0,t=0){for(var o in f.updateMatrixWorld(),f.rotateZ(e*D),f.geometry.vertices)f.geometry.vertices[o].applyAxisAngle(I,t*O);f.geometry.verticesNeedUpdate=!0;const i=f.geometry.vertices[0].clone(),n=f.geometry.vertices[2].clone(),r=f.geometry.vertices[3].clone(),s=f.geometry.vertices[1].clone();if(i.applyMatrix4(f.matrix),n.applyMatrix4(f.matrix),r.applyMatrix4(f.matrix),s.applyMatrix4(f.matrix),s.sub(i),C){if(n.add(k),r.add(k),0<H.vertices.length){var a=H.vertices[H.vertices.length-1].clone().sub(L),c=H.vertices[H.vertices.length-2].clone().sub(L);M.vertices.push(n.clone().sub(s)),M.vertices.push(r.clone().sub(s)),M.vertices.push(c),M.vertices.push(r.clone().sub(s)),M.vertices.push(a),M.vertices.push(c);var l=n.clone(),e=r.clone(),a=H.vertices[H.vertices.length-1].clone(),c=H.vertices[H.vertices.length-2].clone();A.geometry.vertices.push(l),A.geometry.vertices.push(e),A.geometry.vertices.push(c),A.geometry.vertices.push(e),A.geometry.vertices.push(a),A.geometry.vertices.push(c);a=M.vertices.length;const h=new THREE.Face3(a-3,a-2,a-1),p=new THREE.Face3(a-5,a-4,a-6);M.faces.push(h),M.faces.push(p);const m=h.clone(),d=p.clone();m.color=new THREE.Color(16777215),d.color=new THREE.Color(16777215),A.geometry.faces.push(m),A.geometry.faces.push(d)}if(0<N.vertices.length){let e=2,t=1;4<N.vertices.length&&(e=4,t=2);let o=N.vertices[N.vertices.length-e].clone(),i=N.vertices[N.vertices.length-t].clone();N.vertices.push(n.clone().add(s)),N.vertices.push(o.clone()),N.vertices.push(r.clone().add(s)),N.vertices.push(i.clone()),g==x.length-1&&(c=n.clone().add(s),a=r.clone().add(s),N.vertices.push(c),N.vertices.push(a))}else N.vertices.push(n.clone().add(s)),N.vertices.push(r.clone().add(s));H.vertices.push(n.clone()),H.vertices.push(r.clone()),L.copy(s)}else b.vertices.push(i.clone());for(var u in S.copy(i).sub(f.position),f.position.add(S),f.geometry.vertices)f.geometry.vertices[u].applyAxisAngle(I,-1*t*O)},this.terrain=function(e=!0,i=[],n=[],r=[],t=0,a=0,c=0){if(e){w.updateMatrixWorld(),y.geometry.dispose(),y.geometry.copy(new THREE.Geometry),i=[],n=[],r=[];for(let e=0;e<2;e++)r[e]=[],i[e]=[],n[e]=[];for(let e=0;e<w.geometry.vertices.length;e++){var o=e%2;n[o].push(w.geometry.vertices[e])}for(let o=0;o<2;o++)for(let t=0;t<n[o].length;t++){var l=0===o?1:-1;let e=n[o][t].clone();e.sub(n[o+l][t]),e.normalize().multiplyScalar(3),r[o][t]=e.clone()}}let u=0;var h,p=window.performance.now();if(t<4){if(y.geometry.verticesNeedUpdate=!0,y.geometry.elementsNeedUpdate=!0,y.geometry.computeBoundingSphere(),y.geometry.computeFaceNormals(),y.geometry.computeVertexNormals(),y.updateMatrixWorld(),0<t&&0===c){n[a]=[];for(let e=0;e<i[a].length;e++)n[a][e]=y.geometry.vertices[i[a][e]]}for(0===c&&(i[a]=[]),v=c;v<n[a].length&&u<32;){let o=!1;if(void 0!==n[a][v]&&void 0!==n[a][v-1]){if(void 0===r[a][v])r[a][v]=r[s][v-1].clone();else{y.geometry.computeBoundingSphere();let e=n[a][v].clone().add(r[a][v]);e.z-=100,P.set(e,R),e.z+=100;let t=P.intersectObjects([y],!0);if(0<t.length)for(var m in t).01<t[m].point.distanceTo(e)&&(i[a][v]=void 0,o=!0)}o||(y.geometry.vertices.push(n[a][v].clone()),y.geometry.vertices.push(n[a][v].clone().add(r[a][v])),i[a][v]=y.geometry.vertices.length-1,0<v&&(y.geometry.vertices.push(n[a][v-1].clone()),h=y.geometry.vertices.length,0===a?y.geometry.faces.push(new THREE.Face3(h-2,h-1,h-3)):1===a&&y.geometry.faces.push(new THREE.Face3(h-1,h-2,h-3))))}u=window.performance.now()-p,v++,c=v}if(c===n[a].length){c=0;for(let t=1;t<i[a].length;t++)if(void 0!==i[a][t]&&void 0!==i[a][t-1]){let e=y.geometry.vertices[i[a][t]];var d,g=y.geometry.vertices[i[a][t-1]];e.distanceTo(g)<2.8?(e.copy(g),i[a][t]=i[a][t-1],r[a][t].copy(r[a][t-1])):1<t&&(y.geometry.vertices.push(n[a][t-1]),d=0===a?i[a][t]:i[a][t-1],g=0===a?i[a][t-1]:i[a][t],y.geometry.faces.push(new THREE.Face3(d,g,y.geometry.vertices.length-1)))}a++}1<a&&(a=0,t++)}if(4===t){y.geometry.verticesNeedUpdate=!0,y.geometry.elementsNeedUpdate=!0,y.geometry.colorsNeedUpdate=!0,y.geometry.computeFaceNormals(),y.geometry.computeVertexNormals(),y.geometry.mergeVertices(),y.geometry.computeBoundingSphere(),scope.noise(y.geometry);for(let t=0;t<y.geometry.faces.length;t++){var E=y.geometry.vertices[y.geometry.faces[t].a].clone(),f=y.geometry.vertices[y.geometry.faces[t].b].clone(),T=y.geometry.vertices[y.geometry.faces[t].c].clone();y.geometry.colors[y.geometry.faces[t].a],y.geometry.colors[y.geometry.faces[t].b],y.geometry.colors[y.geometry.faces[t].c];A.geometry.vertices.push(E),A.geometry.vertices.push(f),A.geometry.vertices.push(T),wireframe.geometry.vertices.push(E),wireframe.geometry.vertices.push(f),wireframe.geometry.vertices.push(T);T=A.geometry.vertices.length;let e=new THREE.Face3(T-1,T-2,T-3);e.color=new THREE.Color(0),A.geometry.faces.push(e),wireframe.geometry.faces.push(new THREE.Face3(T-1,T-2,T-3))}wireframe.geometry.copy(y.geometry),wireframe.geometry.computeVertexNormals(),scope.biome(),window.setTimeout(scope.complete,0)}else window.setTimeout(function(){scope.terrain(!1,i.slice(),n.slice(),r.slice(),t,a,c)},0)},this.biome=function(){var o=E;const i=wireframe.geometry.faces;let n=[],r=[];for(let t=0;t<i.length;t++)for(let e=0;e<l[E].map.length;e++)i[t].vertexColors[0]=l[E].map[e](i[t].vertexNormals[0].z,i[t].a),i[t].vertexColors[1]=l[E].map[e](i[t].vertexNormals[1].z,i[t].b),i[t].vertexColors[2]=l[E].map[e](i[t].vertexNormals[2].z,i[t].c);for(let t=0;t<l[E].flags.length;t++)for(let e=0;e<w.geometry.vertices.length;e++)wireframe.geometry.vertices[t].distanceTo(w.geometry.vertices[e])<.1&&(l[E].flags[t]=!1);for(let e=0;e<l[E].flags.length;e++)l[E].flags[e]&&n.push(e);let s=0;for(;s<l[E].limit&&s<n.length;){let t=scope.randomInt(0,n.length),e=!0;if(0<r.length&&0<n.length)for(;e;){for(var a in r){if(wireframe.geometry.vertices[n[t]].distanceTo(wireframe.geometry.vertices[r[a]])<l[E].range){e=!0,n.slice(t,1),t=scope.randomInt(0,n.length);break}e=!1}n.length<=0&&(e=!1)}if(0<n.length){let e=l[o].tree();for(var c in e.vertices)u.geometry.vertices.push(e.vertices[c].clone().add(wireframe.geometry.vertices[n[t]])),u.geometry.colors[u.geometry.vertices.length-1]=e.colors[c];r.push(n[t]),n.slice(t,1)}s++}u.verticesNeedUpdate=!0,u.elementsNeedUpdate=!0,scene.add(u)},this.sakura=function(){let c=new THREE.Geometry,l=[],u=[];let h=1;var r,e=new THREE.Vector3(0,0,0);let t=new THREE.Vector3(0,0,3),p=12,o=0,i=new THREE.Vector3(1,0,0),n=new THREE.Vector3(0,0,1);c.vertices.push(e),c.vertices.push(t),c.colors.push(palette[2]),c.colors.push(palette[2]),u.push({v:t.clone(),n:t.clone(),pitch:i.clone(),roll:n.clone()});let m=[];for(;o<4;){let a=[];for(let s=0;s<u.length;s++){let r=0;for(let n=0;n<3;n++){var d=0===o&&2===n&&r<1?1:scope.random();if(.2<d){d=scope.randomInt(-2,2);let e=u[s].n.clone();var g=palette[2];e.applyAxisAngle(u[s].pitch,2*Math.PI/(p+d)),e.applyAxisAngle(u[s].roll,2*Math.PI/3*n),e.multiplyScalar(h);let t=e.clone().add(u[s].v);c.vertices.push(u[s].v.clone()),c.vertices.push(t),c.colors.push(g),c.colors.push(g);let o=u[s].pitch.clone();o.applyAxisAngle(u[s].roll,2*Math.PI/3*n),o.applyAxisAngle(u[s].pitch,2*Math.PI/p);let i=u[s].roll.clone();i.applyAxisAngle(u[s].pitch,2*Math.PI/p),i.applyAxisAngle(u[s].roll,2*Math.PI/3*n),0<n&&l.push({a:t.clone(),b:u[s].v.clone(),pitch:o,roll:i}),a.push({v:t.clone(),n:e.clone(),pitch:o,roll:i}),r++}else 0===r&&2===n&&m.push({v:u[s].v.clone(),n:u[s].n.clone(),pitch:u[s].pitch.clone(),roll:u[s].roll.clone()})}}u=a.slice(),h*=.9,o++}for(r in p=6,l){let e=l[r].a.clone();var s=l[r].b.clone();let t=e.clone().sub(s);var a=t.clone().multiplyScalar(.5).add(s),E=scope.randomInt(0,3)-1;t.applyAxisAngle(l[r].pitch,2*Math.PI/p),t.applyAxisAngle(l[r].roll,2*Math.PI/E),t.multiplyScalar(.5);s=a;let o=t.clone().add(a);c.vertices.push(s),c.vertices.push(o),c.colors.push(palette[2]),c.colors.push(palette[2]);let i=l[r].pitch.clone();i.applyAxisAngle(l[r].roll,2*Math.PI/E),i.applyAxisAngle(l[r].pitch,2*Math.PI/p);let n=l[r].roll.clone();n.applyAxisAngle(l[r].pitch,2*Math.PI/p),n.applyAxisAngle(l[r].roll,2*Math.PI/E),u.push({v:o.clone(),n:t.clone(),pitch:i,roll:n})}u=u.concat(m);for(let o=0;o<u.length;o++)for(let t=0;t<5;t++){let e=u[o].n.clone();e.normalize(),e.applyAxisAngle(u[o].pitch,2*Math.PI/6),e.applyAxisAngle(u[o].roll,2*Math.PI/5*t),e.multiplyScalar(.5);var v=e.add(u[o].v),f=u[o].v.clone();c.vertices.push(v),c.vertices.push(f),c.colors.push(palette[12]),c.colors.push(palette[12])}return c.colorsNeedUpdate=!0,c},this.pine=function(){var o=Math.floor(8*scope.random())+6,i=2*Math.PI/6;const n=new THREE.Geometry;n.vertices.push(new THREE.Vector3(0,0,0)),n.vertices.push(new THREE.Vector3(0,0,+o-.5+1)),n.colors.push(palette[9]),n.colors.push(palette[9]),n.colors.push(palette[9]);for(let t=1;t<o;t++)for(let e=0;e<6;e++)off=i*(t%2*.5),n.vertices.push(new THREE.Vector3(0,0,+t+1)),n.vertices.push(new THREE.Vector3(.3*(o-t),0,+t-.3+1)),n.vertices[n.vertices.length-1].applyAxisAngle(R,i*e+off),n.colors.push(palette[9]),n.colors.push(palette[9]);return n},this.checkpoint=function(){var e=w.geometry,t=e.vertices.length-80,o=Math.floor(t/4)-Math.floor(t/4)%2;const i=[];i[0]=n(e.vertices[40],e.vertices[41],0),i[1]=n(e.vertices[40+o],e.vertices[1+o+40],1),i[2]=n(e.vertices[2*o+40],e.vertices[2*o+1+40],2),i[3]=n(e.vertices[3*o+40],e.vertices[3*o+1+40],3),i[4]=n(e.vertices[4*o+40],e.vertices[4*o+1+40],4),this.DISTANCE=4*o/2*3,scope.start.copy(e.vertices[36]),scope.start.sub(e.vertices[37]),scope.start.multiplyScalar(-.75),scope.start.add(e.vertices[36]);for(let e=0;e<5;e++)null==stage.best&&(stage.best[e]=e<4?o*(e+1)/B:stage.best[e]=stage.best[e-1]);function n(e,t,o){const i=new THREE.Geometry,n=(new THREE.Vector3).copy(e).sub(t);var r=(new THREE.Vector3).copy(e).add(n.clone().multiplyScalar(1.5)),s=(new THREE.Vector3).copy(t).sub(n.clone().multiplyScalar(1.5));i.vertices.push(new THREE.Vector3(r.x,r.y,r.z-12)),i.vertices.push(new THREE.Vector3(r.x,r.y,r.z+12)),i.vertices.push(new THREE.Vector3(s.x,s.y,s.z+12)),i.vertices.push(new THREE.Vector3(s.x,s.y,s.z+12)),i.vertices.push(new THREE.Vector3(s.x,s.y,s.z-12)),i.vertices.push(new THREE.Vector3(r.x,r.y,r.z-12)),i.faces.push(new THREE.Face3(0,1,2)),i.faces.push(new THREE.Face3(3,4,5));const a=new THREE.Geometry;a.vertices.push(new THREE.Vector3(e.x,e.y,e.z+6)),a.vertices.push(new THREE.Vector3(e.x,e.y,e.z+8)),a.vertices.push(new THREE.Vector3(t.x,t.y,t.z+6)),a.vertices.push(new THREE.Vector3(t.x,t.y,t.z+8)),a.vertices.push(new THREE.Vector3(e.x,e.y,e.z+6)),a.vertices.push(new THREE.Vector3(t.x,t.y,t.z+6)),a.vertices.push(new THREE.Vector3(e.x,e.y,e.z+8)),a.vertices.push(new THREE.Vector3(t.x,t.y,t.z+8)),a.vertices.push(new THREE.Vector3(e.x,e.y,e.z+1)),a.vertices.push(new THREE.Vector3(t.x,t.y,t.z+1));const c=new THREE.MeshBasicMaterial({side:THREE.DoubleSide,wireframe:!1,fog:!0});c.color=palette[5];const l=new THREE.Mesh(i,c);l.visible=!0;const u=new THREE.LineSegments(a,c);return l.name="Objective "+o,u.name="Checkpoint"+o,{display:u,collision:l}}return state.target(),i},this.resetCheckpoints=function(){for(var e in scope.checkpoints)scope.checkpoints[e].display.material.color=palette[5]},this.random=function(){SEED=(SEED+1)%2147483647;var e=1e4*Math.sin(SEED);return e-=Math.floor(e)},this.randomInt=function(e,t){return Math.floor(scope.random()*(t-e))+e},this.noise=function(i){const t=new ImprovedNoise,n=[];let o=8,r=0,s=0;var a=1e3*scope.random();E;for(let e=0;e<i.vertices.length;e++)n[e]=0;for(let e=0;e<2;e++){for(let e=0;e<i.vertices.length;e++){var c=i.vertices[e].x,l=i.vertices[e].y;n[e]+=Math.floor(t.noise(c/o,l/o,a)*o),n[e]>r&&(r=n[e]),n[e]<s&&(s=n[e])}o*=3}for(let o=0;o<n.length;o++){let t=2===E?2:.5;for(let e=0;e<w.geometry.vertices.length;e++){var u=i.vertices[o].distanceTo(w.geometry.vertices[e]),u=u*u/100;u<t&&(t=u)}i.vertices[o].z+=n[o]*t}},this.name=function(){let t="";if(CUSTOM_SEED)t=state.custom_seed;else if(CHALLENGE||BATTLE)t=state.CHALLENGES.seed;else{var o=[" forest"," pass"," mountain"],i=["wa","tsu","mi","n","wa","ra","ya","ma","ha","na","ta","ka","a","wi","ri","mi","hi","ni","chi","shi","ki","i","ru","yu","mu","fu","nu","tsu","su","ku","u","we","re","me","he","ne","te","se","ke","e","wo","ro","yo","mo","no","to","so","ko","o"];TOGGLE=!1;var n=Math.ceil(3*Math.random())+1;let e=0;for(;e<n;){var r=Math.floor(Math.random()*i.length);t+=i[r],e++}var s=2===E?1:0,s=o[Math.floor(s+Math.random()*(o.length-s))];if(t+=s,.1<Math.random()){t="";s=Math.floor(Math.random()*seeds.length);for(t=seeds[s];t==LAST_SEED;){var a=Math.floor(Math.random()*seeds.length);t=seeds[a]}}}return LAST_SEED="name",t}}const Ghost=function(e,t=0,o=0,i=[]){var n=this;const r=[];r[0]={name:"logistics crate",geometry:()=>MODEL.logistics_crate()},r[1]={name:"ag-86",geometry:()=>MODEL.ag_86()};var t=t,o=o,s=e.slice();this.tape=s;let a=this.frame=0;var c=new THREE.Vector3(0,0,1);const l=new THREE.Vector3,u=new THREE.Vector3,h=new THREE.Vector3(0,0,1),p=new THREE.Vector3,m=new THREE.Vector3(0,5,0);this.position=new THREE.Vector3,this.direction=new THREE.Vector3;var d;let g=r[t].geometry(),E=new THREE.MeshBasicMaterial({color:PAINT[o]}),v=new THREE.LineSegments(g,E);v.name="ghost_"+ghost.length,v.position.copy(s[0].position),scene.add(v),a=0,cp=i.slice(),(cp[4]<stage.best[4]||null==stage.best[4])&&(stage.best=cp.slice()),this.reset=function(){TIME.reset(),a=0,n.update()},this.update=function(){var e={TS:TIME.time};a=vhs.convert(s,e,a),l.copy(e.position),h.copy(e.lookTarget),d=e.rotation,p.copy(h),p.add(l),v.position.copy(l),v.lookAt(p),v.rotateOnAxis(c,d),u.copy(v.localToWorld(m.clone())),u.sub(l),u.normalize(),n.position.copy(l),n.direction.copy(u),n.frame=a},this.disconnect=function(){scene.remove(v),g.dispose(),E.dispose()}},BUILD="0.0.5",DB_BUILD="005";window.onload=init,window.onresize=resize,window.fullscreenchange=resize,window.focus=resize;let seeds=["nani mountain","eva tribute","ryuk mountain","kokiri forest","kodama forest","hollow touge","ginko mountain","sesh mountain","titan forest"],palette=[1052688,16777215,12698049,2894892,5308334,16740978,2393855,2201343,3424820,2201152,7168071,10066329,16756970];for(let e in palette){const Df=new THREE.Color(palette[e]);palette[e]=Df}let PAINT=[16777215,16760825,12910564,16758197,16383882,14267903,7727359],PAINT_NAME=["snow","sakura","melon","peach","bumblebee","lavender","ice"],LOADSTATUS=0,PERSONAL_BEST=!1,SEED_NAME="",CUSTOM_SEED="",SEED=Math.floor(2147483647*Math.random()),LAST_SEED="",scene,camera,renderer,stage,vehicle,control,ui,vhs,state,ghost=[],SCORE_LIMIT=99,GHOST_LIMIT=20,GHOST_SOFT_LIMIT=9,RAID_LIMIT=20,GHOST_PRIORITY=0,UID=null,NAME="",UP,PLAY=!1,IMPORT=!1,BG=palette[0],FRAME=0,FPS=0,COUNTER=0,TIMEOUT=0,DNF=!1,REASON="out of bounds",FULLSCREEN=!1,MODE=0,LOAD=0,LOADING=!1,MENU=!1,MOBILE=!1,CHALLENGE=!1,OBJECTIVES=[],UPDATES=[],HITBOX=!0,FIREBASE=!0,SCALE=1,RESIZE_SCALE=1,SNOW=!1,RAFID=0,GLOBAL_TS,GLOBAL_DT,GLOBAL_TS_START,GLOBAL_LAST_TS,CHALLENGES=[],BATTLE=!1;var firebaseConfig={apiKey:"AIzaSyB8RCC02kiLKX3Vm5bUCKDdYgKKVyMRh_0",authDomain:"ssio-live.firebaseapp.com",databaseURL:"https://ssio-live-default-rtdb.firebaseio.com",projectId:"ssio-live",storageBucket:"ssio-live.appspot.com",messagingSenderId:"205970490845",appId:"1:205970490845:web:fa37aac1e169e6feade234",measurementId:"G-54D3B95XY3"};function init(){window.addEventListener("touchstart",activateTouch),window.addEventListener("contextmenu",function(){event.preventDefault()}),scene=new THREE.Scene,scene.background=BG,UP=new THREE.Vector3(0,0,1),camera=new THREE.PerspectiveCamera,camera.up=UP,camera.position.z=2e3,camera.lookAt(0,0,0),camera.fov=70,camera.near=1e-4,camera.far=3e3,camera.name="Camera",scene.add(camera),renderer=new THREE.WebGLRenderer({logarithmicDepthBuffer:!0,antialias:!1,precision:"highp"}),renderer.setClearColor(BG),renderer.domElement.id="renderer",document.body.appendChild(renderer.domElement),control=new Control,control.connect(),ui=new UI,stage=new Stage,vehicle=new Vehicle,vhs=new VHS,state=new State,state.login(),state.checksave(),state.decodeURL(),vehicle.init(),resize(),ui.onload=function(){camera.position.set(0,25,10),camera.lookAt(0,0,0),main(),state.intro()}}function activateTouch(){MOBILE=!0,window.removeEventListener("touchstart",activateTouch)}function resize(){var e=1===window.devicePixelRatio&&600<=window.innerWidth&&600<=window.innerHeight?2:1;state.SETTINGS&&state.settings(state.STATE);var t=window.innerWidth,o=window.innerHeight;camera.aspect=t/o,camera.updateProjectionMatrix(),ui.resize(t,o,e),state.resize(t,o,e)}function main(){if(window.requestAnimationFrame(main),RAFID=window.performance.now(),PLAY){vehicle.update();for(let e=0;e<ghost.length;e++)vehicle.START&&(DT(),ghost[e].update());MENU||state.update(),!MOBILE||MENU||DNF||ui.dpad(),control.RESET&&!MENU&&(state.reset(),control.RESET=!1),stage.update()}else if(vhs.PLAY){DT(),vhs.play(vehicle),stage.update();for(let e=0;e<ghost.length;e++)ghost[e].update()}else LOADING?(camera.position.applyAxisAngle(camera.up,.01),camera.lookAt(new THREE.Vector3,0,0,0),state.loading()):(camera.position.applyAxisAngle(camera.up,.01),camera.lookAt(new THREE.Vector3,0,0,0));renderer.render(scene,camera),ui.update(control.touches)}firebase.initializeApp(firebaseConfig),firebase.analytics();const MODEL={ag_86:function(){geometry=new THREE.Geometry;var e={SIDE_FRONT:.3,SIDE_BACK:.45,BODY_FRONT:1.2,BODY_BACK:-.75,SIDE_WING:1,WING_BACK:-1.4,WING_BOTTOM:.4,TOP:1,BOTTOM:-.1};return geometry.vertices.push(new THREE.Vector3(e.SIDE_BACK,e.BODY_BACK,e.TOP)),geometry.vertices.push(new THREE.Vector3(e.SIDE_FRONT,e.BODY_FRONT,e.TOP)),geometry.vertices.push(new THREE.Vector3(-e.SIDE_BACK,e.BODY_BACK,e.TOP)),geometry.vertices.push(new THREE.Vector3(-e.SIDE_FRONT,e.BODY_FRONT,e.TOP)),geometry.vertices.push(new THREE.Vector3(e.SIDE_FRONT,e.BODY_FRONT,e.TOP)),geometry.vertices.push(new THREE.Vector3(-e.SIDE_FRONT,e.BODY_FRONT,e.TOP)),geometry.vertices.push(new THREE.Vector3(e.SIDE_BACK,e.BODY_BACK,e.TOP)),geometry.vertices.push(new THREE.Vector3(-e.SIDE_BACK,e.BODY_BACK,e.TOP)),geometry.vertices.push(new THREE.Vector3(-e.SIDE_FRONT,e.BODY_FRONT,e.TOP)),geometry.vertices.push(new THREE.Vector3(-e.SIDE_WING,e.BODY_BACK,e.BOTTOM)),geometry.vertices.push(new THREE.Vector3(-e.SIDE_BACK,e.BODY_BACK,e.TOP)),geometry.vertices.push(new THREE.Vector3(-e.SIDE_WING,e.BODY_BACK,e.BOTTOM)),geometry.vertices.push(new THREE.Vector3(e.SIDE_FRONT,e.BODY_FRONT,e.TOP)),geometry.vertices.push(new THREE.Vector3(e.SIDE_WING,e.BODY_BACK,e.BOTTOM)),geometry.vertices.push(new THREE.Vector3(e.SIDE_BACK,e.BODY_BACK,e.TOP)),geometry.vertices.push(new THREE.Vector3(e.SIDE_WING,e.BODY_BACK,e.BOTTOM)),geometry.vertices.push(new THREE.Vector3(e.SIDE_BACK,e.BODY_BACK,e.TOP)),geometry.vertices.push(new THREE.Vector3(e.SIDE_BACK,e.WING_BACK,e.WING_BOTTOM)),geometry.vertices.push(new THREE.Vector3(-e.SIDE_BACK,e.BODY_BACK,e.TOP)),geometry.vertices.push(new THREE.Vector3(-e.SIDE_BACK,e.WING_BACK,e.WING_BOTTOM)),geometry.vertices.push(new THREE.Vector3(e.SIDE_BACK,e.WING_BACK,e.WING_BOTTOM)),geometry.vertices.push(new THREE.Vector3(-e.SIDE_BACK,e.WING_BACK,e.WING_BOTTOM)),geometry.vertices.push(new THREE.Vector3(e.SIDE_BACK,e.WING_BACK,e.WING_BOTTOM)),geometry.vertices.push(new THREE.Vector3(e.SIDE_WING,e.BODY_BACK,e.BOTTOM)),geometry.vertices.push(new THREE.Vector3(-e.SIDE_BACK,e.WING_BACK,e.WING_BOTTOM)),geometry.vertices.push(new THREE.Vector3(-e.SIDE_WING,e.BODY_BACK,e.BOTTOM)),geometry.center(),geometry.name="AG-86",geometry},logistics_crate:()=>{const e=(new THREE.Geometry).fromBufferGeometry(new THREE.EdgesGeometry(new THREE.BoxGeometry(1,2,1)));return e.name="Logistics Crate",e}};var ImprovedNoise=function(){for(var d=[151,160,137,91,90,15,131,13,201,95,96,53,194,233,7,225,140,36,103,30,69,142,8,99,37,240,21,10,23,190,6,148,247,120,234,75,0,26,197,62,94,252,219,203,117,35,11,32,57,177,33,88,237,149,56,87,174,20,125,136,171,168,68,175,74,165,71,134,139,48,27,166,77,146,158,231,83,111,229,122,60,211,133,230,220,105,92,41,55,46,245,40,244,102,143,54,65,25,63,161,1,216,80,73,209,76,132,187,208,89,18,169,200,196,135,130,116,188,159,86,164,100,109,198,173,186,3,64,52,217,226,250,124,123,5,202,38,147,118,126,255,82,85,212,207,206,59,227,47,16,58,17,182,189,28,42,223,183,170,213,119,248,152,2,44,154,163,70,221,153,101,155,167,43,172,9,129,22,39,253,19,98,108,110,79,113,224,232,178,185,112,104,218,246,97,228,251,34,242,193,238,210,144,12,191,179,162,241,81,51,145,235,249,14,239,107,49,192,214,31,181,199,106,157,184,84,204,176,115,121,50,45,127,4,150,254,138,236,205,93,222,114,67,29,24,72,243,141,128,195,78,66,215,61,156,180],e=0;e<256;e++)d[256+e]=d[e];function g(e){return e*e*e*(e*(6*e-15)+10)}function E(e,t,o){return t+e*(o-t)}function v(e,t,o,i){var n=15&e,e=n<8?t:o,i=n<4?o:12==n||14==n?t:i;return(0==(1&n)?e:-e)+(0==(2&n)?i:-i)}return{noise:function(e,t,o){var i=Math.floor(e),n=Math.floor(t),r=Math.floor(o),s=255&i,a=255&n,c=255&r,l=(e-=i)-1,u=(t-=n)-1,h=(o-=r)-1,p=g(e),m=g(t),i=g(o),n=d[s]+a,r=d[n]+c,n=d[n+1]+c,s=d[1+s]+a,a=d[s]+c,c=d[s+1]+c;return E(i,E(m,E(p,v(d[r],e,t,o),v(d[a],l,t,o)),E(p,v(d[n],e,u,o),v(d[c],l,u,o))),E(m,E(p,v(d[r+1],e,t,h),v(d[a+1],l,t,o-1)),E(p,v(d[n+1],e,u,h),v(d[c+1],l,u,h))))}}};const profanity=(e,t)=>{let l=["616e616c","617373","6175746973","62616c73","62616c7a","626c77","626c6f776a6f62","626f6e6572","6269746368","746974","627574","6368696e616d656e","6368696e616d616e","6368696e6b","636f636b","63756d","63756e74","64696b","6469636b","64796b65","656a6163756c6174","6572656374696f6e","666167","666774","66676574","666774","66676f74","66617274","66656c6174696f","666f7265736b696e","666f72736b696e","34736b696e","666f7265736b6e","666f72736b6e","34736b6e","666b","66756b","667563","66636b","6675646765706163","66756765706163","667567706163","667564676570636b","66646770636b","676179","6761796c6f72","6761796c72","67796c7264","676f6f6b","68616e646a6f62","686562","6869746c6572","68746c72","6869746c72","68746c6572","6a696761","6a69676761","6a676761","6a676162","6a697a","6b696b65","6d617374657262617465","6d617374757262617465","6d6173747262617465","6d61737475726238","6d61737465726238","6d617374726238","6d6964676574","6a65726b6f66","6a61636b6f66","6a61636b6d656f66","626561746d656174","6265746d6574","6d6574626574","6d65617462656174","6d6f6c657374","6e617a69","6e7a69","6e6772","6e676572","6e6761","6e656772","6e6967","6e6767","6e7574","70616b69","70656e6973","70657276","7068756b","70687563","706863","70696d70","70697373","706f7263686d6f6e6b6579","707263686d6e6b79","706f7263686d6e6b79","707263686d6f6e6b6579","706f7263686d6e6b6579","707263686d6f6e6b6579","706f726e","70726963","707269636b","70726f737469","70757379","7075736965","7065646f","70646f","72617065","7261706973","726170696e","72656374756d","74617264","72696d696e67","72696d6a6f62","736578","7365636b73","7363726f74756d","736b616e6b","736c617665","736c7574","736f646f6d","73706963","73686974","736874","7375636b","737578","73756b73","7370756e6b","73706f6765","7377617374696b61","73797068","746573746963","74657374696b","77616e6b","77686f7265","7768747077","776869746570726964","77686974707264","7768697465706f77","77686974657077","77707777","79656c6f776d616e","7a696761626f","7a6970657268656164","6a65737573","6a77","6a6577","61726162","6d75736c696d","636872697374","736174616e","676f64","6c6f7264","616c6168","62756468","6269626c65","71756172616e"],u=["a4","g6","g9","s5","i1","l1","b8","t7","b6","s$","y$","g&","a&","b&","i!","i/","i\\","i?","g8","b8","s6","o0","e3"],o=e.toLowerCase();for(let e=0;e<o.length;e++){var i=o.charCodeAt(e);if(122<i||57<i&&i<61||i<33||40==i||41==i)return"";let c="";for(let t=e;t<o.length;t++){o.charAt(t);let e=o.charCodeAt(t);(48<=e&&e<=57||97<=e&&e<=122)&&(c+=e.toString(16));for(let e=0;e<l.length;e++){let i="",n="",r=[],s=0,a=0;for(let o=0;o<l[e].length;o+=2){let t=c.charAt(o+s)+c.charAt(o+1+s);var h=l[e].charAt(o)+l[e].charAt(o+1);if((t===i||t===n)&&0!==t.length&&(a++,0<a))for(;t===i||t===n;)s+=2,t=c.charAt(o+s)+c.charAt(o+1+s);if(t===h)r[o/2]=!0,i=t,n=h;else{r[o/2]=!1;for(let e=0;e<u.length;e++){var p=u[e].charCodeAt(1).toString(16),m=u[e].charCodeAt(0).toString(16);t===p&&(m===h?(r[o/2]=!0,i=p,n=h):m!==i&&m!==n||(a++,0<a&&(s+=2,o-=2)))}!1===r[o/2]&&(o=l[e].length)}}let t=0;for(let e=0;e<r.length;e++)if(!0===r[e]&&t++,t===r.length)return""}}}return e};function Stage(){var o=this;this.COMPLETE=!1,this.SNOW=!1,this.start=new THREE.Vector3,this.generate=new Generate,this.checkpoint=[],this.objectives=[],this.best=[],this.grid=[],this.dimension=2400,this.partitionDimension=16,this.partionDivision=this.dimension/this.partitionDimension,this.seed,this.snow={distance:200,height:100,limit:200,mesh:new THREE.Points(new THREE.Geometry,new THREE.PointsMaterial),init:function(){for(;o.snow.mesh.geometry.vertices.length<o.snow.limit;){let e=new THREE.Vector3;e.copy(camera.position),e.x+=Math.random()*o.snow.distance-o.snow.distance/2,e.y+=Math.random()*o.snow.distance-o.snow.distance/2,e.z+=Math.random()*o.snow.height-o.snow.height/2,o.snow.mesh.geometry.vertices.push(e)}o.snow.mesh.geometry.verticesNeedUpdate=!0,o.snow.mesh.geometry.computeBoundingSphere()},update:function(){for(let t=0;t<o.snow.mesh.geometry.vertices.length;t++){let e=o.snow.mesh.geometry.vertices[t];e.z-=.5*vehicle.DT(),(Math.abs(e.z-camera.position.z)>o.snow.height/2||Math.abs(e.x-camera.position.x)>o.snow.distance/2||Math.abs(e.y-camera.position.y)>o.snow.distance/2)&&(e.copy(camera.position),e.x+=Math.random()*o.snow.distance-o.snow.distance/2,e.y+=Math.random()*o.snow.distance-o.snow.distance/2,e.z+=Math.random()*o.snow.height-o.snow.height/2)}o.snow.mesh.geometry.verticesNeedUpdate=!0,o.snow.mesh.geometry.computeBoundingSphere()}};for(let e=0;e<4;e++)this.checkpoint[this.checkpoint.length]=new THREE.Mesh(new THREE.Geometry);this.connect=function(e=!1){if(camera.position.set(0,400,200),camera.far=2e3,camera.updateProjectionMatrix(),camera.lookAt(new THREE.Vector3),renderer.render(scene,camera),!e){this.name=this.generate.name();let e="";for(var t in this.name)e+=this.name.charCodeAt(t).toString();SEED=e}o.generate.connect(),COUNTER++},this.disconnect=function(){SNOW&&(scene.remove(o.snow.mesh),o.SNOW=!1),this.generate.disconnect(),this.generate.reset()},this.reset=function(e=!1){SEED++,o.COMPLETE=!1,o.disconnect(),o.generate=new Generate,o.connect(e)},this.preview=function(){window.setTimeout(0,0)},this.update=function(){this.SNOW&&this.snow.update()}}function State(){var c=this;let o,a,e="",t=0,i=0;this.custom_seed="";let n="#1#ffffff#334#",r=GHOST_LIMIT+"#1#",s=!0;this.SETTINGS=!1,this.STATE=function(){c.intro()},this.CHALLENGES={},this.CHALLENGER="",this.TIMELIST=[],this.BATTLE=[],this.login=function(){var t=null;firebase.auth().onAuthStateChanged(e=>(e?(UID=e.uid,c.STATE(),vhs.requestName(UID,e=>{NAME=e,c.STATE()})):(UID=!1,c.STATE()),t))},this.register=function(e){c.STATE=()=>{c.register(e)},c.inputName(()=>{vhs.export()},!0,"new record! input name to save data")},this.resize=function(e,t){o=ui.width,a=ui.height,GHOST_SOFT_LIMIT=Math.floor((window.innerHeight/ui.scale/ui.row-34)/2)},this.wallet=function(){let e=vehicle.yen();ui.print("$ "+e.toString(),"2","1.0-4")},this.nav=function(e=function(){ui.clear()}){ui.sprite(8,64,8,8,"1.0-4+2p","2",8,8),ui.button("","1.0-8","2+4p","8","8",function(){c.menu(e)},!1)},this.title=function(e,t){c.breadcrumb(e,t),ui.sprite(16,64,8,8,"1.0-4+2p","2",8,8),ui.button("","1.0-7","2+4p","7","5",function(){s||ui.backdrop(!1),e(),MENU=!1,c.SETTINGS=!1},!1),c.wallet()},this.breadcrumb=function(e,t){t=void 0===t?function(){s||ui.backdrop(!1),e(),MENU=!1,c.SETTINGS=!1}:function(){c.menu(e),MENU=!0};ui.print("< menu","2","2"),ui.button("","2","2+4p","7","8",t,!1)},this.menu=function(e){MENU=!0,c.STATE=()=>{c.menu(e)},s||ui.backdrop(),ui.clear(),c.title(e),ui.sprite(0,0,1,1,"2","6","1.0-4",1),ui.print(" > modify vehicle","2","8"),ui.button("","2","8+4p","1.0-4","5",function(){c.vehicle(e)},!1),ui.sprite(0,0,1,1,"2","11","1.0-4",1),ui.print(" > settings","2","13"),ui.button("","2","13+4p","1.0-4","5",function(){c.settings(e)},!1),ui.sprite(0,0,1,1,"2","16","1.0-4",1);let t=8;(PLAY||vhs.PLAY)&&(ui.button("restart stage","2","1.0-2-"+t,"1.0-4","6",function(){ui.backdrop(!1),c.reset()},!0),t+=8),stage.COMPLETE&&(PLAY||vhs.PLAY)&&ui.button("next stage","2","1.0-2-"+t,"1.0-4","6",function(){ui.backdrop(!1),c.next()},!0),c.discord()},this.intro=function(){var e;c.STATE=()=>{c.intro()},s=!0,ui.clear(),ui.print("specialstage.io","2","2"),ui.print("-","2","4"),ui.link("","0","12","1.0",""+(GHOST_SOFT_LIMIT+18),"https://ginko.ltd"),ui.renderer.style.backgroundImage="url('img/promo.png')",ui.renderer.style.backgroundSize="contain",ui.renderer.style.animation="animation 100s linear infinite",ui.print("new physical items","2","1.0-24",2),ui.print("available at ginko.ltd","2","1.0-21"),CHALLENGE?(ui.print("challenge detected","2","6",2),e=0<c.CHALLENGER.length?c.CHALLENGER:"...",ui.print("issued by: "+e,"2","10"),vhs.requestName(c.CHALLENGES.uid,function(e){c.CHALLENGER=e,c.STATE()}),ui.print("seed: "+c.CHALLENGES.seed,"2","12")):CUSTOM_SEED?(ui.print("seed detected:","2","6",1),ui.print("> "+c.custom_seed,"2","10",1)):null!==UID&&!1===UID||""!==NAME?""!==NAME?(ui.print("welcome back","2","6"),ui.print("> "+NAME+" [edit name]","2","9"),ui.button("","2","9+4p","1.0-4","4",function(){c.inputName(c.intro)},!1)):!1===UID&&""===NAME&&(ui.print("> [register/sign in]","2","9"),ui.button("","2","9+4p","1.0-4","4",function(){c.inputName(c.intro)},!1)):ui.print("> loading user data...","2","9"),ui.print(BUILD,"2","1.0-4"),c.nav(function(){c.intro()}),ui.print("menu","1.0-9","2"),ui.button("","1.0-9","2+4p","4","5",function(){c.menu(c.intro)},!1),c.discord(),c.startButton()},this.startButton=function(){ui.button("start","2","1.0-12+"+(2*(RESIZE_SCALE-1)).toString(),"1.0-4","8",function(){ui.clear(),s=!1,ui.renderer.style.background="transparent",ui.renderer.style.animation="none",STATE=()=>{},START=!0,FIREBASE&&firebase.analytics().logEvent("game_start"),stage.connect(),c.load()})},this.discord=function(){ui.sprite(0,72,16,16,"1.0-12","1.0-5+4p",16,16),ui.button("discord","1.0-11","1.0-4+4p","10","4",function(){window.open("https://discord.gg/ACewNWH")},!1)},this.load=function(){c.STATE=()=>{c.target()},ui.clear(),c.TIMELIST=[],vhs.scan(stage.name,function(o){for(let t=0;t<o.length;t++)c.TIMELIST[t]={uid:o[t].uid,time:o[t].time,name:"..."},vhs.requestName(o[t].uid,function(e){c.TIMELIST[t].name=e,c.STATE()}),vhs.checkTime(UID,o[t].uid,o[t].time);var t=c.TIMELIST.length<GHOST_LIMIT?c.TIMELIST.length:GHOST_LIMIT;let i=[];switch(GHOST_PRIORITY){case 0:i=o.slice(0,t);break;case 1:let e=o.slice();for(;i.length<t;){var n=Math.floor(Math.random()*e.length);i.push(Object.assign({},e[n])),e.splice(n,1)}}for(let e=0;e<i.length;e++)vhs.import(stage.name+"/"+i[e].uid,function(e){ghost.push(new Ghost(e.tape,e.model,e.paint,e.cp))});c.STATE()}),LOADING=!0,c.nav(c.load),ui.print("seed : ","2","2");var e=stage.name;ui.print(e,"2","5-1p",2),t=0},this.ready=function(){c.STATE=()=>{c.ready()},ui.clear(),LOADING=!1,c.nav(c.ready),ui.print("stage generated.","2","2"),ui.print(stage.name,"2","5-1p",2),c.target(),ui.print("stage generated.","2","2"),ui.button("ready","2","1.0-10","1.0-4","8",function(){c.STATE=()=>{},stage.generate.END=!1,ui.clear(),c.play(),PLAY=!0,vehicle.connect(stage.start,stage.surface,!1),FIREBASE&&firebase.analytics().logEvent("stage_start")}),c.wallet()},this.play=function(){ui.clear(),c.nav(c.play),MENU=!1},this.complete=function(){MENU=!0,ui.clear(),c.nav(c.complete);var e=CHALLENGE?vehicle.CP()[4]>stage.best[4]?"challenge failed":"challenge victory!":"stage complete!";ui.print(e,"0.5-"+2*Math.round(e.length/2),"0.3-1",2),stage.COMPLETE=!0,window.setTimeout(function(){!1===UID?c.register():vhs.export(c.results),c.STATE=()=>{c.results()}},2e3),FIREBASE&&(e=vehicle.param().model+" ("+(vehicle.param().power+1)+"/"+(vehicle.param().drag+1)+"/"+(vehicle.param().sensitivity+1)+"/"+(vehicle.param().ease+1)+")",firebase.analytics().logEvent("stage_complete",{operator_id:NAME,time:vehicle.AT(),penalty:vehicle.PENALTY(),score:vehicle.AT()+vehicle.PENALTY(),seed:stage.name,rating:Math.round(stage.generate.DISTANCE/(vehicle.AT()+vehicle.PENALTY())),distance:stage.generate.DISTANCE,vehicle:e}))},this.results=function(){c.STATE=()=>{c.results()},ui.clear();NAME,vhs.tape.slice();MENU=!0;var e,t=ui.float(vehicle.AT()+vehicle.PENALTY());let o=0;if(0<c.TIMELIST.length){var i=Math.floor(100*(vehicle.AT()+vehicle.PENALTY()))/100;for(let e=0;e<c.TIMELIST.length;e++)if(i<c.TIMELIST[e].time){o=e+1;break}}c.nav(c.results),ui.print("stage complete : "+stage.name,"2","2"),ui.print(t,"2","5",2),0!=o?ui.print("rank "+o,2*t.length+"+3".toString(),"5+4p"):vehicle.AT()+vehicle.PENALTY()<stage.best[4]?(e=CHALLENGE?"challenge victory!":"new record!",ui.print(e,2*t.length+"+3".toString(),"5+4p")):CHALLENGE&&ui.print("challenge failed",2*t.length+"+3".toString(),"5+4p");let n=9;var r=vehicle.CP();if(320<a){for(let o=0;o<r.length-1;o++){ui.print("cp "+(o+1).toString(),"2",n+"+"+o.toString());o;let e,t;t="number"==typeof r[o]?(e=ui.float(r[o]),Number.isNaN(stage.best[o])?"+1 cp":r[o]-stage.best[o]):(e="penalty",""),ui.print(e.toString(),"0.5 -1-"+e.length.toString(),n+"+"+o.toString());var s="penalty"===e?"25 sec":"+1 cp"==t?"+1 cp":0<t?"( - "+ui.float(t)+" )":"( + "+ui.float(Math.abs(t))+" )";ui.print(s,"0.5+1",n+"+"+o.toString()),n+=1}n+=5}(vehicle.AT()+vehicle.PENALTY()<stage.best[4]||!CHALLENGE)&&(ui.print("reward","2",n.toString()),n+=3,ui.print("$"+vehicle.results().reward,"2",n.toString(),2)),ui.button("issue challenge","0.5+1","1.0-20","0.5-3","4",c.challenge),ui.button("modify vehicle","2","1.0-20","0.5-3","4",()=>{ui.backdrop(),c.vehicle(c.results)}),ui.button("next stage","2","1.0-12","1.0-4","8",function(){c.next()}),ui.button("restart stage","2","1.0-4","0.5-3","4",function(){c.reset("complete")}),ui.button("view replay","0.5+1","1.0-4","0.5-3","4",function(){c.replay()}),window.setTimeout(function(){PLAY=!1,vhs.PLAY=!0},0)},this.battle=function(){var e=new Ghost(vhs.save(vhs.tape),vehicle.MODEL,vehicle.PAINT);ghost.push(e),c.reset()},this.replay=function(){c.STATE=()=>{c.results()},ui.clear(),c.nav(c.results);for(let e=0;e<4;e++){var t="4+"+(4*e).toString(),o=e===vehicle.CAMERA-1?48:40;ui.button("",t+"-10p","1.0-4+4p","3","4",function(){vehicle.CAMERA=e+1,c.replay()},!1),ui.sprite(o,64,8,8,t,"1.0-4",8,8)}ui.print("<","2","2"),ui.button("","2","2+4p","7","8",function(){c.results(c.replay)},!1)},this.next=function(){ui.clear(),CHALLENGE=!1,BATTLE=!1,CUSTOM_SEED=!1,custom_seed="",stage.name="",PERSONAL_BEST=!1,window.history.pushState("","","/"),renderer.clear(),vehicle.reset(),vehicle.disconnect();for(let e=0;e<ghost.length;e++)ghost[e].disconnect();ghost=[],stage.SNOW&&scene.remove(stage.snow.mesh),stage.reset(),MENU=!1,PLAY=!1,vhs.PLAY=!1,c.load(),FIREBASE&&firebase.analytics().logEvent("next_stage")},this.dnf=function(){c.STATE=()=>{c.dnf()},ui.backdrop(!1),ui.clear(),c.nav(c.dnf),FIREBASE&&firebase.analytics().logEvent("dnf"),ui.print("dnf","0.5-3+3p","0.5-8",2),ui.button("restart stage?","2","0.5+8","1.0-4","1.0-4",function(){c.reset("dnf")},!1)},this.reset=function(e="reset"){ghost.index=0,ui.clear(),c.nav(c.play),PLAY=!0,MENU=!1,vehicle.reset();for(let e=0;e<ghost.length;e++)ghost[e].reset();FIREBASE&&firebase.analytics().logEvent("stage_restart",{status:e})},this.update=function(){MENU||!PLAY||DNF||(ui.delete(16,16,o-64,16),ui.delete(16,a-32,64,16),ui.text(ui.float(vehicle.AT()),16,16),ui.text(vehicle.SPEED.toString(),16,a-32))},this.loading=function(){e=t%16!=0?e:3<=e.length?"":e+".",MENU||(ui.delete(16,16,160,8),ui.text("stage generating"+e,16,16)),t++},this.target=function(){var e=stage.name;if(ui.print(e,"2","5-1p",2),0===c.TIMELIST.length&&vhs.SCAN)ui.print("scanning...","2","9");else if(0!==c.TIMELIST.length){ui.print("best time:","2","9"),ui.print(ui.float(c.TIMELIST[0].time),"2","12",2);var e=c.TIMELIST.length<GHOST_SOFT_LIMIT,t=e?c.TIMELIST.length:GHOST_SOFT_LIMIT,e=e?0:c.TIMELIST.length-GHOST_SOFT_LIMIT;for(let e=0;e<t;e++)ui.print(e+1+". "+c.TIMELIST[e].name,"2","16+"+2*e),ui.print(ui.float(c.TIMELIST[e].time),"18","16+"+2*e);0<e&&ui.print("+ "+e+" more entries","2",2*t+"+17")}else ui.print("no entries found.","2","9")},this.save=function(){var e=NAME+"#"+vehicle.MODEL+"#"+vehicle.PAINT+"#"+vehicle.param().power+vehicle.param().drag+ +vehicle.param().sensitivity+"#"+Date.now();e!==n&&(n=e,c.cSave("SAVE",n))},this.vehicle=function(o){c.STATE=()=>{c.vehicle(o)},MENU=!0,ui.clear(),c.title(function(){o(),c.save()},function(){c.menu(),sv()});let i=[];var e=vehicle.param();i.push({id:"power",value:e.power,funct:function(e){vehicle.tune.power(e)}}),i.push({id:"drag",value:e.drag,funct:function(e){vehicle.tune.drag(e)}}),i.push({id:"sensitivity",value:e.sensitivity,funct:function(e){vehicle.tune.sensitivity(e)}});var n="2";ui.sprite(0,0,1,1,n,"8+-5+3","1.0-2-2",1),ui.print("model",n,"8+"),ui.print(vehicle.models()[vehicle.MODEL].name,"2+8","8+"),ui.sprite(0,0,1,1,n,"8++3","1.0-2-2",1),ui.button(">","1.0-6","8++4p","4","4",function(){vehicle.MODEL+=1,1<vehicle.MODEL&&(vehicle.MODEL=0),vehicle.body(),c.vehicle(o)},!1),ui.button("<","1.0-12","8++4p","4","4",function(){--vehicle.MODEL,vehicle.MODEL<0&&(vehicle.MODEL=1),vehicle.body(),c.vehicle(o)},!1),ui.sprite(0,0,1,1,n,"8+5+-5+3","1.0-2-2",1),ui.print("paint",n,"8+5+"),ui.print(PAINT_NAME[vehicle.PAINT],"10","8+5+"),ui.sprite(0,0,1,1,n,"8+5++3","1.0-2-2",1),ui.button(">","1.0-6","8+5++4p","4","4",function(){vehicle.PAINT+=1,vehicle.PAINT>PAINT.length-1&&(vehicle.PAINT=0),vehicle.paint(),c.vehicle(o)},!1),ui.button("<","1.0-12","8+5++4p","4","4",function(){--vehicle.PAINT,vehicle.PAINT<0&&(vehicle.PAINT=PAINT.length-1),vehicle.paint(),c.vehicle(o)},!1);for(let t=0;t<i.length;t++){var r="8+5+5+"+(5*t).toString();ui.print(i[t].id,n,r),ui.sprite(0,0,1,1,n,r+"+3","1.0-2-2",1);for(let e=0;e<6;e++){var s="1.0-18+"+(3*e).toString(),a=e<=i[t].value?48:40;ui.button("",s+"-10p",r+"+4p","3","4",function(){i[t].funct(e),c.vehicle(o)},!1),ui.sprite(a,64,8,8,s,r,8,8)}}},this.settings=function(t){c.SETTINGS=!0,c.STATE=function(){var e=HITBOX?1:0;r=GHOST_LIMIT+"#"+GHOST_PRIORITY+"#"+e+"#",c.cSave("SETTINGS",r),c.settings(t)},ui.clear(),c.title(t,c.menu),ui.sprite(0,0,1,1,"2","6","1.0-4",1),ui.print("ghost config","2","8"),ui.print("[edit]","1.0-2-6","8"),ui.button("","2","8+4p","1.0-4","5",function(){c.ghostConfig(t)},!1),ui.sprite(0,0,1,1,"2","11","1.0-4",1),MOBILE?(e=HITBOX?"enabled":"disabled",ui.print("display touch hitboxes","2","13"),ui.print(e,"1.0-2-"+e.length,"13"),ui.sprite(0,0,1,1,"2","21","1.0-4",1),ui.button("","2","13+4p","1.0-4","5",function(){HITBOX=!HITBOX,c.STATE()},!1)):(ui.print("keybindings","2","13"),ui.print("arrow / wasdr","1.0-15","13"),ui.sprite(0,0,1,1,"2","21","1.0-4",1)),ui.sprite(0,0,1,1,"2","16","1.0-4",1),ui.print("camera mode","2","18");var e=vehicle.FPV?"fpv":"tpv";ui.print(e,"1.0-6","18"),ui.button("","2","18+4p","1.0-4","5",function(){vehicle.FPV=!vehicle.FPV,c.settings(t)},!1),ui.print("www.procedural.ca","2","1.0-10"),ui.print("www.ginko.ltd","2","1.0-8"),c.discord()},this.ghostConfig=function(t,e=!1){c.STATE=function(){var e=HITBOX?1:0;r=GHOST_LIMIT+"#"+GHOST_PRIORITY+"#"+e+"#",c.cSave("SETTINGS",r),c.ghostConfig(t,!0)},ui.clear(),c.title(t,c.settings),ui.sprite(0,0,1,1,"2","6","1.0-4",1),ui.print("ghost name","2","8"),ui.print(NAME,"1.0-13-"+NAME.length,"8"),ui.print("[edit]","1.0-8","8"),ui.button("","2","9+4p","1.0-4","4",function(){c.inputName(c.STATE,!0)},!1),ui.sprite(0,0,1,1,"2","11","1.0-4",1),ui.print("ghost limit","2","13");var o=GHOST_LIMIT.toString();ui.print(o,"1.0-13-"+o.length,"13"),ui.button(">","1.0-6","13+4p","4","4",function(){GHOST_LIMIT<20&&(GHOST_LIMIT+=1),c.STATE()},!1),ui.button("<","1.0-12","13+4p","4","4",function(){0<GHOST_LIMIT&&--GHOST_LIMIT,c.STATE()},!1),ui.sprite(0,0,1,1,"2","16","1.0-4",1),ui.print("ghost priority","2","18");o=0===GHOST_PRIORITY?"best":"random";ui.print(o,"1.0-13-"+o.length,"18"),ui.button(">","1.0-6","18+4p","4","4",function(){GHOST_PRIORITY+=1,1<GHOST_PRIORITY&&(GHOST_PRIORITY=0),c.STATE()},!1),ui.button("<","1.0-12","18+4p","4","4",function(){--GHOST_PRIORITY,GHOST_PRIORITY<0&&(GHOST_PRIORITY=1),c.STATE()},!1),ui.sprite(0,0,1,1,"2","21","1.0-4",1),e&&ui.print("* update requires stage generation","2","1.0-8")},this.controls=function(e){ui.clear(),c.title(e,c.menu)},this.fullscreen=function(){document.fullscreenElement?document.exitFullscreen&&document.exitFullscreen():document.documentElement.requestFullscreen()},this.prompt=function(){ui.clear(),ui.print("specialstage.io","4","4",2),ui.print("-","4","8",2)},this.challenge=function(e){ui.clear(),c.nav(function(){c.challenge()},c.menu),ui.print("link battle","2","2"),ui.print("-","2","4"),ui.print("issued by","2","6"),ui.print("> "+NAME+" [edit name?]","2","9"),ui.button("","2","9+4p","1.0-4","4",function(){c.inputName(c.challenge,!0)},!1),ui.print("seed","2","13"),ui.print(stage.name,"2","15"),ui.print("time","2","19");var t=ui.float(vehicle.CP()[3]+vehicle.PENALTY());ui.print(t,"2","21"),ui.button("copy challenge url","1","1.0-8","1.0-2","8",function(){ui.clear(),c.encodeURL(),window.setTimeout(c.results,2e3)})},this.appearance=function(){ui.clear(),c.breadcrumb(this.vehicle,this.state),c.nav(function(){c.appearance()},c.menu)},this.inputName=function(e,t=!1,o="enter display name:"){ui.clear(),c.nav(function(){e()},c.menu),ui.print(o,"2","2"),ui.textinput(NAME,"2","4","1.0-2","6","operator_id");const i=document.getElementById("operator_id");ui.button("accept","2","14","1.0-4","6",function(){ui.clear(),ui.print("submitting name to db","2","2"),NAME=profanity(i.value.toLowerCase()),!1===UID?firebase.auth().signInAnonymously().then(()=>{UID=firebase.auth().currentUser.uid,c.submitName(UID,e,t),c.STATE=()=>{}}).catch(e=>{e.code,e.message}):!1!==UID&&c.submitName(UID,e,t)},!0)},this.submitName=function(e,t,o=!1){1<NAME.length&&NAME.length<10?firebase.database().ref("uid/"+e).set({name:NAME},e=>{e?(ui.clear(),e="PERMISSION_DENIED"===e.code?"invalid name":"network error",ui.print(e,"2","2"),window.setTimeout(function(){c.inputName(t,o)},1e3)):(ui.clear(),ui.print("name change successful","2","2"),window.setTimeout(t,1e3))}):(ui.print("invalid name","2","2"),window.setTimeout(function(){c.inputName(t,o)},1e3))},this.encodeURL=function(){let o="",i=stage.name;for(let t=0;t<i.length;t++){let e=i.charAt(t);e=" "===e?"-":e,o+=e}o+="/",o+=UID,window.history.pushState("","","/");var e=window.location.href;console.log(e);var t="./#/"+o;navigator.clipboard.writeText(e+"/#/"+o).then(function(){ui.print("url copied to clipboard","2","2"),window.history.pushState("","",t)},function(){window.history.pushState("","",t),ui.print("url copied to address bar","2","2")}),FIREBASE&&firebase.analytics().logEvent("challenge_issued",{url:e+"#/"+o})},this.decodeURL=function(){let o=window.location.href;let i="",n=[],r=!1,s=0;for(let t=0;t<o.length;t++){let e=o.charAt(t);r?"/"===e?(CHALLENGE=!0,s++):(1===s&&(e="-"===e?" ":e,i+=e),1<s&&(n+=e)):"#"===e&&(r=!0,CUSTOM_SEED=!0,s=0)}CHALLENGE&&0<n.length?(c.custom_seed=i,stage.name=i,c.CHALLENGES={seed:i,uid:n}):CUSTOM_SEED&&(c.custom_seed=i,stage.name=i,CHALLENGE=!1),FIREBASE&&firebase.analytics().logEvent("challenge_accepted",{url:o})},this.cSave=function(e,t){var o=new Date;o.setTime(o.getTime()+2808e7);o="expires="+o.toUTCString();document.cookie=e+"="+t+";"+o+";path=/"},this.cLoad=function(e){for(var t=e+"=",o=document.cookie.split(";"),i=0;i<o.length;i++){let e=o[i];for(;" "==e.charAt(0);)e=e.substring(1);if(0==e.indexOf(t))return e.substring(t.length,e.length)}return""},this.checksave=function(){let l=c.cLoad("SAVE");if(0!==l.length&&null!=l){let t="",o=0,i="",n="",r="",s="",a="",c=0;for(let e=0;e<l.length;e++){var u=l.charAt(e);if("#"!==u)switch(c){case 0:t+=u;break;case 1:o=parseInt(u);break;case 2:i+=u;break;case 3:n+=l.charAt(e),r+=l.charAt(e+1),s+=l.charAt(e+2),e+=2;break;case 4:a+=u}else c++}vehicle.MODEL=o,vehicle.PAINT=i,vehicle.paint(),vehicle.tune.power(parseInt(n)),vehicle.tune.drag(parseInt(r)),vehicle.tune.sensitivity(parseInt(s))}else vehicle.PAINT=Math.floor(Math.random()*PAINT.length),vehicle.paint();if(l=c.cLoad("SETTINGS"),0!==l.length&&null!=l){let t=0,o="",i="";for(let e=0;e<l.length;e++){var n=l.charAt(e);if("#"!==n)switch(t){case 0:o+=n;break;case 1:GHOST_PRIORITY=parseInt(n);break;case 2:i=parseInt(n)}else t++}GHOST_LIMIT=parseInt(o),HITBOX=0!==i}},this.credit=()=>{ui.clear(),ui.print("procedural.ca","2","1.0-6"),ui.print("ginko.ltd","2","1.0-4")},this.promo=()=>{ui.clear(),ui.print("0.0.4","2","2"),ui.sprite(56,68,48,20,"2","6-4p",192,80,4),ui.sprite(1,0,255,16,"2","20",255,16),ui.print("https://specialstage.io","2","18"),window.setTimeout(function(){c.music()},2e3)},this.fpv=()=>{ui.clear(),ui.print("https://specialstage.io - 0.0.4","2","2"),ui.print("new feature","4","0.5"),ui.print("first person view (fpv)","4","0.5 + 4",2),window.setTimeout(function(){ui.clear(),ui.print("https://specialstage.io - 0.0.4","2","2")},4e3)},this.biome=()=>{ui.clear(),ui.print("https://specialstage.io - 0.0.4","2","2"),ui.print("new feature","4","0.5"),ui.print("ice biome","4","0.5 + 4",2),window.setTimeout(function(){ui.clear(),ui.print("https://specialstage.io - 0.0.4","2","2")},4e3)},this.physics=()=>{ui.clear(),ui.print("https://specialstage.io - 0.0.4","2","2"),ui.print("update","4","0.5"),ui.print("improved vehicle physics","4","0.5 + 4",2),window.setTimeout(function(){ui.clear(),ui.print("https://specialstage.io - 0.0.4","2","2")},4e3)},this.endtag=()=>{ui.clear(),ui.print("play at","2","0.25-4"),ui.print("https://specialstage.io","2","0.25",1),ui.print("challenges posted on discord","4","0.25+ 6"),ui.print("> discord.ginko.ltd","4","0.25 + 10"),ui.print("> discord.specialstage.io","4","0.25 + 12"),window.setTimeout(c.music,2e3)},this.music=e=>{window.setTimeout(function(){ui.print("procedural.ca","2","1.0-12")},500),window.setTimeout(function(){ui.print("ginko.ltd","2","1.0-10")},1e3),window.setTimeout(function(){},3e3)},this.updates=()=>{ui.clear(),ui.print("https://specialstage.io - 0.0.4","2","2"),ui.print("updates","2","6"),ui.print("> added ice biome","2","10"),ui.print("> added fpv camera","2","12"),ui.print("> added snow particle effects","2","14"),ui.print("> added terrain drag penalty","2","16"),ui.print("> improved vehicle physics","2","18"),ui.print("> increased gravity","2","20"),ui.print("> decreased air resistance","2","22"),ui.print("> disabled DNF timeout during button input for big jumps","2","24"),ui.print("> removed framerate dependecies","2","26"),ui.print("> reworked ui pixel scaling","2","28"),window.setTimeout(function(){ui.clear()},1e4)},this.plug=e=>{if("n"===e.key)switch(i){case 0:ui.clear(),window.setTimeout(c.promo,1e3),i++;break;case 1:window.setTimeout(c.biome,1e3),i++,vehicle.CAMERA=4;break;case 2:window.setTimeout(c.physics,1e3),i++,vehicle.CAMERA=2;break;case 3:window.setTimeout(c.fpv,1e3),i++,vehicle.CAMERA=3;break;case 4:window.setTimeout(c.endtag,1e3),i++,vehicle.CAMERA=1;break;case 5:ui.clear(),i=0}}}const TIME={dt:1,start:window.performance.now(),time:0,last:0,timestep:0,reset:function(){TIME.start=window.performance.now(),TIME.time=0,TIME.last=0,TIME.timestep=16.6667,TIME.dt=1}},DT=()=>(TIME.time=window.performance.now()-TIME.start,TIME.timestep=TIME.time-TIME.last,TIME.dt=TIME.timestep/(1e3/60),2<TIME.dt&&(TIME.dt=2),TIME.last=TIME.time,TIME.dt);function UI(){var d=this;this.renderer=document.createElement("canvas"),this.renderer.id="ui",document.body.appendChild(this.renderer);const m=this.renderer.getContext("2d");this.context=m;const e=document.createElement("img");e.src="./img/stage.font.0.0.4.png",e.onload=function(){d.connect(),d.onload()};document.createElement("canvas");this.onload=function(){};const g=document.createElement("canvas"),t=g.getContext("2d");this.scale=1,this.col=8,this.row=8,this.width,this.height;var r={unit:8,width:128,height:128,cols:16,rows:16};let s={d:{x:128,y:180,w:128,h:80}};s.a={x:128,y:s.d.y,w:128,h:80};let E=!(s.b={x:128,y:s.d.y+60,w:128,h:40}),v=[],f=[],T=[];this.connect=function(){m.imageSmoothingEnabled=!1,g.width=e.width,g.height=e.height,t.drawImage(e,0,0,g.width,g.height,0,0,g.width,g.height)},this.resize=function(e,t,o){d.scale=o;var i=window.devicePixelRatio,n=Math.ceil(i)/i*e<300?Math.floor(i):Math.ceil(i);n-i!=0&&(o=n/i),i<=1&&1<d.scale&&(o=d.scale),this.width=e/o,this.height=t/o,this.renderer.width=this.width,this.renderer.height=this.height,renderer.setSize(this.width,this.height),d.scale=o,this.renderer.style.transform="scale("+o+","+o+")",renderer.domElement.style.transform="scale("+o+","+o+")",this.renderer.style.transformOrigin="top left",renderer.domElement.style.transformOrigin="top left",m.imageSmoothingEnabled=!1,this.redraw(),s.d={x:128,y:180,w:128,h:80},s.a={x:128,y:s.d.y,w:128,h:80},s.b={x:128,y:s.d.y+60,w:128,h:40},this.automate(this.width,this.height)},this.update=function(e){for(var t in e)for(var o in T)if(e[t].x>T[o].x*d.scale&&e[t].y>T[o].y*d.scale&&e[t].x<T[o].w*d.scale&&e[t].y<T[o].h*d.scale&&1==e[t].start){T[o].funct(),e[t].start=!1;break}},this.print=function(e,t,o,i=1){let n=0;for(var r=d.compile(t,d.width,d.col),s=d.compile(o,d.height,d.row);n<e.length;)d.encode(e.charAt(n),r+n*d.col*i,s,i),n++;E||v.push(function(){d.print(e,t,o,i)})},this.text=function(e,t,o,i=1,n){let r=0;for(;r<e.length;)d.encode(e.charAt(r),t+r*d.col*i,o,i),r++},this.button=function(e,t,o,i,n,r,s=!0,a=1){var c=d.compile(t,d.width,d.col),l=d.compile(o,d.height,d.row),u=d.compile(i,d.width,d.col),h=d.compile(n,d.height,d.row);s&&(m.drawImage(g,0,0,1,1,c,l+h/2,u+1,1),m.drawImage(g,0,0,1,1,c,l-h/2,u+1,1),m.drawImage(g,0,0,1,1,c,l-h/2,1,h),m.drawImage(g,0,0,1,1,c+u-1,l-h/2,1,h));let p=0;for(;p<e.length;)d.encode(e.charAt(p),c+p*d.col+u/2-Math.round(e.length*d.col)/2+2,l-d.row/2,a),p++;T.push({x:c,y:l-h/2,w:c+u,h:l+h/2,funct:function(){r()}}),E||v.push(function(){d.button(e,t,o,i,n,r,s,a)})},this.line=function(e,t,o,i){d.sprite(0,0,1,1,e,t,o,i)},this.sprite=function(e,t,o,i,n,r,s,a){var c=d.compile(n,d.width,d.col),l=d.compile(r,d.height,d.row),u=d.compile(s,d.width,d.col),h=d.compile(a,d.height,d.row);m.drawImage(g,e,t,o,i,c,l,u,h),E||v.push(function(){d.sprite(e,t,o,i,n,r,s,a)})},this.backdrop=function(e="#10101099",t,o,i=d.width,n=d.height){!1===e?(d.clear(),d.renderer.style.background="transparent"):(d.clear(),d.renderer.style.background=e)},this.getDrawList=function(){return v},this.redraw=function(){E=!0,d.clear();for(let e=0;e<v.length;e++)v[e]();var t=document.body.getElementsByTagName("input");for(let e=0;e<t.length;e++)d.text(t[e].value,t[e].style.top,t[e].style.left);E=!1},this.automate=function(e,t){e=Math.floor(e/3)-2,t=Math.floor(t/4);s.d.w>e&&(s.d.w=e,s.d.x=e,s.a.w=e,s.a.x=e,s.b.w=e,s.b.x=e),s.d.y>t&&(s.d.y=t+40,s.a.y=s.d.y,s.b.y=s.d.y+60)},this.pad=function(e,t,o,i,n,r,s){let a=0;for(s();a<control.touches.length;)control.touches[a].x>t*d.scale&&control.touches[a].y>o*d.scale&&control.touches[a].x<(t+i)*d.scale&&control.touches[a].y<(o+n)*d.scale&&r(),a++;HITBOX&&(m.drawImage(g,0,0,1,1,t+1,o,i-1,1),m.drawImage(g,0,0,1,1,t+1,o+n,i-1,1),m.drawImage(g,0,0,1,1,t+1,o,1,n),m.drawImage(g,0,0,1,1,t+i-1,o,1,n)),d.encode(e,t+i/2-d.col/2,o+n/2-d.row/2)},this.dpad=function(){m.drawImage(g,88,88,40,40,d.width-s.a.x+s.a.w/2-20,d.height-s.a.y+s.a.h/2-20,40,40),d.pad("<",s.d.x-s.d.w-1,d.height-s.d.y,s.d.w,s.d.h,function(){control.LEFT=!0},function(){control.LEFT=!1}),d.pad(">",s.d.x+1,d.height-s.d.y,s.d.w,s.d.h,function(){control.RIGHT=!0},function(){control.RIGHT=!1}),d.pad("^",d.width-s.a.x,d.height-s.a.y,s.a.w,s.a.h,function(){control.UP=!0},function(){control.UP=!1}),d.pad("b",d.width-s.b.x,d.height-s.b.y+s.b.h/2,s.b.w,s.b.h,function(){control.DOWN=!0},function(){control.DOWN=!1})},this.clear=function(){if(!E){var t=document.body.getElementsByTagName("input");for(let e=0;e<t.length;e++)document.body.removeChild(t[e]);if(!d.REDRAW){v=[];for(let e=0;e<f.length;e++)document.body.removeChild(f[e]);f=[]}v=[]}T=[],m.clearRect(0,0,d.width,d.height)},this.delete=function(e=0,t=0,o=renderer.width,i=renderer.height){e=d.compile(e,d.width,d.col),t=d.compile(t,d.height,d.row),o=d.compile(o,d.width,d.col),i=d.compile(i,d.height,d.row);m.clearRect(e,t,o,i)},this.encode=function(e,t,o,i=1){var n=e.charCodeAt(0),e=n*r.unit%r.width,n=Math.floor(n/r.cols)*r.unit;m.clearRect(t,o,r.unit,r.unit),m.drawImage(g,e,n,r.unit,r.unit,t,o,r.unit*i,r.unit*i)},this.float=function(e,t){let o=Math.floor(Math.abs(100*e));o=o.toString();let i=o.slice(0,o.length-2),n=o.slice(o.length-2,o.length);return 0==e?"0.00":(0==i.length&&(i="0"),n.length<2&&(n+="0"),t&&0<e?i="+"+i:e<0&&(i="-"+i),o=i+"."+n,o)},this.compile=function(n,r,s){let a=0;switch(typeof n){case"number":a=n;break;case"function":a=n();break;case"string":let e=!1,t=1,o=0,i="";for(;o<n.length;){var c=n.charAt(o);"."===c?(i+=c,e=!0):"+"===c?(i=e?Number(i)*r:Number(i)*s,i*=t,t=1,a+=i,e=!1,i=""):"-"===c?(i=e?Number(i)*r:Number(i)*s,i*=t,t=-1,a+=i,e=!1,i=""):"p"===c?(i=Number(i),i*=t,a+=i,i=""):o===n.length-1?(i+=c,i=e?Number(i)*r:Number(i)*s,i*=t,a+=i,i=""):i+=c,o++}}return a},this.textinput=function(e,t,o,i,n,r,s){var a=d.compile(t,d.width,d.col),c=d.compile(o,d.height,d.row),l=d.compile(i,d.width,d.col),u=d.compile(n,d.height,d.row);if(E)d.text("> "+s.value,a,c+u/2);else{(s=document.createElement("input")).type="text",s.id=r,s.name=r,s.value=e,s.style.top=c*d.scale+"px",s.style.left=a*d.scale+"px",s.style.width=l*d.scale+"px",s.style.height=u*d.scale+"px",s.style.paddingLeft=12*d.scale+"px",s.style.fontSize=14*d.scale+"px",s.maxlength=10,s.autofocus=!0,d.text("> "+s.value,a,c+u/2),document.body.appendChild(s),window.setTimeout(function(){s.focus(),s.select()},200),s.oninput=function(){h()},s.onfocusout=function(){h()},s.onfocusin=function(){h()},s.onclick=function(){h()};const h=e=>{d.delete(a,c,l,u),d.text("> "+s.value,a,c+u/2),d.text("_",s.selectionStart*d.col+2*d.col+a,c+u/2)};v.push(function(){d.textinput(s.value,t,o,i,n,r,s)})}},this.link=function(e,t,o,i,n,r,s,a){var c=r,l=d.compile(t,d.width,d.col)*d.scale,u=d.compile(o,d.height,d.row)*d.scale,h=d.compile(i,d.width,d.col)*d.scale,p=d.compile(n,d.height,d.row)*d.scale;E||v.push(function(){return new function(){m.style.left=l+"px",m.style.top=u+"px",m.style.width=h+"px",m.style.height=p+"px",d.print(e,l,u)}});let m=document.createElement("a");m.href=r,m.style.left=l+"px",m.style.top=u+"px",m.style.width=h+"px",m.style.height=p+"px",m.style.display="block",m.style.zIndex=400,m.style.position="fixed",m.style.cursor="crosshair",m.target="_blank",m.id=c,document.body.appendChild(m),f.push(m),E=!0,d.print(e,l,u),E=!1}}function Vehicle(){const s=this;this.SPEED="",this.TEXTTIME="",this.START=!1,this.END=!1,this.OBJECTIVE=0,this.POSITION,this.MODEL=1,this.ANALOG=!1,this.PENALTY=function(){return T},this.CAMERA=1,this.FPV=!1;let a=[],c=0,l=1/60*1e3,t=1,o=0;const u=new THREE.Mesh(new THREE.IcosahedronGeometry(4,0),new THREE.MeshBasicMaterial({wireframe:!0})),h={position:new THREE.Vector3,normal:new THREE.Vector3,direction:new THREE.Vector3,rotation:0};let p=!1,m=!1;let d=!0,g=!1,i=1,n;let E=0,v=[],f=0,T=0,w=0,y=1e3,A=0,I=!1,S=!1,b=!1,M=0,H=0,N=0;this.DT=()=>1;const r={power:2,drag:2,mass:1,brake:3,sensitivity:2,ease:0},O={power:{lo:.016,hi:.02,range:0},drag:{lo:.98,hi:.985,range:0},brake:{lo:.98,hi:.95,range:0},sensitivity:{lo:.06,hi:.075,range:0},ease:{lo:6,hi:12,range:0}};O.power.range=O.power.hi-O.power.lo,O.drag.range=O.drag.hi-O.drag.lo,O.brake.range=O.brake.hi-O.brake.lo,O.sensitivity.range=O.sensitivity.hi-O.sensitivity.lo,O.ease.range=O.ease.hi-O.ease.lo;let D,x,k,C=6,B=.95,P,_=0,G=0,V=0;const U=new THREE.Vector3(0,1,0),F=new THREE.Vector3(0,0,0),z=new THREE.Vector3,Y=new THREE.Vector3(0,5,0);new THREE.Vector3(1,0,0);const W=new THREE.Vector3(0,0,1),K=new THREE.Vector3(0,0,1),j=new THREE.Vector3(0,0,1),X=new THREE.Vector3(0,0,1),q=new THREE.Vector3(0,0,-.008),$=.998;const J=new THREE.Vector3,Z=new THREE.Vector3,Q=new THREE.Vector3,ee=new THREE.Vector3;let te=[];const oe=new THREE.Vector3(0,0,1),ie=new THREE.Raycaster(ee,oe,0,2);this.cameras=[],this.cameras[0]={distance:22,x:0,y:0,z:9,lerp:.1,lookAt:new THREE.Vector3},this.cameras[1]={distance:0,x:20,y:20,z:10,lerp:.05,lookAt:new THREE.Vector3},this.cameras[2]={distance:0,x:-20,y:-20,z:20,lerp:.05,lookAt:new THREE.Vector3},this.cameras[3]={distance:0,x:-40,y:40,z:30,lerp:.075,lookAt:new THREE.Vector3},this.cameras[4]={distance:0,x:0,y:-20,z:60,lerp:.0075,lookAt:new THREE.Vector3};const ne=[];ne[0]={name:"logistics crate",geometry:()=>MODEL.logistics_crate()},ne[1]={name:"ag-86",geometry:()=>MODEL.ag_86()},this.models=function(){return ne},this.PAINT=0;const re=new THREE.MeshBasicMaterial({color:PAINT[s.PAINT]}),e=new THREE.LineSegments(ne[s.MODEL].geometry(),re),se=e.clone();se.name="Vehicle";let ae=0;const ce=new THREE.Geometry;for(;ce.vertices.length<100;){let e=new THREE.Vector3(0,0,0);e.life=0,e.maxLife=100,e.acc=new THREE.Vector3(0,0,0),ce.vertices.push(e);var le=new THREE.Color(4294967040);ce.colors.push(le)}ce.verticesNeedUpdate=!0;let ue=new THREE.Points(ce,new THREE.PointsMaterial({size:.1,vertexColors:THREE.VertexColors,blending:THREE.AdditiveBlending,transparent:!0}));function he(){if(p){let e=0;for(;e<1;){ue.geometry.vertices[ae].copy(h.direction),ue.geometry.vertices[ae].multiplyScalar(-1-Math.random()*P),ue.geometry.vertices[ae].add(h.position),ue.geometry.vertices[ae].life=ue.geometry.vertices[ae].maxLife;Math.random(),Math.random(),Math.random();var t=.1*-Math.random();ue.geometry.vertices[ae].acc.copy(h.direction),ue.geometry.vertices[ae].acc.multiplyScalar(t),ae++,ae%=ue.geometry.vertices.length,e++}}for(var e in ue.geometry.vertices)0<ue.geometry.vertices[e].life&&(ue.geometry.vertices[e].add(ue.geometry.vertices[e].acc),--ue.geometry.vertices[e].life,ue.geometry.colors[e].setHSL(0,0,ue.geometry.vertices[e].life/100)),ue.geometry.vertices[e].life<=0&&(ue.geometry.vertices[e].set(0,0,0),ue.geometry.vertices[ae].acc.x=0,ue.geometry.vertices[ae].acc.y=0,ue.geometry.vertices[ae].acc.z=0);ue.geometry.verticesNeedUpdate=!0,ue.geometry.colorsNeedUpdate=!0,ue.geometry.computeBoundingSphere()}ue.name="Emitter",this.init=function(){},this.connect=function(e,t){se.copy(new THREE.LineSegments(ne[s.MODEL].geometry(),re)),se.name="Vehicle",se.geometry.computeBoundingSphere(),Q.copy(e),J.copy(Q),se.position.copy(Q),Z.copy(J),scene.add(se),scene.add(ue),s.tune.power(),s.tune.drag(),s.tune.sensitivity(),s.tune.ease(),scene.fog=new THREE.FogExp2(palette[0],.005),camera.fov=90,camera.updateProjectionMatrix(),scene.add(stage.generate.stars),g=!1,window.setTimeout(function(){g=!0},1e3),stage.SNOW&&scene.add(stage.snow.mesh),a=[],c=0,A=RAFID,a[0]={position:J.clone(),normal:new THREE.Vector3(0,0,1),direction:new THREE.Vector3(0,1,0),camera:new THREE.Vector3,rotation:0,velocity:new THREE.Vector3,time:RAFID},TIME.reset(),o=0},this.disconnect=function(){s.reset(),scene.remove(se),scene.remove(ue),scene.fog=new THREE.FogExp2(palette[0],0),scene.remove(stage.generate.stars)},this.ready=function(){p&&(TIME.reset(),A=window.performance.now(),E=0,s.START=!0)},this.reset=function(){if(s.END&&v[3]+T<stage.best[3])for(var e in stage.best){var t=3===e?E+T:v[e];stage.best[e]=t}this.START=!1,this.END=!1,DNF=!1,g=!1,control.UP=!1,control.DOWN=!1,control.LEFT=!1,control.RIGHT=!1,p=!1,m=!1,L=!1,R=!1,E=0,v=[],M=0,T=0,w=0,N=0,J.copy(Q),Z.copy(J),U.set(0,1,0),z.set(0,0,0),X.set(0,0,1),se.copy(new THREE.LineSegments(ne[s.MODEL].geometry(),re)),se.lookAt(X),G=0,_=0,camera.position.copy(J),camera.position.add(U.clone().multiplyScalar(-60)),camera.position.z+=40,camera.up.set(0,0,1),camera.lookAt(se.position),camera.updateProjectionMatrix(),renderer.render(scene,camera),vhs.reset(),window.setTimeout(function(){g=!0},1e3);for(let e=0;e<ghost.length;e++)ghost[e].reset();TIME.reset(),a=[],c=0,A=RAFID,a[0]={time:RAFID,position:J.clone(),normal:X.clone(),direction:new THREE.Vector3(0,1,0),camera:camera.position.clone(),velocity:new THREE.Vector3,rotation:0},o=0},this.update=function(){R=DNF||s.END||!g?(p=!1,m=!1,L=!1):(p=control.UP,m=control.DOWN,L=control.LEFT,control.RIGHT);let i=0;if(RAFID>a[c].time){let e={};Object.assign(e,a[c]);let t=e.time;a=[],c=0,a.push({time:t,position:e.position.clone(),normal:e.normal.clone(),direction:e.direction.clone(),velocity:e.velocity.clone(),rotation:e.rotation,camera:e.camera.clone()});let o=window.performance.now();for(;t<o;)t+=l,a.push({time:t,position:a[c].position.clone(),normal:a[c].normal.clone(),direction:a[c].direction.clone(),velocity:a[c].velocity.clone(),camera:e.camera.clone(),rotation:a[c].rotation}),c=a.length-1,r=n=void 0,0!=(r=L&&R?0:L?1:R?-1:0)&&Math.abs(V)<C?V+=r:Math.abs(V)>C?(n=V/Math.abs(V),V=C*n):0<Math.abs(V)&&(n=V/Math.abs(V),V-=V/Math.abs(V),V/Math.abs(V)!=n&&(V=0)),_=V/C*k,a[c].rotation+=_,P=a[c].velocity.length(),n=void 0,p&&d&&(F.copy(a[c].direction),F.multiplyScalar(D),a[c].velocity.add(F)),m&&d&&a[c].velocity.multiplyScalar(B),d?(b=!1,n=S?x-.01:x,a[c].velocity.multiplyScalar(n)):d||(b?a[c].velocity.add(q):b=!0,a[c].velocity.multiplyScalar($)),a[c].position.add(a[c].velocity),u.position.copy(a[c].position),function(){ee.copy(a[c].position),ee.z-=50,te=[],oe.set(0,0,1),ie.far=100,ie.set(ee,oe),stage.surface.raycast(ie,te),0<te.length?(ee.copy(te[0].point),S=a[c].position.z<ee.z&&Math.abs(a[c].position.z-ee.z)<5?(f=0,d=!0,K.copy(te[0].face.normal),a[c].position.copy(ee),1!==te[0].face.color.r):d=!1):0===te.length&&(d=!1,S=!1,p||m||L||R||(f+=l),f>y&&!s.END&&!DNF&&(DNF=!0,state.dnf()));let e=K.clone();e.multiplyScalar(1);var t=b?.001:.25;j.lerp(K,t),X.copy(j),X.add(a[c].position),a[c].normal=j.clone(),u.lookAt(X),u.rotateOnAxis(W,a[c].rotation),U.copy(u.localToWorld(Y.clone())),U.sub(a[c].position),U.normalize(),a[c].direction.copy(U)}(),function(){te=[],oe.copy(a[c].position),oe.sub(a[c-1].position),oe.normalize(),ie.far=oe.length(),ie.set(a[c].position,oe);let t=0,o=!1;for(let e=N;e<5;e++)if(stage.generate.checkpoints[e].collision.raycast(ie,te),0<te.length){t=e,o=!0;break}if(I=!1,o){var e,i=Math.floor(100*E)/100;if(t===N)stage.generate.checkpoints[N].display.material.color=palette[4],0<N&&(v[N-1]=i,ui.delete(16,32,ui.width-16,16),e=Number.isNaN(stage.best[N-1])?"+1 cp":i-stage.best[N-1],e=0<e?"(-"+ui.float(e)+")":"+1 cp"===e?"+1 cp":"(+"+ui.float(Math.abs(e))+")",ui.text(e,16,32)),4===N&&(I=!0,v[t-1]=i,v[t]=i+T,M=E+T<stage.best[3]?100-T+Math.floor(10*(stage.best[3]-(i+T))):100-T,H+=M,s.END=!0,control.RESET=!1,state.complete()),I=!0,N++;else{I=!0;for(let e=N-1;e<t-1;e++)0<=e&&(v[e]="-",w++);T=25*w,4===t?(v[t-1]=i,v[t]=i+T,M=E+T<stage.best[3]?100-T+Math.floor(10*(stage.best[3]-(E+T))):100-T,H+=M,N=0,s.END=!0,control.RESET=!1,state.complete()):(v[t-1]=i,N=t+1,ui.delete("2","4","30","1"),ui.text("missed checkpoint x "+w.toString()+" ( -"+T.toString()+".00 )",16,32)),I=!0,stage.generate.checkpoints[t].display.material.color=palette[4]}}s.SPEED=Math.round(60*P/1e3*3600),s.START&&!s.END&&(E=(RAFID-A)/1e3),s.OBJECTIVE=N,Z.copy(J)}(),i++,s.START&&vhs.record(s),u.updateMatrix(),o=window.performance.now()}var n,r;if(t=(l-(a[c].time-RAFID))/l,1<t&&(t=1),1<a.length){h.position.copy(a[c-1].position),h.position.lerp(a[c].position,t),h.normal.copy(a[c-1].normal),h.normal.lerp(a[c].normal,t),h.normal.multiplyScalar(5);let e=h.normal.clone();e.add(h.position),h.rotation=a[c].rotation,h.rotation-=a[c-1].rotation,h.rotation=a[c-1].rotation+h.rotation*t,h.direction.copy(a[c-1].direction),h.direction.lerp(a[c].direction,t),h.direction.multiplyScalar(5),h.direction.normalize(),se.position.copy(h.position),se.lookAt(e),se.rotateOnAxis(W,h.rotation),function(){if(s.FPV)s.fpv();else{var e=DNF||s.END?1e-5:.1;const t=h.direction.clone();t.multiplyScalar(-s.cameras[0].distance+4*(ui.scale-1)),t.add(h.position),t.z+=s.cameras[0].z,camera.position.lerp(t,e),camera.lookAt(se.position)}}(),he()}this.START||this.ready()},this.results=function(){return{reward:M,yen:H}},this.AT=function(){return E},this.CP=function(){return v.slice()},this.replay=function(e){var t={TS:TIME.time};if(vhs.frame=vhs.convert(vhs.tape,t,vhs.frame),h.position.copy(t.position),j.copy(t.lookTarget),h.rotation=t.rotation,h.normal.copy(j),h.normal.add(h.position),se.position.copy(h.position),se.lookAt(h.normal),se.rotateOnAxis(W,h.rotation),h.direction.copy(se.localToWorld(Y.clone())),h.direction.sub(h.position),h.direction.normalize(),p=t.UP,I=t.CHECK,h.rotation=t.rotation,N=t.objective,!n){let o=h.position.clone();if(I&&(stage.generate.checkpoints[N].display.material.color=palette[4]),3===s.CAMERA)s.fpv();else{let e=1,t=1;s.CAMERA===i&&(e=s.cameras[1].lerp,t=1),i=s.CAMERA,o.x+=s.cameras[s.CAMERA].x,o.y+=s.cameras[s.CAMERA].y,o.z+=s.cameras[s.CAMERA].z,camera.up.set(0,0,1),camera.position.lerp(o,e),s.cameras[i].lookAt.lerp(h.position,t),camera.lookAt(s.cameras[i].lookAt)}}he()},this.record=function(){return{position:a[c].position.clone(),lookTarget:a[c].normal.clone(),UP:p,AT:E,TS:vhs.tape.length*l,rotation:a[c].rotation,objective:N,check:I}},this.fpv=function(){camera.position.copy(h.position);let e=se.localToWorld(new THREE.Vector3(0,0,5));e.sub(h.position),e.normalize(),camera.up.copy(e);const t=h.direction.clone();t.add(h.position),camera.lookAt(t)};function pe(e){return e=e<0?0:5<e?5:e}this.tune={power:function(e=r.power){r.power=pe(e),D=O.power.lo+r.power/5*O.power.range},drag:function(e=r.drag){r.drag=pe(e),x=O.drag.hi-r.drag/5*O.drag.range},sensitivity:function(e=r.sensitivity){r.sensitivity=pe(e),k=O.sensitivity.lo+r.sensitivity/5*O.sensitivity.range},ease:function(e=r.ease){r.ease=pe(e),C=O.ease.lo+r.ease}},this.param=function(){return array=Object.assign(r,[]),array.model=ne[s.MODEL].name,array},this.paint=function(e=s.PAINT){s.PAINT=e,re.color.set(PAINT[e]),re.needsUpdate=!0},this.body=function(){se.geometry.dispose(),se.geometry=ne[s.MODEL].geometry().clone(),se.geometry.verticesNeedUpdate=!0},this.yen=function(){return state.cSave("YEN",H),H},this.debug=function(){console.log("position:",se.position,J),console.log("direction:",U),console.log("rotation:",G),console.log("dt:",1),console.log("TIME:",RAFID),console.log("TAPES:",Math.ceil(RAFID-A)/l),console.log("INTERPOLATION:",t),console.log("PHYSICS MESH:",u.rotation),console.log("TAPE VELOCITY",a[c].velocity),console.log(a),console.log(f)}}function VHS(e){var l=this;this.PLAY=!1,this.RECORD=!0,this.tape=[],this.frame=0,this.timer=0,this.AT=function(){return l.tape[t].timer},this.DT=DT();let t=0;this.SCAN=!1,this.capture=function(e){return{position:(new THREE.Vector3).copy(e.position),normal:(new THREE.Vector3).copy(e.normal),lookTarget:e.lookTarget.clone(),rotation:e.rotation,timer:e.getTime(),objective:e.getObjective(),check:e.check,UP:e.UP}},this.record=function(e){l.tape[t]=e.record(),t=24e4<l.tape[t].TS?0:t+1},this.play=function(e){if(this.RECORD){this.RECORD=!1;for(let e=l.frame=0;e<ghost.length;e++)ghost[e].reset();TIME.reset(),TIMEOUT=0}if(l.frame>l.tape.length-10){l.frame=0,TIME.reset();for(let e=0;e<ghost.length;e++)ghost[e].reset();stage.generate.resetCheckpoints()}if(e.replay(),this.tape[l.frame].check){let e=0;e=0===this.tape[l.frame].objective?4:this.tape[l.frame].objective-1,stage.generate.checkpoints[e].display.material.color=palette[4]}},this.reset=function(){stage.generate.resetCheckpoints(),t=0,l.frame=0,TIME.reset(),l.PLAY=!1,l.RECORD=!0,l.tape=[]},this.export=function(o=function(){state.results()}){if(!1===PERSONAL_BEST||vehicle.CP()[4]<PERSONAL_BEST&&!l.SCAN){ui.print("uploading vhs to db","2","2"),PERSONAL_BEST=vehicle.CP()[4];UID;var e=stage.name,i=vehicle.CP()[4],n=vehicle.CP().slice(),r=vehicle.MODEL,s=vehicle.PAINT,a=l.save(l.tape);let t=[];for(let e=0;e<a.length;e++){var c="";c+=l.burn(a[e].TS),c+="#",c+=l.burn(Math.round(100*a[e].AT)/100),c+="#",c+=l.burn(a[e].position.x),c+="#",c+=l.burn(a[e].position.y),c+="#",c+=l.burn(a[e].position.z),c+="#",c+=l.burn(a[e].lookTarget.x),c+="#",c+=l.burn(a[e].lookTarget.y),c+="#",c+=l.burn(a[e].lookTarget.z),c+="#",c+=l.burn(a[e].rotation),t.push(c)}s={version:DB_BUILD,id:UID,seed:e,time:Math.round(100*i)/100,cp:n,data:t,model:r,paint:s},firebase.database().ref("vhs/"+DB_BUILD+"/"+s.seed+"/"+UID).set(s,e=>{e?(ui.clear(),ui.print("network error","2","2")):(ui.clear(),ui.print("vhs succesfully submitted","2","2")),window.setTimeout(o,1e3)})}else state.results()},this.burn=function(e){return Math.round(1e9*e).toString(16)},this.read=function(e){return parseInt(e,16)/1e9},this.scan=function(e,t){l.SCAN=!0;let o=[];firebase.database().ref("vhs/"+DB_BUILD+"/"+e).orderByChild("time").limitToFirst(SCORE_LIMIT).once("value").then(function(e){e.forEach(function(e){var t=e.child("id").val(),e=e.child("time").val();o.push({uid:t,time:e})}),l.SCAN=!1,t(o)})},this.checkTime=function(e,t,o){e===t&&(PERSONAL_BEST=o)},this.requestName=function(e,t){firebase.database().ref("uid/"+e).once("value").then(e=>{e=e.child("name").val();return t(e),e})},this.import=function(e,a=function(){}){firebase.database().ref("vhs/"+DB_BUILD+"/"+e).once("value").then(e=>{let n=e.val();var t=n.id,o=n.seed,i=n.cp.slice();let r=[];var s=n.model,e=n.paint;for(let i=0;i<n.data.length;i++){let t=0,o=[];o[0]="";for(let e=0;e<n.data[i].length;e++)"#"===n.data[i].charAt(e)?(o[t]=l.read(o[t]),t++,o[t]=""):o[t]+=n.data[i].charAt(e);o[8]=l.read(o[8]),r[i]={TS:o[0],AT:o[1],position:new THREE.Vector3(o[2],o[3],o[4]),lookTarget:new THREE.Vector3(o[5],o[6],o[7]),rotation:o[8]}}l.save(r,1e3/60);a({uid:t,seed:o,cp:i,model:s,paint:e,tape:r.slice()})})},this.save=function(t,e=1e3/30){let o=0,i=[];var n=t[t.length-1].TS;let r=0;for(;r<n;)r+=e,r<n&&i.push({TS:r});for(let e=0;e<i.length;e++)o=l.convert(t,i[e],o);return i},this.convert=function(e,t,o){var i=e[o].TS;let n=e[o+1].TS,r=n-i;for(;t.TS>n&&o<e.length-2;)i=e[++o].TS,n=e[o+1].TS,r=n-i;var s=o,a=o+1,c=(r-(n-t.TS))/r;return t.position=new THREE.Vector3,t.position.copy(e[s].position),t.position.lerp(e[a].position,c),t.lookTarget=new THREE.Vector3,t.lookTarget.copy(e[s].lookTarget),t.lookTarget.lerp(e[a].lookTarget,c),t.rotation=(e[a].rotation-e[s].rotation)*c,t.rotation+=e[s].rotation,t.rotation=(e[a].rotation-e[s].rotation)*c,t.rotation+=e[s].rotation,t.AT=(e[a].AT-e[s].AT)*c,t.AT+=e[s].AT,t.UP=e[s].UP,t.check=e[s].check,t.objective=e[s].objective,o}}TIME.convert=(o=[])=>{let i="[\n";for(let t=0;t<o.length;t++){i+="'";for(let e=0;e<o[t].length;e++)i+=o[t].charCodeAt(e).toString(16);i+="',\n"}return i+="]",console.log(i),i};})();
