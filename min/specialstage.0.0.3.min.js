function UI(){var a=this;this.renderer=document.createElement("canvas");this.renderer.id="ui";document.body.appendChild(this.renderer);var f=this.renderer.getContext("2d");this.context=f;var w=document.createElement("img");w.src="./img/STAGE_8PX.png";w.onload=function(){a.connect();a.onload()};document.createElement("canvas");this.onload=function(){};var q=document.createElement("canvas"),J=q.getContext("2d");this.scale=1;this.row=this.col=8;this.width;this.height;var b=128;var m=180;var n=128;var k=
80;var E=128;var H=m;var Q=128;var K=80;var da=128;var Y=m+60;var ca=128;var Z=40;var N=!1,aa=[],U=[];this.connect=function(){f.imageSmoothingEnabled=!1;q.width=w.width;q.height=w.height;J.drawImage(w,0,0,q.width,q.height,0,0,q.width,q.height)};this.resize=function(t,x,y){var B=document.querySelector("meta[name=viewport]"),I=1/window.devicePixelRatio*Math.round(window.devicePixelRatio);B.setAttribute("content","width="+Math.floor(window.innerWidth*I)+", initial-scale="+I+",maximum-scale=4.0, user-scalable=0");
a.scale=y;this.width=t;this.height=x;this.renderer.width=t;this.renderer.height=x;this.renderer.style.zoom=y;f.imageSmoothingEnabled=!1;this.redraw();b=128;m=180;n=128;k=80;E=128;H=m;Q=128;K=80;da=128;Y=m+60;ca=128;Z=40;this.automate(t,x)};this.update=function(t){for(var x in t)for(var y in U)if(t[x].x>U[y].x*a.scale&&t[x].y>U[y].y*a.scale&&t[x].x<U[y].w*a.scale&&t[x].y<U[y].h*a.scale&&1==t[x].start){U[y].funct();t[x].start=!1;break}};this.print=function(t,x,y,B){B=void 0===B?1:B;for(var I=0,V=a.compile(x,
a.width,a.col),F=a.compile(y,a.height,a.row);I<t.length;)a.encode(t.charAt(I),V+I*a.col*B,F,B),I++;N||aa.push(function(){a.print(t,x,y,B)})};this.text=function(t,x,y,B,I){B=void 0===B?1:B;for(I=0;I<t.length;)a.encode(t.charAt(I),x+I*a.col*B,y,B),I++};this.button=function(t,x,y,B,I,V,F,D){F=void 0===F?!0:F;D=void 0===D?1:D;var M=a.compile(x,a.width,a.col),S=a.compile(y,a.height,a.row),ba=a.compile(B,a.width,a.col),P=a.compile(I,a.height,a.row);F&&(f.drawImage(q,0,0,1,1,M,S+P/2,ba+1,1),f.drawImage(q,
0,0,1,1,M,S-P/2,ba+1,1),f.drawImage(q,0,0,1,1,M,S-P/2,1,P),f.drawImage(q,0,0,1,1,M+ba-1,S-P/2,1,P));for(var ha=0;ha<t.length;)a.encode(t.charAt(ha),M+ha*a.col+ba/2-Math.round(t.length*a.col)/2+2,S-a.row/2,D),ha++;U.push({x:M,y:S-P/2,w:M+ba,h:S+P/2,funct:function(){V()}});N||aa.push(function(){a.button(t,x,y,B,I,V,F,D)})};this.line=function(t,x,y,B){a.sprite(0,0,1,1,t,x,y,B)};this.sprite=function(t,x,y,B,I,V,F,D){var M=a.compile(I,a.width,a.col),S=a.compile(V,a.height,a.row),ba=a.compile(F,a.width,
a.col),P=a.compile(D,a.height,a.row);f.drawImage(q,t,x,y,B,M,S,ba,P);N||aa.push(function(){a.sprite(t,x,y,B,I,V,F,D)})};this.backdrop=function(t,x,y,B,I){t=void 0===t?"#10101099":t;!1===t?(a.clear(),a.renderer.style.background="transparent"):(a.clear(),a.renderer.style.background=t)};this.getDrawList=function(){return aa};this.redraw=function(){N=!0;a.clear();for(var t=0;t<aa.length;t++)aa[t]();t=document.body.getElementsByTagName("input");for(var x=0;x<t.length;x++)a.text(t[x].value,t[x].style.top,
t[x].style.left);N=!1};this.automate=function(t,x){var y=Math.floor(t/3)-2,B=Math.floor(x/4);n>y&&(da=ca=E=Q=b=n=y);m>B&&(H=m=B+40,Y=m+60)};this.pad=function(t,x,y,B,I,V,F){var D=0;for(F();D<control.touches.length;)control.touches[D].x>x*a.scale&&control.touches[D].y>y*a.scale&&control.touches[D].x<(x+B)*a.scale&&control.touches[D].y<(y+I)*a.scale&&V(),D++;HITBOX&&(f.drawImage(q,0,0,1,1,x+1,y,B-1,1),f.drawImage(q,0,0,1,1,x+1,y+I,B-1,1),f.drawImage(q,0,0,1,1,x+1,y,1,I),f.drawImage(q,0,0,1,1,x+B-1,
y,1,I));a.encode(t,x+B/2-a.col/2,y+I/2-a.row/2)};this.dpad=function(){f.drawImage(q,88,88,40,40,a.width-E+Q/2-20,a.height-H+K/2-20,40,40);f.drawImage(q,88,70,40,17,a.width-da+Q/2-20,a.height-Y+Z-8,40,17);a.pad("<",b-n-1,a.height-m,n,k,function(){control.LEFT=!0},function(){control.LEFT=!1});a.pad(">",b+1,a.height-m,n,k,function(){control.RIGHT=!0},function(){control.RIGHT=!1});a.pad("^",a.width-E,a.height-H,Q,K,function(){control.UP=!0},function(){control.UP=!1});a.pad("b",a.width-da,a.height-Y+Z/
2,ca,Z,function(){control.DOWN=!0},function(){control.DOWN=!1})};this.clear=function(){if(!N){for(var t=document.body.getElementsByTagName("input"),x=0;x<t.length;x++)document.body.removeChild(t[x]);aa=[]}U=[];f.clearRect(0,0,a.width,a.height)};this["delete"]=function(t,x,y,B){x=void 0===x?0:x;y=void 0===y?renderer.width:y;B=void 0===B?renderer.height:B;t=a.compile(void 0===t?0:t,a.width,a.col);x=a.compile(x,a.height,a.row);y=a.compile(y,a.width,a.col);B=a.compile(B,a.height,a.row);f.clearRect(t,
x,y,B)};this.encode=function(t,x,y,B){B=void 0===B?1:B;var I=t.charCodeAt(0);t=8*I%128;I=8*Math.floor(I/16);f.clearRect(x,y,8,8);f.drawImage(q,t,I,8,8,x,y,8*B,8*B)};this["float"]=function(t,x){var y=Math.floor(Math.abs(100*t));y=y.toString();var B=y.slice(0,y.length-2);y=y.slice(y.length-2,y.length);if(0==t)return"0.00";0==B.length&&(B="0");2>y.length&&(y+="0");x&&0<t?B="+"+B:0>t&&(B="-"+B);return B+"."+y};this.compile=function(t,x,y){var B=0;switch(typeof t){case "number":B=t;break;case "function":B=
t();break;case "string":for(var I=!1,V=1,F=0,D="";F<t.length;){var M=t.charAt(F);"."===M?(D+=M,I=!0):"+"===M?(D=I?Number(D)*x:Number(D)*y,D*=V,V=1,B+=D,I=!1,D=""):"-"===M?(D=I?Number(D)*x:Number(D)*y,D*=V,V=-1,B+=D,I=!1,D=""):"p"===M?(D=Number(D),D*=V,B+=D,D=""):F===t.length-1?(D+=M,D=I?Number(D)*x:Number(D)*y,D*=V,B+=D,D=""):D+=M;F++}}return B};this.textinput=function(t,x,y,B,I,V,F){var D=a.compile(x,a.width,a.col),M=a.compile(y,a.height,a.row),S=a.compile(B,a.width,a.col),ba=a.compile(I,a.height,
a.row);if(N)a.text("> "+F.value,D,M+ba/2);else{F=document.createElement("input");F.type="text";F.id=V;F.name=V;F.value=t;F.style.top=M*a.scale+"px";F.style.left=D*a.scale+"px";F.style.width=S*a.scale+"px";F.style.height=ba*a.scale+"px";F.style.paddingLeft=12*a.scale+"px";F.style.fontSize=14*a.scale+"px";F.maxlength=10;F.autofocus=!0;a.text("> "+F.value,D,M+ba/2);document.body.appendChild(F);window.setTimeout(function(){F.focus();F.select()},200);F.oninput=function(){P()};F.onfocusout=function(){P()};
F.onfocusin=function(){P()};F.onclick=function(){P()};var P=function(ha){a["delete"](D,M,S,ba);a.text("> "+F.value,D,M+ba/2);a.text("_",F.selectionStart*a.col+2*a.col+D,M+ba/2)};aa.push(function(){a.textinput(F.value,x,y,B,I,V,F)})}}};function Control(){var a=this;this.ENTER=this.RIGHT=this.LEFT=this.DOWN=this.UP=this.MOBILE=!1;this.touches=[];this.connect=function(){this.MOBILE?(window.addEventListener("touchstart",a.touch,!1),window.addEventListener("touchmove",a.touch,!1),window.addEventListener("touchend",a.touch,!1)):(window.addEventListener("keydown",a.key,!1),window.addEventListener("keyup",a.key,!1),window.addEventListener("mousedown",a.mousedown),window.addEventListener("mouseup",a.mouseup,!1),window.addEventListener("touchstart",
a.touchSetup,!1))};this.disconnect=function(){window.removeEventListener("keydown",a.key,!1);window.removeEventListener("keyup",a.key,!1);window.removeEventListener("mousedown",a.mousedown,!1);window.removeEventListener("mouseup",a.mouseup,!1);window.removeEventListener("touchstart",a.touchSetup,!1);window.removeEventListener("touchstart",a.touch,!1);window.removeEventListener("touchmove",a.touch,!1);window.removeEventListener("touchend",a.touch,!1)};this.key=function(f){var w="keydown"==f.type;switch(f.key){case "ArrowUp":a.UP=
w;break;case "ArrowDown":a.DOWN=w;break;case "ArrowLeft":a.LEFT=w;break;case "ArrowRight":a.RIGHT=w;break;case "w":a.UP=w;break;case "s":a.DOWN=w;break;case "a":a.LEFT=w;break;case "d":a.RIGHT=w;break;case "r":a.RESET=w;break;case " ":a.SPACE=w;break;case "Enter":a.ENTER=w}};this.mousedown=function(f){f.preventDefault();a.touches[0]={x:f.clientX,y:f.clientY,start:!0}};this.mouseup=function(f){f.preventDefault();a.touches[0]={x:f.clientX,y:f.clientY,start:!1}};this.touchSetup=function(f){window.removeEventListener("keydown",
a.key,!1);window.removeEventListener("keyup",a.key,!1);window.removeEventListener("keyup",a.key,!1);window.removeEventListener("mousedown",a.mousedown,!1);window.removeEventListener("mouseup",a.mouseup,!1);window.removeEventListener("touchstart",a.touchSetup,!1);window.addEventListener("touchstart",a.touchstart,!1);window.addEventListener("touchmove",a.touchmove,!1);window.addEventListener("touchend",a.touchend,!1);a.touchstart(f)};this.clear=function(){a.touches=[];this.ENTER=this.RIGHT=this.LEFT=
this.DOWN=this.UP=!1};this.touchstart=function(f){f=f.touches;a.touches=[];for(var w=0;w<f.length;w++)a.touches[w]={x:f[w].clientX,y:f[w].clientY,start:!0}};this.touchmove=function(f){a.touches=[];f=f.touches;for(var w=0;w<f.length;w++)a.touches[w]={x:f[w].clientX,y:f[w].clientY,start:!1}};this.touchend=function(f){a.touches=[];f=f.touches;for(var w=0;w<f.length;w++)a.touches[w]={x:f[w].clientX,y:f[w].clientY,start:!1}}};function Vehicle(){function a(){if(w)for(var A=0;1>A;){emitter.geometry.vertices[ea].copy(S);emitter.geometry.vertices[ea].multiplyScalar(-1-Math.random()*V);emitter.geometry.vertices[ea].add(l);emitter.geometry.vertices[ea].life=emitter.geometry.vertices[ea].maxLife;var W=.1*-Math.random();emitter.geometry.vertices[ea].acc.copy(S);emitter.geometry.vertices[ea].acc.multiplyScalar(W);ea++;ea%=emitter.geometry.vertices.length;A++}for(var fa in emitter.geometry.vertices)0<emitter.geometry.vertices[fa].life&&
(emitter.geometry.vertices[fa].add(emitter.geometry.vertices[fa].acc),--emitter.geometry.vertices[fa].life,emitter.geometry.colors[fa].setHSL(0,0,emitter.geometry.vertices[fa].life/100)),0===emitter.geometry.vertices[fa].life&&(emitter.geometry.vertices[fa].set(0,0,0),emitter.geometry.vertices[ea].acc.x=0,emitter.geometry.vertices[ea].acc.y=0,emitter.geometry.vertices[ea].acc.z=0);emitter.geometry.verticesNeedUpdate=!0;emitter.geometry.colorsNeedUpdate=!0;emitter.geometry.computeBoundingSphere()}
var f=this;this.TEXTTIME=this.SPEED="";this.END=this.START=!1;this.OBJECTIVE=0;this.POSITION;this.MODEL=1;this.ANALOG=!1;this.PENALTY=function(){return E};this.CAMERA=1;var w=!1,q=!1,J=!0,b=!1,m=1,n=0,k=[],E=0,H=0,Q=0,K=0,da=!1,Y=0,ca=0,Z=0,N={power:2,drag:2,mass:1,brake:3,sensitivity:2,ease:0},aa=0,U=0,t=0;aa=.02-.015;U=.985-.98;t=.075-.055;var x,y,B,I=6,V,F=0,D=0,M=0,S=new THREE.Vector3(0,1,0),ba=new THREE.Vector3(0,0,0),P=new THREE.Vector3,ha=new THREE.Vector3(0,0,1),ja=new THREE.Vector3(0,0,1),
e=new THREE.Vector3(0,0,1),d=new THREE.Vector3(0,0,1),g=new THREE.Vector3(0,0,-.0065),l=new THREE.Vector3,p=new THREE.Vector3,h=new THREE.Vector3,C=new THREE.Vector3,r=[],u=new THREE.Vector3(0,0,1),G=new THREE.Raycaster(C,u,0,2);this.cameras=[];this.cameras[0]={distance:15,x:0,y:0,z:7,lerp:.1,lookAt:new THREE.Vector3};this.cameras[1]={distance:0,x:20,y:20,z:10,lerp:.05,lookAt:new THREE.Vector3};this.cameras[2]={distance:0,x:-30,y:-30,z:20,lerp:.05,lookAt:new THREE.Vector3};this.cameras[3]={distance:0,
x:-40,y:40,z:30,lerp:.075,lookAt:new THREE.Vector3};this.cameras[4]={distance:0,x:0,y:-20,z:60,lerp:.0075,lookAt:new THREE.Vector3};var z=[];this.models=function(){return z};z[0]=(new THREE.Geometry).fromBufferGeometry(new THREE.EdgesGeometry(new THREE.BoxGeometry(1,2,1)));z[0].name="logistics crate";var T=new THREE.MeshBasicMaterial;z[1]=new THREE.Geometry;z[1].vertices.push(new THREE.Vector3(.45,-.75,1));z[1].vertices.push(new THREE.Vector3(.3,1.2,1));z[1].vertices.push(new THREE.Vector3(-.45,-.75,
1));z[1].vertices.push(new THREE.Vector3(-.3,1.2,1));z[1].vertices.push(new THREE.Vector3(.3,1.2,1));z[1].vertices.push(new THREE.Vector3(-.3,1.2,1));z[1].vertices.push(new THREE.Vector3(.45,-.75,1));z[1].vertices.push(new THREE.Vector3(-.45,-.75,1));z[1].vertices.push(new THREE.Vector3(-.3,1.2,1));z[1].vertices.push(new THREE.Vector3(-1,-.75,-.1));z[1].vertices.push(new THREE.Vector3(-.45,-.75,1));z[1].vertices.push(new THREE.Vector3(-1,-.75,-.1));z[1].vertices.push(new THREE.Vector3(.3,1.2,1));
z[1].vertices.push(new THREE.Vector3(1,-.75,-.1));z[1].vertices.push(new THREE.Vector3(.45,-.75,1));z[1].vertices.push(new THREE.Vector3(1,-.75,-.1));z[1].vertices.push(new THREE.Vector3(.45,-.75,1));z[1].vertices.push(new THREE.Vector3(.45,-1.4,.4));z[1].vertices.push(new THREE.Vector3(-.45,-.75,1));z[1].vertices.push(new THREE.Vector3(-.45,-1.4,.4));z[1].vertices.push(new THREE.Vector3(.45,-1.4,.4));z[1].vertices.push(new THREE.Vector3(-.45,-1.4,.4));z[1].vertices.push(new THREE.Vector3(.45,-1.4,
.4));z[1].vertices.push(new THREE.Vector3(1,-.75,-.1));z[1].vertices.push(new THREE.Vector3(-.45,-1.4,.4));z[1].vertices.push(new THREE.Vector3(-1,-.75,-.1));z[1].center();z[1].name="ag-86";for(var O=(new THREE.LineSegments(z[f.MODEL].clone(),T)).clone(),ea=0,ia=new THREE.Geometry;100>ia.vertices.length;){var X=new THREE.Vector3(0,0,0);X.life=0;X.maxLife=100;X.acc=new THREE.Vector3(0,0,0);ia.vertices.push(X);X=new THREE.Color(4294967040);ia.colors.push(X)}ia.verticesNeedUpdate=!0;emitter=new THREE.Points(ia,
new THREE.PointsMaterial({size:.1,vertexColors:THREE.VertexColors,blending:THREE.AdditiveBlending,transparent:!0}));emitter.name="Emitter";this.init=function(){var A=state.cLoad("YEN");ca=""===A?0:parseInt(A)};this.connect=function(A,W){O.copy(new THREE.LineSegments(z[f.MODEL].clone(),T));h.copy(A);l.copy(h);p.copy(l);scene.add(O);scene.add(emitter);f.tune.power();f.tune.drag();f.tune.sensitivity();f.tune.ease();scene.fog=new THREE.FogExp2(palette[0],.01);camera.fov=90;camera.updateProjectionMatrix();
scene.add(stage.generate.stars);b=!1;window.setTimeout(function(){b=!0},1E3)};this.disconnect=function(){f.reset();scene.remove(O);scene.remove(emitter);scene.fog=new THREE.FogExp2(palette[0],0);scene.remove(stage.generate.stars)};this.ready=function(){w&&(K=performance.now(),n=0,f.START=!0)};this.reset=function(){if(f.END&&k[3]+E<stage.best[3])for(var A in stage.best)stage.best[A]=3===A?n+E:k[A];b=DNF=this.END=this.START=!1;control.UP=!1;control.DOWN=!1;control.LEFT=!1;R=L=q=w=control.RIGHT=!1;n=
0;k=[];Z=H=E=Y=0;l.copy(h);p.copy(l);S.set(0,1,0);P.set(0,0,0);d.set(0,0,1);O.copy(new THREE.LineSegments(z[f.MODEL].clone(),T));O.lookAt(d);F=D=0;camera.position.copy(l);camera.position.add(S.clone().multiplyScalar(-60));camera.position.z+=40;camera.lookAt(O.position);camera.updateProjectionMatrix();renderer.render(scene,camera);vhs.reset();window.setTimeout(function(){b=!0},1E3)};this.update=function(){this.START?control.RESET&&this.reset():this.ready();DNF||f.END||!b?R=L=q=w=!1:(w=control.UP,q=
control.DOWN,L=control.LEFT,R=control.RIGHT);a();var A=L&&R?0:L?1:R?-1:0;0!=A&&Math.abs(M)<I?M+=A:0<Math.abs(M)&&(M-=M/Math.abs(M));F=M/I;F*=B;D+=F;D%=2*Math.PI;S.copy(O.up);S.applyMatrix4(O.matrixWorld);S.sub(l);S.normalize();ba.copy(S);V=P.length();w&&J&&(ba.copy(S).multiplyScalar(x),P.add(ba));q&&J&&P.multiplyScalar(.95);J?P.multiplyScalar(y):P.multiplyScalar(.99);l.add(P);O.position.copy(l);C.copy(l);C.z-=50;r=[];u.set(0,0,1);G.far=100;G.set(C,u);stage.surface.raycast(G,r);0<r.length?(C.copy(r[0].point),
l.z<C.z&&5>Math.abs(l.z-C.z)?(Q=0,J=!0,ja.copy(r[0].face.normal),l.copy(C)):J?(J=!1,P.sub(g)):P.add(g)):0===r.length&&(J=!1,Q++,P.add(g),60<Q&&!f.END&&!DNF&&(DNF=!0,state.dnf()));e.lerp(ja,.2);d.copy(e);d.add(l);O.lookAt(d);O.rotateOnAxis(ha,D);r=[];u.copy(l);u.sub(p);G.far=u.length();u.normalize();G.set(l,u);A=0;for(var W=!1,fa=Z;5>fa;fa++)if(stage.generate.checkpoints[fa].collision.raycast(G,r),0<r.length){A=fa;W=!0;break}da=!1;if(W)if(A===Z)stage.generate.checkpoints[Z].display.material.color=
palette[4],0<Z&&(k[Z-1]=n,ui["delete"]("2","4","30","1"),W=Number.isNaN(stage.best[Z-1])?"+1 cp":n-stage.best[Z-1],W=0<W?"(-"+ui["float"](W)+")":"+1 cp"===W?"+1 cp":"(+"+ui["float"](Math.abs(W))+")",ui.text(W,16,32)),4===Z&&(da=!0,k[A-1]=n,k[A]=n+E,Y=n+E<stage.best[3]?100-E+Math.floor(10*(stage.best[3]-(n+E))):100-E,ca+=Y,f.END=!0,state.complete()),da=!0,Z++;else{da=!0;for(W=Z-1;W<A-1;W++)0<=W&&(k[W]="-",H++);E=25*H;4===A?(k[A-1]=n,k[A]=n+E,Y=n+E<stage.best[3]?100-E+Math.floor(10*(stage.best[3]-(n+
E))):100-E,ca+=Y,Z=0,f.END=!0,state.complete()):(k[A-1]=n,Z=A+1,ui["delete"]("2","4","30","1"),ui.text("missed checkpoint x "+H.toString()+" ( -"+E.toString()+".00 )",16,32));da=!0;stage.generate.checkpoints[A].display.material.color=palette[4]}f.SPEED=Math.round(60*V/1E3*3600);f.START&&!f.END&&(n=Math.floor((window.performance.now()-K)/10)/100);f.OBJECTIVE=Z;p.copy(l);A=DNF||f.END?1E-5:.1;W=S.clone();W.multiplyScalar(-f.cameras[0].distance);W.add(O.position);W.z+=f.cameras[0].z;camera.position.lerp(W,
A);camera.lookAt(O.position)};this.results=function(){return{reward:Y,yen:ca}};this.AT=function(){return n};this.CP=function(){return k.slice()};this.replay=function(A){l.copy(A.position);O.position.copy(l);S.copy(A.direction);ja.copy(A.normal);d.copy(A.lookAt);w=A.UP;da=A.CHECK;D=A.rotation;Z=A.objective;O.lookAt(d);O.rotateOnAxis(ha,D);A=l.clone();var W=1,fa=1;f.CAMERA===m&&(W=f.cameras[1].lerp,fa=1);m=f.CAMERA;A.x+=f.cameras[f.CAMERA].x;A.y+=f.cameras[f.CAMERA].y;A.z+=f.cameras[f.CAMERA].z;camera.position.lerp(A,
W);f.cameras[m].lookAt.lerp(l,fa);camera.lookAt(f.cameras[m].lookAt);da&&(stage.generate.checkpoints[Z].display.material.color=palette[4]);a()};this.record=function(){return{position:l.clone(),direction:S.clone(),normal:ja.clone(),lookAt:d.clone(),UP:w,rotation:D,objective:Z,check:da}};this.tune={power:function(A){A=void 0===A?N.power:A;N.power=0>A?0:5<A?5:A;x=.015+N.power/5*aa},drag:function(A){A=void 0===A?N.drag:A;N.drag=0>A?0:5<A?5:A;y=.985-N.drag/5*U},sensitivity:function(A){A=void 0===A?N.sensitivity:
A;N.sensitivity=0>A?0:5<A?5:A;B=.055+N.sensitivity/5*t},ease:function(A){A=void 0===A?N.ease:A;N.ease=0>A?0:5<A?5:A;I=6+N.ease}};this.param=function(){array=Object.assign(N,[]);array.model=z[f.MODEL].name;return array};this.yen=function(){state.cSave("YEN",ca);return ca};this.debug=function(){console.log("ROTATION:",D)}};function Generate(){scope=this;var a=this.SEED=0;this.length=480;var f=[],w=0;f[0]={name:"forest",palette:palette[9],tree:function(e,d){return scope.pine()},limit:Math.floor(scope.length/2),range:5,map:[],flags:[]};f[0].map[0]=function(e,d){var g=palette[10],l=!1;.92<Math.abs(e)&&(g=.92<Math.abs(e)?palette[9]:palette[2],l=!0);f[0].flags[d]=l;return g};f[1]={name:"sakura",palette:palette[12],tree:function(){return scope.sakura()},limit:Math.floor(1/6*scope.length),range:10,map:[],flags:[]};f[1].map[0]=
function(e,d){var g=palette[1],l=!1;.95<Math.abs(e)&&(g=.92<Math.abs(e)?palette[12]:palette[1],l=!0);f[1].flags[d]=l;return g};var q=new THREE.Points(new THREE.Geometry);q.name="Generative Extruder";q.visible=!1;var J=new THREE.Line(new THREE.Geometry);J.name="Generative Nodes";J.visible=!1;J.material.color=palette[6];J.material.name="Node Material";J.position.z+=2;var b=new THREE.LineSegments(new THREE.Geometry);b.name="Generative Segments";b.visible=!0;b.material.color=palette[3];b.material.name=
"Segments Material";var m=new THREE.Mesh(new THREE.Geometry);m.name="Generative Surface";m.visible=!1;m.material.color=palette[0];m.material.name="Surface Material";var n=new THREE.LineSegments(new THREE.Geometry);n.name="Generative Perimeter";n.material.color=palette[1];n.material.name="Perimeter Material";var k=new THREE.Mesh(new THREE.Geometry,new THREE.MeshBasicMaterial({vertexColors:THREE.VertexColors}));k.name="Terrain";k.material.name="Terrain Material";k.material.wireframe=!0;k.material.side=
THREE.DoubleSide;k.visible=!0;wireframe=new THREE.Mesh(new THREE.Geometry,new THREE.MeshBasicMaterial({vertexColors:THREE.VertexColors}));wireframe.name="Wireframe";wireframe.material.name="Wireframe Material";wireframe.material.wireframe=!0;wireframe.material.side=THREE.FrontSide;wireframe.visible=!0;var E=new THREE.LineSegments(new THREE.Geometry,new THREE.LineBasicMaterial({vertexColors:THREE.VertexColors}));E.name="Trees";var H=new THREE.Mesh(new THREE.Geometry,new THREE.MeshBasicMaterial);H.name=
"Background";H.material.color=palette[0];H.material.name="Background Material";H.material.wireframe=!1;H.material.side=THREE.FrontSide;H.material.opacity=.75;H.material.blendMode=THREE.MultiplyBlending;H.material.transparent=!0;var Q=new THREE.Points(new THREE.Geometry);Q.material.color=palette[1];Q.material.sizeAttenuation=!1;Q.material.size=1.5;Q.material.fog=!1;scope.stars=Q;var K=new THREE.Mesh(new THREE.Geometry);K.name="Collision Mesh";K.visible=!0;K.material.color=palette[3];K.material.name=
"Collision Material";K.material.side=THREE.BackSide;this.checkpoints=[];var da=new THREE.Vector3(0,0,1),Y=new THREE.Vector3(1,0,0);new THREE.Vector3(0,1,0);new THREE.Vector3(0,0,1);var ca=new THREE.Vector3(0,3,0),Z=new THREE.Vector3(0,0,1),N=J.geometry.clone(),aa=m.geometry.clone(),U=b.geometry.clone(),t=n.geometry.clone(),x=[],y=[],B=new THREE.Vector3;x[0]=new THREE.Vector3(4,3,0);x[1]=new THREE.Vector3(-4,3,0);y[0]=x[0].clone();y.z+=1;y[1]=x[1].clone();y.z+=1;var I=Math.PI/64,V=Math.PI/32,F=[],
D=0,M=new THREE.Vector3;this.start=new THREE.Vector3;var S=!1,ba=!1,P=!1;this.IMPORT=this.END=!1;this.DISTANCE=0;var ha=18,ja=new THREE.Raycaster;ja.far=800;q.geometry.vertices[0]=ca.clone();q.geometry.vertices[1]=da.clone().add(ca);q.geometry.vertices[2]=x[0].clone();q.geometry.vertices[3]=x[1].clone();q.geometry.vertices[4]=y[0].clone();q.geometry.vertices[5]=y[1].clone();this.connect=function(){scope.SEED=SEED;w=scope.randomInt(0,2);scene.add(q);scene.add(J);scene.add(b);scene.add(n);scene.add(m);
scene.add(wireframe);scene.add(H);D=window.performance.now();window.setTimeout(scope.generate,0)};this.disconnect=function(){F=[];scene.remove(q);scene.remove(J);scene.remove(b);scene.remove(n);scene.remove(m);scene.remove(wireframe);scene.remove(H);scene.remove(E);for(var e in f)f[e].flag=[];for(var d in scope.checkpoints)scene.remove(scope.checkpoints[d].display),scope.checkpoints[d].display.geometry.dispose(),scope.checkpoints[d].collision.geometry.dispose()};this.complete=function(){K.geometry.mergeVertices();
K.geometry.verticesNeedUpdate=!0;K.geometry.elementsNeedUpdate=!0;K.geometry.computeFaceNormals();K.geometry.computeBoundingSphere();wireframe.geometry.mergeVertices();wireframe.geometry.verticesNeedUpdate=!0;wireframe.geometry.elementsNeedUpdate=!0;wireframe.geometry.computeFaceNormals();wireframe.geometry.computeBoundingSphere();H.geometry.copy(K.geometry);--H.position.z;var e=new THREE.IcosahedronGeometry(1200,4),d;for(d in e.vertices).3>scope.random()&&-400<e.vertices[d].z&&Q.geometry.vertices.push(e.vertices[d].clone());
e.dispose();Q.geometry.computeBoundingSphere();stage.surface=K.clone();stage.start=scope.start.clone();D=window.performance.now()-D;S=!0;scope.END=!0;FIREBASE&&firebase.analytics().logEvent("stage_generation_complete",{time:Math.round(D/1E3)});state.ready()};this.reset=function(){ha=(36+scope.random()-.5)/2;a=0;J.geometry.dispose();b.geometry.dispose();m.geometry.dispose();q.geometry.dispose();n.geometry.dispose();k.geometry.dispose();wireframe.geometry.dispose();K.geometry.dispose();E.geometry.dispose();
Q.geometry.dispose();U.dispose();t.dispose();N.dispose();aa.dispose();U.copy(new THREE.Geometry);t.copy(new THREE.Geometry);N.copy(new THREE.Geometry);aa.copy(new THREE.Geometry);J.geometry.copy(new THREE.Geometry);q.geometry.copy(new THREE.Geometry);b.geometry.copy(new THREE.Geometry);n.geometry.copy(new THREE.Geometry);m.geometry.copy(new THREE.Geometry);k.geometry.copy(new THREE.Geometry);K.geometry.copy(new THREE.Geometry);ca.set(0,3,0);Z.set(0,0,1);x[0]=new THREE.Vector3(4,3,0);x[1]=new THREE.Vector3(-4,
3,0);S&&(P=ba=S=!1);this.END=!1;q.position.set(0,0,0);q.geometry.vertices[0]=ca.clone();q.geometry.vertices[1]=da.clone().add(ca);q.geometry.vertices[2]=x[0].clone();q.geometry.vertices[3]=x[1].clone();q.geometry.vertices[4]=y[0].clone();q.geometry.vertices[5]=y[1].clone();q.geometry.verticesNeedUpdate=!0};this.generate=function(){scope.path()};this.path=function(e,d,g,l,p,h,C,r,u,G){e=void 0===e?0:e;d=void 0===d?0:d;g=void 0===g?0:g;l=void 0===l?0:l;p=void 0===p?0:p;h=void 0===h?{start:0,end:30,
angle:0,slope:0}:h;C=void 0===C?[]:C;r=void 0===r?[]:r;u=void 0===u?!1:u;G=void 0===G?999:G;var z=window.performance.now(),T=0;for(0===l&&(l=.5<scope.random()?1:-1);32>T&&!ba;){if(e===h.end+1){r=[];for(g=0;1>g;g++)if(e>=scope.length)r.push({angle:0,slope:0,end:30}),G=e+30;else if(0===d){T=scope.randomInt(2,4)*l;var O=Math.floor(Math.abs(36/T));l=.01>scope.random()?1*l:-1*l;O=scope.randomInt(1,O);r.push({angle:T,slope:0,end:O})}else T=scope.randomInt(-5,-1),T=.2>scope.random()?T*=-1:T,O=scope.randomInt(2,
20),r.push({angle:0,slope:T,end:O});T=scope.randomInt(0,r.length);d=r[T].angle;g=r[T].slope;h.start=e;h.end=e+r[T].end;r=r.slice(T,1)}u||(scope.extrude(d,g),F.push({angle:d,slope:g}),N.verticesNeedUpdate=!0,e++);if(10<=e&&!u){T=new THREE.Vector2(N.vertices[e-1].x,N.vertices[e-1].y);for(O=0;O<N.vertices.length-1-10;O++)if(18>(new THREE.Vector2(N.vertices[O].x,N.vertices[O].y)).distanceTo(T)){u=!0;break}u&&window.setTimeout(stage.reset(!0),0)}e===G&&(ba=!0,J.geometry.dispose(),J.geometry=N.clone(),
J.geometry.computeBoundingSphere(),J.geometry.center(),J.updateMatrixWorld(),0<J.geometry.vertices.length&&(M.copy(J.geometry.vertices[0]),M.sub(N.vertices[0])),window.setTimeout(function(){scope["import"]()},0));T=window.performance.now()-z}ba||u||window.setTimeout(scope.path,0,e,d,g,l,p,h,C,r,u,G)};this["import"]=function(e){e=void 0===e?0:e;for(var d=window.performance.now(),g=0;!P&&32>g;){0===e&&(q.position.set(0,0,0),q.rotation.z=0,ca.set(0,3,0),q.geometry.vertices[0]=ca.clone(),q.geometry.vertices[1]=
da.clone().add(ca),q.geometry.vertices[2]=x[0].clone(),q.geometry.vertices[3]=x[1].clone(),q.geometry.vertices[4]=y[0].clone(),q.geometry.vertices[5]=y[1].clone(),q.geometry.verticesNeedUpdate=!0,q.updateMatrixWorld());if(e<F.length)angle=F[e].angle,slope=F[e].slope,scope.extrude(angle,slope),b.geometry.dispose(),b.geometry=U.clone(),b.geometry.computeBoundingSphere(),n.geometry.dispose(),n.geometry=t.clone(),n.geometry.computeBoundingSphere(),m.geometry.dispose(),m.geometry=aa.clone(),m.geometry.computeBoundingSphere(),
e++;else if(!P&&e===F.length){scope.checkpoints=scope.checkpoint();for(var l in scope.checkpoints)scene.add(scope.checkpoints[l].display);P=!0;window.setTimeout(function(){scope.terrain(!0)},0)}g=window.performance.now()-d}P||window.setTimeout(scope["import"],0,e,angle,slope)};this.extrude=function(e,d){e=void 0===e?0:e;d=void 0===d?0:d;q.updateMatrixWorld();q.rotateZ(e*V);for(var g in q.geometry.vertices)q.geometry.vertices[g].applyAxisAngle(Y,d*I);q.geometry.verticesNeedUpdate=!0;g=q.geometry.vertices[0].clone();
var l=q.geometry.vertices[2].clone(),p=q.geometry.vertices[3].clone(),h=q.geometry.vertices[1].clone();g.applyMatrix4(q.matrix);l.applyMatrix4(q.matrix);p.applyMatrix4(q.matrix);h.applyMatrix4(q.matrix);h.sub(g);if(ba){l.add(M);p.add(M);if(0<U.vertices.length){var C=U.vertices[U.vertices.length-1].clone().sub(B),r=U.vertices[U.vertices.length-2].clone().sub(B);aa.vertices.push(l.clone().sub(h));aa.vertices.push(p.clone().sub(h));aa.vertices.push(r);aa.vertices.push(p.clone().sub(h));aa.vertices.push(C);
aa.vertices.push(r);C=l.clone();r=p.clone();var u=U.vertices[U.vertices.length-1].clone(),G=U.vertices[U.vertices.length-2].clone();K.geometry.vertices.push(C);K.geometry.vertices.push(r);K.geometry.vertices.push(G);K.geometry.vertices.push(r);K.geometry.vertices.push(u);K.geometry.vertices.push(G);C=aa.vertices.length;aa.faces.push(new THREE.Face3(C-3,C-2,C-1));aa.faces.push(new THREE.Face3(C-5,C-4,C-6));K.geometry.faces.push(new THREE.Face3(C-3,C-2,C-1));K.geometry.faces.push(new THREE.Face3(C-
5,C-4,C-6))}0<t.vertices.length?(r=2,C=1,4<t.vertices.length&&(r=4,C=2),r=t.vertices[t.vertices.length-r].clone(),C=t.vertices[t.vertices.length-C].clone(),t.vertices.push(l.clone().add(h.clone())),t.vertices.push(r.clone()),t.vertices.push(p.clone().add(h.clone())),t.vertices.push(C.clone()),a==F.length-1&&(t.vertices.push(l.clone().add(h.clone())),t.vertices.push(p.clone().add(h.clone())))):(t.vertices.push(l.clone().add(h.clone())),t.vertices.push(p.clone().add(h.clone())));U.vertices.push(l.clone());
U.vertices.push(p.clone());B.copy(h)}else N.vertices.push(g.clone());ca.copy(g).sub(q.position);q.position.add(ca);for(var z in q.geometry.vertices)q.geometry.vertices[z].applyAxisAngle(Y,-1*d*I)};this.terrain=function(e,d,g,l,p,h,C){d=void 0===d?[]:d;g=void 0===g?[]:g;l=void 0===l?[]:l;p=void 0===p?0:p;h=void 0===h?0:h;C=void 0===C?0:C;if(void 0===e||e){b.updateMatrixWorld();k.geometry.dispose();k.geometry.copy(new THREE.Geometry);d=[];g=[];l=[];for(e=0;2>e;e++)l[e]=[],d[e]=[],g[e]=[];for(e=0;e<
b.geometry.vertices.length;e++)g[e%2].push(b.geometry.vertices[e]);for(e=0;2>e;e++)for(var r=0;r<g[e].length;r++){var u=0===e?1:-1,G=g[e][r].clone();G.sub(g[e+u][r]);G.normalize().multiplyScalar(3);l[e][r]=G.clone()}}r=0;e=window.performance.now();if(4>p){k.geometry.verticesNeedUpdate=!0;k.geometry.elementsNeedUpdate=!0;k.geometry.computeBoundingSphere();k.geometry.computeFaceNormals();k.geometry.computeVertexNormals();k.updateMatrixWorld();if(0<p&&0===C)for(g[h]=[],u=0;u<d[h].length;u++)g[h][u]=
k.geometry.vertices[d[h][u]];0===C&&(d[h]=[]);for(v=C;v<g[h].length&&32>r;){r=!1;if(void 0!==g[h][v]&&void 0!==g[h][v-1]){if(void 0===l[h][v])l[h][v]=l[s][v-1].clone();else if(k.geometry.computeBoundingSphere(),u=g[h][v].clone().add(l[h][v]),u.z-=100,ja.set(u,da),u.z+=100,G=ja.intersectObjects([k],!0),0<G.length)for(var z in G).01<G[z].point.distanceTo(u)&&(d[h][v]=void 0,r=!0);r||(k.geometry.vertices.push(g[h][v].clone()),k.geometry.vertices.push(g[h][v].clone().add(l[h][v])),d[h][v]=k.geometry.vertices.length-
1,0<v&&(k.geometry.vertices.push(g[h][v-1].clone()),r=k.geometry.vertices.length,0===h?k.geometry.faces.push(new THREE.Face3(r-2,r-1,r-3)):1===h&&k.geometry.faces.push(new THREE.Face3(r-1,r-2,r-3))))}r=window.performance.now()-e;v++;C=v}if(C===g[h].length){C=0;for(z=1;z<d[h].length;z++)void 0!==d[h][z]&&void 0!==d[h][z-1]&&(e=k.geometry.vertices[d[h][z]],r=k.geometry.vertices[d[h][z-1]],2.8>e.distanceTo(r)?(e.copy(r),d[h][z]=d[h][z-1],l[h][z].copy(l[h][z-1])):1<z&&(k.geometry.vertices.push(g[h][z-
1]),k.geometry.faces.push(new THREE.Face3(0===h?d[h][z]:d[h][z-1],0===h?d[h][z-1]:d[h][z],k.geometry.vertices.length-1))));h++}1<h&&(h=0,p++)}if(4===p){k.geometry.verticesNeedUpdate=!0;k.geometry.elementsNeedUpdate=!0;k.geometry.colorsNeedUpdate=!0;k.geometry.computeFaceNormals();k.geometry.computeVertexNormals();k.geometry.mergeVertices();k.geometry.computeBoundingSphere();scope.noise(k.geometry);for(z=0;z<k.geometry.faces.length;z++)e=k.geometry.vertices[k.geometry.faces[z].a].clone(),r=k.geometry.vertices[k.geometry.faces[z].b].clone(),
u=k.geometry.vertices[k.geometry.faces[z].c].clone(),K.geometry.vertices.push(e),K.geometry.vertices.push(r),K.geometry.vertices.push(u),wireframe.geometry.vertices.push(e),wireframe.geometry.vertices.push(r),wireframe.geometry.vertices.push(u),e=K.geometry.vertices.length,K.geometry.faces.push(new THREE.Face3(e-1,e-2,e-3)),wireframe.geometry.faces.push(new THREE.Face3(e-1,e-2,e-3));wireframe.geometry.copy(k.geometry);wireframe.geometry.computeVertexNormals();scope.biome();window.setTimeout(scope.complete,
0)}else window.setTimeout(function(){scope.terrain(!1,d.slice(),g.slice(),l.slice(),p,h,C)},0)};this.biome=function(){for(var e=w,d=wireframe.geometry.faces,g=[],l=[],p=0;p<d.length;p++)for(var h=0;h<f[w].map.length;h++)d[p].vertexColors[0]=f[w].map[h](d[p].vertexNormals[0].z,d[p].a),d[p].vertexColors[1]=f[w].map[h](d[p].vertexNormals[1].z,d[p].b),d[p].vertexColors[2]=f[w].map[h](d[p].vertexNormals[2].z,d[p].c);for(d=0;d<f[w].flags.length;d++)for(p=0;p<b.geometry.vertices.length;p++).1>wireframe.geometry.vertices[d].distanceTo(b.geometry.vertices[p])&&
(f[w].flags[d]=!1);for(d=0;d<f[w].flags.length;d++)f[w].flags[d]&&g.push(d);for(d=0;d<f[w].limit&&d<g.length;){p=scope.randomInt(0,g.length);h=!0;if(0<l.length&&0<g.length)for(;h;){for(var C in l)if(wireframe.geometry.vertices[g[p]].distanceTo(wireframe.geometry.vertices[l[C]])<f[w].range){h=!0;g.slice(p,1);p=scope.randomInt(0,g.length);break}else h=!1;0>=g.length&&(h=!1)}if(0<g.length){h=f[e].tree();for(var r in h.vertices)E.geometry.vertices.push(h.vertices[r].clone().add(wireframe.geometry.vertices[g[p]])),
E.geometry.colors[E.geometry.vertices.length-1]=h.colors[r];l.push(g[p]);g.slice(p,1)}d++}E.verticesNeedUpdate=!0;E.elementsNeedUpdate=!0;scene.add(E)};this.sakura=function(){var e=new THREE.Geometry,d=[],g=[],l=1,p=new THREE.Vector3(0,0,0),h=new THREE.Vector3(0,0,3),C=12,r=0,u=new THREE.Vector3(1,0,0),G=new THREE.Vector3(0,0,1);e.vertices.push(p);e.vertices.push(h);e.colors.push(palette[2]);e.colors.push(palette[2]);g.push({v:h.clone(),n:h.clone(),pitch:u.clone(),roll:G.clone()});for(p=[];4>r;){h=
[];for(u=0;u<g.length;u++)for(var z=G=0;3>z;z++){var T=0===r&&2===z&&1>G?1:scope.random();if(.2<T){T=scope.randomInt(-2,2);var O=g[u].n.clone(),ea=palette[2];O.applyAxisAngle(g[u].pitch,2*Math.PI/(C+T));O.applyAxisAngle(g[u].roll,2*Math.PI/3*z);O.multiplyScalar(l);T=O.clone().add(g[u].v);e.vertices.push(g[u].v.clone());e.vertices.push(T);e.colors.push(ea);e.colors.push(ea);ea=g[u].pitch.clone();ea.applyAxisAngle(g[u].roll,2*Math.PI/3*z);ea.applyAxisAngle(g[u].pitch,2*Math.PI/C);var ia=g[u].roll.clone();
ia.applyAxisAngle(g[u].pitch,2*Math.PI/C);ia.applyAxisAngle(g[u].roll,2*Math.PI/3*z);0<z&&d.push({a:T.clone(),b:g[u].v.clone(),pitch:ea,roll:ia});h.push({v:T.clone(),n:O.clone(),pitch:ea,roll:ia});G++}else 0===G&&2===z&&p.push({v:g[u].v.clone(),n:g[u].n.clone(),pitch:g[u].pitch.clone(),roll:g[u].roll.clone()})}g=h.slice();l*=.9;r++}C=6;for(var X in d)l=d[X].a.clone(),r=d[X].b.clone(),l=l.clone().sub(r),h=l.clone().multiplyScalar(.5).add(r),r=scope.randomInt(0,3)-1,l.applyAxisAngle(d[X].pitch,2*Math.PI/
C),l.applyAxisAngle(d[X].roll,2*Math.PI/r),l.multiplyScalar(.5),u=h,h=l.clone().add(h),e.vertices.push(u),e.vertices.push(h),e.colors.push(palette[2]),e.colors.push(palette[2]),u=d[X].pitch.clone(),u.applyAxisAngle(d[X].roll,2*Math.PI/r),u.applyAxisAngle(d[X].pitch,2*Math.PI/C),G=d[X].roll.clone(),G.applyAxisAngle(d[X].pitch,2*Math.PI/C),G.applyAxisAngle(d[X].roll,2*Math.PI/r),g.push({v:h.clone(),n:l.clone(),pitch:u,roll:G});g=g.concat(p);for(d=0;d<g.length;d++)for(C=0;5>C;C++)X=g[d].n.clone(),X.normalize(),
X.applyAxisAngle(g[d].pitch,2*Math.PI/6),X.applyAxisAngle(g[d].roll,2*Math.PI/5*C),X.multiplyScalar(.5),X=X.add(g[d].v),p=g[d].v.clone(),e.vertices.push(X),e.vertices.push(p),e.colors.push(palette[12]),e.colors.push(palette[12]);e.colorsNeedUpdate=!0;return e};this.pine=function(){var e=Math.floor(8*scope.random())+6,d=2*Math.PI/6,g=new THREE.Geometry;g.vertices.push(new THREE.Vector3(0,0,0));g.vertices.push(new THREE.Vector3(0,0,1*e-.5+1));g.colors.push(palette[9]);g.colors.push(palette[9]);g.colors.push(palette[9]);
for(var l=1;l<e;l++)for(var p=0;6>p;p++)off=l%2*d*.5,g.vertices.push(new THREE.Vector3(0,0,1*l+1)),g.vertices.push(new THREE.Vector3(.3*(e-l),0,1*l-.3+1)),g.vertices[g.vertices.length-1].applyAxisAngle(da,d*p+off),g.colors.push(palette[9]),g.colors.push(palette[9]);return g};this.checkpoint=function(){function e(p,h,C){var r=new THREE.Geometry,u=(new THREE.Vector3).copy(p).sub(h),G=(new THREE.Vector3).copy(p).add(u.clone().multiplyScalar(1.5));u=(new THREE.Vector3).copy(h).sub(u.clone().multiplyScalar(1.5));
r.vertices.push(new THREE.Vector3(G.x,G.y,G.z-12));r.vertices.push(new THREE.Vector3(G.x,G.y,G.z+12));r.vertices.push(new THREE.Vector3(u.x,u.y,u.z+12));r.vertices.push(new THREE.Vector3(u.x,u.y,u.z+12));r.vertices.push(new THREE.Vector3(u.x,u.y,u.z-12));r.vertices.push(new THREE.Vector3(G.x,G.y,G.z-12));r.faces.push(new THREE.Face3(0,1,2));r.faces.push(new THREE.Face3(3,4,5));G=new THREE.Geometry;G.vertices.push(new THREE.Vector3(p.x,p.y,p.z+6));G.vertices.push(new THREE.Vector3(p.x,p.y,p.z+8));
G.vertices.push(new THREE.Vector3(h.x,h.y,h.z+6));G.vertices.push(new THREE.Vector3(h.x,h.y,h.z+8));G.vertices.push(new THREE.Vector3(p.x,p.y,p.z+6));G.vertices.push(new THREE.Vector3(h.x,h.y,h.z+6));G.vertices.push(new THREE.Vector3(p.x,p.y,p.z+8));G.vertices.push(new THREE.Vector3(h.x,h.y,h.z+8));G.vertices.push(new THREE.Vector3(p.x,p.y,p.z+1));G.vertices.push(new THREE.Vector3(h.x,h.y,h.z+1));p=new THREE.MeshBasicMaterial({side:THREE.DoubleSide,wireframe:!1,fog:!0});p.color=palette[5];r=new THREE.Mesh(r,
p);r.visible=!0;p=new THREE.LineSegments(G,p);r.name="Objective "+C;p.name="Checkpoint"+C;return{display:p,collision:r}}var d=b.geometry,g=d.vertices.length-80;g=Math.floor(g/4)-Math.floor(g/4)%2;var l=[];l[0]=e(d.vertices[40],d.vertices[41],0);l[1]=e(d.vertices[g+40],d.vertices[g+1+40],1);l[2]=e(d.vertices[2*g+40],d.vertices[2*g+41],2);l[3]=e(d.vertices[3*g+40],d.vertices[3*g+41],3);l[4]=e(d.vertices[4*g+40],d.vertices[4*g+41],4);this.DISTANCE=4*g/2*3;scope.start.copy(d.vertices[36]);scope.start.sub(d.vertices[37]);
scope.start.multiplyScalar(-.75);scope.start.add(d.vertices[36]);for(d=0;5>d;d++)stage.best[d]=CHALLENGE?state.CHALLENGES[0].cp[d]:4>d?g*(d+1)/ha:stage.best[d]=stage.best[d-1];state.target();return l};this.resetCheckpoints=function(){for(var e in scope.checkpoints)scope.checkpoints[e].display.material.color=palette[5]};this.random=function(){SEED=(SEED+1)%2147483647;var e=1E4*Math.sin(SEED);return e-=Math.floor(e)};this.randomInt=function(e,d){return Math.floor(scope.random()*(d-e))+e};this.noise=
function(e){for(var d=new ImprovedNoise,g=[],l=8,p=0,h=0,C=1E3*scope.random(),r=0;r<e.vertices.length;r++)g[r]=0;for(r=0;2>r;r++){for(var u=0;u<e.vertices.length;u++)g[u]+=Math.floor(d.noise(e.vertices[u].x/l,e.vertices[u].y/l,C)*l),g[u]>p&&(p=g[u]),g[u]<h&&(h=g[u]);l*=3}for(d=0;d<g.length;d++){l=.5;for(p=0;p<b.geometry.vertices.length;p++)h=e.vertices[d].distanceTo(b.geometry.vertices[p]),h=h*h/100,h<l&&(l=h);e.vertices[d].z+=g[d]*l}};this.name=function(){var e="";if(CHALLENGE)e=state.CHALLENGES[0].seed;
else{var d=" pass; line; forest; summit; route; path; mountain; park".split(";"),g="n wa ra ya ma ha na ta ka a wi ri mi hi ni chi shi ki i ru yu mu fu nu tsu su ku u we re me he ne te se ke e wo ro yo mo no to so ko o".split(" ");TOGGLE=!1;for(var l=Math.ceil(3*Math.random())+1,p=0;p<l;)e+=g[Math.floor(Math.random()*g.length)],p++;e+=d[Math.floor(Math.random()*d.length)]}return e}};function Stage(){this.COMPLETE=!1;this.start=new THREE.Vector3;this.generate=new Generate;this.checkpoint=[];this.objectives=[];this.best=[];this.grid=[];this.dimension=2400;this.partitionDimension=16;this.partionDivision=this.dimension/this.partitionDimension;for(var a=0;4>a;a++)this.checkpoint[this.checkpoint.length]=new THREE.Mesh(new THREE.Geometry);this.connect=function(f){f=void 0===f?!1:f;camera.position.set(0,400,200);camera.far=2E3;camera.updateProjectionMatrix();camera.lookAt(new THREE.Vector3);
renderer.render(scene,camera);if(!f){this.name=this.generate.name();f="";for(var w in this.name)f+=this.name.charCodeAt(w).toString();SEED=f}this.generate.connect();COUNTER++};this.disconnect=function(){this.generate.disconnect();this.generate.reset()};this.reset=function(f){f=void 0===f?!1:f;SEED++;this.COMPLETE=!1;this.disconnect();this.generate=new Generate;this.connect(f)};this.preview=function(){window.setTimeout(0,0)}};function VHS(a){var f=this;this.PLAY=!1;this.RECORD=!0;this.tape=[];this.timer=0;this.AT=function(){return f.tape[w].timer};var w=0;this.capture=function(q){return{position:(new THREE.Vector3).copy(q.position),normal:(new THREE.Vector3).copy(q.normal),direction:(new THREE.Vector3).copy(q.dir),lookAt:q.lookAt.clone(),rotation:q.rotation,timer:q.getTime(),objective:q.getObjective(),check:q.check,UP:q.UP}};this.record=function(q){this.tape[w]=q.record();w++;w%=18E3;17999==w&&console.log("VHS OVERWRITE")};
this.play=function(q){this.RECORD&&(this.RECORD=!1,TIMEOUT=w=0);0===w&&stage.generate.resetCheckpoints();q.replay(this.tape[w]);this.tape[w].check&&(stage.generate.checkpoints[0===this.tape[w].objective?4:this.tape[w].objective-1].display.material.color=palette[4]);this.timer=this.tape[w].timer;w++;w%=this.tape.length;0===w&&stage.generate.resetCheckpoints()};this.reset=function(){w=0;stage.generate.resetCheckpoints();f.PLAY=!1;f.RECORD=!0;f.tape=[]};this["export"]=function(){for(var q="",J=0;J<f.tape.length;J++)q+=
f.tape[J].position.x+" "+f.tape[J].position.y+" "+f.tape[J].position.z,q+="/n";return q}};function State(){var a=this,f,w,q="",J=0;this.SETTINGS=!1;this.STATE=function(){};this.CHALLENGES=[];this.resize=function(b,m){f=b;w=m};this.wallet=function(){var b=vehicle.yen();ui.print("$ "+b.toString(),"2","1.0-4")};this.nav=function(b){b=void 0===b?function(){ui.clear()}:b;ui.sprite(8,64,8,8,"1.0-4+2p","2",8,8);ui.button("","1.0-8","2+4p","8","8",function(){a.menu(b)},!1)};this.title=function(b,m){a.breadcrumb(b,m);ui.sprite(16,64,8,8,"1.0-4+2p","2",8,8);ui.button("","1.0-7","2+4p","7","5",function(){ui.backdrop(!1);
b();MENU=!1;a.SETTINGS=!1},!1);a.wallet()};this.breadcrumb=function(b,m){var n=void 0===m?function(){ui.backdrop(!1);b();MENU=!1;a.SETTINGS=!1}:function(){a.menu(b);MENU=!0};ui.print("< menu","2","2");ui.button("","2","2+4p","7","8",n,!1)};this.menu=function(b){MENU=!0;ui.backdrop();ui.clear();a.title(b);ui.sprite(0,0,1,1,"2","6","1.0-4",1);ui.print(" > modify vehicle","2","8");ui.button("","2","8+4p","1.0-4","5",function(){a.vehicle(b)},!1);ui.sprite(0,0,1,1,"2","11","1.0-4",1);ui.print(" > settings ( dev )",
"2","13");ui.button("","2","13+4p","1.0-4","5",function(){a.settings(b)},!1);ui.sprite(0,0,1,1,"2","16","1.0-4",1);var m=8;if(PLAY||vhs.PLAY)ui.button("restart stage","2","1.0-2-"+m,"1.0-4","6",function(){ui.backdrop(!1);a.reset()},!0),m+=8;stage.COMPLETE&&(PLAY||vhs.PLAY)&&ui.button("next stage","2","1.0-2-"+m,"1.0-4","6",function(){ui.backdrop(!1);a.next()},!0);a.discord()};this.intro=function(){ui.clear();ui.print("specialstage.io","2","2");ui.print("-","2","4");if(CHALLENGE)if(ui.print("challenge detected",
"2","6",2),ui.print("issued by: "+a.CHALLENGES[0].operator_id,"2","10"),ui.print("seed: "+a.CHALLENGES[0].seed,"2","12"),1===state.CHALLENGES.length)ui.print("time: "+a.CHALLENGES[0].cp[4],"2","14");else{if(1<state.CHALLENGES.length){var b=[];for(b.push({operator_id:a.CHALLENGES[0].operator_id,cp:a.CHALLENGES[0].cp.slice()});b.length<a.CHALLENGES.length;){for(var m=1;m<a.CHALLENGES.length;m++){var n=parseFloat(a.CHALLENGES[m].cp[4]),k=parseFloat(b[b.length-1].cp[4]);n>k?b.push({operator_id:a.CHALLENGES[m].operator_id,
cp:a.CHALLENGES[m].cp.slice()}):b.unshift({operator_id:a.CHALLENGES[m].operator_id,cp:a.CHALLENGES[m].cp.slice()})}ui.print("best time: "+b[0].cp[4]+" ("+b[0].operator_id+")","2","14");for(m=0;m<b.length;m++)ui.print(m+1+".  "+b[m].operator_id,"2","18+"+2*m),n=ui["float"](b[m].cp[4]),ui.print(n,"0.5 - "+n.length,"18+"+2*m)}}}else ui.print("operator id:","2","6"),ui.print("> "+OPERATOR_ID+" [edit name?]","2","10"),ui.button("","2","9+4p","1.0-4","4",function(){a.inputName(a.intro)},!1);ui.print("A _ "+
BUILD,"2","1.0-4");a.nav(function(){a.intro()});ui.print("menu","1.0-9","2");ui.button("","1.0-9","2+4p","4","5",function(){a.menu(a.intro)},!1);a.discord();ui.button("start","2","1.0-12+"+(2*(RESIZE_SCALE-1)).toString(),"1.0-4","8",function(){scene.remove(demo);ui.clear();START=!0;FIREBASE&&firebase.analytics().logEvent("game_start");stage.connect();a.load()})};this.discord=function(){ui.sprite(2,83,16,12,"1.0-12","1.0-5+8p",16,12);ui.button("discord","1.0-11","1.0-4+4p","10","4",function(){window.open("https://discord.gg/ACewNWH")},
!1)};this.load=function(){ui.clear();LOADING=!0;a.nav(a.load);ui.print("seed : ","2","2");ui.print(stage.name,"2","5-1p",2);J=0};this.ready=function(){ui.clear();LOADING=!1;a.nav(a.ready);ui.print("stage generated.","2","2");ui.print(stage.name,"2","5-1p",2);a.target();ui.button("ready","2","1.0-10","1.0-4","8",function(){stage.generate.END=!1;ui.clear();a.play();PLAY=!0;vehicle.connect(stage.start,stage.surface);FIREBASE&&firebase.analytics().logEvent("stage_start")});a.wallet()};this.play=function(){ui.clear();
a.nav(a.play);MENU=!1};this.complete=function(){MENU=!0;ui.clear();a.nav(a.complete);var b=CHALLENGE?vehicle.CP()[4]>stage.best[4]?"challenge failed":"challenge victory!":"stage complete!";ui.print(b,"0.5-"+2*Math.round(b.length/2),"0.3-1",2);stage.COMPLETE=!0;window.setTimeout(a.results,2E3);FIREBASE&&(b=vehicle.param().model+" ("+(vehicle.param().power+1)+"/"+(vehicle.param().drag+1)+"/"+(vehicle.param().sensitivity+1)+"/"+(vehicle.param().ease+1)+")",firebase.analytics().logEvent("stage_complete",
{operator_id:OPERATOR_ID,time:vehicle.AT(),penalty:vehicle.PENALTY(),score:vehicle.AT()+vehicle.PENALTY(),seed:stage.name,rating:Math.round(stage.generate.DISTANCE/(vehicle.AT()+vehicle.PENALTY())),distance:stage.generate.DISTANCE,vehicle:b}))};this.results=function(){ui.clear();MENU=!0;var b=ui["float"](vehicle.AT()+vehicle.PENALTY());a.nav(a.results);ui.print("stage complete : "+stage.name,"2","2");ui.print(b,"2","5",2);vehicle.AT()+vehicle.PENALTY()<stage.best[4]?ui.print(CHALLENGE?"challenge victory!":
"new record!",2*b.length+"+3".toString(),"5+4p"):CHALLENGE&&ui.print("challenge failed",2*b.length+"+3".toString(),"5+4p");b=9;var m=vehicle.CP();if(320<w){for(var n=0;n<m.length-1;n++){ui.print("cp "+(n+1).toString(),"2",b+"+"+n.toString());var k=void 0,E=void 0;"number"===typeof m[n]?(k=ui["float"](m[n]),E=Number.isNaN(stage.best[n])?"+1 cp":m[n]-stage.best[n]):(k="penalty",E="");ui.print(k.toString(),"0.5 -1-"+k.length.toString(),b+"+"+n.toString());k="penalty"===k?"25 sec":"+1 cp"==E?"+1 cp":
0<E?"( - "+ui["float"](E)+" )":"( + "+ui["float"](Math.abs(E))+" )";ui.print(k,"0.5+1",b+"+"+n.toString());b+=1}b+=5}if(vehicle.AT()+vehicle.PENALTY()<stage.best[4]||!CHALLENGE)ui.print("reward","2",b.toString()),b+=3,ui.print("$"+vehicle.results().reward,"2",b.toString(),2);ui.button("issue challenge","0.5+1","1.0-20","0.5-3","4",a.challenge);ui.button("next stage","2","1.0-12","1.0-4","8",function(){a.next()});ui.button("restart stage","2","1.0-4","0.5-3","4",function(){a.reset("complete")});ui.button("view replay",
"0.5+1","1.0-4","0.5-3","4",function(){a.replay()});window.setTimeout(function(){PLAY=!1;vhs.PLAY=!0},0)};this.replay=function(){ui.clear();a.nav(a.results);for(var b={$jscomp$loop$prop$i$55:0};4>b.$jscomp$loop$prop$i$55;b={$jscomp$loop$prop$i$55:b.$jscomp$loop$prop$i$55},b.$jscomp$loop$prop$i$55++)ui.button("[ "+(b.$jscomp$loop$prop$i$55+1).toString()+" ]",(7*b.$jscomp$loop$prop$i$55).toString(),"1.0-3","7","5",function(m){return function(){vehicle.CAMERA=m.$jscomp$loop$prop$i$55+1}}(b),!1);ui.print("<",
"2","2");ui.button("","2","2+4p","7","8",function(){a.results(a.replay)},!1)};this.next=function(){ui.clear();CHALLENGE=!1;window.history.pushState("","","/");renderer.clear();vehicle.reset();vehicle.disconnect();stage.reset();PLAY=MENU=!1;vhs.PLAY=!1;a.load();FIREBASE&&firebase.analytics().logEvent("next_stage")};this.dnf=function(){ui.clear();a.nav(a.dnf);FIREBASE&&firebase.analytics().logEvent("dnf");ui.print("dnf","0.5-3+3p","0.5-8",2);ui.button("restart stage?","2","0.5+8","1.0-4","1.0-4",function(){a.reset("dnf")},
!1)};this.reset=function(b){b=void 0===b?"reset":b;ui.clear();a.nav(a.play);PLAY=!0;MENU=!1;vehicle.reset();FIREBASE&&firebase.analytics().logEvent("stage_restart",{status:b})};this.update=function(){MENU||!PLAY||DNF||ui.text(ui["float"](vehicle.AT()),16,16)};this.loading=function(){q=0!==J%16?q:3<=q.length?"":q+".";MENU||(ui["delete"](16,16,160,8),ui.text("stage generating"+q,16,16));J++};this.target=function(){ui.print(stage.name,"2","5-1p",2);ui.print(CHALLENGE?"challenge issued by: "+a.CHALLENGES[0].operator_id:
"target:","2","9");ui.print(ui["float"](stage.best[4]),"2","12-1p",2);if(300<w)for(var b=0;b<stage.best.length-1;b++){var m=Number.isNaN(stage.best[b])?"missed cp - 25 sec":ui["float"](stage.best[b]);ui.print("cp "+(b+1).toString(),"2","16+"+(2*b).toString());ui.print(m,"1.0-2-"+m.length.toString(),"16+"+(2*b).toString())}};this.vehicle=function(b){MENU=!0;ui.clear();var m=function(){a.cSave("MODEL",vehicle.MODEL);a.cSave("POWER",vehicle.param().power);a.cSave("DRAG",vehicle.param().drag);a.cSave("SENSITIVITY",
vehicle.param().sensitivity);a.cSave("EASE",vehicle.param().ease)};a.title(function(){b();m()},function(){a.menu();m()});var n=[],k=vehicle.param();n.push({id:"power",value:k.power,funct:function(Y){vehicle.tune.power(Y)}});n.push({id:"drag",value:k.drag,funct:function(Y){vehicle.tune.drag(Y)}});n.push({id:"sensitivity",value:k.sensitivity,funct:function(Y){vehicle.tune.sensitivity(Y)}});n.push({id:"easing",value:k.ease,funct:function(Y){vehicle.tune.ease(Y)}});k="8+";ui.sprite(0,0,1,1,"2",k+"-5+3",
"1.0-2-2",1);ui.print("model","2",k);ui.print(vehicle.models()[vehicle.MODEL].name,"2+8",k);ui.sprite(0,0,1,1,"2",k+"+3","1.0-2-2",1);ui.button(">","1.0-6",k+"+4p","4","4",function(){vehicle.MODEL+=1;1<vehicle.MODEL&&(vehicle.MODEL=0);a.vehicle(b)},!1);ui.button("<","1.0-12",k+"+4p","4","4",function(){--vehicle.MODEL;0>vehicle.MODEL&&(vehicle.MODEL=1);a.vehicle(b)},!1);k+="5+";for(var E={$jscomp$loop$prop$i$57:0};E.$jscomp$loop$prop$i$57<n.length;E={$jscomp$loop$prop$i$57:E.$jscomp$loop$prop$i$57},
E.$jscomp$loop$prop$i$57++){var H=k+(5*E.$jscomp$loop$prop$i$57).toString();ui.print(n[E.$jscomp$loop$prop$i$57].id,"2",H);ui.sprite(0,0,1,1,"2",H+"+3","1.0-2-2",1);for(var Q={$jscomp$loop$prop$n$59:0};6>Q.$jscomp$loop$prop$n$59;Q={$jscomp$loop$prop$n$59:Q.$jscomp$loop$prop$n$59},Q.$jscomp$loop$prop$n$59++){var K="1.0-18+"+(3*Q.$jscomp$loop$prop$n$59).toString(),da=Q.$jscomp$loop$prop$n$59<=n[E.$jscomp$loop$prop$i$57].value?48:40;ui.button("",K+"-10p",H+"+4p","3","4",function(Y,ca){return function(){n[Y.$jscomp$loop$prop$i$57].funct(ca.$jscomp$loop$prop$n$59);
a.vehicle(b)}}(E,Q),!1);ui.sprite(da,64,8,8,K,H,8,8)}}};this.settings=function(b){a.SETTINGS=!0;a.STATE=function(){b()};ui.clear();a.title(b,a.menu);ui.sprite(0,0,1,1,"2","6","1.0-4",1);ui.print("pixel scaling","2","8");(600>f||600>w)&&1===RESIZE_SCALE?ui.print("1 (locked)","1.0-2-10","8"):(ui.print(RESIZE_SCALE.toString()+" [change]","1.0-4-8","8"),ui.button("","2","8+4p","1.0-4","5",function(){return new function(){if(620<f&&620<w||1!=RESIZE_SCALE)SCALE=1<RESIZE_SCALE?1:2,resize(),a.settings(b)}},
!1));ui.sprite(0,0,1,1,"2","11","1.0-4",1);ui.print("control input","2","13");MOBILE?ui.print("touch (detected)","1.0-7-10","13"):ui.print("keyboard (detected)","1.0-11-10","13");ui.sprite(0,0,1,1,"2","16","1.0-4",1);if(MOBILE){var m=HITBOX?"enabled":"disabled";ui.print("display touch hitboxes","2","18");ui.print(m,"1.0-2-"+m.length,"18");ui.sprite(0,0,1,1,"2","21","1.0-4",1);ui.button("","2","18+4p","1.0-4","5",function(){HITBOX=!HITBOX;a.settings(b)},!1)}else ui.print("keybindings","2","18"),ui.print("arrow / wasd",
"1.0-14","18"),ui.sprite(0,0,1,1,"2","21","1.0-4",1);ui.print("developed by","2","1.0-14");ui.print("www.procedural.ca","2","1.0-10");ui.print("www.ginko.ltd","2","1.0-8");a.discord()};this.controls=function(b){ui.clear();a.title(b,a.menu)};this.fullscreen=function(){document.fullscreenElement?document.exitFullscreen&&document.exitFullscreen():document.documentElement.requestFullscreen()};this.prompt=function(){ui.clear();ui.print("specialstage.io","4","4",2);ui.print("-","4","8",2)};this.challenge=
function(b){ui.clear();a.nav(function(){a.challenge()},a.menu);ui.print("issue challenge url","2","2");ui.print("-","2","4");ui.print("issued by","2","6");ui.print("> "+OPERATOR_ID+" [edit name?]","2","9");ui.button("","2","9+4p","1.0-4","4",function(){a.inputName(a.challenge)},!1);ui.print("seed","2","13");ui.print(stage.name,"2","15");ui.print("time","2","19");b=ui["float"](vehicle.CP()[3]+vehicle.PENALTY());ui.print(b,"2","21");ui.button("copy challenge url","1","1.0-8","1.0-2","8",function(){ui.clear();
a.encodeURL();window.setTimeout(a.results,2E3)})};this.inputName=function(b){ui.clear();a.nav(function(){b()},a.menu);ui.print("edit operator name:","2","2");ui.textinput(OPERATOR_ID,"2","4","1.0-2","6","operator_id");var m=document.getElementById("operator_id");ui.button("accept","2","14","1.0-4","6",function(){OPERATOR_ID=m.value.toLowerCase();document.cookie="OPERATOR_ID="+OPERATOR_ID;b()},!0)};this.encodeURL=function(){data=[];data[0]={operator_id:OPERATOR_ID,seed:stage.name,cp:[]};for(var b=
vehicle.CP();5>data[0].cp.length;)data[0].cp.push(ui["float"](b[data[0].cp.length]));if(CHALLENGE)for(data[1]={operator_id:a.CHALLENGES[0].operator_id,seed:stage.name,cp:[]};5>data[1].cp.length;)data[1].cp.push(ui["float"](a.CHALLENGES[0].cp[data[1].cp.length]));b="";for(var m=0;m<data.length;m++)0<m&&(b+="\n"),b+=data[m].operator_id,b+="\t",b+=data[m].seed,b+="\t",b+=data[m].cp[0],b+="\t",b+=data[m].cp[1],b+="\t",b+=data[m].cp[2],b+="\t",b+=data[m].cp[3],b+="\t",b+=data[m].cp[4];b=window.btoa(b);
window.history.pushState("","","/");m=window.location.href;var n=window.location.pathname+"#"+b;navigator.clipboard.writeText(m+"#"+b).then(function(){ui.print("url copied to clipboard","2","2");window.history.pushState("","",n)},function(){window.history.pushState("","",n);ui.print("url copied to address bar","2","2")});FIREBASE&&firebase.analytics().logEvent("challenge_issued",{url:m+"#"+b})};this.decodeURL=function(){for(var b=window.location.href,m="",n=!1,k=0;k<b.length;k++)n&&(m+=b.charAt(k)),
"#"===b.charAt(k)&&(n=!0);if(n){var E=k=0;n=[[],[]];n[E][k]="";try{var H=window.atob(m);for(m=0;m<H.length;m++){var Q=H.charAt(m);"\t"===Q?(k++,n[E][k]=""):"\n"===Q?(k=0,E++,n[E][k]=""):n[E][k]+=Q}for(H=0;H<n.length;H++)7===n[H].length&&(a.CHALLENGES[H]={id:"",seed:"",cp:[]},a.CHALLENGES[H].operator_id=n[H][0],a.CHALLENGES[H].seed=n[H][1],a.CHALLENGES[H].cp[0]=parseFloat(n[H][2]),a.CHALLENGES[H].cp[1]=parseFloat(n[H][3]),a.CHALLENGES[H].cp[2]=parseFloat(n[H][4]),a.CHALLENGES[H].cp[3]=parseFloat(n[H][5]),
a.CHALLENGES[H].cp[4]=parseFloat(n[H][6]));CHALLENGE=!0;FIREBASE&&firebase.analytics().logEvent("challenge_accepted",{url:b})}catch(K){}}};this.cSave=function(b,m){var n=new Date;n.setTime(n.getTime()+1404E8);n="expires="+n.toUTCString();document.cookie=b+"="+m+";"+n+";path=/"};this.cLoad=function(b){b+="=";for(var m=document.cookie.split(";"),n=0;n<m.length;n++){for(var k=m[n];" "==k.charAt(0);)k=k.substring(1);if(0==k.indexOf(b))return k.substring(b.length,k.length)}return""};this.checksave=function(){var b=
a.cLoad("OPERATOR_ID");OPERATOR_ID=0!==b.length&&void 0!=b?b:"operator";b=a.cLoad("MODEL");var m=a.cLoad("POWER"),n=a.cLoad("DRAG"),k=a.cLoad("SENSITIVITY"),E=a.cLoad("EASE");b=0!=b.length&&void 0!==b?parseInt(b):vehicle.MODEL;m=0!==m.length&&void 0!==m?parseInt(m):vehicle.param().power;n=0!==n.length&&void 0!==n?parseInt(n):vehicle.param().drag;k=0!==k.length&&void 0!=k?parseInt(k):vehicle.param().sensitivity;E=0!==E.length&&void 0!==E?parseInt(E):vehicle.param().ease;vehicle.MODEL=b;vehicle.tune.power(m);
vehicle.tune.drag(n);vehicle.tune.sensitivity(k);vehicle.tune.ease(E)}};var BUILD="0.0.3";window.onload=init;window.onresize=resize;window.fullscreenchange=resize;window.focus=resize;var palette=[1052688,16777215,12698049,2894892,5308334,16740978,2393855,16722266,3424820,2201152,7168071,10066329,16756970],i;for(i in palette){var c=new THREE.Color(palette[i]);palette[i]=c}
var LOADSTATUS=0,SEED_NAME="",SEED=Math.floor(2147483647*Math.random()),scene,camera,renderer,stage,vehicle,control,ui,vhs,state,OPERATOR_ID="operator",UP,PLAY=!1,IMPORT=!1,BG=palette[0],FRAME=0,TIME=0,TIMER=0,DT=0,FPS=0,COUNTER=0,TIMEOUT=0,DNF=!1,REASON="out of bounds",FULLSCREEN=!1,MODE=0,LOAD=0,LOADING=!1,MENU=!1,MOBILE=!1,CHALLENGE=!1,OBJECTIVES=[],UPDATES=[],HITBOX=!0,FIREBASE=!0,SCALE=0,RESIZE_SCALE=1,RAFID=0,demo,CHALLENGES=[];
function init(){window.addEventListener("touchstart",activateTouch);window.addEventListener("contextmenu",function(){event.preventDefault()});scene=new THREE.Scene;scene.background=BG;UP=new THREE.Vector3(0,0,1);camera=new THREE.PerspectiveCamera;camera.up=UP;camera.position.z=2E3;camera.lookAt(0,0,0);camera.fov=70;camera.near=1E-4;camera.far=3E3;camera.name="Camera";scene.add(camera);renderer=new THREE.WebGLRenderer({logarithmicDepthBuffer:!0,antialias:!1});renderer.setClearColor(BG);renderer.domElement.id=
"renderer";document.body.appendChild(renderer.domElement);control=new Control;control.connect();ui=new UI;stage=new Stage;vehicle=new Vehicle;vhs=new VHS;state=new State;state.checksave();state.decodeURL();vehicle.init();resize();ui.onload=function(){camera.position.set(0,25,10);camera.lookAt(0,0,0);main();state.intro()}}function activateTouch(){MOBILE=!0;window.removeEventListener("touchstart",activateTouch)}
function resize(a){state.SETTINGS&&state.settings(state.STATE);RESIZE_SCALE=a=600<=window.innerWidth&&600<=window.innerHeight&&0===SCALE?2:0===SCALE?1:SCALE;var f=window.innerWidth/a,w=window.innerHeight/a;renderer.clear();renderer.setSize(f,w);renderer.domElement.style.zoom=a;camera.aspect=f/w;camera.updateProjectionMatrix();ui.resize(f,w,a);state.resize(f,w,a)}
function main(){RAFID=window.requestAnimationFrame(main);var a=window.performance.now();FPS=a-TIME;TIME=a;FPS=10*Math.round(100/FPS);PLAY?(vehicle.update(),vhs.record(vehicle),MENU||state.update(),!MOBILE||MENU||DNF||ui.dpad(),control.RESET&&(state.reset(),control.RESET=!1)):vhs.PLAY?vhs.play(vehicle):LOADING?(camera.position.applyAxisAngle(camera.up,.01),camera.lookAt(new THREE.Vector3,0,0,0),state.loading()):(camera.position.applyAxisAngle(camera.up,.01),camera.lookAt(new THREE.Vector3,0,0,0));
renderer.render(scene,camera);ui.update(control.touches)};