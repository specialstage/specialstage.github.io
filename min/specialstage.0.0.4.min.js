var ImprovedNoise=function(){function a(b){return b*b*b*(b*(6*b-15)+10)}function d(b,k,m){return k+b*(m-k)}function t(b,k,m,p){b&=15;var C=8>b?k:m;k=4>b?m:12==b||14==b?k:p;return(0==(b&1)?C:-C)+(0==(b&2)?k:-k)}for(var q=[151,160,137,91,90,15,131,13,201,95,96,53,194,233,7,225,140,36,103,30,69,142,8,99,37,240,21,10,23,190,6,148,247,120,234,75,0,26,197,62,94,252,219,203,117,35,11,32,57,177,33,88,237,149,56,87,174,20,125,136,171,168,68,175,74,165,71,134,139,48,27,166,77,146,158,231,83,111,229,122,60,
211,133,230,220,105,92,41,55,46,245,40,244,102,143,54,65,25,63,161,1,216,80,73,209,76,132,187,208,89,18,169,200,196,135,130,116,188,159,86,164,100,109,198,173,186,3,64,52,217,226,250,124,123,5,202,38,147,118,126,255,82,85,212,207,206,59,227,47,16,58,17,182,189,28,42,223,183,170,213,119,248,152,2,44,154,163,70,221,153,101,155,167,43,172,9,129,22,39,253,19,98,108,110,79,113,224,232,178,185,112,104,218,246,97,228,251,34,242,193,238,210,144,12,191,179,162,241,81,51,145,235,249,14,239,107,49,192,214,31,
181,199,106,157,184,84,204,176,115,121,50,45,127,4,150,254,138,236,205,93,222,114,67,29,24,72,243,141,128,195,78,66,215,61,156,180],J=0;256>J;J++)q[256+J]=q[J];return{noise:function(b,k,m){var p=Math.floor(b),C=Math.floor(k),E=Math.floor(m),M=p&255,I=C&255,fa=E&255;b-=p;k-=C;m-=E;p=b-1;C=k-1;E=m-1;var ea=a(b),X=a(k),la=a(m),O=q[M]+I,T=q[O]+fa;O=q[O+1]+fa;I=q[M+1]+I;M=q[I]+fa;fa=q[I+1]+fa;return d(la,d(X,d(ea,t(q[T],b,k,m),t(q[M],p,k,m)),d(ea,t(q[O],b,C,m),t(q[fa],p,C,m))),d(X,d(ea,t(q[T+1],b,k,E),
t(q[M+1],p,k,m-1)),d(ea,t(q[O+1],b,C,E),t(q[fa+1],p,C,E))))}}};function UI(){var a=this;this.renderer=document.createElement("canvas");this.renderer.id="ui";document.body.appendChild(this.renderer);var d=this.renderer.getContext("2d");this.context=d;var t=document.createElement("img");t.src="./img/stage.font.0.0.4.png";t.onload=function(){a.connect();a.onload()};document.createElement("canvas");this.onload=function(){};var q=document.createElement("canvas"),J=q.getContext("2d");this.scale=1;this.row=this.col=8;this.width;this.height;var b=128;var k=180;var m=
128;var p=80;var C=128;var E=k;var M=128;var I=80;var fa=128;var ea=k+60;var X=128;var la=40;var O=!1,T=[],V=[];this.connect=function(){d.imageSmoothingEnabled=!1;q.width=t.width;q.height=t.height;J.drawImage(t,0,0,q.width,q.height,0,0,q.width,q.height)};this.resize=function(r,y,z){a.scale=z;var B=window.devicePixelRatio;0!==Math.ceil(B)-B&&(z=Math.ceil(B)/B);1>=B&&1<a.scale&&(z=a.scale);this.width=r/z;this.height=y/z;this.renderer.width=this.width;this.renderer.height=this.height;renderer.setSize(this.width,
this.height);a.scale=z;this.renderer.style.transform="scale("+z+","+z+")";renderer.domElement.style.transform="scale("+z+","+z+")";this.renderer.style.transformOrigin="top left";renderer.domElement.style.transformOrigin="top left";d.imageSmoothingEnabled=!1;this.redraw();b=128;k=180;m=128;p=80;C=128;E=k;M=128;I=80;fa=128;ea=k+60;X=128;la=40;this.automate(this.width,this.height)};this.update=function(r){for(var y in r)for(var z in V)if(r[y].x>V[z].x*a.scale&&r[y].y>V[z].y*a.scale&&r[y].x<V[z].w*a.scale&&
r[y].y<V[z].h*a.scale&&1==r[y].start){V[z].funct();r[y].start=!1;break}};this.print=function(r,y,z,B){B=void 0===B?1:B;for(var N=0,aa=a.compile(y,a.width,a.col),G=a.compile(z,a.height,a.row);N<r.length;)a.encode(r.charAt(N),aa+N*a.col*B,G,B),N++;O||T.push(function(){a.print(r,y,z,B)})};this.text=function(r,y,z,B,N){B=void 0===B?1:B;for(N=0;N<r.length;)a.encode(r.charAt(N),y+N*a.col*B,z,B),N++};this.button=function(r,y,z,B,N,aa,G,H){G=void 0===G?!0:G;H=void 0===H?1:H;var Q=a.compile(y,a.width,a.col),
ia=a.compile(z,a.height,a.row),Y=a.compile(B,a.width,a.col),W=a.compile(N,a.height,a.row);G&&(d.drawImage(q,0,0,1,1,Q,ia+W/2,Y+1,1),d.drawImage(q,0,0,1,1,Q,ia-W/2,Y+1,1),d.drawImage(q,0,0,1,1,Q,ia-W/2,1,W),d.drawImage(q,0,0,1,1,Q+Y-1,ia-W/2,1,W));for(var ba=0;ba<r.length;)a.encode(r.charAt(ba),Q+ba*a.col+Y/2-Math.round(r.length*a.col)/2+2,ia-a.row/2,H),ba++;V.push({x:Q,y:ia-W/2,w:Q+Y,h:ia+W/2,funct:function(){aa()}});O||T.push(function(){a.button(r,y,z,B,N,aa,G,H)})};this.line=function(r,y,z,B){a.sprite(0,
0,1,1,r,y,z,B)};this.sprite=function(r,y,z,B,N,aa,G,H){var Q=a.compile(N,a.width,a.col),ia=a.compile(aa,a.height,a.row),Y=a.compile(G,a.width,a.col),W=a.compile(H,a.height,a.row);d.drawImage(q,r,y,z,B,Q,ia,Y,W);O||T.push(function(){a.sprite(r,y,z,B,N,aa,G,H)})};this.backdrop=function(r,y,z,B,N){r=void 0===r?"#10101099":r;!1===r?(a.clear(),a.renderer.style.background="transparent"):(a.clear(),a.renderer.style.background=r)};this.getDrawList=function(){return T};this.redraw=function(){O=!0;a.clear();
for(var r=0;r<T.length;r++)T[r]();r=document.body.getElementsByTagName("input");for(var y=0;y<r.length;y++)a.text(r[y].value,r[y].style.top,r[y].style.left);O=!1};this.automate=function(r,y){var z=Math.floor(r/3)-2,B=Math.floor(y/4);m>z&&(fa=X=C=M=b=m=z);k>B&&(E=k=B+40,ea=k+60)};this.pad=function(r,y,z,B,N,aa,G){var H=0;for(G();H<control.touches.length;)control.touches[H].x>y*a.scale&&control.touches[H].y>z*a.scale&&control.touches[H].x<(y+B)*a.scale&&control.touches[H].y<(z+N)*a.scale&&aa(),H++;
HITBOX&&(d.drawImage(q,0,0,1,1,y+1,z,B-1,1),d.drawImage(q,0,0,1,1,y+1,z+N,B-1,1),d.drawImage(q,0,0,1,1,y+1,z,1,N),d.drawImage(q,0,0,1,1,y+B-1,z,1,N));a.encode(r,y+B/2-a.col/2,z+N/2-a.row/2)};this.dpad=function(){d.drawImage(q,88,88,40,40,a.width-C+M/2-20,a.height-E+I/2-20,40,40);a.pad("<",b-m-1,a.height-k,m,p,function(){control.LEFT=!0},function(){control.LEFT=!1});a.pad(">",b+1,a.height-k,m,p,function(){control.RIGHT=!0},function(){control.RIGHT=!1});a.pad("^",a.width-C,a.height-E,M,I,function(){control.UP=
!0},function(){control.UP=!1});a.pad("b",a.width-fa,a.height-ea+la/2,X,la,function(){control.DOWN=!0},function(){control.DOWN=!1})};this.clear=function(){if(!O){for(var r=document.body.getElementsByTagName("input"),y=0;y<r.length;y++)document.body.removeChild(r[y]);T=[]}V=[];d.clearRect(0,0,a.width,a.height)};this["delete"]=function(r,y,z,B){y=void 0===y?0:y;z=void 0===z?renderer.width:z;B=void 0===B?renderer.height:B;r=a.compile(void 0===r?0:r,a.width,a.col);y=a.compile(y,a.height,a.row);z=a.compile(z,
a.width,a.col);B=a.compile(B,a.height,a.row);d.clearRect(r,y,z,B)};this.encode=function(r,y,z,B){B=void 0===B?1:B;var N=r.charCodeAt(0);r=8*N%128;N=8*Math.floor(N/16);d.clearRect(y,z,8,8);d.drawImage(q,r,N,8,8,y,z,8*B,8*B)};this["float"]=function(r,y){var z=Math.floor(Math.abs(100*r));z=z.toString();var B=z.slice(0,z.length-2);z=z.slice(z.length-2,z.length);if(0==r)return"0.00";0==B.length&&(B="0");2>z.length&&(z+="0");y&&0<r?B="+"+B:0>r&&(B="-"+B);return B+"."+z};this.compile=function(r,y,z){var B=
0;switch(typeof r){case "number":B=r;break;case "function":B=r();break;case "string":for(var N=!1,aa=1,G=0,H="";G<r.length;){var Q=r.charAt(G);"."===Q?(H+=Q,N=!0):"+"===Q?(H=N?Number(H)*y:Number(H)*z,H*=aa,aa=1,B+=H,N=!1,H=""):"-"===Q?(H=N?Number(H)*y:Number(H)*z,H*=aa,aa=-1,B+=H,N=!1,H=""):"p"===Q?(H=Number(H),H*=aa,B+=H,H=""):G===r.length-1?(H+=Q,H=N?Number(H)*y:Number(H)*z,H*=aa,B+=H,H=""):H+=Q;G++}}return B};this.textinput=function(r,y,z,B,N,aa,G){var H=a.compile(y,a.width,a.col),Q=a.compile(z,
a.height,a.row),ia=a.compile(B,a.width,a.col),Y=a.compile(N,a.height,a.row);if(O)a.text("> "+G.value,H,Q+Y/2);else{G=document.createElement("input");G.type="text";G.id=aa;G.name=aa;G.value=r;G.style.top=Q*a.scale+"px";G.style.left=H*a.scale+"px";G.style.width=ia*a.scale+"px";G.style.height=Y*a.scale+"px";G.style.paddingLeft=12*a.scale+"px";G.style.fontSize=14*a.scale+"px";G.maxlength=10;G.autofocus=!0;a.text("> "+G.value,H,Q+Y/2);document.body.appendChild(G);window.setTimeout(function(){G.focus();
G.select()},200);G.oninput=function(){W()};G.onfocusout=function(){W()};G.onfocusin=function(){W()};G.onclick=function(){W()};var W=function(ba){a["delete"](H,Q,ia,Y);a.text("> "+G.value,H,Q+Y/2);a.text("_",G.selectionStart*a.col+2*a.col+H,Q+Y/2)};T.push(function(){a.textinput(G.value,y,z,B,N,aa,G)})}}};function Control(){var a=this;this.BINDINGS=this.GAMEPAD=this.ENTER=this.RIGHT=this.LEFT=this.FORWARD=this.BACK=this.DOWN=this.UP=this.MOBILE=!1;this.touches=[];this.connect=function(){this.MOBILE?(window.addEventListener("touchstart",a.touch,!1),window.addEventListener("touchmove",a.touch,!1),window.addEventListener("touchend",a.touch,!1)):(window.addEventListener("keydown",a.key,!1),window.addEventListener("keyup",a.key,!1),window.addEventListener("mousedown",a.mousedown),window.addEventListener("mouseup",
a.mouseup,!1),window.addEventListener("touchstart",a.touchSetup,!1))};this.disconnect=function(){window.removeEventListener("keydown",a.key,!1);window.removeEventListener("keyup",a.key,!1);window.removeEventListener("mousedown",a.mousedown,!1);window.removeEventListener("mouseup",a.mouseup,!1);window.removeEventListener("touchstart",a.touchSetup,!1);window.removeEventListener("touchstart",a.touch,!1);window.removeE;ventListener("touchmove",a.touch,!1);window.removeEventListener("touchend",a.touch,
!1)};this.key=function(d){var t="keydown"==d.type;switch(d.key){case "ArrowUp":a.UP=t;break;case "ArrowDown":a.DOWN=t;break;case "ArrowLeft":a.LEFT=t;break;case "ArrowRight":a.RIGHT=t;break;case "w":a.UP=t;break;case "s":a.DOWN=t;break;case "a":a.LEFT=t;break;case "d":a.RIGHT=t;break;case "r":a.RESET=t;break;case " ":a.SPACE=t;break;case "Enter":a.ENTER=t}};this.mousedown=function(d){d.preventDefault();a.touches[0]={x:d.clientX,y:d.clientY,start:!0}};this.mouseup=function(d){d.preventDefault();a.touches[0]=
{x:d.clientX,y:d.clientY,start:!1}};this.touchSetup=function(d){window.removeEventListener("keydown",a.key,!1);window.removeEventListener("keyup",a.key,!1);window.removeEventListener("keyup",a.key,!1);window.removeEventListener("mousedown",a.mousedown,!1);window.removeEventListener("mouseup",a.mouseup,!1);window.removeEventListener("touchstart",a.touchSetup,!1);window.addEventListener("touchstart",a.touchstart,!1);window.addEventListener("touchmove",a.touchmove,!1);window.addEventListener("touchend",
a.touchend,!1);a.touchstart(d)};this.clear=function(){a.touches=[];this.ENTER=this.RIGHT=this.LEFT=this.DOWN=this.UP=!1};this.touchstart=function(d){d=d.touches;a.touches=[];for(var t=0;t<d.length;t++)a.touches[t]={x:d[t].clientX,y:d[t].clientY,start:!0}};this.touchmove=function(d){a.touches=[];d=d.touches;for(var t=0;t<d.length;t++)a.touches[t]={x:d[t].clientX,y:d[t].clientY,start:!1}};this.touchend=function(d){a.touches=[];d=d.touches;for(var t=0;t<d.length;t++)a.touches[t]={x:d[t].clientX,y:d[t].clientY,
start:!1}}};function Vehicle(){function a(){if(t)for(var n=0;1>n;){emitter.geometry.vertices[ma].copy(ja);emitter.geometry.vertices[ma].multiplyScalar(-1-Math.random()*ia);emitter.geometry.vertices[ma].add(A);emitter.geometry.vertices[ma].life=emitter.geometry.vertices[ma].maxLife;var D=.1*-Math.random();emitter.geometry.vertices[ma].acc.copy(ja);emitter.geometry.vertices[ma].acc.multiplyScalar(D);ma++;ma%=emitter.geometry.vertices.length;n++}for(var Z in emitter.geometry.vertices)0<emitter.geometry.vertices[Z].life&&
(emitter.geometry.vertices[Z].add(emitter.geometry.vertices[Z].acc),--emitter.geometry.vertices[Z].life,emitter.geometry.colors[Z].setHSL(0,0,emitter.geometry.vertices[Z].life/100)),0===emitter.geometry.vertices[Z].life&&(emitter.geometry.vertices[Z].set(0,0,0),emitter.geometry.vertices[ma].acc.x=0,emitter.geometry.vertices[ma].acc.y=0,emitter.geometry.vertices[ma].acc.z=0);emitter.geometry.verticesNeedUpdate=!0;emitter.geometry.colorsNeedUpdate=!0;emitter.geometry.computeBoundingSphere()}var d=this;
this.TEXTTIME=this.SPEED="";this.END=this.START=!1;this.OBJECTIVE=0;this.POSITION;this.MODEL=1;this.ANALOG=!1;this.PENALTY=function(){return M};this.CAMERA=1;var t=this.FPV=!1,q=!1,J=!0,b=!1,k=1,m=window.performance.now(),p=m,C=0,E=[],M=0,I=0,fa=0,ea=0,X=!1,la=!1,O=!1,T=0,V=0,r=0,y={power:2,drag:2,mass:1,brake:3,sensitivity:2,ease:0},z=0,B=0,N=0;z=.02-.015;B=.985-.98;N=.075-.055;var aa,G,H,Q=6,ia,Y=0,W=0,ba=0,ja=new THREE.Vector3(0,1,0),f=new THREE.Vector3(0,0,0),e=new THREE.Vector3,g=new THREE.Vector3(0,
5,0);new THREE.Vector3(1,0,0);var w=new THREE.Vector3(0,0,1),u=new THREE.Vector3(0,0,1),h=new THREE.Vector3(0,0,1),F=new THREE.Vector3(0,0,1),l=new THREE.Vector3(0,0,-.008),x=0,A=new THREE.Vector3,K=new THREE.Vector3,U=new THREE.Vector3,P=new THREE.Vector3,ha=[],ka=new THREE.Vector3(0,0,1),ca=new THREE.Raycaster(P,ka,0,2);this.cameras=[];this.cameras[0]={distance:22,x:0,y:0,z:9,lerp:.1,lookAt:new THREE.Vector3};this.cameras[1]={distance:0,x:20,y:20,z:10,lerp:.05,lookAt:new THREE.Vector3};this.cameras[2]=
{distance:0,x:-20,y:-20,z:20,lerp:.05,lookAt:new THREE.Vector3};this.cameras[3]={distance:0,x:-40,y:40,z:30,lerp:.075,lookAt:new THREE.Vector3};this.cameras[4]={distance:0,x:0,y:-20,z:60,lerp:.0075,lookAt:new THREE.Vector3};var S=[];this.models=function(){return S};S[0]=(new THREE.Geometry).fromBufferGeometry(new THREE.EdgesGeometry(new THREE.BoxGeometry(1,2,1)));S[0].name="logistics crate";var pa=new THREE.MeshBasicMaterial;S[1]=new THREE.Geometry;S[1].vertices.push(new THREE.Vector3(.45,-.75,1));
S[1].vertices.push(new THREE.Vector3(.3,1.2,1));S[1].vertices.push(new THREE.Vector3(-.45,-.75,1));S[1].vertices.push(new THREE.Vector3(-.3,1.2,1));S[1].vertices.push(new THREE.Vector3(.3,1.2,1));S[1].vertices.push(new THREE.Vector3(-.3,1.2,1));S[1].vertices.push(new THREE.Vector3(.45,-.75,1));S[1].vertices.push(new THREE.Vector3(-.45,-.75,1));S[1].vertices.push(new THREE.Vector3(-.3,1.2,1));S[1].vertices.push(new THREE.Vector3(-1,-.75,-.1));S[1].vertices.push(new THREE.Vector3(-.45,-.75,1));S[1].vertices.push(new THREE.Vector3(-1,
-.75,-.1));S[1].vertices.push(new THREE.Vector3(.3,1.2,1));S[1].vertices.push(new THREE.Vector3(1,-.75,-.1));S[1].vertices.push(new THREE.Vector3(.45,-.75,1));S[1].vertices.push(new THREE.Vector3(1,-.75,-.1));S[1].vertices.push(new THREE.Vector3(.45,-.75,1));S[1].vertices.push(new THREE.Vector3(.45,-1.4,.4));S[1].vertices.push(new THREE.Vector3(-.45,-.75,1));S[1].vertices.push(new THREE.Vector3(-.45,-1.4,.4));S[1].vertices.push(new THREE.Vector3(.45,-1.4,.4));S[1].vertices.push(new THREE.Vector3(-.45,
-1.4,.4));S[1].vertices.push(new THREE.Vector3(.45,-1.4,.4));S[1].vertices.push(new THREE.Vector3(1,-.75,-.1));S[1].vertices.push(new THREE.Vector3(-.45,-1.4,.4));S[1].vertices.push(new THREE.Vector3(-1,-.75,-.1));S[1].center();S[1].name="ag-86";for(var da=(new THREE.LineSegments(S[d.MODEL].clone(),pa)).clone(),ma=0,na=new THREE.Geometry;100>na.vertices.length;){var oa=new THREE.Vector3(0,0,0);oa.life=0;oa.maxLife=100;oa.acc=new THREE.Vector3(0,0,0);na.vertices.push(oa);oa=new THREE.Color(4294967040);
na.colors.push(oa)}na.verticesNeedUpdate=!0;emitter=new THREE.Points(na,new THREE.PointsMaterial({size:.1,vertexColors:THREE.VertexColors,blending:THREE.AdditiveBlending,transparent:!0}));emitter.name="Emitter";for(this.snow={distance:200,height:100,limit:100,mesh:new THREE.Points(new THREE.Geometry,new THREE.PointsMaterial),init:function(){for(var n=0;n<d.snow.mesh.geometry.vertices.length;n++){var D=d.snow.mesh.geometry.vertices[n];D.copy(da.position);D.x+=Math.random()*d.snow.distance-d.snow.distance/
2;D.y+=Math.random()*d.snow.distance-d.snow.distance/2;D.z+=Math.random()*d.snow.height-d.snow.height/2}d.snow.mesh.geometry.verticesNeedUpdate=!0;d.snow.mesh.geometry.computeBoundingSphere()},update:function(){for(var n=0;n<d.snow.mesh.geometry.vertices.length;n++){var D=d.snow.mesh.geometry.vertices[n];D.z-=.5*m;if(Math.abs(D.z-camera.position.z)>d.snow.height/2||Math.abs(D.x-camera.position.x)>d.snow.distance/2||Math.abs(D.y-camera.position.y)>d.snow.distance/2)D.copy(camera.position),D.x+=Math.random()*
d.snow.distance-d.snow.distance/2,D.y+=Math.random()*d.snow.distance-d.snow.distance/2,D.z+=Math.random()*d.snow.height-d.snow.height/2}d.snow.mesh.geometry.verticesNeedUpdate=!0;d.snow.mesh.geometry.computeBoundingSphere()}};200>this.snow.mesh.geometry.vertices.length;)na=new THREE.Vector3,d.snow.mesh.geometry.vertices.push(na);this.init=function(){var n=state.cLoad("YEN");V=""===n?0:parseInt(n)};this.connect=function(n,D){da.copy(new THREE.LineSegments(S[d.MODEL].clone(),pa));U.copy(n);A.copy(U);
K.copy(A);scene.add(da);scene.add(emitter);d.tune.power();d.tune.drag();d.tune.sensitivity();d.tune.ease();scene.fog=new THREE.FogExp2(palette[0],.01);camera.fov=90;camera.updateProjectionMatrix();scene.add(stage.generate.stars);d.snow.init();SNOW&&scene.add(d.snow.mesh);b=!1;window.setTimeout(function(){b=!0},1E3)};this.disconnect=function(){d.reset();scene.remove(da);scene.remove(emitter);scene.fog=new THREE.FogExp2(palette[0],0);scene.remove(stage.generate.stars);SNOW&&(scene.remove(d.snow.mesh),
snow=!1)};this.ready=function(){t&&(ea=performance.now(),C=0,d.START=!0)};this.reset=function(){if(d.END&&E[3]+M<stage.best[3])for(var n in stage.best)stage.best[n]=3===n?C+M:E[n];b=DNF=this.END=this.START=!1;control.UP=!1;control.DOWN=!1;control.LEFT=!1;R=L=q=t=control.RIGHT=!1;C=0;E=[];r=I=M=T=0;A.copy(U);K.copy(A);ja.set(0,1,0);e.set(0,0,0);F.set(0,0,1);da.copy(new THREE.LineSegments(S[d.MODEL].clone(),pa));da.lookAt(F);Y=W=0;camera.position.copy(A);camera.position.add(ja.clone().multiplyScalar(-60));
camera.position.z+=40;camera.up.set(0,0,1);camera.lookAt(da.position);camera.updateProjectionMatrix();renderer.render(scene,camera);vhs.reset();SNOW&&d.snow.init();window.setTimeout(function(){b=!0},1E3)};this.update=function(){SNOW&&this.snow.update();this.START||this.ready();DNF||d.END||!b?R=L=q=t=!1:(t=control.UP,q=control.DOWN,L=control.LEFT,R=control.RIGHT);var n=window.performance.now();m=.06*(n-p);2<m&&(m=2);p=n;n=L&&R?0:L?1:R?-1:0;0!=n&&Math.abs(ba)<Q?ba+=n*m:Math.abs(ba)>Q?ba=ba/Math.abs(ba)*
Q:0<Math.abs(ba)&&(n=ba/Math.abs(ba),ba-=ba/Math.abs(ba)*m,ba/Math.abs(ba)!==n&&(ba=0));Y=ba/Q*H;Y*=m;W+=Y;W%=2*Math.PI;ja.copy(da.localToWorld(g.clone()));ja.sub(A);ja.normalize();ia=e.length();t&&J&&(f.copy(ja),f.multiplyScalar(aa*m),e.add(f));if(q&&J){n=e.clone();n.multiplyScalar(.95);var D=e.clone();D.sub(n);D.multiplyScalar(m);e.sub(D)}J?(O=!1,D=la?G-.01:G,n=e.clone(),n.multiplyScalar(D),D=e.clone(),D.sub(n),D.multiplyScalar(m),e.sub(D)):J||(D=e.clone(),D.multiplyScalar(.998),n=e.clone(),n.sub(D),
n.multiplyScalar(m),O?(D=l.clone(),D.multiplyScalar(m),e.add(D)):O=!0,e.sub(n));n=e.clone();n.multiplyScalar(m);A.add(n);da.position.copy(A);ha=[];ka.copy(A);ka.sub(K);ca.far=ka.length();ka.normalize();ca.set(A,ka);n=0;D=!1;for(var Z=r;5>Z;Z++)if(stage.generate.checkpoints[Z].collision.raycast(ca,ha),0<ha.length){n=Z;D=!0;break}X=!1;if(D)if(n===r)stage.generate.checkpoints[r].display.material.color=palette[4],0<r&&(E[r-1]=C,ui["delete"](16,32,ui.width-16,16),D=Number.isNaN(stage.best[r-1])?"+1 cp":
C-stage.best[r-1],D=0<D?"(-"+ui["float"](D)+")":"+1 cp"===D?"+1 cp":"(+"+ui["float"](Math.abs(D))+")",ui.text(D,16,32)),4===r&&(X=!0,E[n-1]=C,E[n]=C+M,T=C+M<stage.best[3]?100-M+Math.floor(10*(stage.best[3]-(C+M))):100-M,V+=T,d.END=!0,control.RESET=!1,state.complete()),X=!0,r++;else{X=!0;for(D=r-1;D<n-1;D++)0<=D&&(E[D]="-",I++);M=25*I;4===n?(E[n-1]=C,E[n]=C+M,T=C+M<stage.best[3]?100-M+Math.floor(10*(stage.best[3]-(C+M))):100-M,V+=T,r=0,d.END=!0,control.RESET=!1,state.complete()):(E[n-1]=C,r=n+1,ui["delete"]("2",
"4","30","1"),ui.text("missed checkpoint x "+I.toString()+" ( -"+M.toString()+".00 )",16,32));X=!0;stage.generate.checkpoints[n].display.material.color=palette[4]}d.SPEED=Math.round(60*ia/1E3*3600);d.START&&!d.END&&(n=window.performance.now(),C=Math.floor(n-ea)/10/100);d.OBJECTIVE=r;K.copy(A);P.copy(A);P.z-=50;ha=[];ka.set(0,0,1);ca.far=100;ca.set(P,ka);stage.surface.raycast(ca,ha);0<ha.length?(P.copy(ha[0].point),A.z<P.z&&5>Math.abs(A.z-P.z)?(fa=0,J=!0,u.copy(ha[0].face.normal),A.copy(P),la=1===
ha[0].face.color.r?!1:!0):la=J=!1):0===ha.length&&(la=J=!1,t||q||L||R||fa++,60<fa&&!d.END&&!DNF&&(DNF=!0,state.dnf()));n=u.clone();n.multiplyScalar(5);D=O?.001:.2;Z=h.clone();Z.lerp(n,D);Z.sub(h);Z.multiplyScalar(m);h.add(Z);F.copy(h);F.add(da.position);da.lookAt(F);da.rotateOnAxis(w,W);a();d.FPV?d.fpv():(n=DNF||d.END?1E-5:.1,D=ja.clone(),D.multiplyScalar(-d.cameras[0].distance+4*(ui.scale-1)),D.add(da.position),D.z+=d.cameras[0].z,Z=camera.position.clone(),Z.lerp(D,n),Z.sub(camera.position),Z.multiplyScalar(m),
camera.position.add(Z),camera.lookAt(da.position))};this.results=function(){return{reward:T,yen:V}};this.AT=function(){return C};this.CP=function(){return E.slice()};this.replay=function(n){A.copy(n.position);da.position.copy(A);ja.copy(n.direction);u.copy(n.normal);F.copy(n.lookAt);h.copy(n.lookTarget);A.copy(n.position);da.position.copy(A);da.lookAt(F);da.rotateOnAxis(w,W);t=n.UP;X=n.CHECK;W=n.rotation;x=n.flip;r=n.objective;SNOW&&d.snow.update();n=A.clone();X&&(stage.generate.checkpoints[r].display.material.color=
palette[4]);if(3===d.CAMERA)d.fpv();else{var D=1,Z=1;d.CAMERA===k&&(D=d.cameras[1].lerp,Z=1);k=d.CAMERA;n.x+=d.cameras[d.CAMERA].x;n.y+=d.cameras[d.CAMERA].y;n.z+=d.cameras[d.CAMERA].z;camera.up.set(0,0,1);camera.position.lerp(n,D);d.cameras[k].lookAt.lerp(A,Z);camera.lookAt(d.cameras[k].lookAt)}a()};this.record=function(){return{position:A.clone(),direction:ja.clone(),normal:u.clone(),lookAt:F.clone(),lookTarget:h.clone(),flip:x,UP:t,rotation:W,objective:r,check:X}};this.fpv=function(){camera.position.copy(da.position);
var n=da.localToWorld(new THREE.Vector3(0,0,5));n.sub(da.position);n.normalize();camera.up.lerp(n,.1);n=ja.clone();n.add(A);camera.lookAt(n)};this.tune={power:function(n){n=void 0===n?y.power:n;y.power=0>n?0:5<n?5:n;aa=.015+y.power/5*z},drag:function(n){n=void 0===n?y.drag:n;y.drag=0>n?0:5<n?5:n;G=.985-y.drag/5*B},sensitivity:function(n){n=void 0===n?y.sensitivity:n;y.sensitivity=0>n?0:5<n?5:n;H=.055+y.sensitivity/5*N},ease:function(n){n=void 0===n?y.ease:n;y.ease=0>n?0:5<n?5:n;Q=6+y.ease}};this.param=
function(){array=Object.assign(y,[]);array.model=S[d.MODEL].name;return array};this.yen=function(){state.cSave("YEN",V);return V};this.debug=function(){var n=new THREE.Vector3(0,1,0);da.localToWorld(n);console.log(da.rotation);console.log(da.quaternion);console.log(da.up)}};function Generate(){scope=this;var a=this.SEED=0;this.length=480;var d=[],t=0;d[0]={name:"forest",palette:palette[9],tree:function(f,e){return scope.pine()},limit:Math.floor(scope.length/2),range:5,map:[],flags:[]};d[0].map[0]=function(f,e){var g=palette[10],w=!1;.92<Math.abs(f)&&(g=.92<Math.abs(f)?palette[9]:palette[2],w=!0);d[0].flags[e]=w;return g};d[1]={name:"sakura",palette:palette[12],tree:function(){return scope.sakura()},limit:Math.floor(1/6*scope.length),range:10,map:[],flags:[]};d[1].map[0]=
function(f,e){var g=palette[1],w=!1;.95<Math.abs(f)&&(g=.92<Math.abs(f)?palette[12]:palette[1],w=!0);d[1].flags[e]=w;return g};d[2]={name:"summit",palette:palette[1],tree:function(){return new THREE.Geometry},limit:0,range:10,map:[],flags:[]};d[2].map[0]=function(f,e){var g=palette[7],w=!1;.95<Math.abs(f)&&(g=.92<Math.abs(f)?palette[2]:palette[7],w=!0);d[2].flags[e]=w;return g};var q=new THREE.Points(new THREE.Geometry);q.name="Generative Extruder";q.visible=!1;var J=new THREE.Line(new THREE.Geometry);
J.name="Generative Nodes";J.visible=!1;J.material.color=palette[6];J.material.name="Node Material";J.position.z+=2;var b=new THREE.LineSegments(new THREE.Geometry);b.name="Generative Segments";b.visible=!0;b.material.color=palette[3];b.material.name="Segments Material";var k=new THREE.Mesh(new THREE.Geometry);k.name="Generative Surface";k.visible=!1;k.material.color=palette[0];k.material.name="Surface Material";var m=new THREE.LineSegments(new THREE.Geometry);m.name="Generative Perimeter";m.material.color=
palette[1];m.material.name="Perimeter Material";var p=new THREE.Mesh(new THREE.Geometry,new THREE.MeshBasicMaterial({vertexColors:THREE.VertexColors}));p.name="Terrain";p.material.name="Terrain Material";p.material.wireframe=!0;p.material.side=THREE.DoubleSide;p.visible=!0;wireframe=new THREE.Mesh(new THREE.Geometry,new THREE.MeshBasicMaterial({vertexColors:THREE.VertexColors}));wireframe.name="Wireframe";wireframe.material.name="Wireframe Material";wireframe.material.wireframe=!0;wireframe.material.side=
THREE.FrontSide;wireframe.visible=!0;var C=new THREE.LineSegments(new THREE.Geometry,new THREE.LineBasicMaterial({vertexColors:THREE.VertexColors}));C.name="Trees";var E=new THREE.Mesh(new THREE.Geometry,new THREE.MeshBasicMaterial);E.name="Background";E.material.color=palette[0];E.material.name="Background Material";E.material.wireframe=!1;E.material.side=THREE.FrontSide;E.material.opacity=.75;E.material.blendMode=THREE.MultiplyBlending;E.material.transparent=!0;var M=new THREE.Points(new THREE.Geometry);
M.material.color=palette[1];M.material.sizeAttenuation=!1;M.material.size=1.5;M.material.fog=!1;scope.stars=M;var I=new THREE.Mesh(new THREE.Geometry,new THREE.MeshBasicMaterial);I.name="Collision Mesh";I.visible=!0;I.material.name="Collision Material";I.material.side=THREE.BackSide;this.checkpoints=[];var fa=new THREE.Vector3(0,0,1),ea=new THREE.Vector3(1,0,0);new THREE.Vector3(0,1,0);new THREE.Vector3(0,0,1);var X=new THREE.Vector3(0,3,0),la=new THREE.Vector3(0,0,1),O=J.geometry.clone(),T=k.geometry.clone(),
V=b.geometry.clone(),r=m.geometry.clone(),y=[],z=[],B=new THREE.Vector3;y[0]=new THREE.Vector3(5,3,0);y[1]=new THREE.Vector3(-5,3,0);z[0]=y[0].clone();z.z+=1;z[1]=y[1].clone();z.z+=1;var N=Math.PI/64,aa=Math.PI/32,G=[],H=0,Q=new THREE.Vector3;this.start=new THREE.Vector3;var ia=!1,Y=!1,W=!1;this.IMPORT=this.END=!1;this.DISTANCE=0;var ba=18,ja=new THREE.Raycaster;ja.far=800;q.geometry.vertices[0]=X.clone();q.geometry.vertices[1]=fa.clone().add(X);q.geometry.vertices[2]=y[0].clone();q.geometry.vertices[3]=
y[1].clone();q.geometry.vertices[4]=z[0].clone();q.geometry.vertices[5]=z[1].clone();this.connect=function(){scope.SEED=SEED;t=scope.randomInt(0,3);SNOW=2===t?!0:!1;scene.add(q);scene.add(J);scene.add(b);scene.add(m);scene.add(k);scene.add(wireframe);scene.add(E);H=window.performance.now();window.setTimeout(scope.generate,0)};this.disconnect=function(){G=[];scene.remove(q);scene.remove(J);scene.remove(b);scene.remove(m);scene.remove(k);scene.remove(wireframe);scene.remove(E);scene.remove(C);for(var f in d)d[f].flag=
[];for(var e in scope.checkpoints)scene.remove(scope.checkpoints[e].display),scope.checkpoints[e].display.geometry.dispose(),scope.checkpoints[e].collision.geometry.dispose()};this.complete=function(){I.geometry.mergeVertices();I.geometry.verticesNeedUpdate=!0;I.geometry.elementsNeedUpdate=!0;I.geometry.computeFaceNormals();I.geometry.computeVertexNormals();I.geometry.computeBoundingSphere();E.geometry.copy(I.geometry);--E.position.z;for(var f=[],e=0;e<I.geometry.faces.length;e++)f[I.geometry.faces[e].a]=
I.geometry.faces[e].vertexNormals[0].clone(),f[I.geometry.faces[e].b]=I.geometry.faces[e].vertexNormals[1].clone(),f[I.geometry.faces[e].c]=I.geometry.faces[e].vertexNormals[2].clone();for(e=0;e<I.geometry.vertices.length;e++)I.geometry.vertices[e].add(f[e].multiplyScalar(2));I.geometry.verticesNeedUpdate=!0;wireframe.geometry.mergeVertices();wireframe.geometry.verticesNeedUpdate=!0;wireframe.geometry.elementsNeedUpdate=!0;wireframe.geometry.computeFaceNormals();wireframe.geometry.computeBoundingSphere();
f=new THREE.IcosahedronGeometry(1200,4);for(var g in f.vertices).3>scope.random()&&-400<f.vertices[g].z&&M.geometry.vertices.push(f.vertices[g].clone());f.dispose();M.geometry.computeBoundingSphere();stage.surface=I.clone();stage.start=scope.start.clone();H=window.performance.now()-H;ia=!0;scope.END=!0;FIREBASE&&firebase.analytics().logEvent("stage_generation_complete",{time:Math.round(H/1E3)});state.ready()};this.reset=function(){ba=(36+scope.random()-.5)/2;a=0;J.geometry.dispose();b.geometry.dispose();
k.geometry.dispose();q.geometry.dispose();m.geometry.dispose();p.geometry.dispose();wireframe.geometry.dispose();I.geometry.dispose();C.geometry.dispose();M.geometry.dispose();V.dispose();r.dispose();O.dispose();T.dispose();V.copy(new THREE.Geometry);r.copy(new THREE.Geometry);O.copy(new THREE.Geometry);T.copy(new THREE.Geometry);J.geometry.copy(new THREE.Geometry);q.geometry.copy(new THREE.Geometry);b.geometry.copy(new THREE.Geometry);m.geometry.copy(new THREE.Geometry);k.geometry.copy(new THREE.Geometry);
p.geometry.copy(new THREE.Geometry);I.geometry.copy(new THREE.Geometry);X.set(0,3,0);la.set(0,0,1);y[0]=new THREE.Vector3(4,3,0);y[1]=new THREE.Vector3(-4,3,0);ia&&(W=Y=ia=!1);this.END=!1;q.position.set(0,0,0);q.geometry.vertices[0]=X.clone();q.geometry.vertices[1]=fa.clone().add(X);q.geometry.vertices[2]=y[0].clone();q.geometry.vertices[3]=y[1].clone();q.geometry.vertices[4]=z[0].clone();q.geometry.vertices[5]=z[1].clone();q.geometry.verticesNeedUpdate=!0};this.generate=function(){scope.path()};
this.path=function(f,e,g,w,u,h,F,l,x,A){f=void 0===f?0:f;e=void 0===e?0:e;g=void 0===g?0:g;w=void 0===w?0:w;u=void 0===u?0:u;h=void 0===h?{start:0,end:30,angle:0,slope:0}:h;F=void 0===F?[]:F;l=void 0===l?[]:l;x=void 0===x?!1:x;A=void 0===A?999:A;var K=window.performance.now(),U=0;for(0===w&&(w=.5<scope.random()?1:-1);32>U&&!Y;){if(f===h.end+1){l=[];for(g=0;1>g;g++)if(f>=scope.length)l.push({angle:0,slope:0,end:30}),A=f+30;else if(0===e){U=scope.randomInt(2,4)*w;var P=Math.floor(Math.abs(36/U));w=
.01>scope.random()?1*w:-1*w;P=scope.randomInt(1,P);l.push({angle:U,slope:0,end:P})}else U=scope.randomInt(-5,-1),P=scope.random(),U=2!==t&&.05>P?U*=-1:U,P=scope.randomInt(2,20),l.push({angle:0,slope:U,end:P});U=scope.randomInt(0,l.length);e=l[U].angle;g=l[U].slope;h.start=f;h.end=f+l[U].end;l=l.slice(U,1)}x||(scope.extrude(e,g),G.push({angle:e,slope:g}),O.verticesNeedUpdate=!0,f++);if(10<=f&&!x){U=new THREE.Vector2(O.vertices[f-1].x,O.vertices[f-1].y);for(P=0;P<O.vertices.length-1-10;P++)if(18>(new THREE.Vector2(O.vertices[P].x,
O.vertices[P].y)).distanceTo(U)){x=!0;break}x&&window.setTimeout(stage.reset(!0),0)}f===A&&(Y=!0,J.geometry.dispose(),J.geometry=O.clone(),J.geometry.computeBoundingSphere(),J.geometry.center(),J.updateMatrixWorld(),0<J.geometry.vertices.length&&(Q.copy(J.geometry.vertices[0]),Q.sub(O.vertices[0])),window.setTimeout(function(){scope["import"]()},0));U=window.performance.now()-K}Y||x||window.setTimeout(scope.path,0,f,e,g,w,u,h,F,l,x,A)};this.skijump=function(f,e,g,w,u,h,F,l,x,A,K){f=void 0===f?0:f;
e=void 0===e?0:e;g=void 0===g?0:g;w=void 0===w?0:w;u=void 0===u?0:u;h=void 0===h?{start:0,end:20,angle:0,slope:0}:h;F=void 0===F?[]:F;l=void 0===l?[]:l;x=void 0===x?!1:x;A=void 0===A?300:A;K=void 0===K?0:K;var U=window.performance.now(),P=0;for(0===w&&(w=.5<scope.random()?1:-1);32>P&&!Y;){if(f===h.end+1){l=[];for(e=0;1>e;e++)0===g&&20===h.end?(K=-1,l.push({angle:0,slope:-4,end:30})):3===g?l.push({angle:0,slope:4,end:3}):4===g?l.push({angle:0,slope:-32,end:10}):-4===g?(K=1,l.push({angle:0,slope:g+
1,end:1})):-32===g?l.push({angle:0,slope:-4,end:40}):1==K?l.push({angle:0,slope:g+1,end:1}):-1==K&&l.push({angle:0,slope:g-1,end:1});P=scope.randomInt(0,l.length);e=l[P].angle;g=l[P].slope;h.start=f;h.end=f+l[P].end;l=l.slice(P,1)}x||(scope.extrude(e,g),G.push({angle:e,slope:g}),O.verticesNeedUpdate=!0,f++);if(10<=f&&!x){P=new THREE.Vector2(O.vertices[f-1].x,O.vertices[f-1].y);for(var ha=0;ha<O.vertices.length-1-10;ha++)if(0>(new THREE.Vector2(O.vertices[ha].x,O.vertices[ha].y)).distanceTo(P)){x=
!0;break}x&&window.setTimeout(stage.reset(!0),0)}f>=A&&(Y=!0,J.geometry.dispose(),J.geometry=O.clone(),J.geometry.computeBoundingSphere(),J.geometry.center(),J.updateMatrixWorld(),0<J.geometry.vertices.length&&(Q.copy(J.geometry.vertices[0]),Q.sub(O.vertices[0])),window.setTimeout(function(){scope["import"]()},0));P=window.performance.now()-U}Y||x||window.setTimeout(scope.skijump,0,f,e,g,w,u,h,F,l,x,A)};this["import"]=function(f){f=void 0===f?0:f;for(var e=window.performance.now(),g=0;!W&&32>g;){0===
f&&(q.position.set(0,0,0),q.rotation.z=0,X.set(0,3,0),q.geometry.vertices[0]=X.clone(),q.geometry.vertices[1]=fa.clone().add(X),q.geometry.vertices[2]=y[0].clone(),q.geometry.vertices[3]=y[1].clone(),q.geometry.vertices[4]=z[0].clone(),q.geometry.vertices[5]=z[1].clone(),q.geometry.verticesNeedUpdate=!0,q.updateMatrixWorld());if(f<G.length)angle=G[f].angle,slope=G[f].slope,scope.extrude(angle,slope),b.geometry.dispose(),b.geometry=V.clone(),b.geometry.computeBoundingSphere(),m.geometry.dispose(),
m.geometry=r.clone(),m.geometry.computeBoundingSphere(),k.geometry.dispose(),k.geometry=T.clone(),k.geometry.computeBoundingSphere(),f++;else if(!W&&f===G.length){scope.checkpoints=scope.checkpoint();for(var w in scope.checkpoints)scene.add(scope.checkpoints[w].display);W=!0;window.setTimeout(function(){scope.terrain(!0)},0)}g=window.performance.now()-e}W||window.setTimeout(scope["import"],0,f,angle,slope)};this.extrude=function(f,e){f=void 0===f?0:f;e=void 0===e?0:e;q.updateMatrixWorld();q.rotateZ(f*
aa);for(var g in q.geometry.vertices)q.geometry.vertices[g].applyAxisAngle(ea,e*N);q.geometry.verticesNeedUpdate=!0;g=q.geometry.vertices[0].clone();var w=q.geometry.vertices[2].clone(),u=q.geometry.vertices[3].clone(),h=q.geometry.vertices[1].clone();g.applyMatrix4(q.matrix);w.applyMatrix4(q.matrix);u.applyMatrix4(q.matrix);h.applyMatrix4(q.matrix);h.sub(g);if(Y){w.add(Q);u.add(Q);if(0<V.vertices.length){var F=V.vertices[V.vertices.length-1].clone().sub(B),l=V.vertices[V.vertices.length-2].clone().sub(B);
T.vertices.push(w.clone().sub(h));T.vertices.push(u.clone().sub(h));T.vertices.push(l);T.vertices.push(u.clone().sub(h));T.vertices.push(F);T.vertices.push(l);F=w.clone();l=u.clone();var x=V.vertices[V.vertices.length-1].clone(),A=V.vertices[V.vertices.length-2].clone();I.geometry.vertices.push(F);I.geometry.vertices.push(l);I.geometry.vertices.push(A);I.geometry.vertices.push(l);I.geometry.vertices.push(x);I.geometry.vertices.push(A);l=T.vertices.length;F=new THREE.Face3(l-3,l-2,l-1);l=new THREE.Face3(l-
5,l-4,l-6);T.faces.push(F);T.faces.push(l);F=F.clone();l=l.clone();F.color=new THREE.Color(16777215);l.color=new THREE.Color(16777215);I.geometry.faces.push(F);I.geometry.faces.push(l)}0<r.vertices.length?(l=2,F=1,4<r.vertices.length&&(l=4,F=2),l=r.vertices[r.vertices.length-l].clone(),F=r.vertices[r.vertices.length-F].clone(),r.vertices.push(w.clone().add(h.clone())),r.vertices.push(l.clone()),r.vertices.push(u.clone().add(h.clone())),r.vertices.push(F.clone()),a==G.length-1&&(r.vertices.push(w.clone().add(h.clone())),
r.vertices.push(u.clone().add(h.clone())))):(r.vertices.push(w.clone().add(h.clone())),r.vertices.push(u.clone().add(h.clone())));V.vertices.push(w.clone());V.vertices.push(u.clone());B.copy(h)}else O.vertices.push(g.clone());X.copy(g).sub(q.position);q.position.add(X);for(var K in q.geometry.vertices)q.geometry.vertices[K].applyAxisAngle(ea,-1*e*N)};this.terrain=function(f,e,g,w,u,h,F){e=void 0===e?[]:e;g=void 0===g?[]:g;w=void 0===w?[]:w;u=void 0===u?0:u;h=void 0===h?0:h;F=void 0===F?0:F;if(void 0===
f||f){b.updateMatrixWorld();p.geometry.dispose();p.geometry.copy(new THREE.Geometry);e=[];g=[];w=[];for(f=0;2>f;f++)w[f]=[],e[f]=[],g[f]=[];for(f=0;f<b.geometry.vertices.length;f++)g[f%2].push(b.geometry.vertices[f]);for(f=0;2>f;f++)for(var l=0;l<g[f].length;l++){var x=0===f?1:-1,A=g[f][l].clone();A.sub(g[f+x][l]);A.normalize().multiplyScalar(3);w[f][l]=A.clone()}}l=0;f=window.performance.now();if(4>u){p.geometry.verticesNeedUpdate=!0;p.geometry.elementsNeedUpdate=!0;p.geometry.computeBoundingSphere();
p.geometry.computeFaceNormals();p.geometry.computeVertexNormals();p.updateMatrixWorld();if(0<u&&0===F)for(g[h]=[],x=0;x<e[h].length;x++)g[h][x]=p.geometry.vertices[e[h][x]];0===F&&(e[h]=[]);for(v=F;v<g[h].length&&32>l;){l=!1;if(void 0!==g[h][v]&&void 0!==g[h][v-1]){if(void 0===w[h][v])w[h][v]=w[s][v-1].clone();else if(p.geometry.computeBoundingSphere(),x=g[h][v].clone().add(w[h][v]),x.z-=100,ja.set(x,fa),x.z+=100,A=ja.intersectObjects([p],!0),0<A.length)for(var K in A).01<A[K].point.distanceTo(x)&&
(e[h][v]=void 0,l=!0);l||(p.geometry.vertices.push(g[h][v].clone()),p.geometry.vertices.push(g[h][v].clone().add(w[h][v])),e[h][v]=p.geometry.vertices.length-1,0<v&&(p.geometry.vertices.push(g[h][v-1].clone()),l=p.geometry.vertices.length,0===h?p.geometry.faces.push(new THREE.Face3(l-2,l-1,l-3)):1===h&&p.geometry.faces.push(new THREE.Face3(l-1,l-2,l-3))))}l=window.performance.now()-f;v++;F=v}if(F===g[h].length){F=0;for(K=1;K<e[h].length;K++)void 0!==e[h][K]&&void 0!==e[h][K-1]&&(f=p.geometry.vertices[e[h][K]],
l=p.geometry.vertices[e[h][K-1]],2.8>f.distanceTo(l)?(f.copy(l),e[h][K]=e[h][K-1],w[h][K].copy(w[h][K-1])):1<K&&(p.geometry.vertices.push(g[h][K-1]),p.geometry.faces.push(new THREE.Face3(0===h?e[h][K]:e[h][K-1],0===h?e[h][K-1]:e[h][K],p.geometry.vertices.length-1))));h++}1<h&&(h=0,u++)}if(4===u){p.geometry.verticesNeedUpdate=!0;p.geometry.elementsNeedUpdate=!0;p.geometry.colorsNeedUpdate=!0;p.geometry.computeFaceNormals();p.geometry.computeVertexNormals();p.geometry.mergeVertices();p.geometry.computeBoundingSphere();
scope.noise(p.geometry);for(K=0;K<p.geometry.faces.length;K++)f=p.geometry.vertices[p.geometry.faces[K].a].clone(),l=p.geometry.vertices[p.geometry.faces[K].b].clone(),x=p.geometry.vertices[p.geometry.faces[K].c].clone(),I.geometry.vertices.push(f),I.geometry.vertices.push(l),I.geometry.vertices.push(x),wireframe.geometry.vertices.push(f),wireframe.geometry.vertices.push(l),wireframe.geometry.vertices.push(x),f=I.geometry.vertices.length,l=new THREE.Face3(f-1,f-2,f-3),l.color=new THREE.Color(0),I.geometry.faces.push(l),
wireframe.geometry.faces.push(new THREE.Face3(f-1,f-2,f-3));wireframe.geometry.copy(p.geometry);wireframe.geometry.computeVertexNormals();scope.biome();window.setTimeout(scope.complete,0)}else window.setTimeout(function(){scope.terrain(!1,e.slice(),g.slice(),w.slice(),u,h,F)},0)};this.biome=function(){for(var f=t,e=wireframe.geometry.faces,g=[],w=[],u=0;u<e.length;u++)for(var h=0;h<d[t].map.length;h++)e[u].vertexColors[0]=d[t].map[h](e[u].vertexNormals[0].z,e[u].a),e[u].vertexColors[1]=d[t].map[h](e[u].vertexNormals[1].z,
e[u].b),e[u].vertexColors[2]=d[t].map[h](e[u].vertexNormals[2].z,e[u].c);for(e=0;e<d[t].flags.length;e++)for(u=0;u<b.geometry.vertices.length;u++).1>wireframe.geometry.vertices[e].distanceTo(b.geometry.vertices[u])&&(d[t].flags[e]=!1);for(e=0;e<d[t].flags.length;e++)d[t].flags[e]&&g.push(e);for(e=0;e<d[t].limit&&e<g.length;){u=scope.randomInt(0,g.length);h=!0;if(0<w.length&&0<g.length)for(;h;){for(var F in w)if(wireframe.geometry.vertices[g[u]].distanceTo(wireframe.geometry.vertices[w[F]])<d[t].range){h=
!0;g.slice(u,1);u=scope.randomInt(0,g.length);break}else h=!1;0>=g.length&&(h=!1)}if(0<g.length){h=d[f].tree();for(var l in h.vertices)C.geometry.vertices.push(h.vertices[l].clone().add(wireframe.geometry.vertices[g[u]])),C.geometry.colors[C.geometry.vertices.length-1]=h.colors[l];w.push(g[u]);g.slice(u,1)}e++}C.verticesNeedUpdate=!0;C.elementsNeedUpdate=!0;scene.add(C)};this.sakura=function(){var f=new THREE.Geometry,e=[],g=[],w=1,u=new THREE.Vector3(0,0,0),h=new THREE.Vector3(0,0,3),F=12,l=0,x=
new THREE.Vector3(1,0,0),A=new THREE.Vector3(0,0,1);f.vertices.push(u);f.vertices.push(h);f.colors.push(palette[2]);f.colors.push(palette[2]);g.push({v:h.clone(),n:h.clone(),pitch:x.clone(),roll:A.clone()});for(u=[];4>l;){h=[];for(x=0;x<g.length;x++)for(var K=A=0;3>K;K++){var U=0===l&&2===K&&1>A?1:scope.random();if(.2<U){U=scope.randomInt(-2,2);var P=g[x].n.clone(),ha=palette[2];P.applyAxisAngle(g[x].pitch,2*Math.PI/(F+U));P.applyAxisAngle(g[x].roll,2*Math.PI/3*K);P.multiplyScalar(w);U=P.clone().add(g[x].v);
f.vertices.push(g[x].v.clone());f.vertices.push(U);f.colors.push(ha);f.colors.push(ha);ha=g[x].pitch.clone();ha.applyAxisAngle(g[x].roll,2*Math.PI/3*K);ha.applyAxisAngle(g[x].pitch,2*Math.PI/F);var ka=g[x].roll.clone();ka.applyAxisAngle(g[x].pitch,2*Math.PI/F);ka.applyAxisAngle(g[x].roll,2*Math.PI/3*K);0<K&&e.push({a:U.clone(),b:g[x].v.clone(),pitch:ha,roll:ka});h.push({v:U.clone(),n:P.clone(),pitch:ha,roll:ka});A++}else 0===A&&2===K&&u.push({v:g[x].v.clone(),n:g[x].n.clone(),pitch:g[x].pitch.clone(),
roll:g[x].roll.clone()})}g=h.slice();w*=.9;l++}F=6;for(var ca in e)w=e[ca].a.clone(),l=e[ca].b.clone(),w=w.clone().sub(l),h=w.clone().multiplyScalar(.5).add(l),l=scope.randomInt(0,3)-1,w.applyAxisAngle(e[ca].pitch,2*Math.PI/F),w.applyAxisAngle(e[ca].roll,2*Math.PI/l),w.multiplyScalar(.5),x=h,h=w.clone().add(h),f.vertices.push(x),f.vertices.push(h),f.colors.push(palette[2]),f.colors.push(palette[2]),x=e[ca].pitch.clone(),x.applyAxisAngle(e[ca].roll,2*Math.PI/l),x.applyAxisAngle(e[ca].pitch,2*Math.PI/
F),A=e[ca].roll.clone(),A.applyAxisAngle(e[ca].pitch,2*Math.PI/F),A.applyAxisAngle(e[ca].roll,2*Math.PI/l),g.push({v:h.clone(),n:w.clone(),pitch:x,roll:A});g=g.concat(u);for(e=0;e<g.length;e++)for(F=0;5>F;F++)ca=g[e].n.clone(),ca.normalize(),ca.applyAxisAngle(g[e].pitch,2*Math.PI/6),ca.applyAxisAngle(g[e].roll,2*Math.PI/5*F),ca.multiplyScalar(.5),ca=ca.add(g[e].v),u=g[e].v.clone(),f.vertices.push(ca),f.vertices.push(u),f.colors.push(palette[12]),f.colors.push(palette[12]);f.colorsNeedUpdate=!0;return f};
this.pine=function(){var f=Math.floor(8*scope.random())+6,e=2*Math.PI/6,g=new THREE.Geometry;g.vertices.push(new THREE.Vector3(0,0,0));g.vertices.push(new THREE.Vector3(0,0,1*f-.5+1));g.colors.push(palette[9]);g.colors.push(palette[9]);g.colors.push(palette[9]);for(var w=1;w<f;w++)for(var u=0;6>u;u++)off=w%2*e*.5,g.vertices.push(new THREE.Vector3(0,0,1*w+1)),g.vertices.push(new THREE.Vector3(.3*(f-w),0,1*w-.3+1)),g.vertices[g.vertices.length-1].applyAxisAngle(fa,e*u+off),g.colors.push(palette[9]),
g.colors.push(palette[9]);return g};this.checkpoint=function(){function f(u,h,F){var l=new THREE.Geometry,x=(new THREE.Vector3).copy(u).sub(h),A=(new THREE.Vector3).copy(u).add(x.clone().multiplyScalar(1.5));x=(new THREE.Vector3).copy(h).sub(x.clone().multiplyScalar(1.5));l.vertices.push(new THREE.Vector3(A.x,A.y,A.z-12));l.vertices.push(new THREE.Vector3(A.x,A.y,A.z+12));l.vertices.push(new THREE.Vector3(x.x,x.y,x.z+12));l.vertices.push(new THREE.Vector3(x.x,x.y,x.z+12));l.vertices.push(new THREE.Vector3(x.x,
x.y,x.z-12));l.vertices.push(new THREE.Vector3(A.x,A.y,A.z-12));l.faces.push(new THREE.Face3(0,1,2));l.faces.push(new THREE.Face3(3,4,5));A=new THREE.Geometry;A.vertices.push(new THREE.Vector3(u.x,u.y,u.z+6));A.vertices.push(new THREE.Vector3(u.x,u.y,u.z+8));A.vertices.push(new THREE.Vector3(h.x,h.y,h.z+6));A.vertices.push(new THREE.Vector3(h.x,h.y,h.z+8));A.vertices.push(new THREE.Vector3(u.x,u.y,u.z+6));A.vertices.push(new THREE.Vector3(h.x,h.y,h.z+6));A.vertices.push(new THREE.Vector3(u.x,u.y,
u.z+8));A.vertices.push(new THREE.Vector3(h.x,h.y,h.z+8));A.vertices.push(new THREE.Vector3(u.x,u.y,u.z+1));A.vertices.push(new THREE.Vector3(h.x,h.y,h.z+1));u=new THREE.MeshBasicMaterial({side:THREE.DoubleSide,wireframe:!1,fog:!0});u.color=palette[5];l=new THREE.Mesh(l,u);l.visible=!0;u=new THREE.LineSegments(A,u);l.name="Objective "+F;u.name="Checkpoint"+F;return{display:u,collision:l}}var e=b.geometry,g=e.vertices.length-80;g=Math.floor(g/4)-Math.floor(g/4)%2;var w=[];w[0]=f(e.vertices[40],e.vertices[41],
0);w[1]=f(e.vertices[g+40],e.vertices[g+1+40],1);w[2]=f(e.vertices[2*g+40],e.vertices[2*g+41],2);w[3]=f(e.vertices[3*g+40],e.vertices[3*g+41],3);w[4]=f(e.vertices[4*g+40],e.vertices[4*g+41],4);this.DISTANCE=4*g/2*3;scope.start.copy(e.vertices[36]);scope.start.sub(e.vertices[37]);scope.start.multiplyScalar(-.75);scope.start.add(e.vertices[36]);for(e=0;5>e;e++)stage.best[e]=CHALLENGE?state.CHALLENGES[0].cp[e]:4>e?g*(e+1)/ba:stage.best[e]=stage.best[e-1];state.target();return w};this.resetCheckpoints=
function(){for(var f in scope.checkpoints)scope.checkpoints[f].display.material.color=palette[5]};this.random=function(){SEED=(SEED+1)%2147483647;var f=1E4*Math.sin(SEED);return f-=Math.floor(f)};this.randomInt=function(f,e){return Math.floor(scope.random()*(e-f))+f};this.noise=function(f){for(var e=new ImprovedNoise,g=[],w=8,u=0,h=0,F=1E3*scope.random(),l=0;l<f.vertices.length;l++)g[l]=0;for(l=0;2>l;l++){for(var x=0;x<f.vertices.length;x++)g[x]+=Math.floor(e.noise(f.vertices[x].x/w,f.vertices[x].y/
w,F)*w),g[x]>u&&(u=g[x]),g[x]<h&&(h=g[x]);w*=3}for(e=0;e<g.length;e++){w=2===t?2:.5;for(u=0;u<b.geometry.vertices.length;u++)h=f.vertices[e].distanceTo(b.geometry.vertices[u]),h=h*h/100,h<w&&(w=h);f.vertices[e].z+=g[e]*w}};this.name=function(){var f="";if(CHALLENGE)f=state.CHALLENGES[0].seed;else{var e=" forest; pass; line; summit; route; path; mountain; park".split(";"),g="n wa ra ya ma ha na ta ka a wi ri mi hi ni chi shi ki i ru yu mu fu nu tsu su ku u we re me he ne te se ke e wo ro yo mo no to so ko o".split(" ");
TOGGLE=!1;for(var w=Math.ceil(3*Math.random())+1,u=0;u<w;)f+=g[Math.floor(Math.random()*g.length)],u++;g=2===t?1:0;f+=e[Math.floor(g+Math.random()*(e.length-g))]}return f}};function Stage(){this.COMPLETE=!1;this.start=new THREE.Vector3;this.generate=new Generate;this.checkpoint=[];this.objectives=[];this.best=[];this.grid=[];this.dimension=2400;this.partitionDimension=16;this.partionDivision=this.dimension/this.partitionDimension;for(var a=0;4>a;a++)this.checkpoint[this.checkpoint.length]=new THREE.Mesh(new THREE.Geometry);this.connect=function(d){d=void 0===d?!1:d;camera.position.set(0,400,200);camera.far=2E3;camera.updateProjectionMatrix();camera.lookAt(new THREE.Vector3);
renderer.render(scene,camera);if(!d){this.name=this.generate.name();d="";for(var t in this.name)d+=this.name.charCodeAt(t).toString();SEED=d}this.generate.connect();COUNTER++};this.disconnect=function(){this.generate.disconnect();this.generate.reset()};this.reset=function(d){d=void 0===d?!1:d;SEED++;this.COMPLETE=!1;this.disconnect();this.generate=new Generate;this.connect(d)};this.preview=function(){window.setTimeout(0,0)}};function VHS(a){var d=this;this.PLAY=!1;this.RECORD=!0;this.tape=[];this.timer=0;this.AT=function(){return d.tape[t].timer};var t=0;this.capture=function(q){return{position:(new THREE.Vector3).copy(q.position),normal:(new THREE.Vector3).copy(q.normal),direction:(new THREE.Vector3).copy(q.dir),lookAt:q.lookAt.clone(),lookTarget:q.lookTarget.clone(),rotation:q.rotation,timer:q.getTime(),objective:q.getObjective(),check:q.check,UP:q.UP}};this.record=function(q){this.tape[t]=q.record();t++;t%=18E3;17999==
t&&console.log("VHS OVERWRITE")};this.play=function(q){this.RECORD&&(this.RECORD=!1,TIMEOUT=t=0);0===t&&stage.generate.resetCheckpoints();q.replay(this.tape[t]);this.tape[t].check&&(stage.generate.checkpoints[0===this.tape[t].objective?4:this.tape[t].objective-1].display.material.color=palette[4]);this.timer=this.tape[t].timer;t++;t%=this.tape.length;0===t&&stage.generate.resetCheckpoints()};this.reset=function(){t=0;stage.generate.resetCheckpoints();d.PLAY=!1;d.RECORD=!0;d.tape=[]};this["export"]=
function(){for(var q="",J=0;J<d.tape.length;J++)q+=d.tape[J].position.x+" "+d.tape[J].position.y+" "+d.tape[J].position.z,q+="/n";return q}};function State(){var a=this,d,t,q="",J=0;this.SETTINGS=!1;this.STATE=function(){};this.CHALLENGES=[];this.resize=function(b,k){d=ui.width;t=ui.height};this.wallet=function(){var b=vehicle.yen();ui.print("$ "+b.toString(),"2","1.0-4")};this.nav=function(b){b=void 0===b?function(){ui.clear()}:b;ui.sprite(8,64,8,8,"1.0-4+2p","2",8,8);ui.button("","1.0-8","2+4p","8","8",function(){a.menu(b)},!1)};this.title=function(b,k){a.breadcrumb(b,k);ui.sprite(16,64,8,8,"1.0-4+2p","2",8,8);ui.button("","1.0-7","2+4p",
"7","5",function(){ui.backdrop(!1);b();MENU=!1;a.SETTINGS=!1},!1);a.wallet()};this.breadcrumb=function(b,k){var m=void 0===k?function(){ui.backdrop(!1);b();MENU=!1;a.SETTINGS=!1}:function(){a.menu(b);MENU=!0};ui.print("< menu","2","2");ui.button("","2","2+4p","7","8",m,!1)};this.menu=function(b){MENU=!0;ui.backdrop();ui.clear();a.title(b);ui.sprite(0,0,1,1,"2","6","1.0-4",1);ui.print(" > modify vehicle","2","8");ui.button("","2","8+4p","1.0-4","5",function(){a.vehicle(b)},!1);ui.sprite(0,0,1,1,"2",
"11","1.0-4",1);ui.print(" > settings","2","13");ui.button("","2","13+4p","1.0-4","5",function(){a.settings(b)},!1);ui.sprite(0,0,1,1,"2","16","1.0-4",1);var k=8;if(PLAY||vhs.PLAY)ui.button("restart stage","2","1.0-2-"+k,"1.0-4","6",function(){ui.backdrop(!1);a.reset()},!0),k+=8;stage.COMPLETE&&(PLAY||vhs.PLAY)&&ui.button("next stage","2","1.0-2-"+k,"1.0-4","6",function(){ui.backdrop(!1);a.next()},!0);a.discord()};this.intro=function(){ui.clear();ui.print("specialstage.io","2","2");ui.print("-","2",
"4");if(CHALLENGE)if(ui.print("challenge detected","2","6",2),ui.print("issued by: "+a.CHALLENGES[0].operator_id,"2","10"),ui.print("seed: "+a.CHALLENGES[0].seed,"2","12"),1===state.CHALLENGES.length)ui.print("time: "+a.CHALLENGES[0].cp[4],"2","14");else{if(1<state.CHALLENGES.length){var b=[];for(b.push({operator_id:a.CHALLENGES[0].operator_id,cp:a.CHALLENGES[0].cp.slice()});b.length<a.CHALLENGES.length;){for(var k=1;k<a.CHALLENGES.length;k++){var m=parseFloat(a.CHALLENGES[k].cp[4]),p=parseFloat(b[b.length-
1].cp[4]);m>p?b.push({operator_id:a.CHALLENGES[k].operator_id,cp:a.CHALLENGES[k].cp.slice()}):b.unshift({operator_id:a.CHALLENGES[k].operator_id,cp:a.CHALLENGES[k].cp.slice()})}ui.print("best time: "+b[0].cp[4]+" ("+b[0].operator_id+")","2","14");for(k=0;k<b.length;k++)ui.print(k+1+".  "+b[k].operator_id,"2","18+"+2*k),m=ui["float"](b[k].cp[4]),ui.print(m,"0.5 - "+m.length,"18+"+2*k)}}}else ui.print("operator id:","2","6"),ui.print("> "+OPERATOR_ID+" [edit name?]","2","10"),ui.button("","2","9+4p",
"1.0-4","4",function(){a.inputName(a.intro)},!1);ui.print("A _ "+BUILD,"2","1.0-4");a.nav(function(){a.intro()});ui.print("menu","1.0-9","2");ui.button("","1.0-9","2+4p","4","5",function(){a.menu(a.intro)},!1);a.discord();ui.button("start","2","1.0-12+"+(2*(RESIZE_SCALE-1)).toString(),"1.0-4","8",function(){scene.remove(demo);ui.clear();START=!0;FIREBASE&&firebase.analytics().logEvent("game_start");stage.connect();a.load()})};this.discord=function(){ui.sprite(0,72,16,16,"1.0-12","1.0-5+4p",16,16);
ui.button("discord","1.0-11","1.0-4+4p","10","4",function(){window.open("https://discord.gg/ACewNWH")},!1)};this.load=function(){ui.clear();LOADING=!0;a.nav(a.load);ui.print("seed : ","2","2");ui.print(stage.name,"2","5-1p",2);J=0};this.ready=function(){ui.clear();LOADING=!1;a.nav(a.ready);ui.print("stage generated.","2","2");ui.print(stage.name,"2","5-1p",2);a.target();ui.button("ready","2","1.0-10","1.0-4","8",function(){stage.generate.END=!1;ui.clear();a.play();PLAY=!0;vehicle.connect(stage.start,
stage.surface);FIREBASE&&firebase.analytics().logEvent("stage_start")});a.wallet()};this.play=function(){ui.clear();a.nav(a.play);MENU=!1};this.complete=function(){MENU=!0;ui.clear();a.nav(a.complete);var b=CHALLENGE?vehicle.CP()[4]>stage.best[4]?"challenge failed":"challenge victory!":"stage complete!";ui.print(b,"0.5-"+2*Math.round(b.length/2),"0.3-1",2);stage.COMPLETE=!0;window.setTimeout(a.results,2E3);FIREBASE&&(b=vehicle.param().model+" ("+(vehicle.param().power+1)+"/"+(vehicle.param().drag+
1)+"/"+(vehicle.param().sensitivity+1)+"/"+(vehicle.param().ease+1)+")",firebase.analytics().logEvent("stage_complete",{operator_id:OPERATOR_ID,time:vehicle.AT(),penalty:vehicle.PENALTY(),score:vehicle.AT()+vehicle.PENALTY(),seed:stage.name,rating:Math.round(stage.generate.DISTANCE/(vehicle.AT()+vehicle.PENALTY())),distance:stage.generate.DISTANCE,vehicle:b}))};this.results=function(){ui.clear();MENU=!0;var b=ui["float"](vehicle.AT()+vehicle.PENALTY());a.nav(a.results);ui.print("stage complete : "+
stage.name,"2","2");ui.print(b,"2","5",2);vehicle.AT()+vehicle.PENALTY()<stage.best[4]?ui.print(CHALLENGE?"challenge victory!":"new record!",2*b.length+"+3".toString(),"5+4p"):CHALLENGE&&ui.print("challenge failed",2*b.length+"+3".toString(),"5+4p");b=9;var k=vehicle.CP();if(320<t){for(var m=0;m<k.length-1;m++){ui.print("cp "+(m+1).toString(),"2",b+"+"+m.toString());var p=void 0,C=void 0;"number"===typeof k[m]?(p=ui["float"](k[m]),C=Number.isNaN(stage.best[m])?"+1 cp":k[m]-stage.best[m]):(p="penalty",
C="");ui.print(p.toString(),"0.5 -1-"+p.length.toString(),b+"+"+m.toString());p="penalty"===p?"25 sec":"+1 cp"==C?"+1 cp":0<C?"( - "+ui["float"](C)+" )":"( + "+ui["float"](Math.abs(C))+" )";ui.print(p,"0.5+1",b+"+"+m.toString());b+=1}b+=5}if(vehicle.AT()+vehicle.PENALTY()<stage.best[4]||!CHALLENGE)ui.print("reward","2",b.toString()),b+=3,ui.print("$"+vehicle.results().reward,"2",b.toString(),2);ui.button("issue challenge","0.5+1","1.0-20","0.5-3","4",a.challenge);ui.button("next stage","2","1.0-12",
"1.0-4","8",function(){a.next()});ui.button("restart stage","2","1.0-4","0.5-3","4",function(){a.reset("complete")});ui.button("view replay","0.5+1","1.0-4","0.5-3","4",function(){a.replay()});window.setTimeout(function(){PLAY=!1;vhs.PLAY=!0},0)};this.replay=function(){ui.clear();a.nav(a.results);for(var b={$jscomp$loop$prop$i$66:0};4>b.$jscomp$loop$prop$i$66;b={$jscomp$loop$prop$i$66:b.$jscomp$loop$prop$i$66},b.$jscomp$loop$prop$i$66++){var k="4+"+(4*b.$jscomp$loop$prop$i$66).toString(),m=b.$jscomp$loop$prop$i$66===
vehicle.CAMERA-1?48:40;ui.button("",k+"-10p","1.0-4+4p","3","4",function(p){return function(){vehicle.CAMERA=p.$jscomp$loop$prop$i$66+1;a.replay()}}(b),!1);ui.sprite(m,64,8,8,k,"1.0-4",8,8)}ui.print("<","2","2");ui.button("","2","2+4p","7","8",function(){a.results(a.replay)},!1)};this.next=function(){ui.clear();CHALLENGE=!1;window.history.pushState("","","/");renderer.clear();vehicle.reset();vehicle.disconnect();stage.reset();PLAY=MENU=!1;vhs.PLAY=!1;a.load();FIREBASE&&firebase.analytics().logEvent("next_stage")};
this.dnf=function(){ui.backdrop(!1);ui.clear();a.nav(a.dnf);FIREBASE&&firebase.analytics().logEvent("dnf");ui.print("dnf","0.5-3+3p","0.5-8",2);ui.button("restart stage?","2","0.5+8","1.0-4","1.0-4",function(){a.reset("dnf")},!1)};this.reset=function(b){b=void 0===b?"reset":b;ui.clear();a.nav(a.play);PLAY=!0;MENU=!1;vehicle.reset();FIREBASE&&firebase.analytics().logEvent("stage_restart",{status:b})};this.update=function(){MENU||!PLAY||DNF||(ui["delete"](16,16,d-64,16),ui["delete"](16,t-32,64,16),
ui.text(ui["float"](vehicle.AT()),16,16),ui.text(vehicle.SPEED.toString(),16,t-32))};this.loading=function(){q=0!==J%16?q:3<=q.length?"":q+".";MENU||(ui["delete"](16,16,160,8),ui.text("stage generating"+q,16,16));J++};this.target=function(){ui.print(stage.name,"2","5-1p",2);ui.print(CHALLENGE?"challenge issued by: "+a.CHALLENGES[0].operator_id:"target:","2","9");ui.print(ui["float"](stage.best[4]),"2","12-1p",2);if(300<t)for(var b=0;b<stage.best.length-1;b++){var k=Number.isNaN(stage.best[b])?"missed cp - 25 sec":
ui["float"](stage.best[b]);ui.print("cp "+(b+1).toString(),"2","16+"+(2*b).toString());ui.print(k,"1.0-2-"+k.length.toString(),"16+"+(2*b).toString())}};this.vehicle=function(b){MENU=!0;ui.clear();var k=function(){a.cSave("MODEL",vehicle.MODEL);a.cSave("POWER",vehicle.param().power);a.cSave("DRAG",vehicle.param().drag);a.cSave("SENSITIVITY",vehicle.param().sensitivity);a.cSave("EASE",vehicle.param().ease)};a.title(function(){b();k()},function(){a.menu();k()});var m=[],p=vehicle.param();m.push({id:"power",
value:p.power,funct:function(ea){vehicle.tune.power(ea)}});m.push({id:"drag",value:p.drag,funct:function(ea){vehicle.tune.drag(ea)}});m.push({id:"sensitivity",value:p.sensitivity,funct:function(ea){vehicle.tune.sensitivity(ea)}});m.push({id:"easing",value:p.ease,funct:function(ea){vehicle.tune.ease(ea)}});p="8+";ui.sprite(0,0,1,1,"2",p+"-5+3","1.0-2-2",1);ui.print("model","2",p);ui.print(vehicle.models()[vehicle.MODEL].name,"2+8",p);ui.sprite(0,0,1,1,"2",p+"+3","1.0-2-2",1);ui.button(">","1.0-6",
p+"+4p","4","4",function(){vehicle.MODEL+=1;1<vehicle.MODEL&&(vehicle.MODEL=0);a.vehicle(b)},!1);ui.button("<","1.0-12",p+"+4p","4","4",function(){--vehicle.MODEL;0>vehicle.MODEL&&(vehicle.MODEL=1);a.vehicle(b)},!1);p+="5+";for(var C={$jscomp$loop$prop$i$68:0};C.$jscomp$loop$prop$i$68<m.length;C={$jscomp$loop$prop$i$68:C.$jscomp$loop$prop$i$68},C.$jscomp$loop$prop$i$68++){var E=p+(5*C.$jscomp$loop$prop$i$68).toString();ui.print(m[C.$jscomp$loop$prop$i$68].id,"2",E);ui.sprite(0,0,1,1,"2",E+"+3","1.0-2-2",
1);for(var M={$jscomp$loop$prop$n$70:0};6>M.$jscomp$loop$prop$n$70;M={$jscomp$loop$prop$n$70:M.$jscomp$loop$prop$n$70},M.$jscomp$loop$prop$n$70++){var I="1.0-18+"+(3*M.$jscomp$loop$prop$n$70).toString(),fa=M.$jscomp$loop$prop$n$70<=m[C.$jscomp$loop$prop$i$68].value?48:40;ui.button("",I+"-10p",E+"+4p","3","4",function(ea,X){return function(){m[ea.$jscomp$loop$prop$i$68].funct(X.$jscomp$loop$prop$n$70);a.vehicle(b)}}(C,M),!1);ui.sprite(fa,64,8,8,I,E,8,8)}}};this.settings=function(b){a.SETTINGS=!0;a.STATE=
function(){b()};ui.clear();a.title(b,a.menu);ui.sprite(0,0,1,1,"2","6","1.0-4",1);ui.print("pixel scaling","2","8");(600>d||600>t)&&1===RESIZE_SCALE?ui.print("1 (locked)","1.0-2-10","8"):(ui.print(RESIZE_SCALE.toString()+" [change]","1.0-4-8","8"),ui.button("","2","8+4p","1.0-4","5",function(){return new function(){if(620<d&&620<t||1!=RESIZE_SCALE)SCALE=1<RESIZE_SCALE?1:2,resize(),a.settings(b)}},!1));ui.sprite(0,0,1,1,"2","11","1.0-4",1);ui.print("control input","2","13");MOBILE?ui.print("touch (detected)",
"1.0-7-10","13"):ui.print("keyboard (detected)","1.0-11-10","13");ui.sprite(0,0,1,1,"2","16","1.0-4",1);if(MOBILE){var k=HITBOX?"enabled":"disabled";ui.print("display touch hitboxes","2","18");ui.print(k,"1.0-2-"+k.length,"18");ui.sprite(0,0,1,1,"2","21","1.0-4",1);ui.button("","2","18+4p","1.0-4","5",function(){HITBOX=!HITBOX;a.settings(b)},!1)}else ui.print("keybindings","2","18"),ui.print("arrow / wasdr","1.0-15","18"),ui.sprite(0,0,1,1,"2","21","1.0-4",1);ui.print("camera mode","2","23");ui.print(vehicle.FPV?
"fpv":"tpv","1.0-6","23");ui.button("","2","23+4p","1.0-4","5",function(){vehicle.FPV=!vehicle.FPV;a.settings(b)},!1);ui.sprite(0,0,1,1,"2","26","1.0-4",1);ui.print("www.procedural.ca","2","1.0-10");ui.print("www.ginko.ltd","2","1.0-8");a.discord()};this.controls=function(b){ui.clear();a.title(b,a.menu)};this.fullscreen=function(){document.fullscreenElement?document.exitFullscreen&&document.exitFullscreen():document.documentElement.requestFullscreen()};this.prompt=function(){ui.clear();ui.print("specialstage.io",
"4","4",2);ui.print("-","4","8",2)};this.challenge=function(b){ui.clear();a.nav(function(){a.challenge()},a.menu);ui.print("issue challenge url","2","2");ui.print("-","2","4");ui.print("issued by","2","6");ui.print("> "+OPERATOR_ID+" [edit name?]","2","9");ui.button("","2","9+4p","1.0-4","4",function(){a.inputName(a.challenge)},!1);ui.print("seed","2","13");ui.print(stage.name,"2","15");ui.print("time","2","19");b=ui["float"](vehicle.CP()[3]+vehicle.PENALTY());ui.print(b,"2","21");ui.button("copy challenge url",
"1","1.0-8","1.0-2","8",function(){ui.clear();a.encodeURL();window.setTimeout(a.results,2E3)})};this.inputName=function(b){ui.clear();a.nav(function(){b()},a.menu);ui.print("edit operator name:","2","2");ui.textinput(OPERATOR_ID,"2","4","1.0-2","6","operator_id");var k=document.getElementById("operator_id");ui.button("accept","2","14","1.0-4","6",function(){OPERATOR_ID=k.value.toLowerCase();a.cSave("OPERATOR_ID",OPERATOR_ID);b()},!0)};this.encodeURL=function(){data=[];data[0]={operator_id:OPERATOR_ID,
seed:stage.name,cp:[]};for(var b=vehicle.CP();5>data[0].cp.length;)data[0].cp.push(ui["float"](b[data[0].cp.length]));if(CHALLENGE)for(data[1]={operator_id:a.CHALLENGES[0].operator_id,seed:stage.name,cp:[]};5>data[1].cp.length;)data[1].cp.push(ui["float"](a.CHALLENGES[0].cp[data[1].cp.length]));b="";for(var k=0;k<data.length;k++)0<k&&(b+="\n"),b+=data[k].operator_id,b+="\t",b+=data[k].seed,b+="\t",b+=data[k].cp[0],b+="\t",b+=data[k].cp[1],b+="\t",b+=data[k].cp[2],b+="\t",b+=data[k].cp[3],b+="\t",
b+=data[k].cp[4];b=window.btoa(b);window.history.pushState("","","/");k=window.location.href;var m=window.location.pathname+"#"+b;navigator.clipboard.writeText(k+"#"+b).then(function(){ui.print("url copied to clipboard","2","2");window.history.pushState("","",m)},function(){window.history.pushState("","",m);ui.print("url copied to address bar","2","2")});FIREBASE&&firebase.analytics().logEvent("challenge_issued",{url:k+"#"+b})};this.decodeURL=function(){for(var b=window.location.href,k="",m=!1,p=
0;p<b.length;p++)m&&(k+=b.charAt(p)),"#"===b.charAt(p)&&(m=!0);if(m){var C=p=0;m=[[],[]];m[C][p]="";try{var E=window.atob(k);for(k=0;k<E.length;k++){var M=E.charAt(k);"\t"===M?(p++,m[C][p]=""):"\n"===M?(p=0,C++,m[C][p]=""):m[C][p]+=M}for(E=0;E<m.length;E++)7===m[E].length&&(a.CHALLENGES[E]={id:"",seed:"",cp:[]},a.CHALLENGES[E].operator_id=m[E][0],a.CHALLENGES[E].seed=m[E][1],a.CHALLENGES[E].cp[0]=parseFloat(m[E][2]),a.CHALLENGES[E].cp[1]=parseFloat(m[E][3]),a.CHALLENGES[E].cp[2]=parseFloat(m[E][4]),
a.CHALLENGES[E].cp[3]=parseFloat(m[E][5]),a.CHALLENGES[E].cp[4]=parseFloat(m[E][6]));CHALLENGE=!0;FIREBASE&&firebase.analytics().logEvent("challenge_accepted",{url:b})}catch(I){}}};this.cSave=function(b,k){var m=new Date;m.setTime(m.getTime()+1404E8);m="expires="+m.toUTCString();document.cookie=b+"="+k+";"+m+";path=/"};this.cLoad=function(b){b+="=";for(var k=document.cookie.split(";"),m=0;m<k.length;m++){for(var p=k[m];" "==p.charAt(0);)p=p.substring(1);if(0==p.indexOf(b))return p.substring(b.length,
p.length)}return""};this.checksave=function(){var b=a.cLoad("OPERATOR_ID");OPERATOR_ID=0!==b.length&&void 0!=b?b:"operator";b=a.cLoad("MODEL");var k=a.cLoad("POWER"),m=a.cLoad("DRAG"),p=a.cLoad("SENSITIVITY"),C=a.cLoad("EASE");b=0!=b.length&&void 0!==b?parseInt(b):vehicle.MODEL;k=0!==k.length&&void 0!==k?parseInt(k):vehicle.param().power;m=0!==m.length&&void 0!==m?parseInt(m):vehicle.param().drag;p=0!==p.length&&void 0!=p?parseInt(p):vehicle.param().sensitivity;C=0!==C.length&&void 0!==C?parseInt(C):
vehicle.param().ease;vehicle.MODEL=b;vehicle.tune.power(k);vehicle.tune.drag(m);vehicle.tune.sensitivity(p);vehicle.tune.ease(C)};this.promo=function(){ui.clear();ui.print("0.0.4","2","2");ui.sprite(56,68,48,20,"2","6-4p",192,80,4);ui.sprite(1,0,255,16,"2","20",255,16);ui.print("_","2","1.0-10");ui.print("https://specialstage.io","2","18")};this.music=function(b){ui.sprite(16,72,16,16,"2","1.0-6-1p",16,16);ui.print("shinpuru - without","6","1.0-6")};this.updates=function(){ui.clear();ui.print("0.0.4 updates",
"2","2");ui.print("> new biome: ice field","2","6");ui.print("> improved vehicle physics","2","8");ui.print("> added fpv camera","2","10");ui.print("> added snow particle effects","2","12");ui.print("> added terrain drag penalty","2","14");ui.print("> increased gravity","2","16");ui.print("> decreased air resistance","2","18");ui.print("> disabled DNF timeout during button input ( for jumps)","2","20");ui.print("> removed framerate dependecies","2","22");ui.print("> reworked ui pixel scaling","2",
"24");ui.print("https://specialstage.io","2","1.0-4")}};var BUILD="0.0.4";window.onload=init;window.onresize=resize;window.fullscreenchange=resize;window.focus=resize;var palette=[1052688,16777215,12698049,2894892,5308334,16740978,2393855,2201343,3424820,2201152,7168071,10066329,16756970],i;for(i in palette){var c=new THREE.Color(palette[i]);palette[i]=c}
var LOADSTATUS=0,SEED_NAME="",SEED=Math.floor(2147483647*Math.random()),scene,camera,renderer,stage,vehicle,control,ui,vhs,state,OPERATOR_ID="operator",UP,PLAY=!1,IMPORT=!1,BG=palette[0],FRAME=0,TIME=0,TIMER=0,DT=0,FPS=0,COUNTER=0,TIMEOUT=0,DNF=!1,REASON="out of bounds",FULLSCREEN=!1,MODE=0,LOAD=0,LOADING=!1,MENU=!1,MOBILE=!1,CHALLENGE=!1,OBJECTIVES=[],UPDATES=[],HITBOX=!0,FIREBASE=!0,SCALE=1,RESIZE_SCALE=1,SNOW=!1,RAFID=0,demo,CHALLENGES=[];
function init(){window.addEventListener("touchstart",activateTouch);window.addEventListener("contextmenu",function(){event.preventDefault()});scene=new THREE.Scene;scene.background=BG;UP=new THREE.Vector3(0,0,1);camera=new THREE.PerspectiveCamera;camera.up=UP;camera.position.z=2E3;camera.lookAt(0,0,0);camera.fov=70;camera.near=1E-4;camera.far=3E3;camera.name="Camera";scene.add(camera);renderer=new THREE.WebGLRenderer({logarithmicDepthBuffer:!0,antialias:!1});renderer.setClearColor(BG);renderer.domElement.id=
"renderer";document.body.appendChild(renderer.domElement);control=new Control;control.connect();ui=new UI;stage=new Stage;vehicle=new Vehicle;vhs=new VHS;state=new State;state.checksave();state.decodeURL();vehicle.init();resize();ui.onload=function(){camera.position.set(0,25,10);camera.lookAt(0,0,0);main();state.intro()}}function activateTouch(){MOBILE=!0;window.removeEventListener("touchstart",activateTouch)}
function resize(){var a=1===window.devicePixelRation&&300<window.innerWidth&&300<window.innerHeight?2:1;state.SETTINGS&&state.settings(state.STATE);var d=window.innerWidth,t=window.innerHeight;camera.aspect=d/t;camera.updateProjectionMatrix();ui.resize(d,t,a);state.resize(d,t,a)}
function main(){RAFID=window.requestAnimationFrame(main);PLAY?(vhs.record(vehicle),vehicle.update(),MENU||state.update(),!MOBILE||MENU||DNF||ui.dpad(),control.RESET&&!MENU&&(state.reset(),control.RESET=!1)):vhs.PLAY?vhs.play(vehicle):LOADING?(camera.position.applyAxisAngle(camera.up,.01),camera.lookAt(new THREE.Vector3,0,0,0),state.loading()):(camera.position.applyAxisAngle(camera.up,.01),camera.lookAt(new THREE.Vector3,0,0,0));renderer.render(scene,camera);ui.update(control.touches)};